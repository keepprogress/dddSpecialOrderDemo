# Quality Checklist: 002-create-order

**Feature**: 新增訂單頁面
**Generated**: 2025-12-19
**Status**: Draft

---

## Specification Completeness

### User Stories

- [x] User Story 1 (P1): 建立基本訂單 - 5 個 Acceptance Scenarios
- [x] User Story 2 (P2): 設定安裝與運送服務 - 5 個 Acceptance Scenarios
- [x] User Story 3 (P3): 套用會員折扣 - 4 個 Acceptance Scenarios
- [x] User Story 4 (P4): 套用優惠券與紅利點數 - 4 個 Acceptance Scenarios
- [x] Edge Cases: 6 個邊界條件已識別

### Functional Requirements

- [x] 訂單建立 (FR-001 ~ FR-005): 5 個需求
- [x] 商品資格驗證 (FR-010 ~ FR-013): 4 個需求
- [x] 價格計算 (FR-020 ~ FR-025): 6 個需求
- [x] 優惠券與紅利 (FR-030 ~ FR-033): 4 個需求

### Key Entities

- [x] Order Aggregate (訂單聚合根): 7 個屬性
- [x] OrderLine Entity (訂單行項): 9 個屬性
- [x] PriceCalculation Value Object: 7 個屬性
- [x] MemberDiscount Value Object: 7 個屬性

### Domain Services

- [x] OrderPricingService: 12 步驟計價流程
- [x] ProductEligibilityService: 6 層驗證
- [x] MemberDiscountService: 4 種折扣類型

### Business Rules

- [x] 訂單建立規則 (OR-001 ~ OR-006): 6 條規則
- [x] 價格與折扣規則 (PR-001 ~ PR-007): 7 條規則
- [x] 會員折扣執行順序: 5 個步驟
- [x] 備貨方式規則 (ST-001 ~ ST-004): 4 條規則

---

## Constitution Compliance

### Core Principles

- [x] **Pragmatic DDD**: Order 為聚合根，OrderLine 為實體，其餘為 Value Object
- [x] **3-Table Rule**: TBL_ORDER_MAST, TBL_ORDER_DETL, TBL_ORDER_COMPUTE 符合規則
- [x] **KISS Principle**: 優先使用既有系統驗證過的邏輯，避免過度抽象
- [x] **Database Schema Documentation**: 參考 docs/tables/*.html
- [x] **Legacy Codebase Reference**: 參考 C:/projects/som

### Architecture Standards

- [x] **No Lombok**: 規格中明確使用 Java Records 作為 DTO
- [x] **MyBatis Generator**: 基礎 Mapper 自動產生，CustomMapper 用於複雜查詢
- [x] **Stateless Backend**: API 無狀態設計，Token 驗證透過 Keycloak
- [x] **OpenAPI RESTful**: API 設計符合 RESTful 規範
- [x] **Angular 21+**: 前端規範已納入技術約束

---

## DDD 領域模型整合驗證

### Bounded Contexts

- [x] Order Context (核心領域): 訂單聚合根與行項管理
- [x] Member Context (支援領域): 會員資訊查詢與折扣資格
- [x] Catalog Context (支援領域): 商品資格驗證與服務關聯
- [x] Pricing Context (支援領域): 12 步驟計價流程
- [x] Fulfillment Context (支援領域): 工種指派與成本計算

### 計價邏輯驗證

- [x] 12 步驟計價流程完整記錄
- [x] 會員折扣執行順序正確：Type 2 → 促銷 → Type 0 → Type 1 → 特殊會員
- [x] Type 2 執行後必須重新分類商品
- [x] Type 0 不修改 actPosAmt，僅記錄於 memberDisc
- [x] Type 1 直接修改 actPosAmt
- [x] 6 種 ComputeType 定義完整

### 商品資格驗證

- [x] 6 層驗證順序正確：格式 → 存在性 → 系統商品 → 稅別 → 銷售禁止 → 類別限制
- [x] 安裝服務關聯邏輯（I, IA, IE, IC, IS, FI）
- [x] 運送方式與備貨方式相容性矩陣

---

## Implementation Readiness

### 待釐清事項

- [x] 商品數量試算上限：500 筆 (TBL_PARM.SKU_COMPUTE_LIMIT)，結帳限制 1000 筆
- [x] CRM 系統整合方式：Controller 層 Mock (K00123/TEMP001 返回假資料)
- [x] Type 2 負數折扣的處理邏輯：歸零處理並發送告警信
- [x] 促銷引擎 (Event A-H) 的優先級控制來源：OMS 控制優先級

### 風險評估

| 風險項目 | 等級 | 緩解措施 |
|---------|------|---------|
| 計價邏輯複雜度高 | 高 | 建立單元測試比對既有系統結果 |
| CRM 系統整合 | 中 | 設計 Anti-Corruption Layer |
| 多重促銷規則 | 高 | 參考既有程式碼，建立測試案例 |
| 前端狀態管理 | 中 | 使用 Angular Signals 簡化狀態流 |

### 依賴項目

- [x] 001-keycloak-user-login 功能完成（登入與店別選擇）
- [x] CRM 系統 API 規格確認（使用 Mock 實作：K00123/TEMP001）
- [x] 資料庫結構文件 (docs/tables) 完整性確認

---

## Test Coverage Planning

### 單元測試

- [x] OrderPricingService: 12 步驟計價流程
- [x] ProductEligibilityService: 6 層商品驗證
- [x] MemberDiscountService: Type 0/1/2/Special 計算
- [x] 折扣分攤計算（固定面額、百分比）

### 整合測試

- [x] Order → Pricing Context 整合
- [x] Order → Member Context 整合（CRM Mock）
- [x] Order → Catalog Context 整合

### E2E 測試 (Playwright)

- [x] 完整訂單建立流程（P1 User Story）
- [x] 安裝服務選擇流程（P2 User Story）
- [x] 會員折扣驗證（P3 User Story）
- [x] 優惠券套用流程（P4 User Story）
- [x] 關鍵步驟截圖驗證

---

## Approval Status

| 審核項目 | 狀態 | 審核人 | 日期 |
|---------|------|--------|------|
| 規格完整性 | ✅ 通過 | Claude | 2025-12-20 |
| DDD 模型合理性 | ✅ 通過 | Claude | 2025-12-20 |
| 業務規則正確性 | ✅ 通過 | Claude | 2025-12-20 |
| 技術可行性 | ✅ 通過 | Claude | 2025-12-20 |
| Constitution 合規性 | ✅ 通過 | Claude | 2025-12-20 |

---

**Generated by**: speckit.specify workflow
**Implementation Status**: ✅ 完成
**Completed Date**: 2025-12-20
