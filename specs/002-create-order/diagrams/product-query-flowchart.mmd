%% 商品查詢流程圖（含 lockTradeStatusY 和大型家具展開）
%% 來源：BzSkuInfoServices.java:237-275, LargeFurnitureService.java:31-60, soSKUSubPage.jsp

flowchart TD
    A[輸入 SKU/Barcode + StoreId] --> B{輸入長度 >= 10?}
    B -->|是| C[TBL_BARCODE 查詢]
    B -->|否| D[直接 SKU 查詢]

    C --> E{找到條碼?}
    E -->|是| F[取得 SKU_NO]
    E -->|否| G[TBL_SKU.BARCODE 備用查詢]
    G --> F

    D --> F
    F --> H[查詢 TBL_SKU + TBL_SKU_STORE]

    H --> I{商品存在?}
    I -->|否| J[返回商品不存在]
    I -->|是| K{SUB_DEPT='026' AND CLASS='888'?}

    K -->|是| L[外包服務商品處理<br/>qerySkuInfoFor026888]
    K -->|否| LOCK_CHECK

    %% ========== lockTradeStatusY 展開（後端 3 項檢查）==========
    subgraph LOCK_CHECK[lockTradeStatusY 判斷<br/>BzSkuInfoServices.java:237-275]
        direction TB

        LOCK1{商品類型在 C08 清單?<br/>TBL_SUB_CONFIG.MASTER_CONFIG_ID='C08'<br/>行 243-244}
        LOCK1 -->|否| REJECT_SKU_TYPE[SKU_TYPE_NOT_ORDERABLE<br/>商品類型不在可訂購清單]
        LOCK1 -->|是| LOCK2

        LOCK2{廠商 STATUS = 'A'?<br/>TBL_VENDOR_COMPANY.STATUS<br/>行 252-260}
        LOCK2 -->|否| LOCK2A{DC_TYPE = 'DC'?}
        LOCK2A -->|是| LOCK2B[設置 isDcVendorStatusD=true<br/>後續需查 AOH 量]
        LOCK2A -->|否| REJECT_VENDOR_NON_DC[VENDOR_FROZEN<br/>廠商凍結-非DC商品]
        LOCK2 -->|是| LOCK3
        LOCK2B --> LOCK3

        LOCK3{採購組織存在?<br/>TBL_SKU_COMPANY 有記錄<br/>行 273-274}
        LOCK3 -->|否| REJECT_PURCHASE_ORG[PURCHASE_ORG_NOT_FOUND<br/>採購組織不存在]
        LOCK3 -->|是| LOCK_PASS[lockTradeStatusY='N'<br/>通過後端檢查]
    end
    %% ========== lockTradeStatusY 展開結束 ==========

    REJECT_SKU_TYPE --> FINAL_X
    REJECT_VENDOR_NON_DC --> FINAL_X
    REJECT_PURCHASE_ORG --> FINAL_X

    LOCK_PASS --> FURNITURE_CHECK

    %% ========== 大型家具判斷展開 ==========
    subgraph FURNITURE_CHECK[大型家具判斷<br/>LargeFurnitureService.java:31-60]
        direction TB

        FUR0[從 TBL_PARM_DETL 讀取設定<br/>PARM='LARGE_FURNITURE'<br/>行 67-73]
        FUR0 --> FUR1

        FUR1{遍歷設定清單}
        FUR1 --> FUR2{SUB_DEPT_ID 符合?<br/>setting.getSubDeptId.equals-subDeptId-}
        FUR2 -->|否| FUR1_NEXT[繼續下一筆]
        FUR1_NEXT --> FUR1
        FUR2 -->|是| FUR3{CLASS_ID 為 NULL?<br/>setting.getClassId-- == null}
        FUR3 -->|是| FUR_YES[largeFurniture=true<br/>大類符合即判定]
        FUR3 -->|否| FUR4{CLASS_ID 符合?<br/>setting.getClassId.equals-classId-}
        FUR4 -->|否| FUR1_NEXT
        FUR4 -->|是| FUR5{SUB_CLASS_ID 為 NULL?<br/>setting.getSubClassId-- == null}
        FUR5 -->|是| FUR_YES2[largeFurniture=true<br/>大中類符合即判定]
        FUR5 -->|否| FUR6{SUB_CLASS_ID 符合?<br/>setting.getSubClassId.equals-subClassId-}
        FUR6 -->|是| FUR_YES3[largeFurniture=true<br/>大中小類皆符合]
        FUR6 -->|否| FUR1_NEXT

        FUR1 -->|遍歷結束無符合| FUR_NO[largeFurniture=false]
    end
    %% ========== 大型家具判斷結束 ==========

    FUR_YES --> CHECK_STATUS
    FUR_YES2 --> CHECK_STATUS
    FUR_YES3 --> CHECK_STATUS
    FUR_NO --> CHECK_STATUS

    CHECK_STATUS{skuStatus='A'?<br/>soSKUSubPage.jsp:527, 1350}
    CHECK_STATUS -->|否| REJECT_STATUS[SKU_INACTIVE<br/>商品狀態非 Active]
    CHECK_STATUS -->|是| CHECK_STORE_STATUS

    CHECK_STORE_STATUS{skuStoreStatus 檢查<br/>soSKUSubPage.jsp:527, 1351-1352}
    CHECK_STORE_STATUS -->|='D' 且 dcType≠DC| REJECT_STORE[SKU_STORE_INACTIVE<br/>門店商品已停用]
    CHECK_STORE_STATUS -->|='A' 或 DC商品| CHECK_HOLD_ORDER

    %% ========== HOLD_ORDER 判斷（依 DC_TYPE 選清單）==========
    subgraph CHECK_HOLD_ORDER[HOLD_ORDER 判斷<br/>soSKUSubPage.jsp:529-540, 1341-1349]
        direction TB

        DECIDE_LIST{DC_TYPE?}
        DECIDE_LIST -->|DC| USE_STO[使用 stoAllowList<br/>允許: N, D, E]
        DECIDE_LIST -->|XD/NULL| USE_PO[使用 poAllowList<br/>允許: N, D]

        USE_STO --> CHECK_IN_LIST{holdOrder 在清單內?}
        USE_PO --> CHECK_IN_LIST
        CHECK_IN_LIST -->|否| REJECT_HOLD_INNER[HOLD_ORDER_RESTRICTED]
        CHECK_IN_LIST -->|是| HOLD_PASS[HOLD_ORDER 通過]
    end
    %% ========== HOLD_ORDER 判斷結束 ==========

    REJECT_HOLD_INNER --> FINAL_X

    HOLD_PASS --> CHECK_DC_VENDOR{isDcVendorStatusD=true?<br/>DC 商品廠商凍結特殊處理}
    CHECK_DC_VENDOR -->|是| CHECK_DC_AOH{AOH > 0 或 大型家具?<br/>soSKUSubPage.jsp:1343-1348}
    CHECK_DC_AOH -->|否| REJECT_DC_VENDOR[DC_VENDOR_FROZEN_NO_AOH<br/>DC商品廠商凍結無庫存]
    CHECK_DC_AOH -->|是| CHECK_CHANNEL_AOH
    CHECK_DC_VENDOR -->|否| CHECK_CHANNEL_AOH

    CHECK_CHANNEL_AOH{TLW/G0 且 DC 且非大型家具?<br/>soSKUSubPage.jsp:1344}
    CHECK_CHANNEL_AOH -->|是| CHECK_AOH{AOH > 0?<br/>soSKUSubPage.jsp:1347}
    CHECK_AOH -->|否| REJECT_AOH[NO_STOCK_FOR_CHANNEL<br/>TLW/G0 通路無庫存]
    CHECK_AOH -->|是| CAN_ORDER
    CHECK_CHANNEL_AOH -->|否| CAN_ORDER

    CAN_ORDER[可訂購<br/>tradeStatus='Y'] --> CHECK_FREE{freeDeliver='Y'?<br/>soSKUSubPage.jsp:1674}
    CHECK_FREE -->|是| CAN_DIRECT[可直送<br/>deliveryFlag='V']
    CHECK_FREE -->|否| NO_DIRECT[不可直送<br/>deliveryFlag='P']

    %% ========== 最終狀態 ==========
    REJECT_STATUS --> FINAL_X
    REJECT_STORE --> FINAL_X
    REJECT_DC_VENDOR --> FINAL_X
    REJECT_AOH --> FINAL_X
    L --> INSTALL

    FINAL_X[不可訂購<br/>tradeStatus='X'<br/>deliveryFlag='P']
    NO_DIRECT --> FINAL_Y_P[可訂購不可直送<br/>tradeStatus='Y'<br/>deliveryFlag='P']
    CAN_DIRECT --> FINAL_Y_V[可訂購可直送<br/>tradeStatus='Y'<br/>deliveryFlag='V']
    INSTALL[載入安裝服務] --> RESULT[組裝 SkuInfoVO 返回]
    J --> END[結束]
    RESULT --> END
    FINAL_X --> END
    FINAL_Y_P --> END
    FINAL_Y_V --> END
