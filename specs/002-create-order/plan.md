# Implementation Plan: 新增訂單頁面

**Branch**: `002-create-order` | **Date**: 2025-12-20 | **Spec**: [spec.md](./spec.md) (v2.0.0)
**Input**: Feature specification from `/specs/002-create-order/spec.md`
**Constitution**: [constitution.md](../../.specify/memory/constitution.md) (v1.10.0)

**Note**: This plan was generated by the `/speckit.plan` command.

## Summary

本功能實作特殊訂單 (Special Order, SO) 新增頁面，整合 5 個 Bounded Context：Order Context（核心領域）、Member Context、Catalog Context、Pricing Context、Fulfillment Context。

**核心需求**：
- 訂單建立與提交流程（FR-001~FR-005）
- 8 層商品資格驗證（FR-010~FR-015）
- 12 步驟計價流程（FR-020~FR-026）
- 優惠券與紅利折抵（FR-030~FR-033）

**技術方案**：
- 參考既有系統 `BzSoServices.java:doCalculate` 重新實作為 `OrderPricingService`
- 使用 Strategy Pattern 處理 Type 0/1/2/Special 四種會員折扣類型
- 前端使用 Angular Signals + RxJS 進行狀態管理
- 前端 UUID + 後端 ConcurrentHashMap 雙重冪等性機制

## Technical Context

**Backend**:
- **Language/Version**: Java 21+（使用 Records、Pattern Matching）
- **Framework**: Spring Boot 3.x+
- **Security**: Spring Security OAuth2 Resource Server + Keycloak
- **Data Access**: MyBatis + MyBatisGenerator（禁用 Lombok）
- **Storage**: Oracle 21c (Production), H2 (Development)
- **API Documentation**: springdoc-openapi (OpenAPI 3.0+)
- **Logging**: Logback + logback-encoder（結構化 JSON 日誌）

**Frontend**:
- **Language/Version**: TypeScript 5.9+
- **Framework**: Angular 21+（Standalone Components, Signals, OnPush）
- **State Management**: Angular Signals + RxJS（HTTP operations）
- **Auth Library**: keycloak-angular
- **E2E Testing**: Playwright

**Testing**:
- Backend: JUnit 5 + JaCoCo（≥ 80% coverage）
- Frontend: Jest/Karma（≥ 80% coverage）
- E2E: Playwright

**Target Platform**: Web Application (SPA + RESTful API)

**Performance Goals**:
- 價格試算 API 回應時間 ≤ 3 秒（500 筆明細以內）
- 商品資格驗證 API 回應時間 ≤ 500ms
- 訂單建立 API 回應時間 ≤ 2 秒

**Constraints**:
- 試算限制：500 筆（可配置於 TBL_PARM.SKU_COMPUTE_LIMIT）
- 結帳限制：1000 筆（TBL_PARM.ORDER_DETL_LIMIT）
- 外部服務逾時：促銷引擎 2s、CRM 2s、商品主檔 1s
- Stateless Backend：無 Server-Side Session

**Scale/Scope**:
- 4 個 User Stories（P1~P4）
- 核心資料表：TBL_ORDER_MAST, TBL_ORDER_DETL, TBL_ORDER_COMPUTE（符合 3-Table Rule）

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| 原則 | 狀態 | 說明 |
|------|------|------|
| I. Pragmatic DDD | ✅ PASS | Order 為聚合根，OrderLine 為實體，使用 Value Objects (OrderId, ProjectId, Money, Customer) |
| II. 3-Table Rule | ✅ PASS | 核心資料表 3 個：TBL_ORDER_MAST, TBL_ORDER_DETL, TBL_ORDER_COMPUTE；商品/會員/價格為支援領域，獨立查詢不 JOIN |
| III. KISS Principle | ✅ PASS | 參考既有設計重新實作，避免過度抽象；CRM Mock 採 Controller 直接判斷 |
| IV. Database Schema Documentation | ✅ PASS | 已查閱 docs/tables/*.html，完成資料表規格驗證 |
| V. Legacy Codebase Reference | ✅ PASS | 已驗證 C:/projects/som 既有程式碼，規格與程式碼證據對照完成（見 spec.md Legacy Code Verification Report）|
| VI. Stateless Backend | ✅ PASS | API 無狀態，Token 驗證透過 Keycloak，無 Server-Side Session |
| VII. Playwright Verification | ⏳ PENDING | 實作完成後執行 E2E 測試驗證 |
| VIII. MyBatis Generator Pattern | ✅ PASS | 基礎 Mapper 自動產生，複雜查詢使用 CustomMapper |
| IX. No Lombok Policy | ✅ PASS | 使用 Java Records 作為 DTO，Entity 手動撰寫 getter/setter |
| X. Data Class Convention | ✅ PASS | API Request/Response 使用 Records，MyBatis Entity 使用傳統 Class |
| XI. OpenAPI RESTful API Standard | ✅ PASS | Code-First 方式，使用 springdoc-openapi 自動產生文件 |
| XII. Angular 21+ Frontend Standard | ✅ PASS | Standalone Components, Signals, 新控制流語法, inject() 函數, OnPush |
| XIII. Code Coverage Requirement | ⏳ PENDING | 實作完成後驗證 ≥ 80% 覆蓋率 |

**Pre-Design Gate**: ✅ PASSED（無阻擋性違規）

## Project Structure

### Documentation (this feature)

```text
specs/002-create-order/
├── plan.md              # This file (/speckit.plan output)
├── spec.md              # Feature specification
├── research.md          # Phase 0: Technical research (Complete)
├── data-model.md        # Phase 1: Domain model (Complete)
├── quickstart.md        # Phase 1: Development guide (Complete)
├── contracts/
│   └── order-api.yaml   # Phase 1: OpenAPI specification (Complete)
├── pricing-calculation-spec.md  # 12 步驟計價流程詳細規格
├── product-query-spec.md        # 商品查詢規格（8 層驗證）
├── worktype-mapping-spec.md     # 工種對照規格
├── delivery-fee-spec.md         # 運送費用規格
├── diagrams/                    # Mermaid 圖表
└── tasks.md             # Phase 2: Implementation tasks (Complete)
```

### Source Code (repository root)

```text
backend/src/main/java/com/tgfc/som/
├── order/                       # Order Context (核心領域)
│   ├── controller/
│   │   └── OrderController.java
│   ├── service/
│   │   ├── OrderService.java
│   │   ├── OrderPricingService.java
│   │   └── IdempotencyService.java
│   ├── domain/
│   │   ├── Order.java           # Aggregate Root
│   │   ├── OrderLine.java       # Entity
│   │   └── vo/                  # Value Objects
│   │       ├── OrderId.java
│   │       ├── ProjectId.java
│   │       ├── Customer.java
│   │       └── Money.java
│   └── dto/
│       ├── CreateOrderRequest.java
│       ├── OrderResponse.java
│       └── CalculationResponse.java
├── product/                     # Catalog Context (支援領域)
│   ├── controller/
│   │   └── ProductController.java
│   ├── service/
│   │   └── ProductEligibilityService.java
│   └── dto/
│       └── EligibilityResponse.java
├── member/                      # Member Context (支援領域)
│   ├── controller/
│   │   └── MemberController.java
│   ├── service/
│   │   └── MemberDiscountService.java
│   └── dto/
│       └── MemberResponse.java
├── pricing/                     # Pricing Context (支援領域)
│   ├── service/
│   │   ├── PricingCalculationService.java
│   │   └── strategy/
│   │       ├── MemberDiscountStrategy.java
│   │       ├── Type0DiscountStrategy.java
│   │       ├── Type1DiscountStrategy.java
│   │       └── Type2DiscountStrategy.java
│   └── dto/
│       └── ComputeTypeVO.java
├── fulfillment/                 # Fulfillment Context (支援領域)
│   └── service/
│       └── WorktypeService.java
├── mapper/                      # MyBatisGenerator 產生的 Mapper
├── mapper/custom/               # 手動撰寫的 CustomMapper
├── entity/                      # MyBatisGenerator 產生的 Entity
└── common/
    ├── config/                  # Keycloak, Security, MyBatis configs
    ├── exception/               # Exception handlers
    └── constant/                # Enums and constants

backend/src/test/java/com/tgfc/som/
├── order/
│   ├── OrderServiceTest.java
│   └── OrderPricingServiceTest.java
├── product/
│   └── ProductEligibilityServiceTest.java
└── pricing/
    └── MemberDiscountStrategyTest.java

frontend/src/app/
├── core/                        # Core module
│   ├── services/
│   │   ├── auth.service.ts
│   │   └── toast.service.ts
│   └── interceptors/
│       └── http-error.interceptor.ts
├── shared/                      # Shared module
│   ├── components/
│   │   ├── skeleton-loader/
│   │   └── toast/
│   └── pipes/
├── features/
│   └── order/                   # Order feature module
│       ├── components/
│       │   ├── create-order/
│       │   ├── member-info/
│       │   ├── order-line/
│       │   ├── product-search/
│       │   └── price-calculation/
│       ├── services/
│       │   ├── order.service.ts
│       │   └── member.service.ts
│       └── order.routes.ts
└── app.routes.ts

e2e/
├── tests/
│   └── order/
│       └── create-order.spec.ts
└── screenshots/
```

**Structure Decision**: 採用 Web Application 架構（frontend + backend），後端依 Bounded Context 分層，前端依 Feature 分層。符合 Constitution 中的 DDD 分層架構規範。

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| 支援領域查詢多於 3 表 | 商品查詢需關聯 TBL_SKU + TBL_SKU_STORE + TBL_VENDOR_COMPANY + TBL_SKU_COMPANY | 這些為支援領域的「讀取」查詢，非核心訂單聚合；查詢為單向且無交易鎖定需求；商品主檔為小資料集（非歷史資料），成長可控 |
| Strategy Pattern for Member Discount | 四種折扣類型（Type 0/1/2/Special）計算邏輯差異大，無法用簡單條件判斷 | 使用 if-else 會導致過長的方法和違反開閉原則；Strategy 提供清晰的擴展點 |

---

## Phase Artifacts Summary

### Phase 0: Research (Complete)

| 產出 | 狀態 | 路徑 |
|------|------|------|
| research.md | ✅ Complete | [research.md](./research.md) |

**研究決策摘要**：
1. 12 步驟計價流程：參考既有設計重新實作
2. 會員折扣：Strategy Pattern 處理 Type 0/1/2/Special
3. 商品驗證：統一 ProductEligibilityService
4. 相容性驗證：前端即時 + 後端雙重檢查
5. 冪等性：UUID + ConcurrentHashMap
6. CRM Mock：Controller 直接判斷
7. 降級策略：Circuit Breaker Pattern
8. 狀態管理：Signals + RxJS
9. Toast：自建輕量元件
10. Skeleton：CSS-based

### Phase 1: Design (Complete)

| 產出 | 狀態 | 路徑 |
|------|------|------|
| data-model.md | ✅ Complete | [data-model.md](./data-model.md) |
| order-api.yaml | ✅ Complete | [contracts/order-api.yaml](./contracts/order-api.yaml) |
| quickstart.md | ✅ Complete | [quickstart.md](./quickstart.md) |
| pricing-calculation-spec.md | ✅ Complete | [pricing-calculation-spec.md](./pricing-calculation-spec.md) (v1.1.0) |
| product-query-spec.md | ✅ Complete | [product-query-spec.md](./product-query-spec.md) |
| worktype-mapping-spec.md | ✅ Complete | [worktype-mapping-spec.md](./worktype-mapping-spec.md) |
| delivery-fee-spec.md | ✅ Complete | [delivery-fee-spec.md](./delivery-fee-spec.md) |

### Phase 2: Tasks (Complete)

| 產出 | 狀態 | 路徑 |
|------|------|------|
| tasks.md | ✅ Complete | [tasks.md](./tasks.md) |

---

## Post-Design Constitution Re-Check

*Re-evaluated after Phase 1 design completion*

| 原則 | 狀態 | 設計驗證 |
|------|------|----------|
| I. Pragmatic DDD | ✅ PASS | data-model.md 定義 Order Aggregate、OrderLine Entity、Value Objects；避免過度抽象 |
| II. 3-Table Rule | ✅ PASS | 核心訂單表 3 個；支援領域查詢已記錄於 Complexity Tracking |
| III. KISS Principle | ✅ PASS | 參考既有設計；Mock 採簡單判斷；Toast 自建輕量元件 |
| IV. Database Schema Documentation | ✅ PASS | product-query-spec.md 詳列 TBL_SKU、TBL_SKU_STORE 等資料表欄位 |
| V. Legacy Codebase Reference | ✅ PASS | pricing-calculation-spec.md 包含 BzSoServices.java 程式碼行號對照 |
| VI. Stateless Backend | ✅ PASS | API 設計無 session 依賴；冪等鍵使用 ConcurrentHashMap 非 session |
| VII. Playwright Verification | ⏳ PENDING | quickstart.md 包含 E2E 測試範例，待實作後執行 |
| VIII. MyBatis Generator Pattern | ✅ PASS | Project Structure 定義 mapper/ 與 mapper/custom/ 分離 |
| IX. No Lombok Policy | ✅ PASS | data-model.md 範例使用 Java Records 與手動 getter/setter |
| X. Data Class Convention | ✅ PASS | Request/Response 使用 Records；Entity 使用傳統 Class |
| XI. OpenAPI RESTful API Standard | ✅ PASS | contracts/order-api.yaml 符合 OpenAPI 3.0 規範 |
| XII. Angular 21+ Frontend Standard | ✅ PASS | quickstart.md 範例使用 Standalone、Signals、新控制流語法 |
| XIII. Code Coverage Requirement | ⏳ PENDING | 待實作完成後驗證 |

**Post-Design Gate**: ✅ PASSED（無阻擋性違規，2 項待實作後驗證）

---

## Next Steps

1. 執行 `/speckit.implement` 開始實作 tasks.md 中的任務
2. 實作完成後執行 Playwright E2E 測試
3. 驗證程式碼覆蓋率 ≥ 80%
4. 更新 Constitution Check 狀態為 PASS
