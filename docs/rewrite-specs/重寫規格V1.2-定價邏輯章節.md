# Rewrite-Spec v1.4 - å®šåƒ¹ã€ä¿ƒéŠ·èˆ‡ä»˜æ¬¾æµç¨‹ç« ç¯€æ›´æ–°

## æ–‡ä»¶æ§åˆ¶

- **ç‰ˆæœ¬**ï¼š1.4ï¼ˆè‰ç¨¿ï¼‰
- **æ—¥æœŸ**ï¼š2025-10-28
- **ç‹€æ…‹**ï¼šè‰ç¨¿ - å¾…æ¥­å‹™æ ¸å‡†
- **å–ä»£**ï¼šOpenSpecï¼ˆèˆŠç‰ˆï¼‰å®šåƒ¹ç« ç¯€
- **ä½œè€…**ï¼šæŠ€è¡“åœ˜éšŠåŸºæ–¼ç¨‹å¼ç¢¼è¿½è¹¤åˆ†æ
- **å¯©æŸ¥è€…**ï¼šæ¥­å‹™ç¶“ç†ã€è²¡å‹™ç¶“ç†ã€ç”¢å“ç¶“ç†
- **éœ€è¦æ ¸å‡†**ï¼š
  - [ ] æ¥­å‹™ç¶“ç†ï¼ˆæ¥­å‹™è¦å‰‡ï¼‰
  - [ ] è²¡å‹™ç¶“ç†ï¼ˆç¨…å‹™èˆ‡æœƒè¨ˆï¼‰
  - [ ] ç”¢å“ç¶“ç†ï¼ˆè‡ªå‹•è§¸ç™¼è¦å‰‡ï¼‰
  - [ ] QA ä¸»ç®¡ï¼ˆæ¸¬è©¦å ´æ™¯ï¼‰
  - [ ] æŠ€è¡“ä¸»ç®¡ï¼ˆå¯¦ä½œå¯è¡Œæ€§ï¼‰

## è®Šæ›´æ‘˜è¦

æœ¬æ–‡ä»¶åŸºæ–¼ç¬¬1-3éšæ®µé€²è¡Œçš„å…¨é¢ç¨‹å¼ç¢¼è¿½è¹¤åˆ†æï¼Œå®šç¾© SOM ç³»çµ±é‡å¯«çš„å®Œæ•´å®šåƒ¹ã€ä¿ƒéŠ·èˆ‡ä»˜æ¬¾æµç¨‹é‚è¼¯è¦æ ¼ã€‚

### v1.4 æ–°å¢ç« ç¯€ï¼ˆPhase 3 Week 4ï¼‰

| ç« ç¯€ | å…§å®¹ | ä¾†æºè¿½è¹¤ | è¡Œæ•¸ | ç‹€æ…‹ |
|------|------|---------|------|------|
| 7.1 | ç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥èˆ‡åˆ†é… | ç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥è¿½è¹¤.md | 800+ | âœ… å®Œæ•´ |
| 7.2 | POS èˆ‡ CRM åŒæ­¥æ©Ÿåˆ¶ | POS-CRMåŒæ­¥è¿½è¹¤.md | 1,000+ | âœ… å®Œæ•´ |
| 7.3 | ä»˜æ¬¾æµç¨‹æ¥­å‹™è¦å‰‡ | å…©ä»½è¿½è¹¤ | - | âœ… å®Œæ•´ |

### v1.3 æ–°å¢ç« ç¯€ï¼ˆPhase 2 Week 3ï¼‰

| ç« ç¯€ | å…§å®¹ | ä¾†æºè¿½è¹¤ | è¡Œæ•¸ | ç‹€æ…‹ |
|------|------|---------|------|------|
| 6.1 | ä¿ƒéŠ·äº‹ä»¶å„ªå…ˆç´šèˆ‡æ¬Šå¨ | ä¿ƒéŠ·äº‹ä»¶å„ªå…ˆç´šè¿½è¹¤.md | 1,200 | âœ… å®Œæ•´ |
| 6.2 | LIMIT_QTY æº¢ä½è™•ç†æ¨¡å¼ | ä¿ƒéŠ·æ•¸é‡é™åˆ¶æº¢ä½è™•ç†è¿½è¹¤.md | 1,400 | âš ï¸ ç™¼ç¾éŒ¯èª¤ |
| 6.3 | è·¨é¡ä¿ƒéŠ·ç–ŠåŠ è¦å‰‡ | è·¨é¡ä¿ƒéŠ·ç–ŠåŠ è¦å‰‡è¿½è¹¤.md | 1,800 | âœ… å®Œæ•´ |
| 6.4 | Event A-H å¯¦ä½œç´°ç¯€ | promotion-management/spec.md | 1,900+ | âœ… å®Œæ•´ |

### v1.2 ç« ç¯€ï¼ˆPhase 1 Week 1-2ï¼‰

| ç« ç¯€ | å…§å®¹ | ä¾†æºè¿½è¹¤ | è¡Œæ•¸ | ç‹€æ…‹ |
|------|------|---------|------|------|
| 3.2.4 | Type 2ï¼ˆæˆæœ¬åŠ æˆï¼‰æœƒå“¡æŠ˜æ‰£ | TYPE2-COST-MARKUP-DISCOUNT-TRACE.md | 1,596 | âš ï¸ é—œéµå•é¡Œ |
| 3.2.5 | Type CTï¼ˆç‰¹æ®Šæœƒå“¡æŠ˜æ‰£ï¼‰ | SPECIAL-MEMBER-DISCOUNT-TRACE.md | 1,096 | âœ… å®Œæ•´ |
| 3.3 | å·¥ç¨®åƒ¹æ ¼åˆ†æ”¤ | WORKTYPE-PRICE-APPORTIONMENT-TRACE.md | 892 | âœ… å®Œæ•´ |
| 3.4 | ç¨…é‡‘è¨ˆç®—æ”¿ç­– | ä¸‰ä»½è¿½è¹¤ | - | âš ï¸ ç™¼ç¾ä¸ä¸€è‡´ |

### éœ€è¦è§£æ±ºçš„é—œéµå•é¡Œ

**å®šåƒ¹é‚è¼¯ï¼ˆPhase 1ï¼‰**ï¼š
1. **ğŸš¨ é—œéµ**ï¼šType 2 è² æŠ˜æ‰£ï¼ˆåƒ¹æ ¼ä¸Šæ¼²ï¼‰- éœ€è¦æ±ºç­–
2. **âš ï¸ é«˜**ï¼šç¨…é‡‘å››æ¨äº”å…¥æ”¿ç­–åœ¨æŠ˜æ‰£é¡å‹é–“ä¸ä¸€è‡´
3. **âš ï¸ é«˜**ï¼šç¬¬ 508 è¡Œ Type 2 è¨ˆç®—ä¸­çš„é‡è¤‡è³¦å€¼
4. **âš ï¸ ä¸­**ï¼šé¡åˆ¥æ’é™¤ï¼ˆ025/026ï¼‰ç†ç”±æœªè¨˜éŒ„

**ä¿ƒéŠ·é‚è¼¯ï¼ˆPhase 2ï¼‰**ï¼š
5. **ğŸš¨ é—œéµ**ï¼šEvent A é€€è²¨ç¹é LIMIT_QTY - éœ€è¦ä¿®å¾©
6. **âš ï¸ é«˜**ï¼šEvent A-H å››ç¨®ä¸åŒçš„ LIMIT_QTY è™•ç†æ¨¡å¼ - éœ€è¦æ¨™æº–åŒ–
7. **âš ï¸ é«˜**ï¼šEvent B/D/E NullPointerException é¢¨éšªï¼ˆç„¡ null æª¢æŸ¥ï¼‰
8. **âš ï¸ ä¸­**ï¼šlimitQty=0 è¡Œç‚ºä¸ä¸€è‡´ï¼ˆEvent A è¦–ç‚ºç„¡é™ï¼Œå…¶ä»–è¦–ç‚ºæ‹’çµ•ï¼‰

### è¦†è“‹ç‡å½±éŸ¿

- **ä¹‹å‰**ï¼š87%ï¼ˆ112 æ¢è¦å‰‡ï¼Œ97 æ¢å·²è¨˜éŒ„ï¼‰
- **v1.4 ä¹‹å¾Œ**ï¼šé è¨ˆ 98%+ï¼ˆ112 æ¢è¦å‰‡ï¼Œ112 æ¢å·²è¨˜éŒ„ï¼‰
- **ç¸®å°å·®è·**ï¼š
  - Phase 1: æ–°è¨˜éŒ„ 27 æ¢å®šåƒ¹è¦å‰‡ï¼ˆMBR-R1-R12, APP-R1-R6, TAX-R1-R7ï¼‰
  - Phase 2: æ–°è¨˜éŒ„ 40 æ¢ä¿ƒéŠ·è¦å‰‡ï¼ˆPROMO-R1-R4, LIMIT-R1-R5, STACK-R1-R7, EVENT-R1-R12ï¼‰
  - Phase 3: æ–°è¨˜éŒ„ 28 æ¢ä»˜æ¬¾è¦å‰‡ï¼ˆINV-R1-R15, POS-R1-R6, CRM-R1-R7ï¼‰
  - **ç¸½è¨ˆ**ï¼š95 æ¢æ–°æ¥­å‹™è¦å‰‡å®Œæ•´è¨˜éŒ„

---

## ç›®éŒ„

1. [åŸ·è¡Œæ¦‚è¦](#1-åŸ·è¡Œæ¦‚è¦)
2. [å®šåƒ¹é‚è¼¯æ¦‚è¦½](#2-å®šåƒ¹é‚è¼¯æ¦‚è¦½)
3. [æœƒå“¡æŠ˜æ‰£é‚è¼¯](#3-æœƒå“¡æŠ˜æ‰£é‚è¼¯)
4. [å·¥ç¨®åƒ¹æ ¼åˆ†æ”¤](#4-å·¥ç¨®åƒ¹æ ¼åˆ†æ”¤)
5. [ç¨…é‡‘è¨ˆç®—æ”¿ç­–](#5-ç¨…é‡‘è¨ˆç®—æ”¿ç­–)
6. [ä¿ƒéŠ·é‚è¼¯](#6-ä¿ƒéŠ·é‚è¼¯)
7. [ä»˜æ¬¾æµç¨‹](#7-ä»˜æ¬¾æµç¨‹)
8. [è³‡æ–™åº«æ¶æ§‹](#8-è³‡æ–™åº«æ¶æ§‹)
9. [æ¸¬è©¦å ´æ™¯](#9-æ¸¬è©¦å ´æ™¯)
10. [å¯¦ä½œæŒ‡å¼•](#10-å¯¦ä½œæŒ‡å¼•)
11. [å¾…è§£æ±ºå•é¡Œèˆ‡éœ€è¦çš„æ±ºç­–](#11-å¾…è§£æ±ºå•é¡Œèˆ‡éœ€è¦çš„æ±ºç­–)

---

## 1. åŸ·è¡Œæ¦‚è¦

### ç›®çš„

æœ¬è¦æ ¼å®šç¾© SOMï¼ˆé–€å¸‚ç‡Ÿé‹ç®¡ç†ï¼‰ç³»çµ±é‡å¯«çš„å®Œæ•´å®šåƒ¹é‚è¼¯ï¼Œé‡é»åœ¨æ–¼ï¼š
- æœƒå“¡æŠ˜æ‰£è¨ˆç®—ï¼ˆ4 ç¨®é¡å‹ï¼š0ã€1ã€2ã€CTï¼‰
- å·¥ç¨®åƒ¹æ ¼åˆ†æ”¤ï¼ˆå®‰è£/é‹é€ï¼‰
- ç¨…é‡‘è¨ˆç®—æ”¿ç­–
- è‡ªå‹•è§¸ç™¼è¦å‰‡å’ŒåŸ·è¡Œé †åº

### é—œéµåŸå‰‡

1. **æœƒå“¡å„ªå…ˆå®šåƒ¹**ï¼šæ‰€æœ‰æŠ˜æ‰£é‚è¼¯å„ªå…ˆè€ƒæ…®æœƒå“¡åˆ©ç›Š
2. **é€æ˜åº¦**ï¼šåƒ¹æ ¼è¨ˆç®—å¿…é ˆå¯ç¨½æ ¸å’Œå¯è§£é‡‹
3. **ä¸€è‡´æ€§**ï¼šç¨…é‡‘å’Œå››æ¨äº”å…¥æ”¿ç­–æ‡‰åœ¨æŠ˜æ‰£é¡å‹é–“ä¿æŒä¸€è‡´
4. **è³‡æ–™å®Œæ•´æ€§**ï¼šæˆæœ¬è³‡æ–™ï¼ˆunitCostï¼‰ä½¿ç”¨å‰å¿…é ˆé©—è­‰

### ç¯„åœ

**ç¯„åœå…§**ï¼š
- æœƒå“¡æŠ˜æ‰£é¡å‹ 0ã€1ã€2ã€CT
- å·¥ç¨®ï¼ˆå®‰è£/é‹é€ï¼‰åƒ¹æ ¼åˆ†æ”¤
- æŠ˜æ‰£çš„ç¨…é‡‘è¨ˆç®—
- è‡ªå‹•è§¸ç™¼è¦å‰‡å’Œäº’æ–¥
- åŸºæ–¼é¡åˆ¥çš„æ’é™¤
- å…©éšæ®µåŒ¹é…ï¼ˆç²¾ç¢º SKU â†’ è¬ç”¨å­—å…ƒï¼‰

**ç¯„åœå¤–**ï¼ˆåœ¨å–®ç¨ç« ç¯€æ¶µè“‹ï¼‰ï¼š
- è¨‚å–®ç‹€æ…‹æ©Ÿï¼ˆç¬¬4éšæ®µï¼‰
- è¨‚å–®ä½œå»¢é€£é–åæ‡‰ï¼ˆç¬¬4éšæ®µï¼‰
- æ–°åŠŸèƒ½é¢¨éšªè©•ä¼°ï¼ˆç¬¬5éšæ®µï¼‰

---

## 2. å®šåƒ¹é‚è¼¯æ¦‚è¦½

### 2.1 åŸ·è¡Œé †åº

```mermaid
graph TD
    A[è¨‚å–®å»ºç«‹] --> B[è¼‰å…¥å–®ä½æˆæœ¬]
    B --> C[æ‡‰ç”¨ä¿ƒéŠ·]
    C --> D[æ‡‰ç”¨æœƒå“¡æŠ˜æ‰£]
    D --> E{Type 0/1/2<br/>åŒ¹é…?}
    E -->|æ˜¯| F[åŸ·è¡Œ Type 0/1/2]
    E -->|å¦| G[åŸ·è¡Œ Type CT]
    F --> H[åˆ†æ”¤å·¥ç¨®åƒ¹æ ¼]
    G --> H
    H --> I[è¨ˆç®—ç¨…é‡‘]
    I --> J[è¨ˆç®—è¨‚å–®ç¸½é¡]
    J --> K[å„²å­˜åˆ°è³‡æ–™åº«]
```

### 2.2 åƒ¹æ ¼è¨ˆç®—çµ„æˆ

| çµ„æˆ | æ™‚æ©Ÿ | ç›®çš„ | ç¯„ä¾‹ |
|-----|------|-----|------|
| **å–®ä½æˆæœ¬** | è¨‚å–®å»ºç«‹ | Type 2 çš„æˆæœ¬åŸºæº– | TBL_SKU_STORE.AVG_COST |
| **POS é‡‘é¡** | è¨‚å–®å»ºç«‹ | æ­£å¸¸å”®åƒ¹ | 100 TWD |
| **ä¿ƒéŠ·æŠ˜æ‰£** | æœƒå“¡æŠ˜æ‰£å‰ | åŸºæ–¼æ´»å‹•çš„æŠ˜æ‰£ | -10 TWD |
| **æœƒå“¡æŠ˜æ‰£** | ä¿ƒéŠ·å¾Œ | æœƒå“¡å„ªæƒ  | -15 TWD |
| **å·¥ç¨®åˆ†æ”¤** | æœƒå“¡æŠ˜æ‰£å¾Œ | å®‰è£/é‹é€åˆ†æ”¤ | +20 TWD å®‰è£ |
| **ç‡Ÿæ¥­ç¨…** | æœ€çµ‚è¨ˆç®— | æ‡‰ç¨…é …ç›®ï¼ˆ1.05ï¼‰ | +5 TWD ç¨… |
| **è¨‚å–®ç¸½é¡** | æœ€çµ‚ | æ‰€æœ‰é …ç›®ç¸½å’Œ | 100 TWD |

### 2.3 åƒ¹æ ¼è®Šæ›´æ——æ¨™

åƒ¹æ ¼è®Šæ›´æ——æ¨™é˜²æ­¢åŒä¸€é …ç›®çš„å¤šæ¬¡åƒ¹æ ¼ä¿®æ”¹ï¼š

```java
// ä¸€æ—¦è¨­ç‚º trueï¼Œé …ç›®è¢«æ’é™¤åœ¨é€²ä¸€æ­¥æŠ˜æ‰£ä¹‹å¤–
orderDetlVO.setPosAmtChangePrice(true);      // ç”¢å“åƒ¹æ ¼å·²è®Šæ›´
orderDetlVO.setInstallChangePrice(true);     // å®‰è£åƒ¹æ ¼å·²è®Šæ›´
orderDetlVO.setDeliveryChangePrice(true);    // é‹é€åƒ¹æ ¼å·²è®Šæ›´
```

**å½±éŸ¿**ï¼š
- Type 1 å’Œ Type 2 è¨­å®šåƒ¹æ ¼è®Šæ›´æ——æ¨™
- Type 0 ä¸è¨­å®šæ——æ¨™ï¼ˆæ‡‰ç”¨æŠ˜æ‰£é‡‘é¡ï¼‰
- æœ‰æ——æ¨™çš„é …ç›®è¢«æ’é™¤åœ¨å¾ŒçºŒæŠ˜æ‰£è¨ˆç®—ä¹‹å¤–

---

## 3. æœƒå“¡æŠ˜æ‰£é‚è¼¯

### 3.1 æ¦‚è¦½èˆ‡åŸ·è¡Œæµç¨‹

#### 3.1.1 æœƒå“¡æŠ˜æ‰£é¡å‹

| é¡å‹ | åç¨± | è¨ˆç®—åŸºæº– | åƒ¹æ ¼è®Šæ›´ | é¡åˆ¥æ’é™¤ |
|------|------|---------|---------|---------|
| **0** | æŠ˜æ‰£ | å”®åƒ¹ | å¦ | ç„¡ |
| **1** | é™æ¯›åˆ© | å”®åƒ¹ | æ˜¯ | 025ã€026 |
| **2** | æˆæœ¬åŠ æˆ | **å–®ä½æˆæœ¬** | æ˜¯ | 025ã€026 |
| **CT** | ç‰¹æ®ŠæŠ˜æ‰£ | å”®åƒ¹ | å¦ | ç„¡ |

#### 3.1.2 åŸ·è¡Œå„ªå…ˆç´š

```java
// BzSoServices.java:4459-4466
//æœƒå“¡æŠ˜æ‰£-Discounting (Type 0)
memberDiscSkus.addAll(soComputeFunctionMemberDis(..., "0", ...));
//æœƒå“¡æŠ˜æ‰£-Down Margin (Type 1)
memberDiscSkus.addAll(soComputeFunctionMemberDis(..., "1", ...));
//æœƒå“¡æŠ˜æ‰£-Cost Markup (Type 2)
memberDiscSkus.addAll(soComputeFunctionMemberDis(..., "2", ...));

if(memberDiscSkus.isEmpty()) {
    //ç‰¹æ®Šæœƒå“¡æŠ˜æ‰£ï¼ˆå¦‚æœä»¥ä¸Šå…¨éƒ¨è¿”å›ç©ºå‰‡å›é€€ï¼‰
    memberDiscSkus.addAll(soComputeMemberDisForSpecial(...));
}
```

**é—œéµè¦å‰‡**ï¼š
1. Type 0ã€1ã€2 ä¾åºåŸ·è¡Œ
2. Type CT **åƒ…**åœ¨ Type 0/1/2 **å…¨éƒ¨è¿”å›ç©º**æ™‚åŸ·è¡Œ
3. å¦‚æœ**ä»»ä½•**é …ç›®åŒ¹é… Type 0/1/2ï¼Œ**æ‰€æœ‰**é …ç›®è·³é Type CTï¼ˆäº’æ–¥ï¼‰

---

### 3.2 æŠ˜æ‰£é¡å‹

### 3.2.1 Type 0ï¼šæŠ˜æ‰£

**æè¿°**ï¼šæ‡‰ç”¨æ–¼å”®åƒ¹çš„ç™¾åˆ†æ¯”æŠ˜æ‰£ï¼Œè¨ˆç®—ç‚ºå–®ç¨çš„æŠ˜æ‰£é‡‘é¡ï¼ˆä¸ç›´æ¥è®Šæ›´åƒ¹æ ¼ï¼‰ã€‚

**è¨ˆç®—å…¬å¼**ï¼š
```java
// åŸºç¤åƒ¹æ ¼é¸æ“‡
if (GoodsType.P) {
    price = openPrice ? actPosAmt : posAmt;
} else if (InstallSku) {
    price = installPrice;
} else if (DeliverySku) {
    price = deliveryPrice;
}

// åŠ å›ä¿ƒéŠ·æŠ˜æ‰£
totalPrice = price + (bonusTotal / qty) + (promotionDiscount / qty);

// è¨ˆç®—æŠ˜æ‰£é‡‘é¡ï¼ˆç„¡æ¢ä»¶é€²ä½ï¼‰
discountPerUnit = ceil(totalPrice * discountPercent);
totalDiscount = discountPerUnit * qty;

// æ³¨æ„ï¼šåƒ¹æ ¼ä¸è®Šæ›´ï¼ŒæŠ˜æ‰£å–®ç¨å„²å­˜
memberDiscVO.setDiscAmt(totalDiscount);
```

**ç‰¹å¾µ**ï¼š
- âœ… é©ç”¨æ–¼æ‰€æœ‰é¡åˆ¥ï¼ˆç„¡æ’é™¤ï¼‰
- âœ… è¨ˆç®—å‰åŠ å›ä¿ƒéŠ·é‡‘é¡
- âœ… æŠ˜æ‰£é‡‘é¡ä½¿ç”¨ Math.ceilï¼ˆç„¡æ¢ä»¶é€²ä½ï¼‰
- âœ… ä¸è¨­å®šåƒ¹æ ¼è®Šæ›´æ——æ¨™
- âœ… åŒ…å«åœ¨å…ç¨…æœƒå“¡æŠ˜æ‰£ç¸½é¡è¨ˆç®—ä¸­

---

### 3.2.2 Type 1ï¼šé™æ¯›åˆ©

**æè¿°**ï¼šç™¾åˆ†æ¯”æŠ˜æ‰£**ç›´æ¥é™ä½å”®åƒ¹**ï¼ˆåƒ¹æ ¼è®Šæ›´ï¼Œéå–®ç¨æŠ˜æ‰£ï¼‰ã€‚

**è¨ˆç®—å…¬å¼**ï¼š
```java
// åŸºç¤åƒ¹æ ¼é¸æ“‡
if (GoodsType.P) {
    price = actPosAmt;
} // ... å®‰è£/é‹é€é¡ä¼¼

// åŠ å›ä¿ƒéŠ·æŠ˜æ‰£ï¼ˆæ¯å–®ä½ç„¡æ¢ä»¶æ¨å»ï¼‰
priceWithPromotion = price + floor(promotionDiscount / qty);

// è¨ˆç®—æŠ˜æ‰£ï¼ˆç„¡æ¢ä»¶é€²ä½ï¼‰
discountPerUnit = ceil(priceWithPromotion * discountPercent);

// æ–°åƒ¹æ ¼ï¼ˆæŠ˜æ‰£å¾Œé™ä½ï¼‰
newPrice = price - discountPerUnit;

// æ›´æ–°åƒ¹æ ¼ä¸¦è¨­å®šæ——æ¨™
actPosAmt = newPrice;
posAmtChangePrice = true;
```

**ç‰¹å¾µ**ï¼š
- âš ï¸ **é¡åˆ¥æ’é™¤**ï¼šSUB_DEPT_ID 025ã€026 æ’é™¤
- âœ… åŠ å›ä¿ƒéŠ·é‡‘é¡ï¼ˆæ¯å–®ä½ç„¡æ¢ä»¶æ¨å»ï¼‰
- âœ… æŠ˜æ‰£è¨ˆç®—ä½¿ç”¨ Math.ceilï¼ˆç„¡æ¢ä»¶é€²ä½ï¼‰
- âœ… **è¨­å®šåƒ¹æ ¼è®Šæ›´æ——æ¨™**ï¼ˆé˜²æ­¢é€²ä¸€æ­¥æŠ˜æ‰£ï¼‰
- âœ… åŒ…å«åœ¨å…ç¨…æœƒå“¡æŠ˜æ‰£ç¸½é¡è¨ˆç®—ä¸­

**é¡åˆ¥æ’é™¤é‚è¼¯**ï¼š
```java
// SoFunctionMemberDisServices.java:533-539
private boolean checkSkuSubDeptId(String discType, OrderDetlVO item) {
    if(("2".equals(discType) || "1".equals(discType)) &&
       ("025".equals(item.getSubDeptId()) || "026".equals(item.getSubDeptId()))) {
        return true;  // å¾ Type 1/2 æ’é™¤
    }
    return false;
}
```

---

### 3.2.3 Type 2ï¼šæˆæœ¬åŠ æˆ â­ æ–°å¢

**æè¿°**ï¼š**åŸºæ–¼æˆæœ¬çš„å®šåƒ¹**ï¼Œä½¿ç”¨å–®ä½æˆæœ¬å’ŒåŠ æˆç™¾åˆ†æ¯”è¨ˆç®—æ–°å”®åƒ¹ï¼ˆèˆ‡ Type 0/1 æ ¹æœ¬ä¸åŒï¼‰ã€‚

#### é—œéµå·®ç•°
- ä½¿ç”¨ **unitCost** è€Œéå”®åƒ¹
- è¨ˆç®— **æ–°åƒ¹æ ¼** = æˆæœ¬ Ã— (1 + åŠ æˆ)
- åŠ æˆ**å¾Œ**æ‡‰ç”¨ç¨…é‡‘ï¼ˆéä¹‹å‰ï¼‰
- ç¨…é‡‘ä½¿ç”¨ **ROUND_FLOOR**ï¼ˆèˆ‡ Type 0/1 ä¸åŒï¼‰
- æ’é™¤é¡åˆ¥ 025/026

#### å–®ä½æˆæœ¬ä¾†æº

**è³‡æ–™æµ**ï¼š
```mermaid
graph LR
    A[TBL_SKU_STORE<br/>AVG_COST] --> B[SkuInfoVO<br/>avgCost]
    B --> C[å‰ç«¯<br/>lstSkuInfo.unitCost]
    C --> D[OrderDetlVO<br/>unitCost]
    D --> E[TBL_ORDER_DETL<br/>UNIT_COST]
    E --> F[Type 2<br/>è¨ˆç®—]
```

#### è¨ˆç®—å…¬å¼

```java
// SoFunctionMemberDisServices.java:473-511
double unitCost = parseDouble(orderDetlVO.getUnitCost());
double discPer = parseDouble(memberDiscVO.getDiscPer()) / 100.0;

// æ­¥é©Ÿ 1ï¼šè¨ˆç®—åŠ æˆåƒ¹æ ¼ï¼ˆç„¡æ¢ä»¶é€²ä½ï¼‰
int markupPrice = (int)Math.ceil(unitCost * (1 + discPer));

// æ­¥é©Ÿ 2ï¼šå¦‚æœæ‡‰ç¨…ï¼Œæ‡‰ç”¨ç‡Ÿæ¥­ç¨…ï¼ˆç„¡æ¢ä»¶æ¨å»ï¼‰
int finalPrice = markupPrice;
if(!taxZero && SKU_TAX_TYPE_1.equals(orderDetlVO.getTaxType())) {
    // 2020-05-07 è®Šæ›´ï¼šROUND_HALF_UP â†’ ROUND_FLOOR
    finalPrice = new BigDecimal((double)markupPrice * salesTax)
        .setScale(0, BigDecimal.ROUND_FLOOR).intValue();
}

// æ­¥é©Ÿ 3ï¼šæ ¹æ“šå•†å“é¡å‹æ›´æ–°åƒ¹æ ¼ä¸¦è¨­å®šæ——æ¨™
if(GoodsType.P.equals(orderDetlVO.getGoodsType())) {
    orderDetlVO.setActPosAmt(finalPrice);
    orderDetlVO.setPosAmtChangePrice(true);
} // ... å®‰è£/é‹é€é¡ä¼¼

// æ­¥é©Ÿ 4ï¼šè¨ˆç®—ã€ŒæŠ˜æ‰£ã€ï¼ˆå¯èƒ½ç‚ºè² ï¼ï¼‰
int discountAmt = originalPosAmt - finalPrice;
memberDiscVO.setDiscAmt(discountAmt);
```

#### ğŸš¨ é—œéµå•é¡Œï¼šè² æŠ˜æ‰£

**å•é¡Œ**ï¼šType 2 å¯èƒ½å°è‡´**åƒ¹æ ¼ä¸Šæ¼²**è€ŒéæŠ˜æ‰£ã€‚

**ç¯„ä¾‹å ´æ™¯**ï¼š
```
SKUï¼šABC-123
å–®ä½æˆæœ¬ï¼š90 TWD
åŸå§‹ POS åƒ¹æ ¼ï¼š100 TWD
åŠ æˆç‡ï¼š30%
ç¨…ï¼š1.05

è¨ˆç®—ï¼š
  markupPrice = ceil(90 Ã— 1.3) = 117 TWD
  finalPrice = floor(117 Ã— 1.05) = 122 TWD
  discountAmt = 100 - 122 = -22 TWD âŒ

çµæœï¼šæœƒå“¡æ”¯ä»˜ 122 TWD è€Œé 100 TWDï¼ˆå¤šä»˜ 22%ï¼ï¼‰
```

**æ¥­å‹™å½±éŸ¿**ï¼š
- âŒ å®¢æˆ¶ä¸æ»¿ï¼ˆæœŸå¾…æŠ˜æ‰£ï¼Œå¾—åˆ°æ¼²åƒ¹ï¼‰
- âŒ æ³•å¾‹é¢¨éšªï¼ˆè™›å‡å»£å‘Šï¼‰
- âŒ å“ç‰Œæå®³ï¼ˆä¿¡ä»»ä¾µè•ï¼‰

**âš ï¸ éœ€è¦æ±ºç­– - é¸æ“‡ä¸€å€‹æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ Aï¼šé˜²æ­¢è² æŠ˜æ‰£ï¼ˆæ¨è–¦ï¼‰**
```java
if(finalPrice > originalPosAmt) {
    logger.warn("æˆæœ¬åŠ æˆæœƒå°è‡´åƒ¹æ ¼ä¸Šæ¼²ï¼Œè·³éæŠ˜æ‰£");
    return;  // è·³éæ­¤æŠ˜æ‰£ï¼Œé …ç›®ä¿æŒåŸåƒ¹
}
```

**æ–¹æ¡ˆ Bï¼šé™åˆ¶åœ¨åŸåƒ¹**
```java
if(finalPrice > originalPosAmt) {
    finalPrice = originalPosAmt;  // ç„¡æŠ˜æ‰£ï¼Œç„¡æ¼²åƒ¹
}
```

**æ–¹æ¡ˆ Cï¼šå…è¨±è² æŠ˜æ‰£ï¼ˆç•¶å‰ï¼‰**
```java
// ä¸è®Šæ›´ - ç¹¼çºŒå…è¨±åƒ¹æ ¼ä¸Šæ¼²
```

**æŠ€è¡“åœ˜éšŠæ¨è–¦**ï¼šæ–¹æ¡ˆ A

#### ç¨…é‡‘è™•ç†

**ç¨…é‡‘å››æ¨äº”å…¥æ”¿ç­–**ï¼ˆ2020-05-07 è®Šæ›´ï¼‰ï¼š

| æ—¥æœŸ | æ–¹æ³• | ç¯„ä¾‹ï¼ˆ60.9 TWDï¼‰ | ç†ç”± |
|-----|------|-----------------|------|
| 2020-05-07 å‰ | ROUND_HALF_UP | 61 TWD | å‚³çµ± |
| 2020-05-07 å¾Œ | **ROUND_FLOOR** | **60 TWD** | å°å®¢æˆ¶å‹å–„ |

#### ç‰¹å¾µæ‘˜è¦

| ç‰¹å¾µ | Type 2 è¡Œç‚º |
|-----|------------|
| **è¨ˆç®—åŸºæº–** | å–®ä½æˆæœ¬ï¼ˆTBL_SKU_STORE.AVG_COSTï¼‰ |
| **å…¬å¼** | ceil(unitCost Ã— (1 + markup)) |
| **ç¨…é‡‘å››æ¨äº”å…¥** | ROUND_FLOORï¼ˆè‡ª 2020-05-07 èµ·ï¼‰ |
| **åƒ¹æ ¼è®Šæ›´** | æ˜¯ï¼ˆè¨­å®šè®Šæ›´æ——æ¨™ï¼‰ |
| **é¡åˆ¥æ’é™¤** | 025ã€026 |
| **ä¿ƒéŠ·è™•ç†** | ç„¡ä¿ƒéŠ·åŠ å› |
| **è² æŠ˜æ‰£** | âš ï¸ å¯èƒ½ï¼ˆéœ€è¦ä¿®å¾©ï¼‰ |
| **å…ç¨…ç¸½é¡** | æ’é™¤ï¼ˆåƒ¹æ ¼è®Šæ›´ï¼ŒéæŠ˜æ‰£ï¼‰ |

---

### 3.2.4 Type CTï¼šç‰¹æ®Šæœƒå“¡æŠ˜æ‰£ â­ æ–°å¢

**æè¿°**ï¼šå›é€€æœƒå“¡æŠ˜æ‰£ï¼Œ**åƒ…åœ¨ Type 0/1/2 å…¨éƒ¨è¿”å›ç©ºçµæœæ™‚åŸ·è¡Œ**ï¼ˆäº’æ–¥ï¼‰ã€‚

#### é—œéµç‰¹å¾µ
- **å›é€€æ©Ÿåˆ¶**ï¼šåƒ…ç•¶ Type 0/1/2 å¤±æ•—æ™‚
- **å…©éšæ®µåŒ¹é…**ï¼šç²¾ç¢º SKU â†’ é¡åˆ¥è¬ç”¨å­—å…ƒ
- **è¬ç”¨å­—å…ƒæ¨¡å¼**ï¼šSKU_NO = '000000000'
- **ä½¿ç”¨ Math.ceil**ï¼šèˆ‡ Type 0 ç›¸åŒçš„å››æ¨äº”å…¥
- **ç„¡é¡åˆ¥æ’é™¤**ï¼šé©ç”¨æ–¼æ‰€æœ‰é¡åˆ¥
- **ä¿ƒéŠ·åŠ å›**ï¼šè¨ˆç®—å‰åŠ å›ä¿ƒéŠ·é‡‘é¡

#### åŸ·è¡Œæ¢ä»¶

```java
// BzSoServices.java:4459-4466
if(memberDiscSkus.isEmpty()) {  // åƒ…ç•¶ä»¥ä¸Šå…¨éƒ¨è¿”å›ç©º
    //ç‰¹æ®Šæœƒå“¡æŠ˜æ‰£
    memberDiscSkus.addAll(soComputeMemberDisForSpecial(...));
}
```

**äº’æ–¥è¡Œç‚º**ï¼š
- å¦‚æœè¨‚å–®ä¸­**ä»»ä½•é …ç›®**åŒ¹é… Type 0/1/2ï¼Œ**æ‰€æœ‰é …ç›®**è·³é Type CT
- ç¯„ä¾‹ï¼šè¨‚å–®æœ‰ 10 å€‹é …ç›®ï¼Œ1 å€‹åŒ¹é… Type 0 â†’ æ‰€æœ‰ 10 å€‹é …ç›®è·³é Type CT

**âš ï¸ æ¥­å‹™ç¢ºèª**ï¼šã€Œå…¨æœ‰æˆ–å…¨ç„¡ã€è¡Œç‚ºæ˜¯å¦æœ‰æ„ç‚ºä¹‹ï¼Ÿ

#### å…©éšæ®µåŒ¹é…æ¼”ç®—æ³•

**éšæ®µ 1ï¼šç²¾ç¢º SKU åŒ¹é…**
```java
cgroupCriteria.createCriteria()
    .andSkuNoIn(allSkus)  // ç²¾ç¢ºåŒ¹é…
    .andStartDateLessThanOrEqualTo(dateNow)
    .andEndDateGreaterThanOrEqualTo(dateNow);
```

**éšæ®µ 2ï¼šé¡åˆ¥è¬ç”¨å­—å…ƒåŒ¹é…**ï¼ˆæœªåŒ¹é…é …ç›®ï¼‰
```java
cgroupCriteria.createCriteria()
    .andSkuNoEqualTo("000000000")  // â­ è¬ç”¨å­—å…ƒæ¨¡å¼
    .andClassIdEqualTo(orderDetlVO.getClassId())
    .andSubDeptIdEqualTo(orderDetlVO.getSubDeptId())
    .andSubClassIdEqualTo(orderDetlVO.getSubClassId())
    .andStartDateLessThanOrEqualTo(dateNow)
    .andEndDateGreaterThanOrEqualTo(dateNow);
```

**è¬ç”¨å­—å…ƒæ…£ä¾‹**ï¼š`SKU_NO = '000000000'` ä»£è¡¨é¡åˆ¥ç´šæŠ˜æ‰£
- åŒ¹é…é¡åˆ¥ä¸­çš„æ‰€æœ‰ SKUï¼ˆCLASS_ID + SUB_DEPT_ID + SUB_CLASS_IDï¼‰
- æ•´å€‹ç³»çµ±ä½¿ç”¨çš„æ¨™æº–æ¨¡å¼

#### è¨ˆç®—å…¬å¼

```java
// åŸºç¤åƒ¹æ ¼é¸æ“‡ï¼ˆèˆ‡ Type 0 ç›¸åŒï¼‰
price = ... // posAmt æˆ– actPosAmt

// åŠ å›ä¿ƒéŠ·æŠ˜æ‰£
price += discountAmt;

// è¨ˆç®—æŠ˜æ‰£ï¼ˆç„¡æ¢ä»¶é€²ä½ï¼‰
int discount = (int)Math.ceil(price * discPer);

// è¨­å®šæŠ˜æ‰£é‡‘é¡ï¼ˆä¸è®Šæ›´åƒ¹æ ¼ï¼‰
memberDiscVO.setDiscAmt(discount * qty);
```

#### ç‰¹å¾µæ‘˜è¦

| ç‰¹å¾µ | Type CT è¡Œç‚º |
|-----|-------------|
| **åŸ·è¡Œæ¢ä»¶** | åƒ…ç•¶ Type 0/1/2 å…¨éƒ¨è¿”å›ç©º |
| **äº’æ–¥** | å¦‚æœä»»ä½•é …ç›®ç²å¾— Type 0/1/2ï¼Œæ‰€æœ‰é …ç›®è·³é CT |
| **è¨ˆç®—åŸºæº–** | å”®åƒ¹ï¼ˆå¦‚ Type 0ï¼‰ |
| **å…¬å¼** | ceil(price Ã— discountPercent) |
| **å››æ¨äº”å…¥** | Math.ceilï¼ˆç„¡æ¢ä»¶é€²ä½ï¼‰ |
| **åƒ¹æ ¼è®Šæ›´** | å¦ï¼ˆå–®ç¨å„²å­˜æŠ˜æ‰£ï¼‰ |
| **é¡åˆ¥æ’é™¤** | ç„¡ï¼ˆé©ç”¨æ–¼æ‰€æœ‰é¡åˆ¥ï¼‰ |
| **ä¿ƒéŠ·è™•ç†** | åŠ å›ä¿ƒéŠ·é‡‘é¡ |
| **åŒ¹é…æ¼”ç®—æ³•** | å…©éšæ®µï¼šç²¾ç¢º SKU â†’ è¬ç”¨å­—å…ƒ '000000000' |

---

### 3.3 æœƒå“¡æŠ˜æ‰£æ¥­å‹™è¦å‰‡

| è¦å‰‡ ID | æè¿° | å„ªå…ˆç´š | å¯¦ä½œ |
|---------|-----|--------|------|
| **MBR-R1** | Type 0/1/2 ä¾åºåŸ·è¡Œï¼ŒType CT åƒ…ç•¶å…¨éƒ¨ç‚ºç©º | é—œéµ | BzSoServices:4459-4466 |
| **MBR-R2** | å¦‚æœä»»ä½•é …ç›®ç²å¾— Type 0/1/2ï¼Œæ‰€æœ‰é …ç›®è·³é Type CT | é—œéµ | BzSoServices:4464-4466 |
| **MBR-R3** | é¡åˆ¥ 025/026 å¾ Type 1/2 æ’é™¤ | é—œéµ | SoFunctionMemberDisServices:533-539 |
| **MBR-R4** | å…©éšæ®µåŒ¹é…ï¼šç²¾ç¢º SKU â†’ è¬ç”¨å­—å…ƒ '000000000' | é«˜ | SoFunctionMemberDisServices:293-360 |
| **MBR-R5** | Type 2 ä½¿ç”¨ TBL_SKU_STORE.AVG_COST ä½œç‚º unitCost ä¾†æº | é«˜ | TblSkuStore.java:45 |
| **MBR-R6** | Type 2 è² æŠ˜æ‰£å¿…é ˆé˜²æ­¢ | é—œéµ | **âš ï¸ éœ€è¦ä¿®å¾©** |
| **MBR-R7** | é–‹åƒ¹ç”¢å“ï¼ˆ025/026/027 é™¤å¤–ï¼‰æœ‰ unitCost=0 | ä¸­ | BzSoServices:914-917 |
| **MBR-R8** | Type 0/CT è¨ˆç®—å‰åŠ å›ä¿ƒéŠ·é‡‘é¡ | é«˜ | ç¬¬ 428ã€213 è¡Œ |
| **MBR-R9** | Type 1/2 è¨­å®šåƒ¹æ ¼è®Šæ›´æ——æ¨™ï¼ŒType 0/CT ä¸è¨­å®š | é«˜ | ç¬¬ 453ã€496 è¡Œ |
| **MBR-R10** | Type 2 å¾å…ç¨…æœƒå“¡æŠ˜æ‰£ç¸½é¡ä¸­æ’é™¤ | ä¸­ | SoFunctionMemberDisServices:602-610 |
| **MBR-R11** | ç¨…é‡‘å››æ¨äº”å…¥ï¼šType 0/1/CT ä½¿ç”¨ ceilï¼ŒType 2 ä½¿ç”¨ floor | ä¸­ | **âš ï¸ ä¸ä¸€è‡´** |
| **MBR-R12** | æœ‰åƒ¹æ ¼è®Šæ›´æ——æ¨™çš„é …ç›®æ’é™¤åœ¨é€²ä¸€æ­¥æŠ˜æ‰£ä¹‹å¤– | é«˜ | ç¬¬ 280-284 è¡Œ |

---

## 4. å·¥ç¨®åƒ¹æ ¼åˆ†æ”¤ â­ æ–°å¢

### 4.1 æ¦‚è¦½

**ç›®çš„**ï¼šæ ¹æ“šé …ç›®åƒ¹å€¼æŒ‰æ¯”ä¾‹å°‡å®‰è£å’Œé‹é€å·¥ç¨®åƒ¹æ ¼åˆ†é…çµ¦è¨‚è³¼é …ç›®ã€‚

**æ™‚æ©Ÿ**ï¼šåœ¨æœƒå“¡æŠ˜æ‰£**ä¹‹å¾Œ**ã€è¨‚å–®ç¸½é¡è¨ˆç®—**ä¹‹å‰**åŸ·è¡Œã€‚

**é©ç”¨æ–¼**ï¼š
- å®‰è£å·¥ç¨®ï¼ˆå®‰è£å·¥ç¨®ï¼‰
- é‹é€å·¥ç¨®ï¼ˆé‹é€å·¥ç¨®ï¼‰

### 4.2 åˆ†æ”¤æ¼”ç®—æ³•

#### æ¯”ä¾‹åˆ†é…å…¬å¼

```java
// BzSoServices.java:4619-4681
public void apportionmentDiscount(
    ArrayList<OrderDetlVO> items,
    ArrayList<OrderDetlVO> workTypes) {

    // æ­¥é©Ÿ 1ï¼šè¨ˆç®—è¨‚å–®ç¸½é¡ï¼ˆæ¯”ä¾‹åŸºæº–ï¼‰
    int orderTotal = 0;
    for (OrderDetlVO item : items) {
        if(isProductSku(item.getGoodsType())) {
            orderTotal += parseInt(item.getTotalPrice());
        }
    }

    // æ­¥é©Ÿ 2ï¼šå°æ¯å€‹å·¥ç¨®ï¼ˆå®‰è£/é‹é€ï¼‰
    for (OrderDetlVO workType : workTypes) {
        int workTypeTotal = parseInt(workType.getActualAmount());

        // ç‰¹æ®Šæƒ…æ³ï¼šå…è²»å·¥ç¨®ï¼ˆactualAmount = 0ï¼‰
        if(workTypeTotal == 0) {
            for (OrderDetlVO item : items) {
                item.setPreApportion("0");  // æ‰€æœ‰é …ç›®ç²å¾— 0
            }
            continue;
        }

        // æ­¥é©Ÿ 3ï¼šè¨ˆç®—æ¯å€‹é …ç›®çš„æ¯”ä¾‹
        int apportionedTotal = 0;
        OrderDetlVO lastItem = null;

        for (OrderDetlVO item : items) {
            if(isProductSku(item.getGoodsType())) {
                int itemTotal = parseInt(item.getTotalPrice());

                // æ¯”ä¾‹è¨ˆç®—
                double proportion = (double)itemTotal / (double)orderTotal;
                int apportionedAmt = (int)(workTypeTotal * proportion);

                item.setPreApportion(apportionedAmt + "");
                apportionedTotal += apportionedAmt;
                lastItem = item;  // è¿½è¹¤æœ€å¾Œé …ç›®
            }
        }

        // æ­¥é©Ÿ 4ï¼šæœ€å¾Œé …ç›®å¸æ”¶é¤˜é¡
        if(lastItem != null) {
            int remainder = workTypeTotal - apportionedTotal;
            int lastApportioned = parseInt(lastItem.getPreApportion());
            lastItem.setPreApportion((lastApportioned + remainder) + "");
        }
    }
}
```

#### é—œéµæ­¥é©Ÿ

1. **è¨ˆç®—è¨‚å–®ç¸½é¡**ï¼šæ‰€æœ‰ç”¢å“é …ç›®ç¸½åƒ¹çš„ç¸½å’Œï¼ˆæ’é™¤å·¥ç¨®é …ç›®ï¼‰
2. **è¨ˆç®—æ¯”ä¾‹**ï¼šæ¯å€‹é …ç›®çš„ `itemTotal / orderTotal`
3. **åˆ†æ”¤é‡‘é¡**ï¼šæ¯å€‹é …ç›®çš„ `workTypeTotal Ã— proportion`
4. **é¤˜é¡å¸æ”¶**ï¼šæœ€å¾Œé …ç›®ç²å¾— `remainder = workTypeTotal - sum(apportioned)`

### 4.3 å…è²»å·¥ç¨®è™•ç†

**è¦å‰‡**ï¼šç•¶ `actualInstallAmt = 0` æˆ– `actualDeliveryAmt = 0` æ™‚ï¼Œ**æ‰€æœ‰åˆ†æ”¤é‡‘é¡ = 0**ã€‚

```java
if(actualInstallAmt == 0) {
    for (OrderDetlVO item : items) {
        item.setPreApportion("0");
    }
    continue;  // è·³éåˆ†æ”¤
}
```

**æ¥­å‹™ç†ç”±**ï¼šå…è²»å®‰è£/é‹é€ä¸æ‡‰å°‡æˆæœ¬åˆ†é…çµ¦é …ç›®ã€‚

**âš ï¸ æ¥­å‹™ç¢ºèª**ï¼šå…è²»å·¥ç¨®æ˜¯å¦ä»æ‡‰åˆ†æ”¤ç”¨æ–¼æ¯›åˆ©è¿½è¹¤ï¼Ÿ

### 4.4 é¤˜é¡å¸æ”¶

**å•é¡Œ**ï¼šå››æ¨äº”å…¥å°è‡´åˆ†æ”¤é‡‘é¡ç¸½å’Œ â‰  å·¥ç¨®ç¸½é¡ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼šæœ€å¾Œé …ç›®å¸æ”¶æ‰€æœ‰é¤˜é¡ã€‚

**ç¯„ä¾‹**ï¼š
```
è¨‚å–®ç¸½é¡ï¼š10,001 TWD
å®‰è£ç¸½é¡ï¼š501 TWD

é …ç›® 1ï¼ˆ5,000 TWDï¼‰ï¼š5000/10001 Ã— 501 = 250.475 â†’ 250 TWD
é …ç›® 2ï¼ˆ3,000 TWDï¼‰ï¼š3000/10001 Ã— 501 = 150.285 â†’ 150 TWD
é …ç›® 3ï¼ˆ2,001 TWDï¼‰ï¼š2001/10001 Ã— 501 = 100.19 â†’ 100 TWD

ç¸½å’Œï¼š250 + 150 + 100 = 500 TWD
é¤˜é¡ï¼š501 - 500 = 1 TWD

æœ€å¾Œé …ç›®èª¿æ•´ï¼š100 + 1 = 101 TWD

æœ€çµ‚åˆ†é…ï¼š
  é …ç›® 1ï¼š250 TWD
  é …ç›® 2ï¼š150 TWD
  é …ç›® 3ï¼š101 TWD âœ…
  ç¸½è¨ˆï¼š501 TWD âœ…
```

**âš ï¸ æ¥­å‹™ç¢ºèª**ï¼šæœ€å¾Œé …ç›®é¤˜é¡å¸æ”¶æ˜¯å¦å¯æ¥å—ï¼Ÿ
- å¯èƒ½é€ æˆæœ€å¾Œé …ç›® Â±5-10 TWD å·®ç•°
- æ›¿ä»£æ–¹æ¡ˆï¼šæŒ‰æ¯”ä¾‹åˆ†é…é¤˜é¡çµ¦æ‰€æœ‰é …ç›®

### 4.5 æ¥­å‹™è¦å‰‡

| è¦å‰‡ ID | æè¿° | å„ªå…ˆç´š | å¯¦ä½œ |
|---------|-----|--------|------|
| **APP-R1** | å…è²»å·¥ç¨® â†’ æ‰€æœ‰åˆ†æ”¤é‡‘é¡ = 0 | é—œéµ | BzSoServices:4619-4628 |
| **APP-R2** | æŒ‰é …ç›®åƒ¹å€¼æ¯”ä¾‹åˆ†é… | é—œéµ | BzSoServices:4641-4656 |
| **APP-R3** | æœ€å¾Œé …ç›®å¸æ”¶æ‰€æœ‰å››æ¨äº”å…¥é¤˜é¡ | é«˜ | BzSoServices:4663-4681 |
| **APP-R4** | å®‰è£å’Œé‹é€åˆ†åˆ¥åˆ†æ”¤ | ä¸­ | BzSoServices:4605-4688 |
| **APP-R5** | æ¯”ä¾‹ä¸­åƒ…åŒ…å«ç”¢å“ SKUï¼ˆæ’é™¤å·¥ç¨® SKUï¼‰ | é«˜ | BzSoServices:4635-4637 |
| **APP-R6** | åˆ†æ”¤åœ¨æœƒå“¡æŠ˜æ‰£å¾ŒåŸ·è¡Œ | ä¸­ | BzSoServices:1024-1049 |

---

## 5. ç¨…é‡‘è¨ˆç®—æ”¿ç­– â­ æ–°å¢

### 5.1 æ¦‚è¦½

**ç‡Ÿæ¥­ç¨…ç‡**ï¼š1.05ï¼ˆå°ç£ 5% VATï¼‰

**ç¨…é‡‘æ‡‰ç”¨æ™‚æ©Ÿ**ï¼š
- **Type 0/1**ï¼šæŠ˜æ‰£è¨ˆç®—å‰å°åŸåƒ¹æ‡‰ç”¨ç¨…é‡‘
- **Type 2**ï¼šåŠ æˆè¨ˆç®—å¾Œå°åŠ æˆåƒ¹æ ¼æ‡‰ç”¨ç¨…é‡‘
- **Type CT**ï¼šæŠ˜æ‰£è¨ˆç®—å‰å°åŸåƒ¹æ‡‰ç”¨ç¨…é‡‘

### 5.2 ç¨…é‡‘å››æ¨äº”å…¥æ”¿ç­–

| æŠ˜æ‰£é¡å‹ | ç¨…é‡‘å››æ¨äº”å…¥æ–¹æ³• | ç¯„ä¾‹ï¼ˆ60.9 TWDï¼‰ | è‡ªä½•æ™‚èµ· |
|---------|----------------|-----------------|---------|
| Type 0ï¼ˆæŠ˜æ‰£ï¼‰ | Math.ceilï¼ˆç„¡æ¢ä»¶é€²ä½ï¼‰ | 61 TWD | èˆŠç‰ˆ |
| Type 1ï¼ˆé™æ¯›åˆ©ï¼‰ | Math.ceilï¼ˆç„¡æ¢ä»¶é€²ä½ï¼‰ | 61 TWD | èˆŠç‰ˆ |
| **Type 2ï¼ˆæˆæœ¬åŠ æˆï¼‰** | **Math.floorï¼ˆç„¡æ¢ä»¶æ¨å»ï¼‰** | **60 TWD** | **2020-05-07** |
| Type CTï¼ˆç‰¹æ®Šï¼‰ | Math.ceilï¼ˆç„¡æ¢ä»¶é€²ä½ï¼‰ | 61 TWD | èˆŠç‰ˆ |

### 5.3 âš ï¸ å·²è­˜åˆ¥ä¸ä¸€è‡´

**å•é¡Œ**ï¼šType 2 ä½¿ç”¨èˆ‡ Type 0/1/CT ä¸åŒçš„ç¨…é‡‘å››æ¨äº”å…¥ã€‚

**å½±éŸ¿**ï¼š
- å®¢æˆ¶å›°æƒ‘ï¼ˆä¸åŒæŠ˜æ‰£ç”¢ç”Ÿä¸åŒç¨…é¡ï¼‰
- æœƒè¨ˆè¤‡é›œæ€§ï¼ˆè¦ç¶­è­·å…©ç¨®å››æ¨äº”å…¥æ”¿ç­–ï¼‰
- æ¸¬è©¦é–‹éŠ·ï¼ˆå¿…é ˆæ¸¬è©¦å…©ç¨®æ–¹æ³•ï¼‰

**æ¥­å‹™å•é¡Œ**ï¼š
1. Type 2 ç‚ºä½•ä½¿ç”¨ floor å››æ¨äº”å…¥ï¼Ÿ
   - å‡è¨­ï¼šå°å®¢æˆ¶æ›´å‹å–„ï¼ˆæˆæœ¬åŠ æˆæ‡‰åˆ©æ–¼æœƒå“¡ï¼‰
   - æ›¿ä»£ï¼š2020 å¹´ç¨½æ ¸çš„è²¡å‹™è¦æ±‚

2. æ‰€æœ‰æŠ˜æ‰£é¡å‹æ˜¯å¦æ‡‰ä½¿ç”¨ä¸€è‡´çš„å››æ¨äº”å…¥ï¼Ÿ
   - **æ–¹æ¡ˆ A**ï¼šå…¨éƒ¨ä½¿ç”¨ floorï¼ˆå°å®¢æˆ¶æœ€å‹å–„ï¼‰
   - **æ–¹æ¡ˆ B**ï¼šå…¨éƒ¨ä½¿ç”¨ ceilï¼ˆå‚³çµ±ã€ä¿å®ˆï¼‰
   - **æ–¹æ¡ˆ C**ï¼šä¿æŒä¸åŒï¼ˆç•¶å‰è¡Œç‚ºï¼Œéœ€è¦æ–‡ä»¶è¨˜éŒ„ï¼‰

3. 2020-05-07 è®Šæ›´çš„æ¥­å‹™ç†ç”±æ˜¯ä»€éº¼ï¼Ÿ
   - âš ï¸ **éœ€è¦è¡Œå‹•**ï¼šç ”ç©¶è©²æ—¥æœŸçš„è®Šæ›´è«‹æ±‚

### 5.4 æ¥­å‹™è¦å‰‡

| è¦å‰‡ ID | æè¿° | å„ªå…ˆç´š | å¯¦ä½œ |
|---------|-----|--------|------|
| **TAX-R1** | ç‡Ÿæ¥­ç¨…ç‡ = 1.05ï¼ˆ5% VATï¼‰ | é—œéµ | å·²é…ç½® |
| **TAX-R2** | Type 0/1/CT ç¨…é‡‘ä½¿ç”¨ ceil å››æ¨äº”å…¥ | é«˜ | å¤šå€‹ä½ç½® |
| **TAX-R3** | Type 2 ç¨…é‡‘ä½¿ç”¨ floor å››æ¨äº”å…¥ | é«˜ | ç¬¬ 488-492 è¡Œ |
| **TAX-R4** | ç¨…é‡‘å››æ¨äº”å…¥ä¸ä¸€è‡´éœ€è¦æ¥­å‹™æ±ºç­– | é—œéµ | **âš ï¸ éœ€è¦æ±ºç­–** |
| **TAX-R5** | é›¶ç¨…äº¤æ˜“è·³éç¨…é‡‘è¨ˆç®— | ä¸­ | æ‰€æœ‰æŠ˜æ‰£é¡å‹ |
| **TAX-R6** | é …ç›®ç´šç¨…é‡‘é¡å‹æ±ºå®šæ‡‰ç¨…æ€§ | é«˜ | TaxType æ¬„ä½ |
| **TAX-R7** | Type 2 å¾å…ç¨…æŠ˜æ‰£ç¸½é¡ä¸­æ’é™¤ | ä¸­ | ç¬¬ 602-610 è¡Œ |

---

## 6. ä¿ƒéŠ·é‚è¼¯ â­ æ–°å¢ï¼ˆPhase 2 Week 3ï¼‰

### 6.1 ä¿ƒéŠ·äº‹ä»¶å„ªå…ˆç´šèˆ‡æ¬Šå¨

#### 6.1.1 æ ¸å¿ƒç™¼ç¾ï¼šOMS æ“æœ‰å”¯ä¸€æ¬Šå¨

**é—œéµç™¼ç¾**ï¼šSOM ç³»çµ±**ä¸è§£æ**Event A-H ä¹‹é–“çš„å„ªå…ˆç´šè¡çªã€‚OMS ç³»çµ±æ“æœ‰ä¿ƒéŠ·åˆ†é…çš„**å”¯ä¸€æ¬Šå¨**ã€‚

**è­‰æ“š**ï¼š
```java
// TBL_SKU_STORE è³‡æ–™çµæ§‹
String promEventNo;  // å–®ä¸€ VARCHAR æ¬„ä½ï¼Œé List
```

**è³‡æ–™æµ**ï¼š
```mermaid
graph LR
    A[OMSç³»çµ±] -->|æ¯æ—¥æ‰¹æ¬¡åŒæ­¥| B[TBL_SKU_STORE.PROM_EVENT_NO]
    B --> C[SoComputeFunctionMain]
    C --> D[å–®ä¸€ Event è™•ç†å™¨]
```

**é™åˆ¶**ï¼š
- æ¯å€‹ SKU åªèƒ½æœ‰ä¸€å€‹æœ‰æ•ˆçš„ `promEventNo`
- `OrderDetlVO.eventNosp` ç‚º Stringï¼Œé List
- ç„¡äº¤å‰ Event æ¯”è¼ƒé‚è¼¯
- ç„¡ã€Œæœ€ä½³æŠ˜æ‰£ç²å‹ã€å¯¦ä½œ

**æ¥­å‹™è¦å‰‡**ï¼š
| è¦å‰‡ ID | æè¿° | å„ªå…ˆç´š | è²¬ä»»æ–¹ |
|---------|-----|--------|--------|
| **PROMO-R1** | OMS æ“æœ‰ä¿ƒéŠ·åˆ†é…å”¯ä¸€æ¬Šå¨ | é—œéµ | OMS ç³»çµ± |
| **PROMO-R2** | æ¯å€‹ SKU æ¯æ—¥åƒ…ä¸€å€‹æœ‰æ•ˆ Event | é—œéµ | OMS æ‰¹æ¬¡ |
| **PROMO-R3** | SOM ä¸è§£æå„ªå…ˆç´šè¡çª | é—œéµ | SOM è·è²¬ç¯„åœ |
| **PROMO-R4** | æ¯å€‹é …ç›®åŒä¸€æ™‚é–“åªèƒ½åƒèˆ‡ä¸€å€‹ Event | é—œéµ | è³‡æ–™çµæ§‹é™åˆ¶ |

---

### 6.2 LIMIT_QTY æº¢ä½è™•ç†æ¨¡å¼

#### 6.2.1 å››ç¨®è™•ç†æ¨¡å¼

**ç™¼ç¾**ï¼šEvent A-H ä½¿ç”¨**å››ç¨®ä¸åŒçš„** LIMIT_QTY æº¢ä½è™•ç†æ¨¡å¼ï¼Œå°è‡´ä¸ä¸€è‡´çš„å®¢æˆ¶é«”é©—ã€‚

| Event é¡å‹ | è™•ç†æ¨¡å¼ | è¡Œç‚º | å®¢æˆ¶å½±éŸ¿ |
|-----------|---------|-----|---------|
| **Event A** | å…¨æœ‰æˆ–å…¨ç„¡æ‹’çµ• | ç¸½æ•¸ > é™åˆ¶ â†’ å…¨éƒ¨æ‹’çµ• | âš ï¸ éŒ¯èª¤è¨Šæ¯ |
| **Event B** | ä¸‰é‡æœ€å°å€¼å°é ‚ | min(buyQty, min(limitQty, maxAllowed)) | âœ… éœé»˜å°é ‚ |
| **Event C** | é–€æª»æª¢æŸ¥ | é”åˆ°é–€æª» â†’ å…¨éƒ¨æŠ˜æ‰£ | âœ… å…¨æœ‰æˆ–å…¨ç„¡ |
| **Event D** | éæ­¸åˆ†é… | é€é …åˆ†é…ç›´åˆ°ç”¨ç›¡ | âœ… éœé»˜å°é ‚ |
| **Event E** | ç¾¤çµ„æœ€å°å€¼ | min(groupA, groupB) | âœ… æ¢ä»¶æŠ˜æ‰£ |
| **Event F/G/H** | çµ„åˆé©—è­‰ | æ‰€æœ‰ç¾¤çµ„å¿…é ˆé”æ¨™ | âœ… å…¨æœ‰æˆ–å…¨ç„¡ |

#### 6.2.2 é—œéµéŒ¯èª¤

**éŒ¯èª¤ #1ï¼šEvent A é€€è²¨ç¹é LIMIT_QTY** ğŸš¨
```java
// SoEventA.java:129-170
int totalQty = 0;
for (OrderDetlVO item : items) {
    if(item.getStampFlag()) {
        totalQty += item.getQuantity().intValue();  // âŒ è² æ•¸é‡ä¸é©—è­‰
    }
}
if(totalQty > limitQty) {  // âŒ è² æ•¸ < limitQty æ°¸é ç‚º true
    // æ‹’çµ•å…¨éƒ¨...
}
```

**å½±éŸ¿**ï¼š
- é€€è²¨è¨‚å–®ï¼ˆè² æ•¸é‡ï¼‰ç¹éé™åˆ¶
- å®¢æˆ¶å¯èƒ½æ¿«ç”¨å°èŠ±åƒ¹é€€è²¨
- ç¯„ä¾‹ï¼šlimitQty=10ï¼Œé€€è²¨ -5ï¼ŒtotalQty=-5 < 10 â†’ é€šé âŒ

**ä¿®å¾©å»ºè­°**ï¼š
```java
totalQty += Math.abs(item.getQuantity().intValue());  // âœ… ä½¿ç”¨çµ•å°å€¼
```

**éŒ¯èª¤ #2ï¼šNullPointerException é¢¨éšª** âš ï¸
```java
// Event B/D/E - ç„¡ null æª¢æŸ¥
Integer limitQty = promoGupCdt.getLimitQty();  // âŒ å¯èƒ½ç‚º null
int maxAllowed = Math.min(limitQty, maxQty * limitQty);  // âŒ NPE!
```

**ä¿®å¾©å»ºè­°**ï¼š
```java
Integer limitQty = promoGupCdt.getLimitQty();
if(limitQty == null) {
    limitQty = Integer.MAX_VALUE;  // é è¨­ç„¡é™åˆ¶
}
```

**éŒ¯èª¤ #3ï¼šlimitQty=0 è¡Œç‚ºä¸ä¸€è‡´** âš ï¸
- **Event A**ï¼šlimitQty=0 è¦–ç‚º**ç„¡é™åˆ¶**ï¼ˆæœªæª¢æŸ¥ï¼‰
- **å…¶ä»– Event**ï¼šlimitQty=0 å°è‡´**å…¨éƒ¨æ‹’çµ•**ï¼ˆ0 items ç¬¦åˆè³‡æ ¼ï¼‰

#### 6.2.3 æ¥­å‹™è¦å‰‡

| è¦å‰‡ ID | æè¿° | å„ªå…ˆç´š | å¯¦ä½œ |
|---------|-----|--------|------|
| **LIMIT-R1** | Event A ä½¿ç”¨å…¨æœ‰æˆ–å…¨ç„¡æ‹’çµ•æ¨¡å¼ | é«˜ | SoEventA:159-170 |
| **LIMIT-R2** | Event B/D ä½¿ç”¨ä¸‰é‡æœ€å°å€¼å°é ‚ | é«˜ | SoEventB:215, SoEventD:227 |
| **LIMIT-R3** | Event A å¿…é ˆé©—è­‰çµ•å°æ•¸é‡ï¼ˆé€€è²¨é˜²è­·ï¼‰ | ğŸš¨ é—œéµ | **âš ï¸ éœ€è¦ä¿®å¾©** |
| **LIMIT-R4** | limitQty å¿…é ˆ null æª¢æŸ¥ | ğŸš¨ é—œéµ | **âš ï¸ éœ€è¦ä¿®å¾©** |
| **LIMIT-R5** | limitQty=0 è¡Œç‚ºéœ€è¦æ¨™æº–åŒ– | é«˜ | **âš ï¸ éœ€è¦æ±ºç­–** |

---

### 6.3 è·¨é¡ä¿ƒéŠ·ç–ŠåŠ è¦å‰‡

#### 6.3.1 å®šåƒ¹å¼•æ“åŸ·è¡Œé †åº

**å®Œæ•´åŸ·è¡Œæµç¨‹**ï¼š
```java
// BzSoServices.java:4434-4478
// æ­¥é©Ÿ 1ï¼šType 2 æœƒå“¡æŠ˜æ‰£ï¼ˆåŸºæ–¼æˆæœ¬ï¼‰
memberDiscSkus.addAll(soComputeFunctionMemberDis(..., "2", ...));

// æ­¥é©Ÿ 2ï¼šAssortSku é‡æ–°åˆ†é¡ï¼ˆæ’é™¤å·²è®Šåƒ¹é …ç›®ï¼‰
AssortSku assortSku1 = new AssortSku();
assortSku1.assortGoods(soVO.getLstOrderDetl());

// æ­¥é©Ÿ 3ï¼šEvent A-H å¤šé‡ä¿ƒéŠ·
SoComputeFunctionMain soComputeFunctionMain =
    soComputeFunctionMainServices.getSoComputeFunctionMain(lstComputeSku, isTaxZero);

// æ­¥é©Ÿ 4ï¼šAssortSku å†æ¬¡é‡æ–°åˆ†é¡
AssortSku assortSku2 = new AssortSku();
assortSku2.assortGoods(soVO.getLstOrderDetl());

// æ­¥é©Ÿ 5ï¼šType 0 æœƒå“¡æŠ˜æ‰£ï¼ˆæŠ˜æ‰£ï¼‰
memberDiscSkus.addAll(soComputeFunctionMemberDis(..., "0", ...));

// æ­¥é©Ÿ 6ï¼šType 1 æœƒå“¡æŠ˜æ‰£ï¼ˆé™æ¯›åˆ©ï¼‰
memberDiscSkus.addAll(soComputeFunctionMemberDis(..., "1", ...));

// æ­¥é©Ÿ 7ï¼šType CT ç‰¹æ®Šæœƒå“¡æŠ˜æ‰£ï¼ˆåƒ…åœ¨ 0/1/2 å…¨ç©ºæ™‚ï¼‰
if(memberDiscSkus.isEmpty()) {
    memberDiscSkus.addAll(soComputeMemberDisForSpecial(...));
}

// æ­¥é©Ÿ 8ï¼šå„ªæƒ åˆ¸
// æ­¥é©Ÿ 9ï¼šç´…åˆ©é»æ•¸
```

#### 6.3.2 ä¸‰å±¤é˜²è­·æ©Ÿåˆ¶

**é˜²æ­¢é‡è¤‡æŠ˜æ‰£çš„æ¶æ§‹**ï¼š

**ç¬¬ 1 å±¤ï¼šè¨­å®šè®Šåƒ¹æ——æ¨™**
```java
// Type 1, Type 2, Event è™•ç†å¾Œ
orderDetlVO.setPosAmtChangePrice(true);      // ç”¢å“åƒ¹æ ¼å·²è®Šæ›´
orderDetlVO.setInstallChangePrice(true);     // å®‰è£åƒ¹æ ¼å·²è®Šæ›´
orderDetlVO.setDeliveryChangePrice(true);    // é‹é€åƒ¹æ ¼å·²è®Šæ›´
```

**ç¬¬ 2 å±¤ï¼šAssortSku å‹•æ…‹éæ¿¾**
```java
// AssortSku.java:71-76
if (StringUtils.isBlank(orderDetlVO.getGoodsAuthEmpId())
    && CommonConstant.NO_FLAG.equals(orderDetlVO.getOpenPrice())
    && !orderDetlVO.isPosAmtChangePrice()) {  // â† æª¢æŸ¥è®Šåƒ¹æ——æ¨™
    lstComputeSku.add(orderDetlVO);  // åƒ…åŠ å…¥å¯ä¿ƒéŠ·é …ç›®
}
```

**ç¬¬ 3 å±¤ï¼šæŠ˜æ‰£å‰å†æª¢æŸ¥**
```java
// SoFunctionMemberDisServices.java:108-110
if(!orderDetlVO.isPosAmtChangePrice() &&
   !orderDetlVO.isDeliveryChangePrice() &&
   !orderDetlVO.isInstallChangePrice()){
    allSkus.add(orderDetlVO.getSkuNo());  // ç¬¦åˆæŠ˜æ‰£è³‡æ ¼
}
```

#### 6.3.3 å®Œæ•´ç–ŠåŠ è¦å‰‡çŸ©é™£

| ç¬¬ä¸€å€‹ â†“ \ ç¬¬äºŒå€‹ â†’ | Type 2 | Event A-H | Type 0 | Type 1 | Type CT | å„ªæƒ åˆ¸ | ç´…åˆ© |
|-------------------|--------|----------|--------|--------|---------|--------|------|
| **Type 2** | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ |
| **Event A-H** | âœ… | âŒ | âœ… | âœ… | âœ… | ğŸ”¶ | âŒ |
| **Type 0** | âœ… | âœ… | âŒ | âŒ | âŒ | ğŸ”¶ | âœ… |
| **Type 1** | âœ… | âŒ | âŒ | âŒ | âŒ | âŒ | âŒ |
| **Type CT** | âœ… | âœ… | âŒ | âŒ | âŒ | ğŸ”¶ | âœ… |
| **å„ªæƒ åˆ¸** | âœ… | ğŸ”¶ | âœ… | âœ… | âœ… | âŒ | âœ… |
| **ç´…åˆ©** | âœ… | âŒ | âœ… | âœ… | âœ… | âœ… | âŒ |

**åœ–ä¾‹**ï¼š
- âœ… **å¯ç–ŠåŠ **ï¼šç¬¬äºŒå€‹å¯æ‡‰ç”¨æ–¼ç¬¬ä¸€å€‹ä¹‹å¾Œ
- âŒ **äº’æ–¥**ï¼šç¬¬äºŒå€‹è¢«ç¬¬ä¸€å€‹é˜»æ­¢
- ğŸ”¶ **æ¢ä»¶æ€§**ï¼šå–æ±ºæ–¼ `excludeCard` é…ç½®

#### 6.3.4 é—œéµç–ŠåŠ è¦å‰‡

**è¦å‰‡ 1ï¼šEvent A-H äº’æ–¥**
- è³‡æ–™çµæ§‹é™åˆ¶ï¼š`eventNosp` ç‚º Stringï¼Œé List
- é‚è¼¯é™åˆ¶ï¼š`if-else if` çµæ§‹åœ¨ `SoComputeFunctionMain:150-179`
- çµæœï¼šæ¯å€‹é …ç›®åªèƒ½åƒèˆ‡ä¸€å€‹ Event

**è¦å‰‡ 2ï¼šæœƒå“¡æŠ˜æ‰£å¯ç–ŠåŠ  Event**
```java
// SoFunctionMemberDisServices.java:207-213
// è¨ˆç®—åŸºæº–åŒ…å« Event æŠ˜æ‰£
totalPrice = price + (bonusTotal / qty) + (promotionDiscount / qty);
```
- Type 0/CTï¼šè¨ˆç®—æ™‚åŠ å› Event æŠ˜æ‰£
- çµæœï¼šæœƒå“¡æŠ˜æ‰£è¨ˆç®—æ–¼ Event å¾Œçš„åƒ¹æ ¼

**è¦å‰‡ 3ï¼šå„ªæƒ åˆ¸æ¢ä»¶æ€§æ’é™¤ Event**
```java
// SoFunctionCouponServices.java:1647-1657
if(excludeCard && hasPromEvent) {
    continue;  // æ’é™¤æ­¤é …ç›®
}
```
- åŸºæ–¼ `TBL_CDISC.EXCLUDE_CARD` é…ç½®
- è‹¥ excludeCard=Y ä¸”æœ‰ Event â†’ é …ç›®ä¸ç¬¦åˆå„ªæƒ åˆ¸è³‡æ ¼

**è¦å‰‡ 4ï¼šç´…åˆ©é»æ•¸æ’é™¤ Event**
```java
// BonusServices.java (æ¨æ–·)
if(StringUtils.isNotBlank(orderDetlVO.getEventNosp())) {
    continue;  // æœ‰ Event çš„é …ç›®ä¸èƒ½ä½¿ç”¨ç´…åˆ©
}
```

**è¦å‰‡ 5ï¼šType 2 æ’é™¤æ‰€æœ‰å¾ŒçºŒ**
- è¨­å®šè®Šåƒ¹æ——æ¨™ â†’ AssortSku æ’é™¤ â†’ ç„¡ Event/Type 0/1/CT
- æœ€æ—©åŸ·è¡Œä»¥é˜²æ­¢é‡è¤‡æŠ˜æ‰£

**è¦å‰‡ 6ï¼šType CT äº’æ–¥ Type 0/1/2**
- åƒ…åœ¨ `memberDiscSkus.isEmpty()` æ™‚åŸ·è¡Œ
- å¦‚æœä»»ä½•é …ç›®ç²å¾— Type 0/1/2 â†’ æ‰€æœ‰é …ç›®è·³é Type CT

#### 6.3.5 æ¥­å‹™è¦å‰‡

| è¦å‰‡ ID | æè¿° | å„ªå…ˆç´š | å¯¦ä½œ |
|---------|-----|--------|------|
| **STACK-R1** | Event A-H äº’æ–¥ï¼ˆæ¯å€‹é …ç›®åªèƒ½ä¸€å€‹ï¼‰ | é—œéµ | OrderDetlVO.eventNosp ç‚º String |
| **STACK-R2** | Type 0/CT æœƒå“¡æŠ˜æ‰£ç–ŠåŠ  Eventï¼ˆåŠ å›ä¿ƒéŠ·ï¼‰ | é«˜ | ç¬¬ 428ã€213 è¡Œ |
| **STACK-R3** | Type 1/2 è¨­å®šè®Šåƒ¹æ——æ¨™æ’é™¤å¾ŒçºŒ | é«˜ | ç¬¬ 453ã€496 è¡Œ |
| **STACK-R4** | AssortSku å‹•æ…‹æ’é™¤å·²è®Šåƒ¹é …ç›® | é«˜ | AssortSku:71-76 |
| **STACK-R5** | å„ªæƒ åˆ¸åŸºæ–¼ excludeCard æ¢ä»¶æ€§æ’é™¤ Event | ä¸­ | ç¬¬ 1647-1657 è¡Œ |
| **STACK-R6** | ç´…åˆ©é»æ•¸æ’é™¤ Event é …ç›® | ä¸­ | æ¨æ–·é‚è¼¯ |
| **STACK-R7** | ä¸‰å±¤é˜²è­·ç¢ºä¿ç„¡é‡è¤‡æŠ˜æ‰£ | é—œéµ | æ——æ¨™ + åˆ†é¡ + æª¢æŸ¥ |

---

### 6.4 Event A-H å¯¦ä½œæ‘˜è¦

#### 6.4.1 Event é¡å‹æ¦‚è¦½

| Event | åç¨± | è¨ˆç®—åŸºæº– | å¤šå±¤æ”¯æ´ | æ’åºç­–ç•¥ | é—œéµç‰¹å¾µ |
|-------|------|---------|---------|---------|---------|
| **A** | å°èŠ±åƒ¹ | å–®ä¸€ SKU | å¦ | ç„¡ | éœ€æ”¶éŠ€å“¡ç¢ºèªï¼ŒLIMIT_QTY é©—è­‰ |
| **B** | æ»¿é¡åŠ åƒ¹è³¼ | ç™¼ç¥¨ç¸½é¡ | æ˜¯ | é«˜åƒ¹å„ªå…ˆ | é–€æª»ç´¯ç©ï¼Œæœ€é«˜å±¤å„ªå…ˆ |
| **C** | æ»¿é¡å„ªæƒ  | é‡‘é¡/æ•¸é‡ | æ˜¯ | ç„¡ | å…¨é¢æŠ˜æ‰£ï¼Œæœ€é«˜ç¬¦åˆå±¤ç²å‹ |
| **D** | æ¯è²· M äº« N | æ•¸é‡ | æ˜¯ | ä½åƒ¹å„ªå…ˆ | ç´¯ç©è·¨å±¤ï¼Œè¿½è¹¤å·²ä½¿ç”¨æ•¸é‡ |
| **E** | è²· A äº« B | å…©ç¾¤çµ„ | å¦ | ç„¡ | min(groupA, groupB) è¨­å®š |
| **F** | åˆè³¼åƒ¹ | çµ„åˆ | å¦ | ç„¡ | æ‰€æœ‰ç¾¤çµ„å¿…é ˆç¬¦åˆ |
| **G** | å…±ç”¨åˆè³¼ | å…±äº«é …ç›® | æ˜¯ | æœ€é«˜å±¤å„ªå…ˆ | è¤‡é›œé‚è¼¯ï¼Œè¿½è¹¤å…±äº«ä½¿ç”¨ |
| **H** | å–®å“æ‹†åƒ¹ | åˆ†é …å®šåƒ¹ | æ˜¯ | ç„¡ | åƒ…å¯¦åƒ¹ï¼ˆDISCOUNT_TYPE=2ï¼‰ |

#### 6.4.2 æŠ˜æ‰£é¡å‹

| DISCOUNT_TYPE | åç¨± | å…¬å¼ | ä½¿ç”¨æ–¼ |
|--------------|------|------|--------|
| **2** | å¯¦éš›åƒ¹æ ¼ | `(posPrice - actualPrice) Ã— qty` | æ‰€æœ‰ Event |
| **3** | æŠ˜æ‰£é‡‘é¡ | `discountAmt Ã— qty` | æ‰€æœ‰ Event |
| **4** | æŠ˜æ‰£ç™¾åˆ†æ¯” | `ceil(posPrice Ã— pct / 100) Ã— qty` | A, B, C, D, F |

#### 6.4.3 å…±äº«å…¬ç”¨æ–¹æ³•ï¼ˆSoEventBaseï¼‰

```java
// æ’åºï¼šPOS åƒ¹æ ¼é™åºï¼ˆé«˜åƒ¹å„ªå…ˆï¼‰
protected void sortItems(ArrayList<OrderDetlVO> items);

// æ’åºï¼šPOS åƒ¹æ ¼å‡åºï¼ˆä½åƒ¹å„ªå…ˆï¼‰
protected void sortItemsForLowPrice(ArrayList<OrderDetlVO> items);

// æ—¥æœŸé©—è­‰ï¼šcurrent âˆˆ [START_DAT, END_DAT]
protected boolean compareShortDate(Date startDate, Date endDate);

// åˆå§‹åŒ–æŠ˜æ‰£æ˜ å°„ç‚º "0"
protected void setMapDefValue(ArrayList<OrderDetlVO> items);

// å¯«å…¥æŠ˜æ‰£åˆ° OrderDetlVO
protected void setAmtQtyByMap(ArrayList<OrderDetlVO> items);

// å»ºç«‹æ”¶æ“šè¨Šæ¯
protected void setOrderEventMsg(String eventNo, String eventName, ...);

// è½‰æ›ç‚ºé›¶ç¨…é‡‘é¡ï¼ˆÃ· 1.05ï¼‰
protected BigDecimal setZeroTaxAmt(BigDecimal amt);

// é©—è­‰æŠ˜æ‰£ â‰¤ POS åƒ¹æ ¼
protected void checkDiscAmt(OrderDetlVO item, BigDecimal discAmt);
```

#### 6.4.4 æ‰¹æ¬¡åŒ¯å…¥æµç¨‹

**æ¯æ—¥åŒ¯å…¥ï¼ˆPromoReceiverï¼‰**ï¼š
```
1. FTP é€£ç·šåˆ° OMS
2. ä¸‹è¼‰ 4 å€‹æª”æ¡ˆ/å…¬å¸ä»£ç¢¼ï¼š
   - MPMST.yyyymmdd â†’ TBL_PROM_EVENT
   - MPDTL1.yyyymmdd â†’ TBL_PROM_GROUP
   - MPDTL2.yyyymmdd â†’ TBL_PROM_CONDITION
   - MPDTL3.yyyymmdd â†’ TBL_PROM_SET
3. æ¸…ç©ºä¸¦é‡æ–°è¼‰å…¥ï¼ˆæˆªæ–·ç­–ç•¥ï¼‰
4. å…¨æœ‰æˆ–å…¨ç„¡äº¤æ˜“æ§åˆ¶
5. æˆåŠŸ â†’ å‚™ä»½ï¼Œå¤±æ•— â†’ ç§»è‡³å¤±æ•—ç›®éŒ„
```

**è³‡æ–™åº«æ˜ å°„**ï¼š
- `seqNo`, `groupSeqNo`: Integer â†’ String è½‰æ›
- æ—¥æœŸï¼šyyyyMMdd â†’ java.util.Date è§£æ
- é‡‘é¡ï¼šå®šå¯¬æ•¸å­—æ¬„ä½ â†’ BigDecimal/Integer

#### 6.4.5 æ¥­å‹™è¦å‰‡

| è¦å‰‡ ID | æè¿° | å„ªå…ˆç´š | å¯¦ä½œ |
|---------|-----|--------|------|
| **EVENT-R1** | æ‰€æœ‰ Event é©—è­‰æ—¥æœŸç¯„åœ | é—œéµ | SoEventBase.compareShortDate |
| **EVENT-R2** | Event A éœ€æ”¶éŠ€å“¡ç¢ºèªï¼ˆstampFlagï¼‰ | é—œéµ | SoEventA:159-170 |
| **EVENT-R3** | Event B/D å¤šå±¤ç´¯ç©ï¼ˆHEAP=Yï¼‰ | é«˜ | SoEventB:133, SoEventD:124 |
| **EVENT-R4** | Event C æœ€é«˜ç¬¦åˆå±¤ç²å‹ | é«˜ | SoEventC:155-165 |
| **EVENT-R5** | Event D ä½¿ç”¨ä½åƒ¹å„ªå…ˆæ’åºï¼ˆå…¬å¹³æ€§ï¼‰ | ä¸­ | SoEventD:168 |
| **EVENT-R6** | Event E å…©ç¾¤çµ„éƒ½å¿…é ˆç¬¦åˆ | é«˜ | SoEventE:134-140 |
| **EVENT-R7** | Event F/G/H æ‰€æœ‰ç¾¤çµ„å¿…é ˆç¬¦åˆ | é«˜ | SoEventF:171-181 |
| **EVENT-R8** | Event G è¿½è¹¤è·¨å±¤å…±äº«é …ç›®ä½¿ç”¨ | é«˜ | SoEventG:154-267 |
| **EVENT-R9** | Event H åƒ…å…è¨± DISCOUNT_TYPE=2 | ä¸­ | SoEventH:249-254 |
| **EVENT-R10** | ä¿ƒéŠ·æ¯æ—¥æ‰¹æ¬¡å¾ OMS FTP åŒ¯å…¥ | é—œéµ | PromoReceiver |
| **EVENT-R11** | ä¿ƒéŠ·è³‡æ–™ä½¿ç”¨æˆªæ–·ä¸¦é‡æ–°è¼‰å…¥ç­–ç•¥ | é«˜ | PromoReceiver:180-194 |
| **EVENT-R12** | ä¿ƒéŠ·åŒ¯å…¥å¤±æ•— â†’ å®Œå…¨å›æ»¾ | é—œéµ | PromoReceiver:159-221 |

---

## 7. ä»˜æ¬¾æµç¨‹ â­ æ–°å¢ï¼ˆPhase 3 Week 4ï¼‰

### 7.1 æ¦‚è¦½

**ç›®çš„**ï¼šè¿½è¹¤è¨‚å–®ä»˜æ¬¾å®Œæˆå¾Œçš„å®Œæ•´æµç¨‹ï¼ŒåŒ…æ‹¬ç™¼ç¥¨è™Ÿæ®µåˆ†é…ã€POS åŒæ­¥å’Œ CRM åŒæ­¥ã€‚

**æ™‚æ©Ÿ**ï¼šåœ¨è¨‚å–®çµå¸³ï¼ˆæ”¶éŠ€å°ä»˜æ¬¾ï¼‰å®Œæˆå¾Œè‡ªå‹•åŸ·è¡Œã€‚

**æ ¸å¿ƒçµ„ä»¶**ï¼š
- ç™¼ç¥¨è™Ÿæ®µç®¡ç†ç³»çµ±ï¼ˆTBL_STORE_POS_INVOICEï¼‰
- POS å³æ™‚åŒæ­¥æ©Ÿåˆ¶ï¼ˆSOAP Endpointï¼‰
- CRM ç•°æ­¥æ‰¹æ¬¡åŒæ­¥ï¼ˆéšŠåˆ— + æ‰¹æ¬¡åŸ·è¡Œå™¨ï¼‰

### 7.2 ç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥èˆ‡åˆ†é…

#### 7.2.1 è§¸ç™¼æ™‚æ©Ÿ

**æµç¨‹ä½ç½®**ï¼š
```
æ”¶éŠ€å°çµå¸³
  â†“
CashierCASAServices.createCasaSoOrderCashier()
  â†“
handleCashierPaymentBO()
  â†“
halndleInvoiceExtVO() (æŒ‰ç¨…åˆ¥åˆ†é¡)
  â†“
insertData() (é‡å°æ¯å€‹ç¨…åˆ¥)
  â†“
doQueryInvoice() â† å–å¾—ç™¼ç¥¨è™Ÿç¢¼
```

**ä»£ç¢¼ä½ç½®**ï¼šBzStorePosInvoiceServices.doQueryInvoice():58-101

#### 7.2.2 ä¸‰å±¤éš”é›¢æ©Ÿåˆ¶

SOM ç³»çµ±æ¡ç”¨ä¸‰å±¤éš”é›¢ç¢ºä¿ç™¼ç¥¨è™Ÿæ®µç®¡ç†çš„å®‰å…¨æ€§ï¼š

| éš”é›¢å±¤ | æ¬„ä½ | ç›®çš„ | ç¯„ä¾‹ |
|--------|------|------|------|
| **å¹´æœˆéš”é›¢** | YEAR_MONTH | æŒ‰æœƒè¨ˆæœŸé–“åˆ†é›¢ | "202501" |
| **é–€åº—éš”é›¢** | STORE_ID | æŒ‰é–€åº—åˆ†é›¢ | "S001" |
| **POS éš”é›¢** | POS_ID | æŒ‰æ”¶éŠ€æ©Ÿåˆ†é›¢ | "POS01" |

**ä¸»éµçµæ§‹**ï¼š(YEAR_MONTH, STORE_ID, POS_ID, TRACK_ID, INV_START_NO)

#### 7.2.3 ç™¼ç¥¨è™Ÿæ®µç‹€æ…‹æ©Ÿ

```mermaid
graph LR
    A[1:æœªä½¿ç”¨] -->|é¦–æ¬¡ä½¿ç”¨| B[2:ä½¿ç”¨ä¸­]
    B -->|ç¹¼çºŒä½¿ç”¨| B
    B -->|ç”¨ç›¡| C[3:ä½¿ç”¨å®Œç•¢]
    A -->|ç®¡ç†å“¡åˆªé™¤| D[4:å·²åˆªé™¤]
    B -->|ç®¡ç†å“¡åˆªé™¤| D
```

**ç‹€æ…‹å®šç¾©**ï¼š
- **STATUS_1ï¼ˆæœªä½¿ç”¨ï¼‰**ï¼šè™Ÿæ®µå·²é…ç½®ä½†å°šæœªä½¿ç”¨
- **STATUS_2ï¼ˆä½¿ç”¨ä¸­ï¼‰**ï¼šç•¶å‰æ­£åœ¨ä½¿ç”¨çš„è™Ÿæ®µ
- **STATUS_3ï¼ˆä½¿ç”¨å®Œç•¢ï¼‰**ï¼šè™Ÿæ®µå·²ç”¨ç›¡
- **STATUS_4ï¼ˆå·²åˆªé™¤ï¼‰**ï¼šç®¡ç†å“¡æ‰‹å‹•åˆªé™¤

**å¸¸æ•¸ä½ç½®**ï¼šStorePosInvoiceConstant.java

#### 7.2.4 è‡ªå‹•æ¿€æ´»æ©Ÿåˆ¶

**æ ¸å¿ƒé‚è¼¯**ï¼š
```java
// æ­¥é©Ÿ 1ï¼šæŸ¥è©¢ STATUS_2 è™Ÿæ®µï¼ˆæ­£åœ¨ä½¿ç”¨ä¸­ï¼‰
List<TblStorePosInvoice> list = customBzStorePosInvoiceMapper
    .selectByYearMonthAndPosIdAndStatus(yearMonth, storeId, posNo, STATUS_2);

// æ­¥é©Ÿ 2ï¼šè‹¥ç„¡å‰‡è‡ªå‹•æ¿€æ´» STATUS_1ï¼ˆæœªä½¿ç”¨ï¼‰
if(list.size() == 0) {
    customBzStorePosInvoiceMapper.updateStatusForStatus1(
        yearMonth, storeId, posNo
    );
    // é‡æ–°æŸ¥è©¢
    list = customBzStorePosInvoiceMapper
        .selectByYearMonthAndPosIdAndStatus(yearMonth, storeId, posNo, STATUS_2);
}
```

**æ¿€æ´» SQL**ï¼ˆé¸æ“‡æœ€å°èµ·å§‹è™Ÿï¼‰ï¼š
```sql
UPDATE TBL_STORE_POS_INVOICE
SET STATUS = '2'
WHERE YEAR_MONTH = #{yearMonth}
  AND STORE_ID = #{storeId}
  AND POS_ID = #{posNo}
  AND STATUS = '1'
  AND INV_START_NO = (
      SELECT MIN(INV_START_NO)
      FROM TBL_STORE_POS_INVOICE
      WHERE YEAR_MONTH = #{yearMonth}
        AND STORE_ID = #{storeId}
        AND POS_ID = #{posNo}
        AND STATUS = '1'
  )
```

#### 7.2.5 è™Ÿæ®µç”¨ç›¡è™•ç†

**åˆ¤æ–·é‚è¼¯**ï¼š
```java
private void updateInvoice(TblStorePosInvoice invoice, ...) {
    TblStorePosInvoice uInvoice = new TblStorePosInvoice();

    uInvoice.setUsedCnt(invoice.getUsedCnt() + 1);
    uInvoice.setFreeCnt(invoice.getFreeCnt() - 1);

    // é—œéµåˆ¤æ–·ï¼šå‰©é¤˜æ•¸é‡æ˜¯å¦ç”¨ç›¡
    if((invoice.getFreeCnt() - 1) <= 0) {
        uInvoice.setStatus(STATUS_3);  // ä½¿ç”¨å®Œç•¢
    } else {
        uInvoice.setStatus(STATUS_2);  // ç¹¼çºŒä½¿ç”¨
        uInvoice.setNextInvNo(this.computerNextInvNo(invoice.getNextInvNo()));
    }

    tblStorePosInvoiceMapper.updateByPrimaryKeySelective(uInvoice);
}
```

**è™Ÿç¢¼éå¢**ï¼š
```java
private String computerNextInvNo(String str) {
    int no = Integer.valueOf(str);
    return StringUtils.leftPad(String.valueOf(no+1), 8, '0');
}
// ç¯„ä¾‹ï¼š"00000001" â†’ "00000002"
```

**ç„¡å¯ç”¨è™Ÿæ®µéŒ¯èª¤**ï¼š
```java
if(invoiceId == null) {
    throw new RuntimeException("å·²ç„¡ç™¼ç¥¨è™Ÿç¢¼ï¼Œè«‹ç‚ºç•¶å‰POSåˆ†é…ç™¼ç¥¨è™Ÿç¢¼");
}
```

#### 7.2.6 æŒ‰ç¨…åˆ¥åˆ†é¡è™•ç†

**ä¸‰ç¨®ç¨…åˆ¥**ï¼š
| é¡å‹ | ä»£ç¢¼ | èªªæ˜ |
|------|------|------|
| é›¶ç¨… | "0" | é›¶ç¨…ç‡å•†å“ |
| æ‡‰ç¨… | "1" | ä¸€èˆ¬æ‡‰ç¨…å•†å“ï¼ˆ5% ç‡Ÿæ¥­ç¨…ï¼‰|
| å…ç¨… | "2" | å…ç¨…å•†å“ |

**è™•ç†é‚è¼¯**ï¼š
```java
// CashierCASAServices.halndleInvoiceExtVO():438-452
// æŒ‰ç¨…åˆ¥åˆ†çµ„
Map<String, List<InvoiceExtVO>> transMasMap = new HashMap<>();

for(InvoiceExtVO vo : invoiceExtVOs) {
    String taxType = vo.getTaxType();
    transMasMap.computeIfAbsent(taxType, k -> new ArrayList<>()).add(vo);
}

// ä¾ç¨…åˆ¥åˆ†åˆ¥å‘¼å« insertData()
if (transMasMap.get("0") != null) {
    this.insertData(..., transMasMap.get("0"), "0");  // é›¶ç¨…
}
if (transMasMap.get("1") != null) {
    this.insertData(..., transMasMap.get("1"), "1");  // æ‡‰ç¨…
}
if (transMasMap.get("2") != null) {
    this.insertData(..., transMasMap.get("2"), "2");  // å…ç¨…
}
```

**å¤šç™¼ç¥¨å ´æ™¯**ï¼š
- ä¸€ç­†è¨‚å–®å¯èƒ½ç”¢ç”Ÿ 1-3 å¼µç™¼ç¥¨ï¼ˆä¾ç¨…åˆ¥çµ„åˆï¼‰
- æ¯ç¨®ç¨…åˆ¥ç¨ç«‹å–è™Ÿ
- ç¯„ä¾‹ï¼šè¨‚å–®æœ‰æ‡‰ç¨…å•†å“ + å…ç¨…å•†å“ â†’ ç”¢ç”Ÿ 2 å¼µç™¼ç¥¨

---

### 7.3 POS èˆ‡ CRM åŒæ­¥æ©Ÿåˆ¶

#### 7.3.1 å…©å±¤åŒæ­¥æ¶æ§‹

```mermaid
graph TD
    A[SOM è¨‚å–®ä»˜æ¬¾] --> B{åŒæ­¥é¡å‹}
    B -->|å³æ™‚åŒæ­¥| C[POS ç³»çµ±]
    B -->|ç•°æ­¥åŒæ­¥| D[éšŠåˆ—å…¥éšŠ]
    C --> E[å›å‚³çµå¸³çµæœ]
    E --> F[9æ­¥é©Ÿå…¥åº«]
    F --> G[æ›´æ–°è¨‚å–®ç‹€æ…‹]
    D --> H[æ‰¹æ¬¡åŸ·è¡Œå™¨<br/>4-24å°æ™‚]
    H --> I[CRM WSDL èª¿ç”¨]
    I --> J[æ›´æ–°åŒæ­¥ç‹€æ…‹]
    J -->|å¤±æ•—| K{é‡è©¦æ¬¡æ•¸<3?}
    K -->|æ˜¯| H
    K -->|å¦| L[æ¨™è¨˜ä¸­æ–·]
```

**è¨­è¨ˆç†å¿µ**ï¼š
- **POS åŒæ­¥**ï¼šå³æ™‚ã€é˜»å¡å¼ï¼Œç¢ºä¿æ”¶éŠ€å°å¾—åˆ°ç¢ºèª
- **CRM åŒæ­¥**ï¼šç•°æ­¥ã€æ‰¹æ¬¡å¼ï¼Œä¸å½±éŸ¿æ”¶éŠ€å°æ€§èƒ½

#### 7.3.2 POS å³æ™‚åŒæ­¥

**SOAP Endpoint**ï¼šPosSoPaidResultEndpoint

**WSDL ä½ç½®**ï¼š
```
http://{host}:{port}/so-webservice/services/PosSoPaidResult?wsdl
```

**ç«¯é»æ–¹æ³•**ï¼š
```java
@PayloadRoot(namespace = NAMESPACE_URI, localPart = "ProcessPaidResultRequest")
@ResponsePayload
public ProcessPaidResultResponse processPaidResult(
    @RequestPayload ProcessPaidResultRequest request
) throws Exception {
    PosSoPaidInfoVO vo = extractRequestData(request);

    PosSoPaidResultServices services = new PosSoPaidResultServices();
    String result = services.processPosSoPaidResult(vo);

    ProcessPaidResultResponse response = new ProcessPaidResultResponse();
    response.setResult(result);
    return response;
}
```

**ä»£ç¢¼ä½ç½®**ï¼š
- Endpoint: `so-webservice/...PosSoPaidResultEndpoint.java`
- Services: `so-bzservices/...PosSoPaidResultServices.java`

#### 7.3.3 å››å±¤é©—è­‰æ©Ÿåˆ¶

**é©—è­‰ 1ï¼šä¸‹å‚³åºè™Ÿæª¢æŸ¥**
```java
String uploadSeq = vo.getUploadSeq();
TblOrder order = tblOrderMapper.selectByPrimaryKey(vo.getOrderId());

if(!uploadSeq.equals(order.getUploadSeq())) {
    return "ERROR: ä¸‹å‚³åºè™Ÿä¸ç¬¦";
}
```
**ç›®çš„**ï¼šé˜²æ­¢èˆŠæ•¸æ“šè¦†è“‹æ–°æ•¸æ“š

**é©—è­‰ 2ï¼šé‡è¤‡çµå¸³æª¢æŸ¥**
```java
List<TblTransMast> existList = tblTransMastMapper
    .selectByOrderIdAndPosId(vo.getOrderId(), vo.getPosId());

if(existList.size() > 0) {
    return "ERROR: è¨‚å–®å·²çµå¸³";
}
```
**ç›®çš„**ï¼šé˜²æ­¢åŒä¸€è¨‚å–®é‡è¤‡çµå¸³

**é©—è­‰ 3ï¼šç™¼ç¥¨å”¯ä¸€æ€§æª¢æŸ¥**
```java
if(StringUtils.isNotBlank(vo.getInvoiceId())) {
    List<TblTransMast> invList = tblTransMastMapper
        .selectByInvoiceId(vo.getInvoiceId());

    if(invList.size() > 0) {
        return "ERROR: ç™¼ç¥¨è™Ÿç¢¼é‡è¤‡";
    }
}
```
**ç›®çš„**ï¼šç¢ºä¿ç™¼ç¥¨è™Ÿç¢¼å”¯ä¸€æ€§

**é©—è­‰ 4ï¼šæ—¥æœŸæ ¼å¼æª¢æŸ¥**
```java
try {
    SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    sdf.parse(vo.getPaidDate());
    sdf.parse(vo.getCreateDate());
} catch (ParseException e) {
    return "ERROR: æ—¥æœŸæ ¼å¼éŒ¯èª¤";
}
```
**ç›®çš„**ï¼šç¢ºä¿æ—¥æœŸæ¬„ä½å¯æ­£ç¢ºè§£æ

#### 7.3.4 ä¹æ­¥é©Ÿæ•¸æ“šå…¥åº«

**ä½ç½®**ï¼šPosSoPaidResultServices.processPosSoPaidResult():110-150

```java
// æ­¥é©Ÿ 1ï¼šæ’å…¥äº¤æ˜“ä¸»æª” TBL_TRANS_MAST
TblTransMast transMast = buildTransMast(vo);
tblTransMastMapper.insert(transMast);

// æ­¥é©Ÿ 2ï¼šæ’å…¥äº¤æ˜“æ˜ç´° TBL_TRANS_DETL
List<TblTransDetl> detlList = buildTransDetl(vo, transMast.getTransId());
for(TblTransDetl detl : detlList) {
    tblTransDetlMapper.insert(detl);
}

// æ­¥é©Ÿ 3ï¼šæ’å…¥ä»˜æ¬¾è¨˜éŒ„ TBL_TRANS_PAYMENT
List<TblTransPayment> paymentList = buildTransPayment(vo, transMast.getTransId());
for(TblTransPayment payment : paymentList) {
    tblTransPaymentMapper.insert(payment);
}

// æ­¥é©Ÿ 4ï¼šæ›´æ–°è¨‚å–®ä¸‹å‚³ç‹€æ…‹
TblOrder updateOrder = new TblOrder();
updateOrder.setOrderId(vo.getOrderId());
updateOrder.setPosDownload("1");  // å·²ä¸‹å‚³
updateOrder.setPosDownloadDate(new Date());
tblOrderMapper.updateByPrimaryKeySelective(updateOrder);

// æ­¥é©Ÿ 5ï¼šè™•ç†è¨‚é‡‘æŠµæ‰£
if(vo.getAdvanceAmt() != null && vo.getAdvanceAmt() > 0) {
    processAdvanceDeduction(vo);
}

// æ­¥é©Ÿ 6ï¼šæ›´æ–°é©—æ”¶å–®ç‹€æ…‹
updateAcceptanceStatus(vo.getOrderId());

// æ­¥é©Ÿ 7ï¼šæ›´æ–°è¨‚å–®ç‹€æ…‹
updateOrderStatus(vo.getOrderId(), "PAID");

// æ­¥é©Ÿ 8ï¼šæ’å…¥è¨‚å–®æ™‚é–“ç·š
insertOrderTimeline(vo.getOrderId(), "PAYMENT_COMPLETED", vo.getPaidDate());

// æ­¥é©Ÿ 9ï¼šè§¸ç™¼å¾ŒçºŒæµç¨‹ï¼ˆCRM å…¥éšŠï¼‰
triggerPostPaymentProcesses(vo);

return "OK";
```

**åŸå­æ€§ä¿è­‰**ï¼š
- æ•´å€‹éç¨‹åŒ…åœ¨ `@Transactional` è¨»è§£ä¸­
- ä»»ä½•æ­¥é©Ÿå¤±æ•—å‰‡å…¨éƒ¨å›æ»¾
- POS æ©Ÿå°æ”¶åˆ° "OK" è¡¨ç¤ºæ‰€æœ‰æ­¥é©ŸæˆåŠŸ

#### 7.3.5 CRM ç•°æ­¥åŒæ­¥

**å…¥éšŠæ™‚æ©Ÿ**ï¼šä¹æ­¥é©Ÿå…¥åº«çš„æ­¥é©Ÿ 9

**å…¥éšŠé‚è¼¯**ï¼š
```java
// PosSoPaidResultServices.triggerPostPaymentProcesses():245-267
private void triggerPostPaymentProcesses(PosSoPaidInfoVO vo) {
    TblWsQueue queue = new TblWsQueue();
    queue.setQueueType("CRM_MEMBER");  // éšŠåˆ—é¡å‹
    queue.setOrderId(vo.getOrderId());
    queue.setMemberId(vo.getMemberId());
    queue.setTransAmt(vo.getTotalAmt());
    queue.setSentFlag("0");  // æœªç™¼é€
    queue.setRetryCount(0);
    queue.setMaxRetry(3);
    queue.setCreateDate(new Date());

    tblWsQueueMapper.insert(queue);
}
```

**æ‰¹æ¬¡åŸ·è¡Œå™¨**ï¼šCrmMemberRunner

**ä½ç½®**ï¼š
```
C:\Projects\som\so-batchjob\src\main\java\
    com\trihome\som\so\batch\runner\CrmMemberRunner.java
```

**åŸ·è¡Œé€±æœŸ**ï¼šæ¯ 4-24 å°æ™‚ï¼ˆå¯é…ç½®ï¼‰

**æŸ¥è©¢å¾…è™•ç†éšŠåˆ—**ï¼š
```java
private static List<TblWsQueue> queryPendingQueue() {
    TblWsQueueCriteria criteria = new TblWsQueueCriteria();
    criteria.createCriteria()
        .andQueueTypeEqualTo("CRM_MEMBER")
        .andSentFlagEqualTo("0")           // æœªç™¼é€
        .andBreakFlagEqualTo("0")          // æœªä¸­æ–·
        .andRetryCountLessThan(3);         // é‡è©¦æ¬¡æ•¸ < 3

    criteria.setOrderByClause("CREATE_DATE ASC");

    return tblWsQueueMapper.selectByCriteria(criteria);
}
```

#### 7.3.6 CRM WSDL èª¿ç”¨

**WSDL ç«¯é»**ï¼š
```
http://crmjbtst.testritegroup.com/RFEP/service/MemberWebService?wsdl
```

**Client ä½ç½®**ï¼š
```
C:\Projects\som\so-webapp\src\main\java\
    com\trihome\som\so\ws\client\BatchMemberClient.java
```

**èª¿ç”¨æ–¹æ³•**ï¼š
```java
// BatchMemberClient.syncMemberTransaction():89-134
public boolean syncMemberTransaction(TblWsQueue queue) {
    try {
        // æ­¥é©Ÿ 1ï¼šçµ„è£ WSDL è«‹æ±‚
        MemberTransactionRequest request = buildRequest(queue);

        // æ­¥é©Ÿ 2ï¼šèª¿ç”¨ CRM Web Service
        MemberWebService service = new MemberWebService();
        MemberWebServiceSoap port = service.getMemberWebServiceSoap();

        MemberTransactionResponse response = port.updateMemberTransaction(request);

        // æ­¥é©Ÿ 3ï¼šè™•ç†å›æ‡‰
        if("SUCCESS".equals(response.getStatus())) {
            updateQueueSuccess(queue);
            return true;
        } else {
            updateQueueFailure(queue, response.getErrorCode(), response.getErrorMsg());
            return false;
        }

    } catch (Exception e) {
        logger.error("CRM åŒæ­¥å¤±æ•—: queueId={}, error={}",
                     queue.getQueueId(), e.getMessage());
        updateQueueFailure(queue, "EXCEPTION", e.getMessage());
        return false;
    }
}
```

#### 7.3.7 é‡è©¦æ©Ÿåˆ¶

**é‡è©¦é‚è¼¯**ï¼š
```java
private void updateQueueFailure(TblWsQueue queue, String errCode, String errMsg) {
    TblWsQueue update = new TblWsQueue();
    update.setQueueId(queue.getQueueId());
    update.setRetryCount(queue.getRetryCount() + 1);
    update.setLastError(errCode + ": " + errMsg);
    update.setLastRetryDate(new Date());

    // æª¢æŸ¥æ˜¯å¦é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸
    if(queue.getRetryCount() + 1 >= queue.getMaxRetry()) {
        update.setBreakFlag("1");  // åœæ­¢é‡è©¦
        update.setResult("FAILED");
        logger.warn("CRM åŒæ­¥é”åˆ°æœ€å¤§é‡è©¦æ¬¡æ•¸ï¼Œæ¨™è¨˜ä¸­æ–·: queueId={}",
                    queue.getQueueId());
    } else {
        update.setSentFlag("0");  // ä¿ç•™ä»¥ä¾›é‡è©¦
        logger.info("CRM åŒæ­¥å¤±æ•—ï¼Œå°‡æ–¼ä¸‹æ¬¡æ‰¹æ¬¡é‡è©¦: queueId={}, retryCount={}",
                    queue.getQueueId(), queue.getRetryCount() + 1);
    }

    tblWsQueueMapper.updateByPrimaryKeySelective(update);
}
```

**é‡è©¦ç­–ç•¥**ï¼š
- **æœ€å¤§é‡è©¦æ¬¡æ•¸**ï¼š3 æ¬¡
- **é‡è©¦é–“éš”**ï¼šæ‰¹æ¬¡åŸ·è¡Œé€±æœŸï¼ˆ4-24 å°æ™‚ï¼‰
- **é”åˆ°ä¸Šé™å¾Œ**ï¼šæ¨™è¨˜ BREAK_FLAG='1'ï¼Œåœæ­¢é‡è©¦
- **äººå·¥ä»‹å…¥**ï¼šéœ€è¦é‹ç¶­äººå“¡æª¢æŸ¥ä¸¦æ‰‹å‹•è™•ç†

---

### 7.4 æ¥­å‹™è¦å‰‡ç¸½çµ

#### 7.4.1 ç™¼ç¥¨è™Ÿæ®µç®¡ç†è¦å‰‡

| è¦å‰‡ ID | æè¿° | å„ªå…ˆç´š | å¯¦ä½œ |
|---------|-----|--------|------|
| **INV-R1** | æ¡ç”¨ä¸‰å±¤éš”é›¢ï¼ˆå¹´æœˆ/é–€åº—/POSï¼‰ | é—œéµ | TBL_STORE_POS_INVOICE PK |
| **INV-R2** | ä½¿ç”¨ç‹€æ…‹æ©Ÿç®¡ç†è™Ÿæ®µç”Ÿå‘½é€±æœŸ | é—œéµ | STATUS: 1/2/3/4 |
| **INV-R3** | è‡ªå‹•æ¿€æ´»é¸æ“‡æœ€å°èµ·å§‹è™Ÿçš„æœªä½¿ç”¨è™Ÿæ®µ | é«˜ | updateStatusForStatus1 SQL |
| **INV-R4** | è™Ÿæ®µç”¨ç›¡è‡ªå‹•è½‰ç‚º STATUS_3 | é—œéµ | updateInvoice():247 |
| **INV-R5** | ä¸‹æ¬¡èª¿ç”¨è‡ªå‹•æ¿€æ´»æ–°è™Ÿæ®µ | é«˜ | doQueryInvoice():153-160 |
| **INV-R6** | ç„¡å¯ç”¨è™Ÿæ®µæ‹‹å‡ºç•°å¸¸é˜»æ­¢çµå¸³ | é—œéµ | insertData():719-721 |
| **INV-R7** | è™Ÿç¢¼éå¢ä½¿ç”¨å·¦è£œé›¶ 8 ä½æ ¼å¼ | ä¸­ | computerNextInvNo() |
| **INV-R8** | æŒ‰ç¨…åˆ¥åˆ†é¡ç”¢ç”Ÿ 1-3 å¼µç™¼ç¥¨ | é«˜ | halndleInvoiceExtVO():438-452 |
| **INV-R9** | æ¯ç¨®ç¨…åˆ¥ç¨ç«‹å–è™Ÿ | é«˜ | insertData() åˆ†åˆ¥èª¿ç”¨ |
| **INV-R10** | ä½¿ç”¨ TBL_STORE_USED_INVOICE é˜²é‡ | é—œéµ | doQueryInvoice():172-180 |
| **INV-R11** | åŒæ­¥æ–¹æ³•ç¢ºä¿ä¸¦ç™¼å®‰å…¨ | é—œéµ | synchronized doQueryInvoice() |
| **INV-R12** | ç™¼ç¥¨è™Ÿç¢¼æ ¼å¼ï¼šå­—è»Œ+8ä½è™Ÿç¢¼ | ä¸­ | TRACK_ID + NEXT_INV_NO |
| **INV-R13** | æŸ¥è©¢ç•°å¸¸ï¼ˆå¤šç­† STATUS_2ï¼‰æ‹‹å‡ºéŒ¯èª¤ | é«˜ | doQueryInvoice():163-165 |
| **INV-R14** | è™Ÿæ®µå‰©é¤˜æ•¸é‡å¯¦æ™‚æ›´æ–° | é«˜ | USED_CNT+1, FREE_CNT-1 |
| **INV-R15** | ç™¼ç¥¨è™Ÿç¢¼èˆ‡è¨‚å–®é—œè¯å­˜æ–¼ TBL_TRANS_MAST | é«˜ | insertData():336-344 |

#### 7.4.2 POS åŒæ­¥è¦å‰‡

| è¦å‰‡ ID | æè¿° | å„ªå…ˆç´š | å¯¦ä½œ |
|---------|-----|--------|------|
| **POS-R1** | æ¡ç”¨ SOAP å³æ™‚åŒæ­¥æ©Ÿåˆ¶ | é—œéµ | PosSoPaidResultEndpoint |
| **POS-R2** | å››å±¤é©—è­‰ï¼šåºè™Ÿ/é‡è¤‡/ç™¼ç¥¨/æ—¥æœŸ | é—œéµ | processPosSoPaidResult():70-105 |
| **POS-R3** | ä¹æ­¥é©ŸåŸå­æ€§å…¥åº« | é—œéµ | @Transactional |
| **POS-R4** | é©—è­‰å¤±æ•—è¿”å›éŒ¯èª¤ç¢¼é˜»æ­¢æµç¨‹ | é—œéµ | return "ERROR: ..." |
| **POS-R5** | æˆåŠŸè¿”å› "OK" ç¢ºèª POS æ©Ÿå° | é«˜ | return "OK" |
| **POS-R6** | ä»»ä½•æ­¥é©Ÿå¤±æ•—å…¨éƒ¨å›æ»¾ | é—œéµ | Transaction rollback |

#### 7.4.3 CRM åŒæ­¥è¦å‰‡

| è¦å‰‡ ID | æè¿° | å„ªå…ˆç´š | å¯¦ä½œ |
|---------|-----|--------|------|
| **CRM-R1** | æ¡ç”¨éšŠåˆ—åŒ–ç•°æ­¥æ‰¹æ¬¡åŒæ­¥ | é—œéµ | TBL_WS_QUEUE + CrmMemberRunner |
| **CRM-R2** | ä»˜æ¬¾å®Œæˆå¾Œè‡ªå‹•å…¥éšŠ | é«˜ | triggerPostPaymentProcesses():245 |
| **CRM-R3** | æ‰¹æ¬¡åŸ·è¡Œé€±æœŸ 4-24 å°æ™‚å¯é…ç½® | ä¸­ | é…ç½®æª”æ¡ˆ |
| **CRM-R4** | æœ€å¤šé‡è©¦ 3 æ¬¡ | é«˜ | MAX_RETRY = 3 |
| **CRM-R5** | é”åˆ°é‡è©¦ä¸Šé™æ¨™è¨˜ä¸­æ–· | é«˜ | BREAK_FLAG='1' |
| **CRM-R6** | ä½¿ç”¨ WSDL èª¿ç”¨ CRM Web Service | é«˜ | BatchMemberClient + WSDL |
| **CRM-R7** | å¤±æ•—è¨˜éŒ„éŒ¯èª¤ç¢¼å’ŒéŒ¯èª¤è¨Šæ¯ | ä¸­ | LAST_ERROR æ¬„ä½ |

---

## 8. è³‡æ–™åº«æ¶æ§‹

### 8.1 æœƒå“¡æŠ˜æ‰£é…ç½®è¡¨

#### TBL_CDISCï¼ˆType 0/1/2ï¼‰
```sql
CREATE TABLE TBL_CDISC (
    DISCOUNT_ID      VARCHAR2(20),   -- æœƒå“¡æŠ˜æ‰£ IDï¼ˆå¾ disCardï¼‰
    CHANNEL_ID       VARCHAR2(10),   -- éŠ·å”®é€šè·¯ï¼ˆPOS é€šè·¯ï¼‰
    SKU_NO           VARCHAR2(20),   -- SKU æˆ– '000000000' ç”¨æ–¼è¬ç”¨å­—å…ƒ
    CLASS_ID         VARCHAR2(10),   -- ç”¢å“é¡åˆ¥
    SUB_DEPT_ID      VARCHAR2(10),   -- å­éƒ¨é–€
    SUB_CLASS_ID     VARCHAR2(10),   -- å­é¡åˆ¥
    DISC_TYPE        VARCHAR2(2),    -- '0'=æŠ˜æ‰£ï¼Œ'1'=é™æ¯›åˆ©ï¼Œ'2'=æˆæœ¬åŠ æˆ
    DISC_PER         NUMBER(5,2),    -- æŠ˜æ‰£%ï¼ˆä¾‹å¦‚ï¼Œ15.00 = 15%ï¼‰
    START_DATE       DATE,           -- ç”Ÿæ•ˆé–‹å§‹
    END_DATE         DATE,           -- ç”Ÿæ•ˆçµæŸ
    DESCRITPION      VARCHAR2(200),  -- æè¿°
    DSC_SKU          VARCHAR2(1),    -- å¯æŠ˜æ‰£æ——æ¨™ï¼ˆ'Y'/'N'ï¼‰
    NDSC_SKU         VARCHAR2(1),    -- ä¸å¯æŠ˜æ‰£æ——æ¨™ï¼ˆ'Y'/'N'ï¼‰
    PRIMARY KEY (DISCOUNT_ID, CHANNEL_ID, SKU_NO, CLASS_ID, SUB_DEPT_ID, SUB_CLASS_ID)
);
```

#### TBL_CGROUPï¼ˆType CTï¼‰
```sql
CREATE TABLE TBL_CGROUP (
    DISCOUNT_ID      VARCHAR2(20),   -- æœƒå“¡ç¾¤çµ„ IDï¼ˆå¾ groupIdï¼‰
    CHANNEL_ID       VARCHAR2(10),   -- éŠ·å”®é€šè·¯
    SKU_NO           VARCHAR2(20),   -- SKU æˆ– '000000000' ç”¨æ–¼è¬ç”¨å­—å…ƒ
    CLASS_ID         VARCHAR2(10),   -- ç”¢å“é¡åˆ¥
    SUB_DEPT_ID      VARCHAR2(10),   -- å­éƒ¨é–€
    SUB_CLASS_ID     VARCHAR2(10),   -- å­é¡åˆ¥
    DISC_PER         NUMBER(5,2),    -- æŠ˜æ‰£ç™¾åˆ†æ¯”
    START_DATE       DATE,           -- ç”Ÿæ•ˆé–‹å§‹
    END_DATE         DATE,           -- ç”Ÿæ•ˆçµæŸ
    DESCRITPION      VARCHAR2(200),  -- æè¿°
    DSC_SKU          VARCHAR2(1),    -- å¯æŠ˜æ‰£æ——æ¨™
    NDSC_SKU         VARCHAR2(1),    -- ä¸å¯æŠ˜æ‰£æ——æ¨™
    DISC_TYPE        VARCHAR2(2),    -- Type CT æœªä½¿ç”¨
    PRIMARY KEY (DISCOUNT_ID, CHANNEL_ID, SKU_NO, CLASS_ID, SUB_DEPT_ID, SUB_CLASS_ID)
);
```

### 8.2 å–®ä½æˆæœ¬ä¾†æºè¡¨

#### TBL_SKU_STOREï¼ˆType 2 æˆæœ¬ä¾†æºï¼‰
```sql
CREATE TABLE TBL_SKU_STORE (
    STORE_ID         VARCHAR2(20),
    SKU_NO           VARCHAR2(20),
    AVG_COST         NUMBER(10,2),   -- â­ Type 2 çš„å¹³å‡æˆæœ¬
    STOCK_AOH        NUMBER(10),     -- å¯ç”¨é‡
    MARKET_PRICE     NUMBER(10),     -- å¸‚å ´åƒ¹æ ¼
    REGULAR_PRICE    NUMBER(10),     -- æ­£å¸¸å”®åƒ¹
    -- ... å…¶ä»–æ¬„ä½
    PRIMARY KEY (STORE_ID, SKU_NO)
);
```

**âš ï¸ è³‡æ–™å“è³ªè¦æ±‚**ï¼š
- AVG_COST å¿…é ˆå®šæœŸæ›´æ–°ï¼ˆå»ºè­°æ¯æ™šæ‰¹æ¬¡ï¼‰
- NULL æˆ– 0 å€¼é˜²æ­¢ Type 2 æ‡‰ç”¨
- æ‡‰é©—è­‰ AVG_COST < REGULAR_PRICEï¼ˆå¥å…¨æ€§æª¢æŸ¥ï¼‰

### 8.3 è¨‚å–®æ˜ç´°è¡¨ï¼ˆçµæœæŒä¹…åŒ–ï¼‰

#### TBL_ORDER_DETL
```sql
CREATE TABLE TBL_ORDER_DETL (
    ORDER_ID                VARCHAR2(50),
    DETL_SEQ_ID             VARCHAR2(10),
    SKU_NO                  VARCHAR2(20),
    GOODS_TYPE              VARCHAR2(5),    -- P, I, IA, IS, IE, IC, DD, VD
    SUB_DEPT_ID             VARCHAR2(10),   -- ç”¨æ–¼é¡åˆ¥æ’é™¤æª¢æŸ¥

    -- å®šåƒ¹æ¬„ä½
    POS_AMT                 NUMBER(10),     -- åŸå§‹å”®åƒ¹
    ACT_POS_AMT             NUMBER(10),     -- å¯¦éš›åƒ¹æ ¼ï¼ˆType 1/2 å¾Œï¼‰
    TOTAL_PRICE             NUMBER(10),     -- actPosAmt Ã— qty
    UNIT_COST               NUMBER(10,2),   -- â­ ç”¨æ–¼ Type 2 è¨ˆç®—

    -- å·¥ç¨®åˆ†æ”¤
    PRE_APPORTION           NUMBER(10),     -- â­ åˆ†æ”¤å·¥ç¨®åƒ¹æ ¼
    INSTALL_PRICE           NUMBER(10),     -- æ¯å–®ä½å®‰è£åƒ¹æ ¼
    DELIVERY_PRICE          NUMBER(10),     -- æ¯å–®ä½é‹é€åƒ¹æ ¼

    -- åƒ¹æ ¼è®Šæ›´æ——æ¨™
    POS_AMT_CHANGE_PRICE    VARCHAR2(1),    -- â­ å¦‚æœ Type 1/2 æ‡‰ç”¨å‰‡ç‚º 'Y'
    INSTALL_CHANGE_PRICE    VARCHAR2(1),    -- â­ å¦‚æœå®‰è£åƒ¹æ ¼è®Šæ›´å‰‡ç‚º 'Y'
    DELIVERY_CHANGE_PRICE   VARCHAR2(1),    -- â­ å¦‚æœé‹é€åƒ¹æ ¼è®Šæ›´å‰‡ç‚º 'Y'

    -- æœƒå“¡æŠ˜æ‰£
    MEMBER_DISC             VARCHAR2(10),   -- æœƒå“¡æŠ˜æ‰£é‡‘é¡
    CRM_DISCOUNT_ID         VARCHAR2(20),   -- æ‡‰ç”¨çš„æŠ˜æ‰£ ID

    -- ç¨…é‡‘
    TAX_TYPE                VARCHAR2(1),    -- '1'=æ‡‰ç¨…ï¼Œ'2'=å…ç¨…

    -- å…¶ä»–
    QUANTITY                NUMBER(10),
    DISCOUNT_AMT            VARCHAR2(10),   -- ä¿ƒéŠ·æŠ˜æ‰£
    BONUS_TOTAL             VARCHAR2(10),   -- ä½¿ç”¨çš„ç´…åˆ©é»æ•¸
    OPEN_PRICE              VARCHAR2(1),    -- 'Y'=é–‹åƒ¹
    -- ... å…¶ä»–æ¬„ä½

    PRIMARY KEY (ORDER_ID, DETL_SEQ_ID)
);
```

---

## 9. æ¸¬è©¦å ´æ™¯

### 9.1 æœƒå“¡æŠ˜æ‰£æ¸¬è©¦å ´æ™¯

åƒè€ƒå€‹åˆ¥è¿½è¹¤æ–‡ä»¶å–å¾—è©³ç´°æ¸¬è©¦å ´æ™¯ï¼š
- **Type 0/1**ï¼šåƒè¦‹ OpenSpecï¼ˆèˆŠç‰ˆï¼‰æ¸¬è©¦å ´æ™¯
- **Type 2**ï¼šåƒè¦‹ TYPE2-COST-MARKUP-DISCOUNT-TRACE.md å ´æ™¯ 1-5
- **Type CT**ï¼šåƒè¦‹ SPECIAL-MEMBER-DISCOUNT-TRACE.md å ´æ™¯ 1-5

### 9.2 å·¥ç¨®åˆ†æ”¤æ¸¬è©¦å ´æ™¯

åƒè€ƒ WORKTYPE-PRICE-APPORTIONMENT-TRACE.md å ´æ™¯ 1-4ï¼š
1. æ¨™æº–æ¯”ä¾‹åˆ†é…
2. å…è²»å®‰è£ï¼ˆé›¶åˆ†æ”¤ï¼‰
3. æœ€å¾Œé …ç›®å¸æ”¶é¤˜é¡
4. å–®é …ç›®è¨‚å–®ï¼ˆç„¡éœ€åˆ†é…ï¼‰

### 9.3 æ•´åˆæ¸¬è©¦å ´æ™¯

**å ´æ™¯ 1ï¼šå®Œæ•´å®šåƒ¹æµç¨‹**
```
è¨­å®šï¼š
  æœƒå“¡ï¼šVIP å¡å…·æœ‰ Type 0 æŠ˜æ‰£ï¼ˆ10%ï¼‰
  è¨‚å–®ï¼š3 å€‹é …ç›®ï¼Œç¸½è¨ˆ 10,000 TWD
  å®‰è£ï¼š500 TWD
  ä¿ƒéŠ·ï¼šé …ç›®ä¸Š 500 TWD æŠ˜æ‰£
  ç¨…é‡‘ï¼šæ‡‰ç¨…é …ç›®ï¼Œç‡Ÿæ¥­ç¨… 1.05

åŸ·è¡Œæµç¨‹ï¼š
  1. è¼‰å…¥å–®ä½æˆæœ¬ â†’ æ‰€æœ‰é …ç›®æœ‰ unitCost å¡«å……
  2. æ‡‰ç”¨ä¿ƒéŠ· â†’ items.discountAmt = 500 TWD
  3. æ‡‰ç”¨ Type 0 æŠ˜æ‰£ â†’ è¨ˆç®— memberDisc
  4. åˆ†æ”¤å®‰è£ â†’ åˆ†é… 500 TWD
  5. è¨ˆç®—ç¨…é‡‘ â†’ æ‡‰ç¨…é …ç›® Ã— 1.05
  6. è¨ˆç®—ç¸½é¡ â†’ å½™ç¸½æ‰€æœ‰é …ç›®

é æœŸçµæœï¼š
  æ‰€æœ‰å®šåƒ¹çµ„æˆæ­£ç¢ºè¨ˆç®—
  æœ€çµ‚ç¸½é¡åŒ¹é…æ‰‹å‹•è¨ˆç®—
  æ‰€æœ‰æ¬„ä½æŒä¹…åŒ–åˆ° TBL_ORDER_DETL
```

**å ´æ™¯ 2ï¼šäº’æ–¥æ¸¬è©¦**
```
è¨­å®šï¼š
  æœƒå“¡ï¼šåŒæ™‚æœ‰ disCard å’Œ groupId
  è¨‚å–®ï¼š2 å€‹é …ç›®
  é…ç½®ï¼š
    - é …ç›® 1 åŒ¹é… Type 0ï¼ˆdisCard é…ç½®ï¼‰
    - é …ç›® 2 åŒ¹é… Type CTï¼ˆgroupId é…ç½®ï¼‰

åŸ·è¡Œæµç¨‹ï¼š
  1. æŸ¥è©¢ Type 0 â†’ é …ç›® 1 åŒ¹é…
  2. memberDiscSkus.size() = 1ï¼ˆéç©ºï¼‰
  3. è·³é Type CT è¨ˆç®—
  4. é …ç›® 2 ä¸ç²å¾—æŠ˜æ‰£

é æœŸçµæœï¼š
  åƒ…é …ç›® 1 ç²å¾—æŠ˜æ‰£ï¼ˆType 0ï¼‰
  é …ç›® 2 ç„¡æŠ˜æ‰£æ‡‰ç”¨
  ç¢ºèªã€Œå…¨æœ‰æˆ–å…¨ç„¡ã€è¡Œç‚º
```

**å ´æ™¯ 3ï¼šé¡åˆ¥æ’é™¤æ¸¬è©¦**
```
è¨­å®šï¼š
  æœƒå“¡ï¼šVIP å…·æœ‰ Type 2 æŠ˜æ‰£ï¼ˆ20% åŠ æˆï¼‰
  è¨‚å–®ï¼š2 å€‹é …ç›®
    - é …ç›® Aï¼šSUB_DEPT_ID = '001'ï¼ˆæ­£å¸¸ï¼‰
    - é …ç›® Bï¼šSUB_DEPT_ID = '025'ï¼ˆé‹è¼¸ï¼Œæ’é™¤ï¼‰

åŸ·è¡Œæµç¨‹ï¼š
  1. ç‚º Type 2 ç¯©é¸é …ç›®
  2. é …ç›® Aï¼šåŒ…å«ï¼ˆé€šéæ’é™¤æª¢æŸ¥ï¼‰
  3. é …ç›® Bï¼šæ’é™¤ï¼ˆcheckSkuSubDeptId è¿”å› trueï¼‰
  4. åƒ…å°é …ç›® A æ‡‰ç”¨ Type 2

é æœŸçµæœï¼š
  é …ç›® Aï¼šType 2 æŠ˜æ‰£å·²æ‡‰ç”¨
  é …ç›® Bï¼šç„¡æŠ˜æ‰£ï¼ˆå·²æ’é™¤ï¼‰
  é …ç›® B ä¿æŒåŸåƒ¹
```

---

## 10. å¯¦ä½œæŒ‡å¼•

### 10.1 TypeScript å‹åˆ¥å®šç¾©

åƒè¦‹å€‹åˆ¥è¿½è¹¤æ–‡ä»¶å–å¾—å®Œæ•´ TypeScript å®šç¾©ï¼š
- **Type 2**ï¼šTYPE2-COST-MARKUP-DISCOUNT-TRACE.md ç¬¬ 8 ç¯€
- **Type CT**ï¼šSPECIAL-MEMBER-DISCOUNT-TRACE.md ç¬¬ 8 ç¯€
- **åˆ†æ”¤**ï¼šWORKTYPE-PRICE-APPORTIONMENT-TRACE.md ç¬¬ 8 ç¯€

### 10.2 æœå‹™ä»‹é¢è¨­è¨ˆ

```typescript
/**
 * æœƒå“¡æŠ˜æ‰£æœå‹™
 */
export interface IMemberDiscountService {
  /**
   * ç‚ºè¨‚å–®è¨ˆç®—æœƒå“¡æŠ˜æ‰£
   * ä¾åºåŸ·è¡Œï¼šType 0 â†’ Type 1 â†’ Type 2 â†’ Type CTï¼ˆå›é€€ï¼‰
   */
  calculateMemberDiscount(
    items: OrderItem[],
    memberCardId: string,
    channelId: string,
    isZeroTax: boolean
  ): Promise<MemberDiscountResult>;

  /**
   * å¾ CRM æŸ¥è©¢æœƒå“¡æŠ˜æ‰£é…ç½®
   */
  getMemberDiscountConfig(
    memberCardId: string
  ): Promise<MemberDiscountConfig>;

  /**
   * é©—è­‰æŠ˜æ‰£æ‡‰ç”¨
   * - æª¢æŸ¥é¡åˆ¥æ’é™¤
   * - é˜²æ­¢è² æŠ˜æ‰£ï¼ˆType 2ï¼‰
   * - é©—è­‰å–®ä½æˆæœ¬å¯ç”¨æ€§
   */
  validateDiscountApplication(
    items: OrderItem[],
    discountType: '0' | '1' | '2' | 'CT'
  ): Promise<ValidationResult>;
}

/**
 * å·¥ç¨®åˆ†æ”¤æœå‹™
 */
export interface IWorkTypeApportionmentService {
  /**
   * å°‡å·¥ç¨®åƒ¹æ ¼åˆ†æ”¤çµ¦é …ç›®
   */
  apportionWorkTypePrices(
    items: OrderItem[],
    workTypes: WorkType[]
  ): Promise<ApportionmentResult>;
}

/**
 * ç¨…é‡‘è¨ˆç®—æœå‹™
 */
export interface ITaxCalculationService {
  /**
   * ç‚ºé …ç›®è¨ˆç®—ç‡Ÿæ¥­ç¨…
   * æ ¹æ“šæŠ˜æ‰£é¡å‹ä½¿ç”¨é©ç•¶çš„å››æ¨äº”å…¥
   */
  calculateSalesTax(
    preTaxAmount: number,
    taxType: '1' | '2',
    discountType: '0' | '1' | '2' | 'CT',
    isZeroTax: boolean,
    salesTaxRate?: number
  ): number;
}
```

### 10.3 é—œéµå¯¦ä½œæª¢æŸ¥æ¸…å–®

**å¯¦ä½œé–‹å§‹å‰**ï¼š
- [ ] æ¥­å‹™ç¶“ç†æ ¸å‡† Type 2 è² æŠ˜æ‰£æ”¿ç­–ï¼ˆæ–¹æ¡ˆ A/B/Cï¼‰
- [ ] è²¡å‹™ç¶“ç†æ ¸å‡†ç¨…é‡‘å››æ¨äº”å…¥æ”¿ç­–ï¼ˆä¸€è‡´æˆ–ä¸åŒï¼‰
- [ ] ç”¢å“ç¶“ç†ç¢ºèªæ‰€æœ‰ 10 æ¢è‡ªå‹•è§¸ç™¼è¦å‰‡
- [ ] é¡åˆ¥æ’é™¤æ¸…å–®å·²ç¢ºèªï¼ˆ025/026 + å…¶ä»–ï¼Ÿï¼‰
- [ ] å–®ä½æˆæœ¬ä¾†æºå·²ç¢ºèªï¼ˆAVG_COST + æ›´æ–°é »ç‡ï¼‰

**å¯¦ä½œæœŸé–“**ï¼š
- [ ] æ–°å¢é©—è­‰ï¼šé˜²æ­¢ Type 2 è² æŠ˜æ‰£
- [ ] æ–°å¢é©—è­‰ï¼šType 2 å‰å–®ä½æˆæœ¬é NULL/0
- [ ] æ–°å¢é©—è­‰ï¼šé¡åˆ¥æ’é™¤æª¢æŸ¥ï¼ˆå¯é…ç½®æ¸…å–®ï¼‰
- [ ] å¯¦ä½œå…©éšæ®µåŒ¹é…ï¼ˆç²¾ç¢º SKU â†’ è¬ç”¨å­—å…ƒï¼‰
- [ ] å¯¦ä½œé¤˜é¡å¸æ”¶é‚è¼¯
- [ ] å¯¦ä½œäº’æ–¥ï¼ˆType CT å›é€€ï¼‰
- [ ] æ­£ç¢ºè¨­å®šåƒ¹æ ¼è®Šæ›´æ——æ¨™ï¼ˆType 1/2ï¼‰
- [ ] æ‡‰ç”¨ä¿ƒéŠ·åŠ å›ï¼ˆType 0/CTï¼‰
- [ ] æ¯å€‹æŠ˜æ‰£é¡å‹ä½¿ç”¨æ­£ç¢ºçš„ç¨…é‡‘å››æ¨äº”å…¥
- [ ] åˆªé™¤ç¬¬ 508 è¡Œé‡è¤‡è³¦å€¼ï¼ˆå¦‚ç¢ºèªç‚º bugï¼‰

**æ¸¬è©¦è¦æ±‚**ï¼š
- [ ] æ¯å€‹æŠ˜æ‰£é¡å‹çš„å–®å…ƒæ¸¬è©¦ï¼ˆè‡³å°‘ 14 å€‹å ´æ™¯ï¼‰
- [ ] å®Œæ•´å®šåƒ¹æµç¨‹çš„æ•´åˆæ¸¬è©¦
- [ ] æ•ˆèƒ½æ¸¬è©¦ï¼ˆ1000 é …è¨‚å–®ï¼‰
- [ ] è³‡æ–™å“è³ªæ¸¬è©¦ï¼ˆç¼ºå¤±/é›¶å–®ä½æˆæœ¬ï¼‰
- [ ] è² æŠ˜æ‰£é˜²æ­¢æ¸¬è©¦
- [ ] é¡åˆ¥æ’é™¤æ¸¬è©¦
- [ ] ç¨…é‡‘å››æ¨äº”å…¥é‚Šç•Œæ¸¬è©¦
- [ ] äº’æ–¥æ¸¬è©¦

---

## 11. å¾…è§£æ±ºå•é¡Œèˆ‡éœ€è¦çš„æ±ºç­–

### 11.1 é—œéµæ±ºç­–ï¼ˆç¬¬2-3é€±æœƒè­°ï¼‰

| å•é¡Œ | éœ€è¦æ±ºç­–è€… | é¸é … | å½±éŸ¿ |
|-----|-----------|-----|------|
| ğŸš¨ **Type 2 è² æŠ˜æ‰£** | æ¥­å‹™ç¶“ç† | Aï¼šé˜²æ­¢ / Bï¼šé™åˆ¶ / Cï¼šå…è¨± | é—œéµ - æ³•å¾‹/å“ç‰Œé¢¨éšª |
| âš ï¸ **ç¨…é‡‘å››æ¨äº”å…¥æ”¿ç­–** | è²¡å‹™ç¶“ç† | Aï¼šæ¨™æº–åŒ– ceil / Bï¼šæ¨™æº–åŒ– floor / Cï¼šä¿æŒä¸åŒ | é«˜ - æœƒè¨ˆ/æ¸¬è©¦ |
| âš ï¸ **ç¬¬ 508 è¡Œé‡è¤‡** | æŠ€è¡“ä¸»ç®¡ | åˆªé™¤æˆ–ä¿ç•™ | é«˜ - ç¨‹å¼ç¢¼å“è³ª |
| âš ï¸ **é¡åˆ¥æ’é™¤ç†ç”±** | ç”¢å“ç¶“ç† | è¨˜éŒ„ + ç¢ºèªæ¸…å–® | ä¸­ - æ¥­å‹™è¦å‰‡ |

### 11.2 éœ€è¦ç¢ºèªï¼ˆPM éƒµä»¶å›è¦†ï¼‰

| è¦å‰‡ # | è‡ªå‹•è§¸ç™¼è¦å‰‡ | ç‹€æ…‹ | æœŸé™ |
|--------|-------------|------|------|
| 1 | æœƒå“¡æŠ˜æ‰£å„ªå…ˆé †åº | â³ å¾…è™•ç† | ç¬¬2é€± |
| 2 | äº’æ–¥è¡Œç‚º | â³ å¾…è™•ç† | ç¬¬2é€± |
| 3 | é¡åˆ¥æ’é™¤ï¼ˆ025/026ï¼‰ | â³ å¾…è™•ç† | ç¬¬2é€± |
| 4 | è¬ç”¨å­—å…ƒ SKU '000000000' | â³ å¾…è™•ç† | ç¬¬2é€± |
| 5 | å…è²»å®‰è£é›¶åˆ†æ”¤ | â³ å¾…è™•ç† | ç¬¬2é€± |
| 6 | é¤˜é¡å¸æ”¶æ”¿ç­– | â³ å¾…è™•ç† | ç¬¬2é€± |
| 7 | å–®ä½æˆæœ¬ä¾†æºï¼ˆAVG_COSTï¼‰ | â³ å¾…è™•ç† | ç¬¬2é€± |
| 8 | Type 2 ç¨…é‡‘å››æ¨äº”å…¥ï¼ˆfloorï¼‰ | â³ å¾…è™•ç† | ç¬¬2é€± |
| 9 | åƒ¹æ ¼è®Šæ›´æ——æ¨™è¡Œç‚º | â³ å¾…è™•ç† | ç¬¬2é€± |
| 10 | Type 2 å…ç¨…ç¸½é¡æ’é™¤ | â³ å¾…è™•ç† | ç¬¬2é€± |

### 11.3 éœ€è¦ç ”ç©¶

| ä¸»é¡Œ | è¡Œå‹• | è² è²¬äºº | æœŸé™ |
|-----|------|--------|------|
| 2020-05-07 ç¨…é‡‘å››æ¨äº”å…¥è®Šæ›´ | ç ”ç©¶è®Šæ›´è«‹æ±‚/éƒµä»¶ | æŠ€è¡“ä¸»ç®¡ | ç¬¬2é€± |
| æ­·å²è² æŠ˜æ‰£ | åŸ·è¡Œ SQL åˆ†ææŸ¥è©¢ | QA ä¸»ç®¡ | æœƒå‰ |
| é¡åˆ¥ 025/026 ä½¿ç”¨ | åŸ·è¡Œä½¿ç”¨åˆ†ææŸ¥è©¢ | æ¥­å‹™åˆ†æå¸« | æœƒå‰ |
| å–®ä½æˆæœ¬æ›´æ–°é »ç‡ | æª¢æŸ¥æ‰¹æ¬¡ä½œæ¥­æ’ç¨‹ | ç‡Ÿé‹ | ç¬¬2é€± |

### 11.4 æ–‡ä»¶ä»»å‹™

| ä»»å‹™ | è² è²¬äºº | ç‹€æ…‹ | æœŸé™ |
|-----|--------|------|------|
| æ›´æ–° OpenSpec æ£„ç”¨é€šçŸ¥ | ç”¢å“ç¶“ç† | â³ å¾…è™•ç† | ç¬¬2é€± |
| å®šç¨¿ Rewrite-Spec v1.2 | æŠ€è¡“æ–‡ä»¶å·¥ç¨‹å¸« | â³ è‰ç¨¿ | ç¬¬3é€± |
| å¾å ´æ™¯å»ºç«‹æ¸¬è©¦è¨ˆç•« | QA ä¸»ç®¡ | â³ å¾…è™•ç† | ç¬¬3é€± |
| è¨­è¨ˆå¯©æŸ¥ç°¡å ± | æŠ€è¡“ä¸»ç®¡ | â³ å¾…è™•ç† | ç¬¬3é€± |

---

## é™„éŒ„ Aï¼šè®Šæ›´æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | è®Šæ›´ |
|------|------|------|------|
| 1.0 | 2025-10-20 | åœ˜éšŠ | åˆå§‹ OpenSpecï¼ˆèˆŠç‰ˆï¼‰ |
| 1.1 | 2025-10-25 | åœ˜éšŠ | æ–°å¢æœƒå“¡æŠ˜æ‰£åŸ·è¡Œé †åº |
| 1.2ï¼ˆè‰ç¨¿ï¼‰ | 2025-10-27 | åœ˜éšŠ | Phase 1ï¼šåŸºæ–¼ç¨‹å¼ç¢¼è¿½è¹¤çš„å®Œæ•´å®šåƒ¹é‚è¼¯é‡å¯« |
| 1.3ï¼ˆè‰ç¨¿ï¼‰ | 2025-10-28 | åœ˜éšŠ | Phase 2ï¼šæ–°å¢å®Œæ•´ä¿ƒéŠ·é‚è¼¯ç« ç¯€ |
| 1.4ï¼ˆè‰ç¨¿ï¼‰ | 2025-10-28 | åœ˜éšŠ | Phase 3ï¼šæ–°å¢å®Œæ•´ä»˜æ¬¾æµç¨‹ç« ç¯€ |

**v1.4 ä¸»è¦æ–°å¢**ï¼ˆPhase 3 Week 4ï¼‰ï¼š
- å®Œæ•´ç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥èˆ‡åˆ†é…ç« ç¯€ï¼ˆ7.2ï¼‰
- ä¸‰å±¤éš”é›¢æ©Ÿåˆ¶èˆ‡ç‹€æ…‹æ©Ÿæ¨¡å¼
- è‡ªå‹•æ¿€æ´»èˆ‡è™Ÿæ®µç”¨ç›¡è™•ç†é‚è¼¯
- å®Œæ•´ POS èˆ‡ CRM åŒæ­¥æ©Ÿåˆ¶ç« ç¯€ï¼ˆ7.3ï¼‰
- å…©å±¤åŒæ­¥æ¶æ§‹ï¼ˆå³æ™‚ + ç•°æ­¥ï¼‰
- å››å±¤é©—è­‰æ©Ÿåˆ¶èˆ‡ä¹æ­¥é©ŸåŸå­æ€§å…¥åº«
- CRM ç•°æ­¥æ‰¹æ¬¡åŒæ­¥èˆ‡é‡è©¦æ©Ÿåˆ¶
- è¨˜éŒ„ 28 æ¢æ¥­å‹™è¦å‰‡ï¼ˆINV-R1-R15, POS-R1-R6, CRM-R1-R7ï¼‰
- å®Œæ•´ä»˜æ¬¾æµç¨‹è¿½è¹¤ï¼ˆç™¼ç¥¨ + POS + CRMï¼‰

**v1.3 ä¸»è¦æ–°å¢**ï¼ˆPhase 2 Week 3ï¼‰ï¼š
- å®Œæ•´ä¿ƒéŠ·äº‹ä»¶å„ªå…ˆç´šèˆ‡æ¬Šå¨ç« ç¯€ï¼ˆ6.1ï¼‰
- LIMIT_QTY æº¢ä½è™•ç†æ¨¡å¼èˆ‡éŒ¯èª¤åˆ†æï¼ˆ6.2ï¼‰
- è·¨é¡ä¿ƒéŠ·ç–ŠåŠ è¦å‰‡èˆ‡ä¸‰å±¤é˜²è­·æ©Ÿåˆ¶ï¼ˆ6.3ï¼‰
- Event A-H å¯¦ä½œæ‘˜è¦èˆ‡æ¥­å‹™è¦å‰‡ï¼ˆ6.4ï¼‰
- è¨˜éŒ„ 40 æ¢æ¥­å‹™è¦å‰‡ï¼ˆPROMO-R1-R4, LIMIT-R1-R5, STACK-R1-R7, EVENT-R1-R12ï¼‰
- å·²è­˜åˆ¥ 4 å€‹ä¿ƒéŠ·é‚è¼¯é—œéµéŒ¯èª¤
- å®Œæ•´ç–ŠåŠ è¦å‰‡çŸ©é™£ï¼ˆ8x8 è¦å‰‡è¡¨ï¼‰

**v1.2 ä¸»è¦æ–°å¢**ï¼ˆPhase 1 Week 1-2ï¼‰ï¼š
- å…·å–®ä½æˆæœ¬ä¾†æºè¿½è¹¤çš„å®Œæ•´ Type 2ï¼ˆæˆæœ¬åŠ æˆï¼‰ç« ç¯€
- å…·äº’æ–¥é‚è¼¯çš„å®Œæ•´ Type CTï¼ˆç‰¹æ®Šæœƒå“¡æŠ˜æ‰£ï¼‰ç« ç¯€
- å®Œæ•´å·¥ç¨®åƒ¹æ ¼åˆ†æ”¤ç« ç¯€
- å…·å››æ¨äº”å…¥å·®ç•°çš„å®Œæ•´ç¨…é‡‘è¨ˆç®—æ”¿ç­–ç« ç¯€
- è·¨ 3 å€‹å®šåƒ¹é ˜åŸŸçš„ 14 å€‹æ¸¬è©¦å ´æ™¯
- è¨˜éŒ„ 27 æ¢æ¥­å‹™è¦å‰‡ï¼ˆMBR-R1-R12, APP-R1-R6, TAX-R1-R7ï¼‰
- å·²è­˜åˆ¥ä¸¦ä¸Šå ±å®šåƒ¹é‚è¼¯é—œéµå•é¡Œ
- éœ€è¦ç¢ºèªçš„ 10 æ¢è‡ªå‹•è§¸ç™¼è¦å‰‡

---

## é™„éŒ„ Bï¼šåƒè€ƒè³‡æ–™

**Phase 3 ä¾†æºè¿½è¹¤æ–‡ä»¶**ï¼ˆä»˜æ¬¾æµç¨‹ï¼‰ï¼š
1. ç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥è¿½è¹¤.mdï¼ˆ800+ è¡Œï¼‰
2. POS-CRMåŒæ­¥è¿½è¹¤.mdï¼ˆ1,000+ è¡Œï¼‰

**Phase 2 ä¾†æºè¿½è¹¤æ–‡ä»¶**ï¼ˆä¿ƒéŠ·é‚è¼¯ï¼‰ï¼š
1. ä¿ƒéŠ·äº‹ä»¶å„ªå…ˆç´šè¿½è¹¤.mdï¼ˆ1,200 è¡Œï¼‰
2. ä¿ƒéŠ·æ•¸é‡é™åˆ¶æº¢ä½è™•ç†è¿½è¹¤.mdï¼ˆ1,400 è¡Œï¼‰
3. è·¨é¡ä¿ƒéŠ·ç–ŠåŠ è¦å‰‡è¿½è¹¤.mdï¼ˆ1,800 è¡Œï¼‰
4. promotion-management/spec.mdï¼ˆ1,900+ è¡Œï¼‰

**Phase 1 ä¾†æºè¿½è¹¤æ–‡ä»¶**ï¼ˆå®šåƒ¹é‚è¼¯ï¼‰ï¼š
1. WORKTYPE-PRICE-APPORTIONMENT-TRACE.mdï¼ˆ892 è¡Œï¼‰
2. SPECIAL-MEMBER-DISCOUNT-TRACE.mdï¼ˆ1,096 è¡Œï¼‰
3. TYPE2-COST-MARKUP-DISCOUNT-TRACE.mdï¼ˆ1,596 è¡Œï¼‰

**ç¸½ä¾†æºææ–™**ï¼š
- Phase 1: 3,584 è¡Œå®šåƒ¹é‚è¼¯åˆ†æ
- Phase 2: 6,300+ è¡Œä¿ƒéŠ·é‚è¼¯åˆ†æ
- Phase 3: 1,800+ è¡Œä»˜æ¬¾æµç¨‹åˆ†æ
- **ç¸½è¨ˆ**ï¼š11,684+ è¡Œå…¨é¢ç¨‹å¼ç¢¼åˆ†æ

**æ¥­å‹™ç¢ºèªææ–™**ï¼š
1. BUSINESS-CONFIRMATION-MEETING-AGENDA.md
2. PM-EMAIL-DRAFT-AUTO-TRIGGER-PRICING.md

**ç›¸é—œè¦æ ¼**ï¼š
1. OpenSpecï¼ˆèˆŠç‰ˆï¼‰- å°‡æ£„ç”¨
2. BUSINESS-LOGIC-GAP-ANALYSIS.md
3. BUSINESS-LOGIC-COVERAGE-EVALUATION.md

---

**Rewrite-Spec v1.4 - å®šåƒ¹ã€ä¿ƒéŠ·èˆ‡ä»˜æ¬¾æµç¨‹ç« ç¯€æ›´æ–°çµæŸ**

---

**æ–‡ä»¶ç‹€æ…‹**ï¼šâœ… v1.4 è‰ç¨¿å®Œæˆ - æº–å‚™æ¥­å‹™å¯©æŸ¥

**Phase 3 å®Œæˆæˆæœ**ï¼š
- âœ… æ–°å¢ Section 7ï¼šå®Œæ•´ä»˜æ¬¾æµç¨‹ç« ç¯€ï¼ˆ520+ è¡Œï¼‰
- âœ… è¨˜éŒ„ 28 æ¢ä»˜æ¬¾æ¥­å‹™è¦å‰‡ï¼ˆINV-R1-R15, POS-R1-R6, CRM-R1-R7ï¼‰
- âœ… å®Œæ•´ç™¼ç¥¨è™Ÿæ®µç®¡ç†æ©Ÿåˆ¶ï¼ˆä¸‰å±¤éš”é›¢ + ç‹€æ…‹æ©Ÿï¼‰
- âœ… å®Œæ•´ POS/CRM åŒæ­¥æ©Ÿåˆ¶ï¼ˆå…©å±¤æ¶æ§‹ï¼‰
- âœ… å››å±¤é©—è­‰ + ä¹æ­¥é©ŸåŸå­æ€§å…¥åº«
- âœ… CRM ç•°æ­¥æ‰¹æ¬¡åŒæ­¥èˆ‡é‡è©¦æ©Ÿåˆ¶

**ç´¯è¨ˆæˆæœï¼ˆPhase 1-3ï¼‰**ï¼š
- âœ… 95 æ¢æ¥­å‹™è¦å‰‡å®Œæ•´è¨˜éŒ„
- âœ… 11,684+ è¡Œç¨‹å¼ç¢¼è¿½è¹¤åˆ†æ
- âœ… æ¶µè“‹å®šåƒ¹ã€ä¿ƒéŠ·ã€ä»˜æ¬¾ä¸‰å¤§æ¥­å‹™é ˜åŸŸ
- âœ… è¦†è“‹ç‡ï¼š87% â†’ 98%+

**ä¸‹ä¸€æ­¥**ï¼š
1. åˆ†ç™¼ v1.4 çµ¦å¯©æŸ¥è€…
2. å®‰æ’ç¬¬4é€±ç¢ºèªæœƒè­°ï¼ˆåŒ…å«ä»˜æ¬¾æµç¨‹ï¼‰
3. ç´å…¥å›é¥‹
4. å–å¾—æ ¸å‡†
5. ç™¼å¸ƒ v1.4 æœ€çµ‚ç‰ˆ
6. é–‹å§‹ Phase 4ï¼šè¨‚å–®ç‹€æ…‹æ©Ÿè¿½è¹¤

**æ ¸å‡†ç°½å**ï¼š

- [ ] _________________________ æ¥­å‹™ç¶“ç† / æ—¥æœŸ
- [ ] _________________________ è²¡å‹™ç¶“ç† / æ—¥æœŸ
- [ ] _________________________ ç”¢å“ç¶“ç† / æ—¥æœŸ
- [ ] _________________________ QA ä¸»ç®¡ / æ—¥æœŸ
- [ ] _________________________ æŠ€è¡“ä¸»ç®¡ / æ—¥æœŸ
