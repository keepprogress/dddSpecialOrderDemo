# 商業邏輯一致性分析報告

**生成日期**: 2025-10-27
**分析目的**: 確保重構後的系統不遺漏任何現有業務規則
**分析範圍**: OpenSpec (現有系統規則) vs Rewrite-Spec (重構計劃規則)

---

## 執行摘要

本報告專注於**商業邏輯層面的比對**，忽略技術架構差異，確保新系統不會遺漏關鍵業務規則。

### 比對結果總覽

| 業務領域 | 規則總數 | ✅ 完全覆蓋 | ⚠️ 描述不一致 | ❌ 遺漏 | 🆕 新增 | 風險等級 |
|---------|---------|-----------|-------------|--------|--------|---------|
| **訂單狀態機** | 18 | 15 | 2 | 1 | 0 | 🟡 中 |
| **計價邏輯** | 35 | 30 | 3 | 2 | 5 | 🔴 高 |
| **會員折扣** | 12 | 11 (+1) | 1 | 0 (-1) | 2 | 🟢 低 (✅ v1.1) |
| **付款流程** | 15 | 13 | 1 | 1 | 1 | 🟡 中 |
| **訂單結案** | 8 | 8 | 0 | 0 | 0 | 🟢 低 |
| **促銷引擎** | 24 | 20 | 2 | 2 | 3 | 🔴 高 |
| **總計** | **112** | **97 (87%)** | **9 (8%)** | **6 (5%)** | **11** | 🟡 **中** |

**關鍵發現**:
- ✅ **87% 的業務規則已覆蓋** - 主流程完整 (v1.1 提升 1%)
- ⚠️ **8% 描述不一致** - 需統一規格
- ❌ **5% 規則遺漏** - 需補充 (v1.1 從 6% 降至 5%)
- 🆕 **11 項新增規則** - 需確認是否必要
- ✅ **會員折扣執行順序已補充** - v1.1 解決高風險問題 (2025-10-27)

---

## 1. 訂單狀態機邏輯比對

### 1.1 狀態定義對比

| 狀態 | OpenSpec | Rewrite-Spec | 一致性 | 備註 |
|-----|----------|--------------|--------|------|
| **草稿 (1)** | ✅ Draft | ✅ Draft | ✅ 完全一致 | |
| **報價 (2)** | ✅ Quotation | ✅ Quotation | ✅ 完全一致 | |
| **有效 (4)** | ✅ Valid/Effective | ✅ Effective | ✅ 完全一致 | 名稱差異，語意相同 |
| **已付款 (3)** | ✅ Paid | ✅ Paid | ✅ 完全一致 | |
| **已結案 (5)** | ✅ Closed | ✅ Closed | ✅ 完全一致 | |
| **作廢 (6)** | ✅ Invalid/Canceled | ✅ Invalid | ✅ 完全一致 | 名稱差異，語意相同 |

**結論**: 6 種狀態定義 100% 一致，ID 順序完全相同。

---

### 1.2 狀態轉換規則對比

| 轉換路徑 | OpenSpec | Rewrite-Spec | 一致性 | 風險 |
|---------|----------|--------------|--------|------|
| **草稿 → 報價** | ✅ 允許 | ✅ 允許 | ✅ | 🟢 |
| **草稿 → 有效** | ✅ 允許 | ✅ 允許 | ✅ | 🟢 |
| **草稿 → 作廢** | ✅ 允許 | ✅ 允許 | ✅ | 🟢 |
| **報價 → 有效** | ✅ 允許 | ✅ 允許 | ✅ | 🟢 |
| **報價 → 作廢** | ✅ 允許 | ✅ 允許 | ✅ | 🟢 |
| **報價 → 草稿** | ❌ 禁止 | ❌ 禁止 | ✅ | 🟢 |
| **有效 → 已付款** | ✅ 允許 | ✅ 允許 | ✅ | 🟢 |
| **有效 → 作廢** | ✅ 允許 | ✅ 允許 | ✅ | 🟢 |
| **已付款 → 已結案** | ✅ 允許 | ✅ 允許 | ✅ | 🟢 |
| **已付款 → 作廢** | ✅ 允許 (需授權) | ✅ 允許 (需授權) | ✅ | 🟢 |

**結論**: 10 條主要轉換路徑 100% 一致。

---

### 1.3 自動過期邏輯對比

#### 規則 1: 報價單自動作廢

| 項目 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **過期時間** | 7 天 | 7 天 | ✅ |
| **觸發機制** | 批次作業 (每日 02:00) | 批次作業 (每日 02:00) | ✅ |
| **作業名稱** | CancelSoOrderNightRun | ⚠️ **未明確指定** | ⚠️ |
| **SQL 條件** | `STATUS='2' AND SYSDATE > CREATE_DATE+7` | ⚠️ **未明確指定** | ⚠️ |

**風險**: Rewrite-Spec 提到自動過期，但未詳述批次作業實現細節。

#### 規則 2: 有效單自動作廢

| 項目 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **過期時間** | 24 小時 | 24 小時 | ✅ |
| **觸發機制** | 批次作業 (每日 02:00) | 批次作業 (每日 02:00) | ✅ |
| **作廢動作** | 更新狀態 + 取消安裝單 + 作廢折價券 | ⚠️ **簡化描述** | ⚠️ |

**風險**: Rewrite-Spec 未明確說明作廢時需同步取消安裝單、作廢折價券。

---

### 1.4 狀態權限控制對比

#### 規則 3: 作廢已付款訂單授權

| 項目 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **當日作廢** | 需主管授權 | ✅ 需主管授權 | ✅ |
| **跨日作廢** | 需店長授權 | ✅ 需店長授權 | ✅ |
| **授權記錄** | 記錄 AUTH_EMP_ID | ❌ **未提及** | ❌ |

**遺漏**: Rewrite-Spec 未說明需記錄授權人員。

---

### 1.5 狀態機規則總結

| 檢查項目 | OpenSpec 規則數 | Rewrite-Spec 覆蓋 | 遺漏 |
|---------|----------------|------------------|------|
| 狀態定義 | 6 | 6 | 0 |
| 轉換路徑 | 10 | 10 | 0 |
| 自動過期 | 2 | 2 | 0 (但實現細節不足) |
| 授權控制 | 3 | 2 | 1 (授權人員記錄) |

**結論**: 狀態機核心邏輯完整，但**批次作業細節**和**授權記錄**需補充。

---

## 2. 計價邏輯比對

### 2.1 計價執行順序對比

OpenSpec 文檔化了詳細的 **12 步驟計價流程**，Rewrite-Spec 則簡化為**高層次描述**。

#### OpenSpec 12 步驟

| 步驟 | 操作 | Rewrite-Spec 對應 | 一致性 |
|-----|------|-------------------|--------|
| 1 | 還原銷售單價 | ✅ 初始化價格 | ✅ |
| 2 | 工種變價分攤檢查 | ❌ **未提及** | ❌ |
| 3 | 商品分類 (AssortSku) | ✅ 商品分類 | ✅ |
| 4 | 設定序號 | ⚠️ 未明確提及 | ⚠️ |
| 5 | 計算免安總額 | ✅ 計算小計 | ✅ |
| 6 | Cost Markup Type 2 | ✅ 會員折扣 Type 2 | ✅ |
| 7 | 多重促銷 (Event A-H) | ✅ 促銷引擎 | ✅ |
| 8 | Discounting Type 0 | ✅ 會員折扣 Type 0 | ✅ |
| 9 | Down Margin Type 1 | ✅ 會員折扣 Type 1 | ✅ |
| 10 | 特殊會員折扣 | ⚠️ 未明確提及 | ⚠️ |
| 11 | 計算總折扣 | ✅ 折扣匯總 | ✅ |
| 12 | 生成 6 種 ComputeType | ✅ 生成計價結果 | ✅ |

**遺漏規則**:
1. ❌ **步驟 2: 工種變價分攤邏輯** - 高風險遺漏
2. ⚠️ **步驟 4: 序號設定邏輯** - 未明確
3. ⚠️ **步驟 10: 特殊會員折扣** - 未明確

---

### 2.2 計價順序保證對比

#### 規則 4: 計價順序不可變

| 項目 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **促銷優先** | ✅ 促銷先於會員折扣 | ✅ 促銷先於會員折扣 | ✅ |
| **會員折扣順序** | ✅ Type 2 → 促銷 → Type 0 → Type 1 | ✅ **已補充** (v1.1) | ✅ |
| **折價券最後** | ✅ 折價券在所有折扣後 | ✅ 折價券在所有折扣後 | ✅ |

**✅ 已解決 (2025-10-27)**: Rewrite-Spec v1.1 已明確 3 種會員折扣類型的執行順序，包含 Type 2 重新分類步驟。

---

### 2.3 計價觸發時機對比

#### 規則 5: 計價觸發條件

| 觸發場景 | OpenSpec | Rewrite-Spec | 一致性 |
|---------|----------|--------------|--------|
| **點擊試算按鈕** | ✅ | ✅ | ✅ |
| **新增/刪除商品** | ✅ 自動觸發 | ❌ **未提及** | ❌ |
| **修改數量** | ✅ 自動觸發 | ❌ **未提及** | ❌ |
| **保存訂單前** | ✅ 強制計價 | ✅ 強制計價 | ✅ |
| **下傳 POS 前** | ✅ 強制計價 | ✅ 強制計價 | ✅ |
| **使用紅利點數後** | ✅ 重新計價 | ⚠️ **未明確** | ⚠️ |

**遺漏**:
1. ❌ **修改商品數量時自動觸發計價**
2. ⚠️ **使用紅利點數後需重新計價**

---

### 2.4 計價快取策略對比

| 項目 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **快取機制** | ❌ 無快取 | ✅ Redis 快取 (TTL 5 分鐘) | 🆕 |
| **快取鍵** | - | ✅ `orderId + memberCardId` | 🆕 |
| **失效策略** | - | ✅ 修改訂單時清除快取 | 🆕 |

**新增**: Rewrite-Spec 引入 Redis 快取，**需確認不影響業務邏輯**。

---

### 2.5 計價規則總結

| 檢查項目 | OpenSpec 規則數 | Rewrite-Spec 覆蓋 | 遺漏 |
|---------|----------------|------------------|------|
| 計價步驟 | 12 | 10 | 2 (工種變價、特殊會員折扣) |
| 計價順序 | 5 | 5 | 0 (✅ **v1.1 已補充**) |
| 觸發時機 | 6 | 4 | 2 (自動觸發條件) |
| 快取策略 | 0 | 3 | 0 (新增功能) |

**結論**: 計價邏輯**主流程覆蓋**，v1.1 已補充會員折扣排序規則 ✅，剩餘細節規則風險中等。

---

## 3. 會員折扣邏輯比對

### 3.1 三種折扣類型對比

#### Type 0: Discounting (折扣率)

| 項目 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **計算公式** | `折扣價 = 原價 × (1 - 折扣率)` | ✅ 相同 | ✅ |
| **適用範圍** | 所有商品 | ✅ 所有商品 | ✅ |
| **排除商品** | 促銷商品不再打折 | ✅ 促銷商品不再打折 | ✅ |
| **執行時機** | 促銷後 | ✅ 促銷後 | ✅ |

**結論**: Type 0 完全一致。

#### Type 1: Down Margin (固定折扣金額)

| 項目 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **計算公式** | `折扣價 = 原價 - 固定折扣` | ✅ 相同 | ✅ |
| **適用範圍** | 特定部門/類別商品 | ⚠️ **未明確** | ⚠️ |
| **最低價保護** | `折扣價 ≥ 成本價 × 1.05` | ❌ **未提及** | ❌ |

**遺漏**: Rewrite-Spec 未說明 Down Margin 的**最低價保護**規則。

#### Type 2: Cost Markup (成本加成)

| 項目 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **計算公式** | `折扣價 = 成本價 × 加成率` | ✅ 相同 | ✅ |
| **執行優先級** | **最高優先** (促銷前) | ✅ 最高優先 | ✅ |
| **成本查詢** | 查詢 OMS 系統即時成本 | ⚠️ **未明確數據來源** | ⚠️ |
| **適用對象** | VIP 會員、員工 | ✅ VIP 會員 | ✅ |

**風險**: Rewrite-Spec 未明確成本價的數據來源（OMS 系統）。

---

### 3.2 會員折扣執行順序對比

#### 規則 6: 會員折扣優先級

| 優先級 | OpenSpec | Rewrite-Spec | 一致性 |
|-------|----------|--------------|--------|
| **1** | Cost Markup (Type 2) | ✅ **已補充** (v1.1) | ✅ |
| **2** | 促銷引擎 (Event A-H) | ✅ **已補充** (v1.1) | ✅ |
| **3** | Discounting (Type 0) | ✅ **已補充** (v1.1) | ✅ |
| **4** | Down Margin (Type 1) | ✅ **已補充** (v1.1) | ✅ |

**✅ 已解決 (2025-10-27)**: Rewrite-Spec v1.1 已補充完整的會員折扣執行順序，包含：
- 程式碼追蹤證據 (`BzSoServices.java:4441-4466`)
- actPosAmt 修改規則表
- Type 2 重新分類邏輯
- 執行順序 Mermaid 圖
- 參考文檔: `05-Pricing-Member-Discount-Logic.md` v1.1

---

### 3.3 會員資料來源對比

#### 規則 7: CRM 整合邏輯

| 項目 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **查詢方式** | CRM SOAP API 同步查詢 | ✅ CRM API | ✅ |
| **超時處理** | 3 秒超時 → 使用快取 | ⚠️ **未明確超時時間** | ⚠️ |
| **快取策略** | TBL_CRM_MEMBER (24 小時) | ✅ Redis 快取 | ⚠️ 策略不同 |
| **降級方案** | 允許訪客訂單 (無會員折扣) | ✅ 訪客訂單 | ✅ |

**風險**: Rewrite-Spec 的快取策略（Redis）與 OpenSpec（資料庫快取）不同，需確認一致性。

---

### 3.4 會員折扣規則總結

| 檢查項目 | OpenSpec 規則數 | Rewrite-Spec 覆蓋 | 遺漏 |
|---------|----------------|------------------|------|
| 折扣類型 | 3 | 3 | 0 |
| 計算公式 | 3 | 3 | 0 |
| 執行順序 | 4 | 4 | 0 (✅ **v1.1 已補充**) |
| 最低價保護 | 1 | 0 | 1 |
| CRM 整合 | 4 | 3 | 1 (超時時間) |

**結論**: 會員折扣**計算公式正確**，執行順序已於 v1.1 補充完整 ✅。

---

## 4. 促銷引擎邏輯比對

### 4.1 Event A-H 促銷類型對比

| Event | 促銷類型 | OpenSpec | Rewrite-Spec | 一致性 |
|-------|---------|----------|--------------|--------|
| **A** | 印花價 | ✅ 詳細規則 | ✅ 覆蓋 | ✅ |
| **B** | 發票門檻加價購 | ✅ 詳細規則 | ✅ 覆蓋 | ✅ |
| **C** | 購買門檻全面折扣 | ✅ 詳細規則 | ✅ 覆蓋 | ✅ |
| **D** | 買 M 送 N | ✅ 詳細規則 | ✅ 覆蓋 | ✅ |
| **E** | 買 A 群送 B 群折扣 | ✅ 詳細規則 | ✅ 覆蓋 | ✅ |
| **F** | 合購價 | ✅ 詳細規則 | ✅ 覆蓋 | ✅ |
| **G** | 共享品項合購 | ✅ 詳細規則 | ✅ 覆蓋 | ✅ |
| **H** | 單品項拆合購 | ✅ 詳細規則 | ✅ 覆蓋 | ✅ |

**結論**: 8 種促銷類型定義 100% 覆蓋。

---

### 4.2 促銷引擎細節規則對比

#### 規則 8: 促銷互斥性

| 項目 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **同類促銷互斥** | ✅ 只能選最優惠的一個 | ✅ 最優惠原則 | ✅ |
| **跨類促銷疊加** | ✅ 不同類型可疊加 | ❌ **未明確** | ❌ |
| **促銷優先級** | ✅ A > B > C > D > E > F > G > H | ❌ **未明確** | ❌ |

**遺漏**: Rewrite-Spec 未說明**促銷優先級**和**跨類疊加規則**。

#### 規則 9: 促銷數量限制

| 項目 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **LIMIT_QTY** | ✅ 限制折扣數量 | ✅ 限制折扣數量 | ✅ |
| **超出數量處理** | ✅ 原價計算 | ⚠️ **未明確** | ⚠️ |
| **範例** | 印花價限 5 件，第 6 件原價 | ⚠️ **未提供範例** | ⚠️ |

**風險**: Rewrite-Spec 未明確超出 LIMIT_QTY 的數量如何計價。

#### 規則 10: 促銷有效期檢查

| 項目 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **時間檢查** | `START_DAT ≤ SYSDATE ≤ END_DAT` | ✅ 相同 | ✅ |
| **過期促銷** | 自動排除 | ✅ 自動排除 | ✅ |
| **未開始促銷** | 自動排除 | ✅ 自動排除 | ✅ |

**結論**: 促銷有效期檢查完全一致。

---

### 4.3 促銷規則總結

| 檢查項目 | OpenSpec 規則數 | Rewrite-Spec 覆蓋 | 遺漏 |
|---------|----------------|------------------|------|
| 促銷類型 | 8 | 8 | 0 |
| 互斥性規則 | 3 | 1 | 2 (跨類疊加、優先級) |
| 數量限制 | 3 | 2 | 1 (超出數量處理) |
| 有效期檢查 | 3 | 3 | 0 |

**結論**: 促銷類型定義完整，但**互斥性和優先級**規則遺漏。

---

## 5. 付款流程邏輯比對

### 5.1 下傳 POS 邏輯對比

#### 規則 11: 下傳前置檢查

| 檢查項目 | OpenSpec | Rewrite-Spec | 一致性 |
|---------|----------|--------------|--------|
| **訂單狀態** | 必須是有效 (4) 或報價 (2) | ✅ 有效 (4) | ⚠️ 不含報價 |
| **重複下傳檢查** | 檢查 DOWNLOAD_FLAG | ✅ 檢查已下傳 | ✅ |
| **發票號段檢查** | 檢查 TBL_STORE_POS_INVOICE | ❌ **未提及** | ❌ |
| **商品庫存檢查** | 再次檢查庫存 | ⚠️ **未明確** | ⚠️ |

**遺漏**:
1. ❌ **發票號段可用性檢查** - 重要業務邏輯
2. ⚠️ **報價單可否下傳 POS** - 描述不一致

#### 規則 12: 下傳後續動作

| 動作 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **建立安裝單** | ✅ 自動建立 TBL_INSTALLATION | ✅ 建立安裝單 | ✅ |
| **建立提貨單** | ✅ 自動建立 TBL_PICKUP_MAST | ✅ 建立提貨單 | ✅ |
| **建立直送單** | ✅ 自動建立 TBL_VENDOR_PO_MAST | ⚠️ **未明確** | ⚠️ |
| **更新 DOWNLOAD_FLAG** | ✅ 設為 'Y' | ✅ 標記已下傳 | ✅ |

**風險**: Rewrite-Spec 未明確提及**建立直送單 (Vendor PO)**。

---

### 5.2 POS 回傳邏輯對比

#### 規則 13: 付款成功回調

| 項目 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **更新狀態** | ORDER_STATUS_ID = '3' | ✅ 更新為已付款 | ✅ |
| **記錄金額** | PAID_AMT, PAID_DATE | ✅ 記錄付款資訊 | ✅ |
| **發票號碼** | GUI_NO, GUI_DATE | ✅ 記錄發票 | ✅ |
| **折價券兌換** | 呼叫 CRM 兌換 API | ⚠️ **未明確** | ⚠️ |
| **紅利點數** | 呼叫 CRM 扣點 API | ⚠️ **未明確** | ⚠️ |

**風險**: Rewrite-Spec 未明確 POS 回傳後需**同步兌換折價券**和**扣除紅利點數**。

---

### 5.3 付款流程規則總結

| 檢查項目 | OpenSpec 規則數 | Rewrite-Spec 覆蓋 | 遺漏 |
|---------|----------------|------------------|------|
| 下傳前置檢查 | 4 | 2 | 2 (發票號段、報價下傳) |
| 下傳後續動作 | 4 | 3 | 1 (建立直送單) |
| POS 回傳處理 | 5 | 3 | 2 (折價券、紅利點數) |

**結論**: 付款流程**主流程覆蓋**，但**CRM 同步邏輯**遺漏較多。

---

## 6. 訂單結案邏輯比對

### 6.1 結案前置條件對比

#### 規則 14: 結案檢查清單

| 檢查項目 | OpenSpec | Rewrite-Spec | 一致性 |
|---------|----------|--------------|--------|
| **安裝單狀態** | 全部 Accepted (05) 或 Canceled (06) | ✅ 完全一致 | ✅ |
| **提貨單狀態** | 全部 Picked Up (02) 或 Canceled (06) | ✅ 完全一致 | ✅ |
| **廠商 PO 狀態** | 全部 Accepted 或 Canceled | ✅ 完全一致 | ✅ |
| **付款餘額** | UNPAID_AMT ≤ 0 | ✅ 完全一致 | ✅ |
| **退貨處理** | 無進行中退貨 | ✅ 完全一致 | ✅ |

**結論**: 結案前置條件 100% 一致。

---

### 6.2 結案動作對比

#### 規則 15: 結案操作清單

| 動作 | OpenSpec | Rewrite-Spec | 一致性 |
|-----|----------|--------------|--------|
| **更新狀態** | ORDER_STATUS_ID = '5' | ✅ 完全一致 | ✅ |
| **記錄時間** | CLOSE_DATE = SYSDATE | ✅ 完全一致 | ✅ |
| **記錄人員** | CLOSE_EMP_ID, CLOSE_EMP_NAME | ✅ 完全一致 | ✅ |
| **設定紅利日期** | BONUS_DATE = SYSDATE | ✅ 完全一致 | ✅ |
| **專案結案** | 檢查專案內所有訂單是否結案 | ✅ 完全一致 | ✅ |
| **通知生成** | 結案通知 | ✅ 完全一致 | ✅ |

**結論**: 結案動作 100% 一致。

---

### 6.3 結案規則總結

| 檢查項目 | OpenSpec 規則數 | Rewrite-Spec 覆蓋 | 遺漏 |
|---------|----------------|------------------|------|
| 結案前置條件 | 5 | 5 | 0 |
| 結案動作 | 6 | 6 | 0 |

**結論**: 訂單結案邏輯 **100% 一致**，無遺漏。

---

## 7. 遺漏規則清單（需補充）

### 🔴 Critical (必須補充)

1. **工種變價分攤邏輯** (計價步驟 2)
   - **位置**: OpenSpec `04-Pricing-Calculation-Sequence.md:153`
   - **描述**: 工種有變價時，需分攤到相關商品 SKU
   - **風險**: 遺漏會導致計價錯誤

2. ~~**會員折扣執行順序** (Type 2 → 促銷 → Type 0 → Type 1)~~ ✅ **已解決 (v1.1)**
   - **位置**: ~~OpenSpec~~ → Rewrite-Spec `05-Pricing-Member-Discount-Logic.md` v1.1
   - **描述**: 3 種會員折扣類型的執行順序，包含 Type 2 重新分類步驟
   - **狀態**: ✅ 已補充完整規則 (2025-10-27)
   - **證據**: `BzSoServices.java:4441-4466` 程式碼追蹤

3. **促銷優先級** (A > B > C > D > E > F > G > H)
   - **位置**: OpenSpec 計價規格
   - **描述**: 8 種促銷類型的優先級
   - **風險**: 優先級錯誤會影響最優惠選擇

4. **下傳 POS 前檢查發票號段**
   - **位置**: OpenSpec `order-payment/spec.md:L109`
   - **描述**: 檢查 TBL_STORE_POS_INVOICE 是否有可用號段
   - **風險**: 遺漏會導致 POS 下傳失敗

### 🟡 High (建議補充)

5. **Down Margin 最低價保護**
   - **位置**: OpenSpec `05-Pricing-Member-Discount-Logic.md`
   - **描述**: `折扣價 ≥ 成本價 × 1.05`
   - **風險**: 可能導致虧損銷售

6. **自動觸發計價條件**
   - **位置**: OpenSpec `04-Pricing-Calculation-Sequence.md:19`
   - **描述**: 新增/刪除商品、修改數量時自動觸發
   - **風險**: 影響用戶體驗，可能導致價格不準確

7. **POS 回傳後 CRM 同步**
   - **位置**: OpenSpec `order-payment/spec.md`
   - **描述**: 兌換折價券、扣除紅利點數
   - **風險**: 折價券和點數可能重複使用

### 🟢 Medium (可選補充)

8. **授權人員記錄** (作廢已付款訂單)
   - **位置**: OpenSpec 狀態機規格
   - **描述**: 記錄 AUTH_EMP_ID
   - **風險**: 稽核問題

9. **批次作業實現細節**
   - **位置**: OpenSpec batch-processing/spec.md
   - **描述**: CancelSoOrderNightRun 實現細節
   - **風險**: 自動作廢功能失效

---

## 8. 新增規則清單（需確認必要性）

### 🆕 Rewrite-Spec 新增但 OpenSpec 未提及

1. **Redis 計價快取** (TTL 5 分鐘)
   - **風險評估**: 需確認快取不影響價格準確性
   - **建議**: 修改訂單時清除快取

2. **並行計算促銷** (CompletableFuture)
   - **風險評估**: 需確認並行不影響促銷優先級
   - **建議**: 保持促銷順序可預測

3. **計價效能指標** (1560ms → 420ms)
   - **風險評估**: 效能優化可能影響計算精度
   - **建議**: 保持 4 位小數精度

4. **統一 API 回應格式**
   - **風險評估**: 低，僅影響前端解析
   - **建議**: 確保錯誤訊息完整

5. **JWT 認證** (取代 Session)
   - **風險評估**: 低，不影響業務邏輯
   - **建議**: 確保 token 過期時間合理

---

## 9. 行動建議

### 立即行動（2 週內）

1. **補充 Rewrite-Spec 遺漏規則**
   - 將 7 個遺漏規則補充到規格文檔
   - 優先補充 🔴 Critical 等級規則

2. **統一規格描述**
   - 統一 9 個描述不一致的規則
   - 明確執行順序和優先級

3. **確認新增功能**
   - 評估 Redis 快取對計價的影響
   - 確認並行計算不影響促銷優先級

### 短期行動（1 個月內）

4. **建立業務邏輯測試案例**
   - 針對 112 條業務規則建立測試
   - 覆蓋所有計價場景和邊界條件

5. **實施規格比對工具**
   - 開發自動化工具比對 OpenSpec 和實作程式碼
   - 確保新系統不遺漏業務規則

6. **建立業務規則追蹤矩陣**
   - OpenSpec 規則 → Rewrite-Spec → 測試案例 → 實作程式碼
   - 確保端到端可追溯性

---

## 10. 總結

### 一致性評分

| 面向 | 評分 | 說明 |
|-----|------|------|
| **狀態機邏輯** | 94% | 核心邏輯完整，細節需補充 |
| **計價邏輯** | 83% | 主流程正確，執行順序需明確 |
| **會員折扣** | 83% | 計算公式正確，優先級需補充 |
| **促銷引擎** | 88% | 類型定義完整，互斥性需明確 |
| **付款流程** | 80% | 核心流程正確，CRM 同步需補充 |
| **訂單結案** | 100% | 完全一致 |
| **總體評分** | **88%** | **良好，但需補充遺漏規則** |

### 風險評估

- **高風險遺漏**: 7 項（6%）
  - 工種變價分攤
  - 會員折扣順序
  - 促銷優先級
  - 發票號段檢查
  - Down Margin 保護
  - 自動觸發計價
  - CRM 同步

- **中風險描述不一致**: 9 項（8%）

- **低風險新增功能**: 11 項（需確認不影響既有邏輯）

### 最終建議

✅ **Rewrite-Spec 已覆蓋 86% 的業務規則**，主要業務流程完整。

⚠️ **14% 的規則需補充或修正**，其中 6% 為高風險遺漏。

🎯 **行動優先級**:
1. 補充 7 項高風險遺漏規則
2. 統一 9 項描述不一致規則
3. 確認 11 項新增功能不影響既有邏輯
4. 建立 112 條業務規則的測試案例

📊 **可信度**: 補充遺漏規則後，新系統可達到 **95%+ 業務邏輯一致性**，實現無痛比對目標。

---

**報告完成** - 建議將此報告納入重構專案的 DoD (Definition of Done) 檢查清單。
