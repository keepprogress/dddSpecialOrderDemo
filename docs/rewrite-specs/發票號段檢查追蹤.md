# SOM ç³»çµ±ç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥å’Œåˆ†é…æµç¨‹è¿½è¹¤å ±å‘Š

## æ–‡ä»¶æ§åˆ¶

- **ç‰ˆæœ¬**ï¼š1.0
- **æ—¥æœŸ**ï¼š2025-10-28
- **éšæ®µ**ï¼šPhase 3 Week 4 - Task 12
- **ä½œè€…**ï¼šæŠ€è¡“åœ˜éšŠåŸºæ–¼ç¨‹å¼ç¢¼è¿½è¹¤åˆ†æ
- **ç›®çš„**ï¼šè¿½è¹¤è¨‚å–®ä»˜æ¬¾å¾Œç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥å’Œåˆ†é…é‚è¼¯

---

## åŸ·è¡Œæ‘˜è¦

æœ¬å ±å‘Šè©³ç´°è¿½è¹¤ SOM (Store Operation Management) ç³»çµ±ä¸­çš„ç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥å’Œåˆ†é…é‚è¼¯ã€‚è©²ç³»çµ±æ¡ç”¨ POS ç™¼ç¥¨ç®¡ç†æ¨¡å¼ï¼Œé€šé **TBL_STORE_POS_INVOICE** è¡¨é€²è¡Œç™¼ç¥¨è™Ÿæ®µçš„å‹•æ…‹åˆ†é…å’Œç®¡ç†ï¼Œåœ¨è¨‚å–®ä»˜æ¬¾å¾Œè‡ªå‹•é€²è¡Œç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥å’Œåˆ†é…ã€‚

**é—œéµç™¼ç¾**ï¼š
- æ¡ç”¨å¹´æœˆéš”é›¢ã€é–€åº—éš”é›¢ã€POS éš”é›¢çš„ä¸‰å±¤éš”é›¢æ©Ÿåˆ¶
- ä½¿ç”¨ç‹€æ…‹æ©Ÿæ¨¡å¼ç®¡ç†è™Ÿæ®µç”Ÿå‘½é€±æœŸ
- è‡ªå‹•æ¿€æ´»æ©Ÿåˆ¶ç¢ºä¿è™Ÿæ®µé€£çºŒæ€§
- å®Œå–„çš„ä¸¦ç™¼æ§åˆ¶é˜²æ­¢é‡è¤‡åˆ†é…

---

## ç›®éŒ„

1. [ç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥çš„è§¸ç™¼æ™‚æ©Ÿ](#ä¸€ç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥çš„è§¸ç™¼æ™‚æ©Ÿ)
2. [ç™¼ç¥¨è™Ÿæ®µè¡¨çµæ§‹](#äºŒç™¼ç¥¨è™Ÿæ®µè¡¨çµæ§‹)
3. [ç™¼ç¥¨è™Ÿç¢¼åˆ†é…é‚è¼¯](#ä¸‰ç™¼ç¥¨è™Ÿç¢¼åˆ†é…é‚è¼¯)
4. [ç™¼ç¥¨è™Ÿæ®µç”¨ç›¡è™•ç†](#å››ç™¼ç¥¨è™Ÿæ®µç”¨ç›¡è™•ç†)
5. [ç™¼ç¥¨è™Ÿç¢¼èˆ‡è¨‚å–®çš„é—œè¯](#äº”ç™¼ç¥¨è™Ÿç¢¼èˆ‡è¨‚å–®çš„é—œè¯)
6. [ä¸åŒç™¼ç¥¨é¡å‹çš„è™•ç†](#å…­ä¸åŒç™¼ç¥¨é¡å‹çš„è™•ç†)
7. [ç™¼ç¥¨è™Ÿæ®µåˆå§‹åŒ–å’Œæ›´æ–°æµç¨‹](#ä¸ƒç™¼ç¥¨è™Ÿæ®µåˆå§‹åŒ–å’Œæ›´æ–°æµç¨‹)
8. [éŒ¯èª¤è™•ç†æ©Ÿåˆ¶](#å…«éŒ¯èª¤è™•ç†æ©Ÿåˆ¶)
9. [æ¥­å‹™è¦å‰‡ç¸½çµ](#ä¹æ¥­å‹™è¦å‰‡ç¸½çµ)
10. [é—œéµæ–‡ä»¶ä½ç½®](#åé—œéµæ–‡ä»¶ä½ç½®)

---

## ä¸€ã€ç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥çš„è§¸ç™¼æ™‚æ©Ÿ

### æ”¯ä»˜å¾Œè‡ªå‹•è§¸ç™¼

è¨‚å–®åœ¨çµå¸³ï¼ˆæ”¯ä»˜ï¼‰å¾Œï¼Œç³»çµ±è‡ªå‹•é€²è¡Œç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥å’Œåˆ†é…ã€‚

**è§¸ç™¼ä½ç½®ï¼š**
- `CashierCASAServices.createCasaSoOrderCashier()` (ç¬¬ 233-261 è¡Œ)
- èª¿ç”¨ `handleCashierPaymentBO()` (ç¬¬ 319 è¡Œ)

**å®Œæ•´æµç¨‹**ï¼š
```mermaid
graph TD
    A[æ”¶éŠ€å°çµå¸³] --> B[createCasaSoOrderCashier]
    B --> C[handleCashierPaymentBO]
    C --> D[halndleInvoiceExtVO]
    D --> E{æŒ‰ç¨…åˆ¥åˆ†é¡}
    E -->|é›¶ç¨…| F[insertData 0]
    E -->|æ‡‰ç¨…| G[insertData 1]
    E -->|å…ç¨…| H[insertData 2]
    F --> I[doQueryInvoice]
    G --> I
    H --> I
    I --> J[è¿”å›ç™¼ç¥¨è™Ÿç¢¼]
```

**ä»£ç¢¼ä½ç½®ï¼š**
`C:\Projects\som\so-webapp\src\main\java\com\trihome\som\so\web\service\CashierCASAServices.java`

```java
// ç¬¬ 233-261 è¡Œ
public CASAResultVO createCasaSoOrderCashier(...) throws Exception {
    // ... å‰ç½®è™•ç†

    // ç¬¬ 319 è¡Œï¼šè§¸ç™¼ä»˜æ¬¾è™•ç†
    this.handleCashierPaymentBO(resultVO, ...);

    // ... å¾ŒçºŒè™•ç†
}
```

---

## äºŒã€ç™¼ç¥¨è™Ÿæ®µè¡¨çµæ§‹

### TBL_STORE_POS_INVOICE è¡¨

**ä¸»è¦æ¬„ä½ï¼š**

| æ¬„ä½ | é¡å‹ | èªªæ˜ | ç¯„ä¾‹ |
|------|------|------|------|
| YEAR_MONTH | VARCHAR(6) | å¹´æœˆ (PK) | "202501" |
| STORE_ID | VARCHAR(20) | é–€åº—ä»£è™Ÿ (PK) | "S001" |
| POS_ID | VARCHAR(10) | POS æ©Ÿè™Ÿ (PK) | "POS01" |
| TRACK_ID | VARCHAR(2) | ç™¼ç¥¨è»Œè·¡ä»£è™Ÿï¼ˆå­—è»Œï¼‰ | "AB" |
| INV_START_NO | VARCHAR(8) | èµ·å§‹è™Ÿç¢¼ | "00000001" |
| INV_END_NO | VARCHAR(8) | çµ‚æ­¢è™Ÿç¢¼ | "00001000" |
| NEXT_INV_NO | VARCHAR(8) | ä¸‹ä¸€å€‹å¯ç”¨è™Ÿç¢¼ | "00000156" |
| USED_CNT | DECIMAL | å·²ä½¿ç”¨æ•¸é‡ | 155 |
| TOTAL_CNT | DECIMAL | ç¸½é…é¡ | 1000 |
| FREE_CNT | DECIMAL | å‰©é¤˜å¯ç”¨æ•¸é‡ | 845 |
| STATUS | VARCHAR(1) | ç‹€æ…‹ç¢¼ | "2" |

**DAO ä½ç½®ï¼š**
`C:\Projects\som\so-coredb\src\main\java\com\trihome\som\so\mybatis\dao\TblStorePosInvoice.java`

### ç™¼ç¥¨è™Ÿæ®µç‹€æ…‹ç¢¼

**å®šç¾©ä½ç½®ï¼š**
`C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\common\constant\StorePosInvoiceConstant.java`

```java
public interface StorePosInvoiceConstant {
    String STATUS_1 = "1";  // æœªä½¿ç”¨
    String STATUS_2 = "2";  // å·²ä½¿ç”¨ï¼ˆæ­£åœ¨ä½¿ç”¨ä¸­ï¼‰
    String STATUS_3 = "3";  // ä½¿ç”¨å®Œç•¢
    String STATUS_4 = "4";  // å·²åˆªé™¤
}
```

**ç‹€æ…‹è½‰æ›åœ–**ï¼š
```mermaid
graph LR
    A[1:æœªä½¿ç”¨] -->|é¦–æ¬¡ä½¿ç”¨| B[2:ä½¿ç”¨ä¸­]
    B -->|ç¹¼çºŒä½¿ç”¨| B
    B -->|ç”¨ç›¡| C[3:ä½¿ç”¨å®Œç•¢]
    A -->|ç®¡ç†å“¡åˆªé™¤| D[4:å·²åˆªé™¤]
    B -->|ç®¡ç†å“¡åˆªé™¤| D
```

---

## ä¸‰ã€ç™¼ç¥¨è™Ÿç¢¼åˆ†é…é‚è¼¯

### æ ¸å¿ƒæ–¹æ³•ï¼šdoQueryInvoice()

**ä½ç½®ï¼š**
`C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\service\BzStorePosInvoiceServices.java` (ç¬¬ 58-101 è¡Œ)

**åˆ†é…æµç¨‹ï¼š**

```java
public synchronized String doQueryInvoice(String storeId, String posNo,
                                          String empId, String empName) {
    // æ­¥é©Ÿ 1ï¼šç”Ÿæˆå¹´æœˆç¢¼
    String yearMonth = DateFormatUtils.format(new Date(), "yyyyMM");

    // æ­¥é©Ÿ 2ï¼šæŸ¥è©¢ STATUS_2 è™Ÿæ®µï¼ˆæ­£åœ¨ä½¿ç”¨ä¸­ï¼‰
    List<TblStorePosInvoice> list = customBzStorePosInvoiceMapper
        .selectByYearMonthAndPosIdAndStatus(yearMonth, storeId, posNo,
                                            StorePosInvoiceConstant.STATUS_2);

    // æ­¥é©Ÿ 3ï¼šè‹¥ç„¡å‰‡æ¿€æ´» STATUS_1ï¼ˆæœªä½¿ç”¨ï¼‰
    if(list.size() == 0) {
        customBzStorePosInvoiceMapper.updateStatusForStatus1(
            yearMonth, storeId, posNo
        );
        list = customBzStorePosInvoiceMapper
            .selectByYearMonthAndPosIdAndStatus(yearMonth, storeId, posNo,
                                                StorePosInvoiceConstant.STATUS_2);
    }

    // æ­¥é©Ÿ 4ï¼šæª¢æŸ¥ç•°å¸¸
    if(list.size() > 1) {
        throw new RuntimeException("ç™¼ç¥¨è™Ÿç¢¼å–è™Ÿæœ‰å•é¡Œ!è«‹è¯çµ¡ç³»çµ±äººå“¡");
    }

    // æ­¥é©Ÿ 5ï¼šæå–ç™¼ç¥¨è™Ÿ
    TblStorePosInvoice invoice = list.size() == 0 ? null : list.get(0);

    // æ­¥é©Ÿ 6ï¼šè¨˜éŒ„ä½¿ç”¨
    if(invoice != null) {
        TblStoreUsedInvoice tblStoreUsedInvoice = new TblStoreUsedInvoice();
        tblStoreUsedInvoice.setInvoiceId(invoice.getTrackId() + invoice.getNextInvNo());
        int result = tblStoreUsedInvoiceMapper.insert(tblStoreUsedInvoice);

        if(result == 0) {
            throw new RuntimeException(
                "ç™¼ç¥¨è™Ÿç¢¼å–è™Ÿé‡è¤‡!è«‹æ›´æ–°é é¢è³‡è¨Šå¾Œé‡æ–°åšçµå¸³å‹•ä½œ"
            );
        }
    }

    // æ­¥é©Ÿ 7ï¼šæ›´æ–°è™Ÿæ®µ
    this.updateInvoice(invoice, empId, empName);
    return invoice.getTrackId() + invoice.getNextInvNo();
}
```

### è‡ªå‹•æ¿€æ´» SQL

**ä½ç½®ï¼š** `CustomBzStorePosInvoiceMapper.xml` (ç¬¬ 5-19 è¡Œ)

```xml
<update id="updateStatusForStatus1">
    UPDATE TBL_STORE_POS_INVOICE
    SET STATUS = '2'
    WHERE YEAR_MONTH = #{yearMonth}
      AND STORE_ID = #{storeId}
      AND POS_ID = #{posNo}
      AND STATUS = '1'
      AND INV_START_NO = (
          SELECT MIN(INV_START_NO)
          FROM TBL_STORE_POS_INVOICE
          WHERE YEAR_MONTH = #{yearMonth}
            AND STORE_ID = #{storeId}
            AND POS_ID = #{posNo}
            AND STATUS = '1'
      )
</update>
```

**é—œéµé‚è¼¯**ï¼šé¸æ“‡æœ€å°èµ·å§‹è™Ÿçš„æœªä½¿ç”¨è™Ÿæ®µé€²è¡Œæ¿€æ´»

### è™Ÿç¢¼éå¢é‚è¼¯

**æ–¹æ³•ï¼šcomputerNextInvNo()** (ç¬¬ 130-133 è¡Œ)

```java
private String computerNextInvNo(String str) {
    int no = Integer.valueOf(str);
    return StringUtils.leftPad(String.valueOf(no+1), 8, '0');
}
```

**ç¯„ä¾‹**ï¼š
- è¼¸å…¥ï¼š`"00000001"` â†’ è¼¸å‡ºï¼š`"00000002"`
- è¼¸å…¥ï¼š`"00000999"` â†’ è¼¸å‡ºï¼š`"00001000"`
- è¼¸å…¥ï¼š`"00999999"` â†’ è¼¸å‡ºï¼š`"01000000"`

---

## å››ã€ç™¼ç¥¨è™Ÿæ®µç”¨ç›¡è™•ç†

### ç”¨ç›¡åˆ¤æ–·

**ä½ç½®ï¼š** BzStorePosInvoiceServices.updateInvoice() (ç¬¬ 121-126 è¡Œ)

```java
private void updateInvoice(TblStorePosInvoice invoice, String empId, String empName) {
    TblStorePosInvoice uInvoice = new TblStorePosInvoice();
    // ... è¨­ç½®åŸºæœ¬è³‡è¨Š

    uInvoice.setUsedCnt(invoice.getUsedCnt() + 1);
    uInvoice.setFreeCnt(invoice.getFreeCnt() - 1);

    // é—œéµåˆ¤æ–·ï¼šå‰©é¤˜æ•¸é‡æ˜¯å¦ç”¨ç›¡
    if((invoice.getFreeCnt() - 1) <= 0) {
        uInvoice.setStatus(StorePosInvoiceConstant.STATUS_3);  // ä½¿ç”¨å®Œç•¢
    } else {
        uInvoice.setStatus(StorePosInvoiceConstant.STATUS_2);  // ç¹¼çºŒä½¿ç”¨
        uInvoice.setNextInvNo(this.computerNextInvNo(invoice.getNextInvNo()));
    }

    // ... æ›´æ–°æ•¸æ“šåº«
}
```

### ç”¨ç›¡å¾Œçš„è¡Œç‚º

**è‡ªå‹•æ¿€æ´»æµç¨‹**ï¼š
1. ç•¶å‰è™Ÿæ®µç‹€æ…‹è¨­ç‚º STATUS_3ï¼ˆä½¿ç”¨å®Œç•¢ï¼‰
2. ä¸‹æ¬¡èª¿ç”¨ `doQueryInvoice()` æ™‚ï¼š
   - æŸ¥è©¢ STATUS_2 â†’ è¿”å›ç©º
   - è‡ªå‹•æ¿€æ´» STATUS_1 â†’ è½‰ç‚º STATUS_2
   - è¿”å›æ–°è™Ÿæ®µçš„ç¬¬ä¸€å€‹è™Ÿç¢¼

**ç„¡å¯ç”¨è™Ÿæ®µçš„éŒ¯èª¤è™•ç†**ï¼š

**ä½ç½®ï¼š** CashierCASAServices.insertData() (ç¬¬ 719-721 è¡Œ)

```java
String invoiceId = bzStorePosInvoiceServices.doQueryInvoice(
    storeId, posNo, empId, empName
);

if(invoiceId == null) {
    throw new RuntimeException("å·²ç„¡ç™¼ç¥¨è™Ÿç¢¼ï¼Œè«‹ç‚ºç•¶å‰POSåˆ†é…ç™¼ç¥¨è™Ÿç¢¼");
}
```

**æ¥­å‹™å½±éŸ¿**ï¼š
- æ”¶éŠ€å°ç„¡æ³•å®Œæˆçµå¸³
- éœ€è¦ç®¡ç†å“¡ç‚º POS åˆ†é…æ–°çš„è™Ÿæ®µ
- é˜²æ­¢ç™¼ç¥¨è™Ÿç¢¼è¶…å‡ºç¯„åœ

---

## äº”ã€ç™¼ç¥¨è™Ÿç¢¼èˆ‡è¨‚å–®çš„é—œè¯

### ç™¼ç¥¨è¨˜éŒ„è¡¨

**è¡¨ï¼šTBL_TRANS_MASTï¼ˆäº¤æ˜“ä¸»æª”ï¼‰**

**é—œéµæ¬„ä½ï¼š**
| æ¬„ä½ | èªªæ˜ |
|------|------|
| INVOICE_ID | ç™¼ç¥¨è™Ÿç¢¼ï¼ˆå­—è»Œ+è™Ÿç¢¼ï¼‰ |
| ORDER_ID | è¨‚å–® ID |
| STORE_ID | é–€åº— ID |
| TAX_TYPE | ç¨…åˆ¥ï¼ˆ0-é›¶ç¨…, 1-æ‡‰ç¨…, 2-å…ç¨…ï¼‰ |
| TOTAL_AMT | ç™¼ç¥¨é‡‘é¡ |
| TAX_AMT | ç¨…é¡ |

### æ”¯ä»˜æµç¨‹ä¸­çš„ç™¼ç¥¨åˆ†é…

**ä½ç½®ï¼š** CashierCASAServices.insertData() (ç¬¬ 691-755 è¡Œ)

```
è¨‚å–®çµå¸³æµç¨‹
  â†“
handleCashierPaymentBO()
  â†“
halndleInvoiceExtVO() (æŒ‰ç¨…åˆ¥çµ„ç¹”)
  â†“
insertData() (é‡å°æ¯å€‹ç¨…åˆ¥)
  â”œâ”€ doQueryInvoice() â† å–å¾—ç™¼ç¥¨è™Ÿç¢¼
  â”œâ”€ insert TBL_TRANS_MAST
  â”œâ”€ assign() â†’ insert TBL_TRANS_PAYMENT
  â””â”€ insert TBL_INADVANCE_INVOICE
```

**å®Œæ•´ä»£ç¢¼é‚è¼¯**ï¼š

```java
private void insertData(CASAResultVO resultVO, ..., String taxType) {
    // æ­¥é©Ÿ 1ï¼šå–å¾—ç™¼ç¥¨è™Ÿç¢¼
    String invoiceId = bzStorePosInvoiceServices.doQueryInvoice(
        storeId, posNo, empId, empName
    );

    if(invoiceId == null) {
        throw new RuntimeException("å·²ç„¡ç™¼ç¥¨è™Ÿç¢¼ï¼Œè«‹ç‚ºç•¶å‰POSåˆ†é…ç™¼ç¥¨è™Ÿç¢¼");
    }

    // æ­¥é©Ÿ 2ï¼šçµ„è£äº¤æ˜“ä¸»æª”
    TblTransMast tblTransMast = new TblTransMast();
    tblTransMast.setInvoiceId(invoiceId);
    tblTransMast.setOrderId(orderId);
    tblTransMast.setTaxType(taxType);
    tblTransMast.setTotalAmt(totalAmt);
    // ... å…¶ä»–æ¬„ä½

    // æ­¥é©Ÿ 3ï¼šæ’å…¥äº¤æ˜“ä¸»æª”
    tblTransMastMapper.insert(tblTransMast);

    // æ­¥é©Ÿ 4ï¼šæ’å…¥ä»˜æ¬¾æ˜ç´°
    this.assign(...);

    // æ­¥é©Ÿ 5ï¼šè™•ç†é æ”¶ç™¼ç¥¨
    // ...
}
```

---

## å…­ã€ä¸åŒç™¼ç¥¨é¡å‹çš„è™•ç†

### ä¸‰ç¨®ç¨…åˆ¥

| é¡å‹ | ä»£ç¢¼ | å¸¸æ•¸ | èªªæ˜ |
|------|------|------|------|
| é›¶ç¨… | "0" | SKU_TAX_TYPE_0 | é›¶ç¨…ç‡å•†å“ |
| æ‡‰ç¨… | "1" | SKU_TAX_TYPE_1 | ä¸€èˆ¬æ‡‰ç¨…å•†å“ |
| å…ç¨… | "2" | SKU_TAX_TYPE_2 | å…ç¨…å•†å“ |

**å¸¸æ•¸å®šç¾©ä½ç½®ï¼š**
`C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\common\constant\CommonConstant.java`

### æŒ‰ç¨…åˆ¥åˆ†é¡è™•ç†

**ä½ç½®ï¼š** CashierCASAServices.halndleInvoiceExtVO() (ç¬¬ 438-452 è¡Œ)

```java
private void halndleInvoiceExtVO(...) {
    // æŒ‰ç¨…åˆ¥åˆ†çµ„
    Map<String, List<InvoiceExtVO>> transMasMap = new HashMap<>();

    for(InvoiceExtVO vo : invoiceExtVOs) {
        String taxType = vo.getTaxType();
        if(!transMasMap.containsKey(taxType)) {
            transMasMap.put(taxType, new ArrayList<>());
        }
        transMasMap.get(taxType).add(vo);
    }

    // ä¾ç¨…åˆ¥åˆ†åˆ¥å‘¼å« insertData()
    if (transMasMap.get(CommonConstant.SKU_TAX_TYPE_0) != null) {
        this.insertData(..., transMasMap.get(CommonConstant.SKU_TAX_TYPE_0), "0");
    }
    if (transMasMap.get(CommonConstant.SKU_TAX_TYPE_1) != null) {
        this.insertData(..., transMasMap.get(CommonConstant.SKU_TAX_TYPE_1), "1");
    }
    if (transMasMap.get(CommonConstant.SKU_TAX_TYPE_2) != null) {
        this.insertData(..., transMasMap.get(CommonConstant.SKU_TAX_TYPE_2), "2");
    }
}
```

### å¤šç™¼ç¥¨å ´æ™¯

**ç¯„ä¾‹å ´æ™¯**ï¼š
```
è¨‚å–®å…§å®¹ï¼š
- å•†å“ Aï¼ˆæ‡‰ç¨…ï¼‰ï¼š100 TWD
- å•†å“ Bï¼ˆå…ç¨…ï¼‰ï¼š200 TWD
- å•†å“ Cï¼ˆé›¶ç¨…ï¼‰ï¼š50 TWD

çµæœï¼š
- ç™¼ç¥¨ 1ï¼ˆæ‡‰ç¨…ï¼‰ï¼šAB00000156, é‡‘é¡ 100 TWD
- ç™¼ç¥¨ 2ï¼ˆå…ç¨…ï¼‰ï¼šAB00000157, é‡‘é¡ 200 TWD
- ç™¼ç¥¨ 3ï¼ˆé›¶ç¨…ï¼‰ï¼šAB00000158, é‡‘é¡ 50 TWD

ç¸½è¨ˆä½¿ç”¨ 3 å€‹ç™¼ç¥¨è™Ÿç¢¼
```

**æ¥­å‹™è¦å‰‡**ï¼š
- ä¸€ç­†è¨‚å–®æœ€å¤šç”¢ç”Ÿ 3 å¼µç™¼ç¥¨
- æ¯ç¨®ç¨…åˆ¥ç¨ç«‹é–‹ç«‹
- ç™¼ç¥¨è™Ÿç¢¼é€£çºŒåˆ†é…

---

## ä¸ƒã€ç™¼ç¥¨è™Ÿæ®µåˆå§‹åŒ–å’Œæ›´æ–°æµç¨‹

### å¹´åº¦ç™¼ç¥¨åˆå§‹åŒ–

**è¡¨ï¼šTBL_STORE_INVOICEï¼ˆå¹´åº¦ç™¼ç¥¨ç¸½è¡¨ï¼‰**

**ä¸»è¦æ¬„ä½ï¼š**
| æ¬„ä½ | èªªæ˜ |
|------|------|
| YEAR_MONTH | å¹´æœˆï¼ˆYYYYMMï¼‰ |
| STORE_ID | é–€åº— ID |
| TRACK_ID | ç™¼ç¥¨å­—è»Œ |
| INV_START_NO | èµ·å§‹è™Ÿç¢¼ |
| INV_END_NO | çµ‚æ­¢è™Ÿç¢¼ |
| TOTAL_CNT | ç¸½é…é¡ |

**åˆå§‹åŒ–æ–¹æ³•ï¼š** ConfigServices.InsertStoreInvoice() (ç¬¬ 705-708 è¡Œ)

```java
public synchronized String InsertStoreInvoice(...) {
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
    TblStoreInvoiceCriteria criteria = new TblStoreInvoiceCriteria();
    criteria.createCriteria()
        .andYearMonthEqualTo(yearMonth)
        .andStoreIdEqualTo(storeId)
        .andTrackIdEqualTo(trackId);

    List<TblStoreInvoice> list = tblStoreInvoiceMapper.selectByCriteria(criteria);

    if(list.size() > 0) {
        return "ç™¼ç¥¨å­—è»Œã€" + trackId + "ã€‘å·²å­˜åœ¨";
    }

    // æ’å…¥æ–°è™Ÿæ®µ
    TblStoreInvoice invoice = new TblStoreInvoice();
    invoice.setYearMonth(yearMonth);
    invoice.setStoreId(storeId);
    invoice.setTrackId(trackId);
    invoice.setInvStartNo(invStartNo);
    invoice.setInvEndNo(invEndNo);
    invoice.setTotalCnt(calculateTotalCnt(invStartNo, invEndNo));

    tblStoreInvoiceMapper.insert(invoice);
    return "OK";
}
```

### POS ç™¼ç¥¨åˆ†é…

**æ–¹æ³•ï¼šConfigServices.insertStorePosInvoice()** (ç¬¬ 742-804 è¡Œ)

**åˆ†é…æµç¨‹**ï¼š

```java
public synchronized String insertStorePosInvoice(...) {
    // æ­¥é©Ÿ 1ï¼šè¨ˆç®—å¹´åº¦ç™¼ç¥¨ç¸½æ•¸
    int totalCnt = Integer.parseInt(invoice.getInvEndNo())
                 - Integer.parseInt(invoice.getInvStartNo()) + 1;

    // æ­¥é©Ÿ 2ï¼šè¨ˆç®—å·²åˆ†é…æ•¸
    TblStorePosInvoiceCriteria criteria = new TblStorePosInvoiceCriteria();
    criteria.createCriteria()
        .andYearMonthEqualTo(yearMonth)
        .andStoreIdEqualTo(storeId);

    List<TblStorePosInvoice> list = tblStorePosInvoiceMapper.selectByCriteria(criteria);

    int usedCnt = 0;
    for(TblStorePosInvoice pos : list) {
        usedCnt += pos.getTotalCnt();
    }

    // æ­¥é©Ÿ 3ï¼šè¨ˆç®—å¯ç”¨æ•¸
    int canUseCnt = totalCnt - usedCnt;

    // æ­¥é©Ÿ 4ï¼šæª¢æŸ¥å®¹é‡
    if (needCnt > canUseCnt) {
        return "ç¾æœ‰æœªåˆ†é…ç™¼ç¥¨å¼µæ•¸ä¸è¶³ï¼Œè«‹å‘ç¸½å…¬å¸ç”³è«‹å¹´åº¦ç™¼ç¥¨çµ¦è™Ÿ";
    }

    // æ­¥é©Ÿ 5ï¼šé€å€‹åˆ†é…
    TblStorePosInvoice newInvoice = this.newStorePosInvoice(
        invoice, usedCnt, needCnt, posId, yearMonth, storeId
    );

    tblStorePosInvoiceMapper.insert(newInvoice);
    return "OK";
}
```

### è©³ç´°åˆ†é…è¨ˆç®—

**æ–¹æ³•ï¼šConfigServices.newStorePosInvoice()** (ç¬¬ 806-837 è¡Œ)

```java
private TblStorePosInvoice newStorePosInvoice(
    TblStoreInvoice invoice, int usedCnt, int needCnt,
    String posId, String yearMonth, String storeId
) {
    // è¨ˆç®—èµ·å§‹å’Œçµ‚æ­¢è™Ÿç¢¼
    int starNo = Integer.parseInt(invoice.getInvStartNo()) + usedCnt;
    int endNo = starNo + needCnt - 1;

    String invStartNo = fillLeftSideWithZero(8, String.valueOf(starNo));
    String invEndNo = fillLeftSideWithZero(8, String.valueOf(endNo));

    // çµ„è£ POS è™Ÿæ®µå°è±¡
    TblStorePosInvoice result = new TblStorePosInvoice();
    result.setYearMonth(yearMonth);
    result.setStoreId(storeId);
    result.setPosId(posId);
    result.setTrackId(invoice.getTrackId());
    result.setInvStartNo(invStartNo);
    result.setInvEndNo(invEndNo);
    result.setNextInvNo(invStartNo);  // åˆå§‹å€¼ç­‰æ–¼èµ·å§‹è™Ÿ
    result.setUsedCnt(0);
    result.setTotalCnt(needCnt);
    result.setFreeCnt(needCnt);
    result.setStatus(StorePosInvoiceConstant.STATUS_1);  // åˆå§‹æœªä½¿ç”¨

    return result;
}
```

**ç¯„ä¾‹**ï¼š
```
å‡è¨­å¹´åº¦è™Ÿæ®µï¼šAB00000001 - AB00010000 (ç¸½æ•¸ 10000)
å·²åˆ†é…ï¼šPOS01 ä½¿ç”¨ 00000001-00003000 (3000å¼µ)

ç¾åœ¨ç‚º POS02 åˆ†é… 2000 å¼µï¼š
- starNo = 1 + 3000 = 3001
- endNo = 3001 + 2000 - 1 = 5000
- invStartNo = "00003001"
- invEndNo = "00005000"
- nextInvNo = "00003001"
- status = "1" (æœªä½¿ç”¨)
```

---

## å…«ã€éŒ¯èª¤è™•ç†æ©Ÿåˆ¶

### ä¸»è¦éŒ¯èª¤é¡å‹

| éŒ¯èª¤ä»£ç¢¼ | éŒ¯èª¤æ¶ˆæ¯ | åŸå›  | ä½ç½® | è¡Œè™Ÿ |
|---------|---------|-----|------|------|
| ERR_001 | "å·²ç„¡ç™¼ç¥¨è™Ÿç¢¼ï¼Œè«‹ç‚ºç•¶å‰POSåˆ†é…ç™¼ç¥¨è™Ÿç¢¼" | æ‰€æœ‰è™Ÿæ®µç”¨ç›¡ | CashierCASAServices | 720 |
| ERR_002 | "ç™¼ç¥¨è™Ÿç¢¼å–è™Ÿæœ‰å•é¡Œ!è«‹è¯çµ¡ç³»çµ±äººå“¡" | å¤šå€‹ STATUS_2 è™Ÿæ®µ | BzStorePosInvoiceServices | 79 |
| ERR_003 | "ç™¼ç¥¨è™Ÿç¢¼å–è™Ÿé‡è¤‡!è«‹æ›´æ–°é é¢è³‡è¨Šå¾Œé‡æ–°åšçµå¸³å‹•ä½œ" | ä¸¦ç™¼è¡çª | BzStorePosInvoiceServices | 95 |
| ERR_004 | "ç¾æœ‰æœªåˆ†é…ç™¼ç¥¨å¼µæ•¸ä¸è¶³ï¼Œè«‹å‘ç¸½å…¬å¸ç”³è«‹å¹´åº¦ç™¼ç¥¨çµ¦è™Ÿ" | åˆ†é…å®¹é‡ä¸è¶³ | ConfigServices | 774 |
| ERR_005 | "ç™¼ç¥¨å­—è»Œã€XXã€‘å·²å­˜åœ¨" | é‡è¤‡åˆå§‹åŒ– | ConfigServices | 708 |

### ä¸¦ç™¼æ§åˆ¶æ©Ÿåˆ¶

**ä½¿ç”¨ `synchronized` é—œéµå­—ä¿è­·é—œéµæ–¹æ³•**ï¼š

1. **BzStorePosInvoiceServices.doQueryInvoice()** (ç¬¬ 58 è¡Œ)
   ```java
   public synchronized String doQueryInvoice(...)
   ```
   - ä¿è­·ï¼šç™¼ç¥¨è™Ÿç¢¼å–è™Ÿéç¨‹
   - é˜²æ­¢ï¼šå¤šå€‹æ”¶éŠ€å“¡åŒæ™‚å–å¾—ç›¸åŒè™Ÿç¢¼

2. **ConfigServices.InsertStoreInvoice()** (ç¬¬ 705 è¡Œ)
   ```java
   public synchronized String InsertStoreInvoice(...)
   ```
   - ä¿è­·ï¼šå¹´åº¦è™Ÿæ®µåˆå§‹åŒ–
   - é˜²æ­¢ï¼šé‡è¤‡å»ºç«‹ç›¸åŒå­—è»Œ

3. **ConfigServices.insertStorePosInvoice()** (ç¬¬ 742 è¡Œ)
   ```java
   public synchronized String insertStorePosInvoice(...)
   ```
   - ä¿è­·ï¼šPOS è™Ÿæ®µåˆ†é…
   - é˜²æ­¢ï¼šè¶…é¡åˆ†é…

### é‡è¤‡ä½¿ç”¨é˜²è­·

**è¡¨ï¼šTBL_STORE_USED_INVOICE**

**æ¬„ä½ï¼š**
- INVOICE_ID (PK)ï¼šç™¼ç¥¨è™Ÿç¢¼ï¼ˆå­—è»Œ+è™Ÿç¢¼ï¼‰
- CREATED_DATEï¼šä½¿ç”¨æ™‚é–“

**æ©Ÿåˆ¶ï¼š**
```java
// BzStorePosInvoiceServices.java:91-98
TblStoreUsedInvoice tblStoreUsedInvoice = new TblStoreUsedInvoice();
tblStoreUsedInvoice.setInvoiceId(invoice.getTrackId() + invoice.getNextInvNo());

int result = tblStoreUsedInvoiceMapper.insert(tblStoreUsedInvoice);

if(result == 0) {
    // æ’å…¥å¤±æ•—è¡¨ç¤ºè™Ÿç¢¼å·²è¢«ä½¿ç”¨ï¼ˆä¸»éµè¡çªï¼‰
    throw new RuntimeException(
        "ç™¼ç¥¨è™Ÿç¢¼å–è™Ÿé‡è¤‡!è«‹æ›´æ–°é é¢è³‡è¨Šå¾Œé‡æ–°åšçµå¸³å‹•ä½œ"
    );
}
```

**å„ªé»ï¼š**
- æ•¸æ“šåº«å±¤é¢çš„å”¯ä¸€æ€§ç´„æŸ
- å³ä½¿ä¸¦ç™¼æ§åˆ¶å¤±æ•—ä¹Ÿèƒ½æ””æˆªé‡è¤‡
- æä¾›å®Œæ•´çš„ä½¿ç”¨è¨˜éŒ„

---

## ä¹ã€æ¥­å‹™è¦å‰‡ç¸½çµ

### è™Ÿæ®µç®¡ç†è¦å‰‡

| è¦å‰‡ ID | æè¿° | å„ªå…ˆç´š | å¯¦ä½œä½ç½® |
|---------|-----|--------|---------|
| **INV-R1** | å¹´æœˆéš”é›¢ï¼šæ¯å€‹å¹´æœˆä½¿ç”¨ç¨ç«‹è™Ÿæ®µ | é—œéµ | doQueryInvoice:60 |
| **INV-R2** | é–€åº—éš”é›¢ï¼šä¸åŒé–€åº—ä½¿ç”¨ä¸åŒè™Ÿæ®µ | é—œéµ | doQueryInvoice:64 |
| **INV-R3** | POS éš”é›¢ï¼šåŒä¸€é–€åº—çš„ä¸åŒ POS æ©Ÿä½¿ç”¨ä¸åŒè™Ÿæ®µ | é—œéµ | doQueryInvoice:64 |
| **INV-R4** | ç¨…åˆ¥å€åˆ†ï¼šæ‡‰ç¨…ã€å…ç¨…ã€é›¶ç¨…åˆ†é–‹é–‹ç«‹ | é—œéµ | halndleInvoiceExtVO:438-452 |
| **INV-R5** | é †åºåˆ†é…ï¼šæŒ‰ NEXT_INV_NO é †åºï¼Œä½¿ç”¨å¾Œè‡ªå‹•éå¢ | é«˜ | computerNextInvNo:130-133 |
| **INV-R6** | è‡ªå‹•æ¿€æ´»ï¼šè™Ÿæ®µç”¨ç›¡è‡ªå‹•æ¿€æ´»ä¸‹ä¸€å€‹ STATUS_1 | é«˜ | updateStatusForStatus1:5-19 |
| **INV-R7** | å®¹é‡ç®¡ç†ï¼šåˆ†é…æ™‚æª¢æŸ¥ç¸½å®¹é‡æ˜¯å¦å……è¶³ | é«˜ | insertStorePosInvoice:769-774 |
| **INV-R8** | ä½¿ç”¨è¨˜éŒ„ï¼šTBL_STORE_USED_INVOICE è¨˜éŒ„æ¯æ¬¡ä½¿ç”¨ | ä¸­ | doQueryInvoice:91-98 |
| **INV-R9** | ä¸¦ç™¼ä¿è­·ï¼šé—œéµæ–¹æ³•ä½¿ç”¨ synchronized | é—œéµ | å¤šè™• |
| **INV-R10** | ç‹€æ…‹æµè½‰ï¼š1(æœªä½¿ç”¨)â†’2(ä½¿ç”¨ä¸­)â†’3(ç”¨ç›¡) | é«˜ | updateInvoice:121-126 |

### éŒ¯èª¤è™•ç†è¦å‰‡

| è¦å‰‡ ID | æè¿° | å„ªå…ˆç´š | å¯¦ä½œä½ç½® |
|---------|-----|--------|---------|
| **ERR-R1** | ç„¡å¯ç”¨è™Ÿæ®µæ™‚æ‹‹å‡ºç•°å¸¸ï¼Œé˜»æ­¢çµå¸³ | é—œéµ | insertData:719-721 |
| **ERR-R2** | å¤šå€‹ STATUS_2 è™Ÿæ®µæ™‚æ‹‹å‡ºç•°å¸¸ï¼Œéœ€äººå·¥ä»‹å…¥ | é—œéµ | doQueryInvoice:77-79 |
| **ERR-R3** | è™Ÿç¢¼é‡è¤‡æ™‚æ‹‹å‡ºç•°å¸¸ï¼Œè¦æ±‚åˆ·æ–°é é¢ | é—œéµ | doQueryInvoice:94-96 |
| **ERR-R4** | å®¹é‡ä¸è¶³æ™‚è¿”å›å‹å¥½æç¤º | é«˜ | insertStorePosInvoice:769-774 |
| **ERR-R5** | å­—è»Œé‡è¤‡æ™‚è¿”å›å‹å¥½æç¤º | é«˜ | InsertStoreInvoice:708 |

---

## åã€é—œéµæ–‡ä»¶ä½ç½®

### æœå‹™å±¤

| æ–‡ä»¶ | åŠŸèƒ½ | é—œéµæ–¹æ³• |
|------|------|---------|
| **BzStorePosInvoiceServices.java** | ç™¼ç¥¨å–è™Ÿæ ¸å¿ƒé‚è¼¯ | doQueryInvoice, updateInvoice, computerNextInvNo |
| **CashierCASAServices.java** | æ”¶éŠ€çµå¸³æµç¨‹ | createCasaSoOrderCashier, handleCashierPaymentBO, insertData |
| **ConfigServices.java** | è™Ÿæ®µé…ç½®ç®¡ç† | InsertStoreInvoice, insertStorePosInvoice, newStorePosInvoice |

**å®Œæ•´è·¯å¾‘ï¼š**
```
C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\service\
â”œâ”€ BzStorePosInvoiceServices.java
â””â”€ ConfigServices.java

C:\Projects\som\so-webapp\src\main\java\com\trihome\som\so\web\service\
â””â”€ CashierCASAServices.java
```

### æ•¸æ“šè¨ªå•å±¤

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| **TblStorePosInvoiceMapper.java** | POS è™Ÿæ®µ DAO |
| **TblStoreInvoiceMapper.java** | å¹´åº¦è™Ÿæ®µ DAO |
| **TblStoreUsedInvoiceMapper.java** | ä½¿ç”¨è¨˜éŒ„ DAO |
| **TblTransMastMapper.java** | äº¤æ˜“ä¸»æª” DAO |
| **CustomBzStorePosInvoiceMapper.xml** | è‡ªå®šç¾© SQL |

**å®Œæ•´è·¯å¾‘ï¼š**
```
C:\Projects\som\so-coredb\src\main\java\com\trihome\som\so\mybatis\dao\
â”œâ”€ TblStorePosInvoiceMapper.java
â”œâ”€ TblStoreInvoiceMapper.java
â”œâ”€ TblStoreUsedInvoiceMapper.java
â””â”€ TblTransMastMapper.java

C:\Projects\som\so-coredb\src\main\resources\sqlMap\
â””â”€ CustomBzStorePosInvoiceMapper.xml
```

### å¸¸æ•¸å®šç¾©

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| **StorePosInvoiceConstant.java** | ç™¼ç¥¨ç‹€æ…‹ç¢¼ |
| **CommonConstant.java** | ç¨…åˆ¥å¸¸æ•¸ |

**å®Œæ•´è·¯å¾‘ï¼š**
```
C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\common\constant\
â”œâ”€ StorePosInvoiceConstant.java
â””â”€ CommonConstant.java
```

---

## çµè«–

SOM ç³»çµ±çš„ç™¼ç¥¨è™Ÿæ®µæª¢æŸ¥å’Œåˆ†é…æ©Ÿåˆ¶æ˜¯ä¸€å¥—**å®Œæ•´ã€åš´è¬¹**çš„ç³»çµ±ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹é»ï¼š

### å„ªé»

1. **å±¤æ¬¡åŒ–ç®¡ç†**ï¼šå¹´åº¦è™Ÿæ®µ â†’ POS è™Ÿæ®µ â†’ å¯¦éš›ä½¿ç”¨ï¼Œä¸‰å±¤çµæ§‹æ¸…æ™°
2. **ç‹€æ…‹æ©Ÿè¨­è¨ˆ**ï¼šä½¿ç”¨ç‹€æ…‹ç¢¼ç®¡ç†è™Ÿæ®µç”Ÿå‘½é€±æœŸï¼Œè½‰æ›é‚è¼¯æ˜ç¢º
3. **ä¸¦ç™¼æ§åˆ¶**ï¼šä½¿ç”¨ synchronized å’Œæ•¸æ“šåº«å”¯ä¸€ç´„æŸé›™é‡ä¿è­·
4. **è‡ªå‹•åŒ–ç¨‹åº¦é«˜**ï¼šè™Ÿæ®µç”¨ç›¡è‡ªå‹•æ¿€æ´»ï¼Œç„¡éœ€äººå·¥å¹²é 
5. **éŒ¯èª¤è™•ç†å®Œå–„**ï¼šå„ç¨®ç•°å¸¸æƒ…æ³éƒ½æœ‰æ˜ç¢ºçš„éŒ¯èª¤æç¤º

### æ”¹é€²å»ºè­°

1. **ç›£æ§æ©Ÿåˆ¶**ï¼šå»ºè­°å¢åŠ è™Ÿæ®µå‰©é¤˜é‡ç›£æ§ï¼Œæå‰é è­¦
2. **æ—¥èªŒè¨˜éŒ„**ï¼šé—œéµæ“ä½œæ‡‰è¨˜éŒ„è©³ç´°æ—¥èªŒä¾¿æ–¼è¿½è¹¤
3. **å®¹éŒ¯æ©Ÿåˆ¶**ï¼šè€ƒæ…®å¢åŠ è™Ÿæ®µé åˆ†é…æ©Ÿåˆ¶ï¼Œé¿å…é«˜å³°æœŸç”¨ç›¡
4. **æ€§èƒ½å„ªåŒ–**ï¼šé«˜ä¸¦ç™¼å ´æ™¯ä¸‹ synchronized å¯èƒ½æˆç‚ºç“¶é ¸ï¼Œå¯è€ƒæ…®åˆ†æ•£å¼é–

### è¦†è“‹ç‡å½±éŸ¿

æœ¬æ¬¡è¿½è¹¤æ–°å¢ **15 æ¢æ¥­å‹™è¦å‰‡**ï¼ˆINV-R1 ~ INV-R10, ERR-R1 ~ ERR-R5ï¼‰ï¼Œæå‡å°ç™¼ç¥¨ç®¡ç†é‚è¼¯çš„è¦†è“‹ã€‚

---

**è¿½è¹¤å®Œæˆæ—¥æœŸ**ï¼š2025-10-28
**æ–‡ä»¶ç‰ˆæœ¬**ï¼š1.0
**ä¸‹ä¸€æ­¥**ï¼šæ•´åˆåˆ° Rewrite-Spec v1.4

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
