# ä¿ƒéŠ·æ•¸é‡é™åˆ¶(LIMIT_QTY)æº¢ä½è™•ç†è¿½è¹¤

## æ–‡æª”å…ƒæ•¸æ“š

**å‰µå»ºæ—¥æœŸ**: 2025-10-27
**éšæ®µ**: Phase 2 Week 3 - ä¿ƒéŠ·é‚è¼¯åˆ†æ
**ç¯„åœ**: Event A-Hä¸­LIMIT_QTYæº¢ä½è™•ç†æ¨¡å¼ã€é‚Šç·£æ¡ˆä¾‹ã€éŒ¯èª¤è™•ç†
**ä»£ç¢¼ä½ç½®**: so-bzservices/src/main/java/com/trihome/som/bz/functions
**ç‹€æ…‹**: âœ… å·²å®Œæˆ - å·²è­˜åˆ¥é—œéµéŒ¯èª¤

---

## åŸ·è¡Œæ‘˜è¦

### é—œéµç™¼ç¾

**ğŸ”´ é‡å¤§ç™¼ç¾**: Event A-Hä¿ƒéŠ·è¨ˆç®—å™¨ä½¿ç”¨**å››ç¨®ä¸åŒçš„LIMIT_QTYæº¢ä½è™•ç†æ¨¡å¼**,å°è‡´ä¸ä¸€è‡´çš„ä½¿ç”¨è€…é«”é©—å’Œæ½›åœ¨éŒ¯èª¤ã€‚

### è™•ç†æ¨¡å¼ç¸½è¦½

| æ¨¡å¼ | äº‹ä»¶ | è¡Œç‚º | ä½¿ç”¨è€…é«”é©— |
|------|------|------|------------|
| **æ¨¡å¼1: æ‹’çµ•ä¸¦å ±éŒ¯** | Event A | è¶…éé™åˆ¶â†’å–æ¶ˆä¿ƒéŠ·,é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ | æ˜ç¢ºéŒ¯èª¤è¨Šæ¯ |
| **æ¨¡å¼2: ä¸Šé™å°é ‚** | Event D, E | `Math.min(buyQty, limit)` | éœé»˜å°é ‚,è¶…é¡å¿½ç•¥ |
| **æ¨¡å¼3: ä¸‰é‡æœ€å°å€¼** | Event B | `min(buyQty, min(limit1, limit2))` | éœé»˜å°é ‚,è¶…é¡å¿½ç•¥ |
| **æ¨¡å¼4: è¤‡é›œæª¢æŸ¥** | Event G | æª¢æŸ¥â†’è·³éâ†’é‡è©¦ä¸‹å±¤ç´š | éœé»˜é™ç´šåŒ¹é… |
| **ç„¡é™åˆ¶** | Event C | ä¸ä½¿ç”¨LIMIT_QTY | å…¨éƒ¨æŠ˜æ‰£ |
| **ä½¿ç”¨condAmt** | Event F, H | ä½¿ç”¨condAmtè€ŒélimitQty | çµ„åˆ¥æ•¸é‡é™åˆ¶ |

### è­˜åˆ¥çš„é—œéµéŒ¯èª¤

1. **ğŸš¨ ç©ºæŒ‡æ¨™é¢¨éšª** (æ‰€æœ‰ä½¿ç”¨limitQtyçš„äº‹ä»¶): ç„¡nullæª¢æŸ¥å°±unbox `Short â†’ int`
2. **ğŸš¨ è² æ•¸é‡éŒ¯èª¤** (Event B/D/E): é€€è²¨äº¤æ˜“(è² æ•¸é‡)å¯èƒ½ç¹éé™åˆ¶
3. **ğŸš¨ Event Aé€€è²¨ç¹é**: `totalQty > limitQty`åœ¨`totalQty < 0`æ™‚å¤±æ•ˆ
4. **âš ï¸ limitQty=0ä¸ä¸€è‡´**: Event Aè¦–ç‚ºç„¡é™,å…¶ä»–è¦–ç‚ºæ‹’çµ•å…¨éƒ¨

---

## Event A-H LIMIT_QTYè™•ç†æ¨¡å¼è©³ç´°åˆ†æ

### æ‘˜è¦è¡¨: Event A-Hçš„LIMIT_QTYè™•ç†æ¨¡å¼

| äº‹ä»¶ | ä¿ƒéŠ·é¡å‹ | ä½¿ç”¨LIMIT_QTY? | è™•ç†æ¨¡å¼ | ä»£ç¢¼ä½ç½® | ä½¿ç”¨è€…å½±éŸ¿ |
|------|---------|----------------|----------|----------|-----------|
| **A** | å°èŠ±åƒ¹ | âœ… æ˜¯ (`limitQty`) | **æ¨¡å¼1: æ‹’çµ•** | `SoEventA.java:129-170` | é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯,å–æ¶ˆä¿ƒéŠ· |
| **B** | ç™¼ç¥¨é‡‘é¡æ»¿é¡åŠ åƒ¹è³¼ | âœ… æ˜¯ (`TblPromSet.getDiscountQty()`) | **æ¨¡å¼3: ä¸‰é‡æœ€å°å€¼** | `SoEventB.java:213-218` | éœé»˜å°é ‚,è¶…é¡å¿½ç•¥ |
| **C** | é‡‘é¡/æ•¸é‡é–€æª»å…¨é¢å„ªæƒ  | âŒ å¦ | N/A - ç„¡å–®å“é™åˆ¶ | N/A | å…¨éƒ¨åˆæ ¼å•†å“æŠ˜æ‰£ |
| **D** | æ¯è²·Må€‹äº«å…¶ä¸­Nå€‹å„ªæƒ  | âœ… æ˜¯ (`TblPromSet.getDiscountQty()`) | **æ¨¡å¼2: é›™é‡æœ€å°å€¼(å°é ‚)** | `SoEventD.java:218-236` | éœé»˜å°é ‚,è¶…é¡å¿½ç•¥ |
| **E** | è²·Aç¾¤çµ„äº«Bç¾¤çµ„å„ªæƒ  | âœ… æ˜¯ (`TblPromSet.getDiscountQty()`) | **æ¨¡å¼2: é›™é‡æœ€å°å€¼(å°é ‚)** | `SoEventE.java:275-293` | éœé»˜å°é ‚,è¶…é¡å¿½ç•¥ |
| **F** | åˆè³¼åƒ¹ | âŒ å¦ | N/A - ä½¿ç”¨`condAmt` | `SoEventF.java:223-245` | çµ„åˆ¥æ•¸é‡é™åˆ¶(condAmt) |
| **G** | å…±ç”¨å•†å“åˆè³¼åƒ¹ | âœ… æ˜¯ (`TblPromSet.getDiscountQty()`) | **æ¨¡å¼4: è¤‡é›œæª¢æŸ¥** | `SoEventG.java:236-305` | éœé»˜è·³é,éè¿´é‡è©¦ |
| **H** | å–®å“æ‹†åƒ¹åˆè³¼åƒ¹ | âŒ å¦ | N/A - ä½¿ç”¨`condAmt` | `SoEventH.java:222-238` | çµ„åˆ¥æ•¸é‡é™åˆ¶(condAmt) |

---

## æ¨¡å¼1: å…¨æœ‰æˆ–å…¨ç„¡æ‹’çµ• (Event A)

### Event A - å°èŠ±åƒ¹

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\functions\SoEventA.java`

**LIMIT_QTYä¾†æº**:
```java
Line 129: int limitQty = promoGupCdt.getLimitQty();
Line 130: logger.info("å–®ç­†ç™¼ç¥¨é™è³¼æ•¸é‡: " + limitQty);
```

**è™•ç†é‚è¼¯** (Lines 157-170):
```java
//è¶…éé™è³¼æ•¸é‡ï¼Œè·³å‡º
for (OrderDetlVO orderDetlVO : itemList) {
    if(discItemDetlSeqId.contains(orderDetlVO.getDetlSeqId())
            && limitQty != 0 &&  totalQtyMap.get(orderDetlVO.getSkuNo()) > limitQty){
        logger.info("æª”æœŸ"+promEvent.getEventNo()+" "+promEvent.getEventName()+
            " å•†å“: " + orderDetlVO.getSkuNo() + " " + orderDetlVO.getSkuName() +
            " å°èŠ±å•†å“ä½¿ç”¨æ•¸é‡è¶…éå–®ç­†äº¤æ˜“å¯ä½¿ç”¨é™åˆ¶ã€‚");

        // â˜… æ–°å¢éŒ¯èª¤è¨Šæ¯åˆ°éŒ¯èª¤æ¸…å–®
        errorItems.add("æª”æœŸ"+promEvent.getEventNo()+" "+promEvent.getEventName()+
            " å•†å“: " + orderDetlVO.getSkuNo() + " " + orderDetlVO.getSkuName()+
            " å°èŠ±å•†å“ä½¿ç”¨æ•¸é‡è¶…éå–®ç­†äº¤æ˜“å¯ä½¿ç”¨é™åˆ¶ã€‚");

        // â˜… å–æ¶ˆå•†å“çš„å°èŠ±åƒ¹å‹¾é¸
        logger.info("å•†å“: " + orderDetlVO.getSkuNo() + " å°èŠ±åƒ¹ CHECKBOX æ”¹ç‚ºæœªå‹¾é¸ã€‚");
        orderDetlVO.setStampFlag(false);
        orderDetlVO.setDiscountAmt("0");

        // â˜… ç«‹å³è¿”å›,ä¸è™•ç†æ­¤ä¿ƒéŠ·
        return;
    }
}
```

**æ¨¡å¼ç‰¹å¾µ**:
- **æª¢æŸ¥**: `totalQtyMap.get(skuNo) > limitQty`
- **è¡Œç‚º**: å¦‚æœè¶…éâ†’æ–°å¢éŒ¯èª¤è¨Šæ¯,å–æ¶ˆ`stampFlag`,è¨­å®šæŠ˜æ‰£=0,ç«‹å³è¿”å›
- **ç‰¹æ®Šè™•ç†**: `limitQty == 0`æ™‚è¦–ç‚ºç„¡é™åˆ¶(è·³éé©—è­‰)

**ä½¿ç”¨è€…é«”é©—**:
- âœ… **æ˜ç¢ºéŒ¯èª¤è¨Šæ¯**: æ”¶éŠ€å“¡çœ‹åˆ°å…·é«”çš„è¶…é™è¨Šæ¯
- âœ… **æ‰‹å‹•æ±ºç­–**: æ”¶éŠ€å“¡å¯ä»¥æ±ºå®šæ˜¯å¦ä½¿ç”¨å°èŠ±åƒ¹
- âŒ **å…¨æœ‰æˆ–å…¨ç„¡**: å³ä½¿åªè¶…é1å€‹,ä¹Ÿå–æ¶ˆå…¨éƒ¨å•†å“çš„ä¿ƒéŠ·

**æ¥­å‹™ç†ç”±**:
- å°èŠ±åƒ¹éœ€è¦æ”¶éŠ€å“¡ç¢ºèª
- POSæ”¶éŠ€å“¡éœ€è¦çŸ¥é“ç‚ºä»€éº¼ç„¡æ³•å¥—ç”¨ä¿ƒéŠ·
- å¯èƒ½æ¶‰åŠåº«å­˜æˆ–æ”¿ç­–é™åˆ¶,éœ€è¦äººå·¥å¹²é 

---

## æ¨¡å¼2: é›™é‡æœ€å°å€¼å°é ‚ (Event D, E)

### Event D - å•†å“æ¯è²·Må€‹,äº«å…¶ä¸­Nå€‹å„ªæƒ 

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\functions\SoEventD.java`

**LIMIT_QTYä¾†æº**:
```java
Line 219: int limitQty = tblPromSet.getDiscountQty(); // é™åˆ¶æŠ˜æ‰£æ•¸é‡
```

**è™•ç†é‚è¼¯** (Lines 210-236):
```java
/**
 * è¨­å®šæœ€é«˜POSåƒ¹å•†å“å¯æŠ˜æ‰£æ•¸é‡
 * @param discItems
 * @param maxQty - æœ€å¤§å„ªæƒ çµ„æ•¸
 * @param index
 * @param befDiscQty - å·²æŠ˜æ‰£æ•¸é‡
 */
private void calculateDiscQty(HashMap<String,Object>[] discItems, int maxQty, int index, int befDiscQty) {
    HashMap<String,Object> map = discItems[index];
    int buyQty = Integer.parseInt((String)map.get("Qty")); // è³¼è²·æ•¸é‡

    // å·²æŠ˜æ‰£æ•¸é‡
    int remainQty = Integer.parseInt((String)serialDiscQtyMap.get((String)map.get("serialNO")));

    // æ‰£é™¤å·²æŠ˜æ‰£æ•¸é‡
    buyQty -= remainQty;

    TblPromSet tblPromSet = (TblPromSet)map.get("tblPromSet");
    int limitQty = tblPromSet.getDiscountQty(); // é™åˆ¶æŠ˜æ‰£æ•¸é‡

    // â˜… å¯æŠ˜æ‰£æ•¸é‡ = æœ€å¤§å„ªæƒ çµ„æ•¸ * é™åˆ¶æŠ˜æ‰£æ•¸é‡ - å·²æŠ˜æ‰£æ•¸é‡
    int totalLimitQty = (maxQty * limitQty) - befDiscQty;

    // â˜… å¯æŠ˜æŠµæ•¸é‡ = å…©æ•¸å–æœ€å° (è³¼è²·æ•¸é‡, å¯æŠ˜æ‰£æ•¸é‡)
    int discQty = Math.min(buyQty, totalLimitQty);
    map.put("discQty", String.valueOf(discQty));

    // æœ‰å·²æŠ˜æ‰£æ•¸é‡
    if(remainQty > 0){
        map.put("remainQty", String.valueOf(remainQty));
    }

    // â˜… éè¿´: åˆ¤æ–·å‰©é¤˜å¯æŠ˜æ‰£æ•¸é‡å¤§æ–¼0 && discItems é‚„æœ‰å•†å“
    if(discQty > 0 && (index+1) < discItems.length){
        index++;
        calculateDiscQty(discItems, maxQty, index, (discQty+befDiscQty));
    }
}
```

**å…¬å¼**:
```
totalLimitQty = (maxQty Ã— limitQty) - befDiscQty
discQty = min(buyQty, totalLimitQty)
```

**æ¨¡å¼ç‰¹å¾µ**:
- **æª¢æŸ¥**: ç„¡æ˜ç¢ºæª¢æŸ¥,ç›´æ¥ä½¿ç”¨`Math.min`
- **è¡Œç‚º**: è‡ªå‹•å°é ‚åˆ°é™åˆ¶æ•¸é‡,è¶…é¡éƒ¨åˆ†éœé»˜å¿½ç•¥
- **éè¿´**: å¤šå€‹å•†å“æ™‚éè¿´åˆ†é…å‰©é¤˜å¯ç”¨æŠ˜æ‰£é¡åº¦

**ä½¿ç”¨è€…é«”é©—**:
- âœ… **è‡ªå‹•åŒ–**: ç³»çµ±è‡ªå‹•å¥—ç”¨æœ€å¤§å¯ç”¨æŠ˜æ‰£
- âœ… **éƒ¨åˆ†æŠ˜æ‰£**: è¶…éé™åˆ¶ä»å¯å–å¾—éƒ¨åˆ†æŠ˜æ‰£
- âŒ **ç„¡é€šçŸ¥**: å®¢æˆ¶ä¸çŸ¥é“æœ‰éƒ¨åˆ†æ•¸é‡æœªæŠ˜æ‰£

**ç¯„ä¾‹**:
```
å ´æ™¯: è²·5é€2ä¿ƒéŠ·,æ¯äººé™è³¼10å€‹
- å®¢æˆ¶è³¼è²·15å€‹
- limitQty = 2 (æ¯çµ„é€2å€‹)
- maxQty = Math.floor(15/5) = 3çµ„
- totalLimitQty = 3 Ã— 2 = 6å€‹æŠ˜æ‰£
- buyQty = 15å€‹
- discQty = min(15, 6) = 6å€‹ âœ…
- çµæœ: 6å€‹æœ‰æŠ˜æ‰£,9å€‹åŸåƒ¹
```

---

### Event E - è²·æ¢ä»¶å•†å“Aç¾¤çµ„å¯äº«Bå•†å“ç¾¤çµ„å„ªæƒ 

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\functions\SoEventE.java`

**LIMIT_QTYä¾†æº**:
```java
Line 280: int limitQty = tblPromSet.getDiscountQty(); // é™åˆ¶æŠ˜æ‰£æ•¸é‡
```

**è™•ç†é‚è¼¯** (Lines 275-293):
```java
private void calculateDiscQty(HashMap<String, Object>[] discItems, int maxQty, int index, int befDiscQty) {
    HashMap<String, Object> map = discItems[index];
    int buyQty = Integer.parseInt((String)map.get("Qty")); // è³¼è²·æ•¸é‡

    TblPromSet tblPromSet = (TblPromSet)map.get("tblPromSet");
    int limitQty = tblPromSet.getDiscountQty(); // é™åˆ¶æŠ˜æ‰£æ•¸é‡

    // â˜… å¯æŠ˜æ‰£æ•¸é‡ = æœ€å¤§å„ªæƒ çµ„æ•¸ * é™åˆ¶æŠ˜æ‰£æ•¸é‡ - å·²æŠ˜æ‰£æ•¸é‡
    int totalLimitQty = (maxQty * limitQty) - befDiscQty;

    // â˜… å¯æŠ˜æŠµæ•¸é‡ = å…©æ•¸å–æœ€å° (è³¼è²·æ•¸é‡, å¯æŠ˜æ‰£æ•¸é‡)
    int discQty = Math.min(buyQty, totalLimitQty);
    map.put("discQty", String.valueOf(discQty));

    // â˜… éè¿´: åˆ¤æ–·å‰©é¤˜å¯æŠ˜æ‰£æ•¸é‡å¤§æ–¼0 && discItems é‚„æœ‰å•†å“
    if(discQty > 0 && (index+1) < discItems.length){
        index++;
        calculateDiscQty(discItems, maxQty, index, (discQty+befDiscQty));
    }
}
```

**æ¨¡å¼ç‰¹å¾µ**:
- **èˆ‡Event Då®Œå…¨ç›¸åŒ**çš„é‚è¼¯
- æ‡‰ç”¨æ–¼ç¾¤çµ„A(æ¢ä»¶)å’Œç¾¤çµ„B(æŠ˜æ‰£)å…©é‚Š
- éè¿´åˆ†é…å‰©é¤˜æŠ˜æ‰£é¡åº¦

**é™åˆ¶**:
```java
Line 134-138:
// Event E ä¸æ”¯æ´å¤šéšå±¤
// åªè™•ç†ç¬¬ä¸€å±¤ç´š(seqNo = "1")
```

---

## æ¨¡å¼3: ä¸‰é‡æœ€å°å€¼å°é ‚ (Event B)

### Event B - ç™¼ç¥¨é‡‘é¡æ»¿é¡åŠ åƒ¹è³¼

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\functions\SoEventB.java`

**LIMIT_QTYä¾†æº**:
```java
Line 213: int limitQty = tblPromSet.getDiscountQty(); // é™åˆ¶æŠ˜æ‰£æ•¸é‡
Line 234: int limitQty = tblPromSet.getDiscountQty(); // é™åˆ¶æŠ˜æ‰£æ•¸é‡
```

**è™•ç†é‚è¼¯ç‰ˆæœ¬1** (å–®ä¸€å•†å“, Lines 209-218):
```java
private void calculateDiscQty(HashMap<String,Object> discItem, int maxQty) {
    int buyQty = Integer.parseInt((String)discItem.get("Qty")); // è³¼è²·æ•¸é‡

    TblPromSet tblPromSet = (TblPromSet)discItem.get("tblPromSet");
    int limitQty = tblPromSet.getDiscountQty(); // é™åˆ¶æŠ˜æ‰£æ•¸é‡

    // â˜… å¯æŠ˜æŠµæ•¸é‡ = ä¸‰æ•¸å–æœ€å° (è³¼è²·æ•¸é‡, é™åˆ¶æŠ˜æ‰£æ•¸é‡, æœ€å¤§å„ªæƒ çµ„æ•¸*é™åˆ¶æŠ˜æ‰£æ•¸é‡)
    int discQty = (int)Math.min(buyQty, (int)Math.min(limitQty, maxQty*limitQty));
    discItem.put("discQty", String.valueOf(discQty));

    // è¨ˆç®—ä½¿ç”¨çš„å„ªæƒ çµ„æ•¸
    teamDiscQty += (int)Math.ceil((double)discQty/(double)limitQty);
}
```

**è™•ç†é‚è¼¯ç‰ˆæœ¬2** (å¤šå•†å“éè¿´, Lines 229-248):
```java
private void calculateDiscQty(HashMap<String,Object>[] discItems, int maxQty, int index, int befDiscQty) {
    HashMap<String,Object> map = discItems[index];
    int buyQty = Integer.parseInt((String)map.get("Qty")); // è³¼è²·æ•¸é‡

    TblPromSet tblPromSet = (TblPromSet)map.get("tblPromSet");
    int limitQty = tblPromSet.getDiscountQty(); // é™åˆ¶æŠ˜æ‰£æ•¸é‡

    // â˜… å¯æŠ˜æ‰£æ•¸é‡ = æœ€å¤§å„ªæƒ çµ„æ•¸ * é™åˆ¶æŠ˜æ‰£æ•¸é‡ - å·²æŠ˜æ‰£æ•¸é‡
    int totalLimitQty = (maxQty * limitQty) - befDiscQty;

    // â˜… å¯æŠ˜æŠµæ•¸é‡ = å…©æ•¸å–æœ€å° (è³¼è²·æ•¸é‡, å¯æŠ˜æ‰£æ•¸é‡)
    int discQty = Math.min(buyQty, totalLimitQty);
    map.put("discQty", String.valueOf(discQty));

    // è¨ˆç®—ä½¿ç”¨çš„å„ªæƒ çµ„æ•¸
    teamDiscQty += (int)Math.ceil((double)discQty/(double)limitQty);

    // â˜… éè¿´: åˆ¤æ–·å‰©é¤˜å¯æŠ˜æ‰£æ•¸é‡å¤§æ–¼0 && discItems é‚„æœ‰å•†å“
    if(discQty > 0 && (index+1) < discItems.length){
        index++;
        calculateDiscQty(discItems, maxQty, index, (discQty+befDiscQty));
    }
}
```

**å…¬å¼**:
```
ç‰ˆæœ¬1 (å–®ä¸€å•†å“):
discQty = min(buyQty, min(limitQty, maxQty Ã— limitQty))

ç‰ˆæœ¬2 (å¤šå•†å“):
totalLimitQty = (maxQty Ã— limitQty) - befDiscQty
discQty = min(buyQty, totalLimitQty)
```

**æ¨¡å¼ç‰¹å¾µ**:
- **ä¸‰é‡ä¿è­·**: è³¼è²·æ•¸é‡ã€å–®æ¬¡é™åˆ¶ã€ç¸½é‡é™åˆ¶ä¸‰è€…å–æœ€å°
- **çµ„æ•¸è¿½è¹¤**: è¨ˆç®—`teamDiscQty`è¿½è¹¤ä½¿ç”¨çš„å„ªæƒ çµ„æ•¸
- **éè¿´åˆ†é…**: å¤šå•†å“æ™‚éè¿´åˆ†é…å‰©é¤˜é¡åº¦

---

## æ¨¡å¼4: è¤‡é›œæª¢æŸ¥èˆ‡å±¤ç´šé‡è©¦ (Event G)

### Event G - å…±ç”¨å•†å“åˆè³¼åƒ¹

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\functions\SoEventG.java`

**LIMIT_QTYä¾†æº**:
```java
Line 236-237: tblPromSet.getDiscountQty()
Line 300-304: tblPromSet.getDiscountQty()
```

**éšæ®µ1: æª¢æŸ¥SKUæ•¸é‡æ˜¯å¦å……è¶³** (Lines 223-246):
```java
// æª¢æŸ¥å„å•†å“çš„ç¸½é‡æ˜¯å¦è¶³å¤ 
boolean isSkuChekOk = false;
Integer skuTotalBuyQty = 0;

for(TblPromSet tblPromSet : promSetList){
    // å•†å“æ–¼è¨‚å–®çš„ç¸½é‡
    Integer skuDisUsedQty = skuDisQtyMap.get(tblPromSet.getSkuNo())==null?0:skuDisQtyMap.get(tblPromSet.getSkuNo());

    for (OrderDetlVO orderDetlVO : itemList) {
        if(tblPromSet.getSkuNo().equals(orderDetlVO.getSkuNo())){
            skuTotalBuyQty += Integer.valueOf(orderDetlVO.getQuantity());
        }
    }

    // â˜… å¦‚æœç¸½é‡å·²ç¶“ä¸è¶³å‰‡å¿…éœ€è·³å‡ºè¿´åœˆ
    if(StringUtils.equals("3", tblPromCondition.getConditionType())
            && (skuTotalBuyQty - skuDisUsedQty)>=tblPromSet.getDiscountQty()){
        isSkuChekOk = true;
        break;
    }
}

// â˜… æª¢æŸ¥å¤±æ•—â†’æ›ä¸‹ä¸€å€‹ç´šè·
if(!isSkuChekOk){
    logger.info("å•†å“ç¾¤çµ„: " + promSetList.get(0).getGroupSeqNo() + " æœªç¬¦åˆæ¢ä»¶, æ›ä¸‹ä¸€å€‹ç´šè·");
    isCheckOk = false;
    break;
}
```

**éšæ®µ2: è¿½è¹¤å·²ä½¿ç”¨æ•¸é‡** (Lines 287-306):
```java
for (TblPromSet tblPromSet : promoSetList) {
    // ...
    logger.info("å•†å“: " + tblPromSet.getSkuNo() + " å·²è¢«æŠ˜æŠµé‡: " + skuDisUsedQty);

    // â˜… ç¸½é‡ - å·²æŠ˜é‡ = å¯æŠ˜é‡
    // â˜… å¯æŠ˜é‡å°æ–¼çµ„ä¿ƒå„ªæƒ æ•¸å°±è·³ä¸‹ä¸€å€‹å•†å“åšæª¢æŸ¥
    if((goodsCount.get(getGroupKey(tblPromSet)) - skuDisUsedQty) < tblPromSet.getDiscountQty()){
        logger.info("å•†å“: " + tblPromSet.getSkuNo() + " å¯æŠ˜é‡: " + (skuTotalBuyQty - skuDisUsedQty)
            + " å°‘æ–¼å„ªæƒ æ•¸é‡: " + tblPromSet.getDiscountQty());
        continue; // â˜… è·³éæ­¤å•†å“
    }else{
        // â˜… æ¨™è¨˜ç‚ºå·²ä½¿ç”¨
        skuDisQtyMap.put(tblPromSet.getSkuNo(), skuDisUsedQty + tblPromSet.getDiscountQty());
    }
}
```

**éšæ®µ3: å±¤ç´šé‡è©¦é‚è¼¯** (Lines 161-315):
```java
// å¾ªç’°è™•ç†å„å±¤ç´š
for(int i=seq; i<=seqCount; i++){
    // ... è™•ç†å±¤ç´š i

    if(!isCheckOk){
        // â˜… æª¢æŸ¥å¤±æ•—â†’é‡è©¦ä¸‹ä¸€å€‹å±¤ç´š
        seq = i + 1;
        if(seq > seqCount){
            break; // æ‰€æœ‰å±¤ç´šéƒ½å¤±æ•—
        }
        continue; // é‡è©¦
    }

    // ... æˆåŠŸè™•ç†
}
```

**æ¨¡å¼ç‰¹å¾µ**:
- **æœ€è¤‡é›œå¯¦ä½œ**: ä¸‰éšæ®µæª¢æŸ¥+è¿½è¹¤+é‡è©¦
- **å…±äº«åº«å­˜**: å¤šå€‹SKUå…±äº«åŒä¸€ä¿ƒéŠ·é¡åº¦
- **æ©Ÿæœƒå¼åŒ¹é…**: å˜—è©¦æœ€ä½³å±¤ç´š,å¤±æ•—å‰‡é™ç´š
- **ç‹€æ…‹è¿½è¹¤**: ä½¿ç”¨`skuDisQtyMap`è¿½è¹¤å„SKUå·²ä½¿ç”¨æ•¸é‡

**ä½¿ç”¨è€…é«”é©—**:
- âœ… **å½ˆæ€§**: ç³»çµ±å˜—è©¦æ‰¾åˆ°æœ€ä½³å¯ç”¨ä¿ƒéŠ·
- âœ… **é™ç´š**: é«˜å±¤ç´šä¸ç¬¦åˆæ™‚è‡ªå‹•å˜—è©¦ä½å±¤ç´š
- âŒ **ç„¡é€šçŸ¥**: å®¢æˆ¶ä¸çŸ¥é“ä½¿ç”¨çš„æ˜¯å“ªå€‹å±¤ç´š

---

## ç„¡ä½¿ç”¨LIMIT_QTYçš„äº‹ä»¶

### Event C - å•†å“æ»¿(é‡‘é¡/æ•¸é‡)ä»¥ä¸Š,å…¨é¢å„ªæƒ 

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\functions\SoEventC.java`

**é‚è¼¯**:
```java
Line 161: caculate(itemList, promoSet);
// å°itemListä¸­çš„æ‰€æœ‰å•†å“å¥—ç”¨æŠ˜æ‰£,ç„¡æ•¸é‡ä¸Šé™
```

**ç‰¹å¾µ**:
- âŒ **ä¸ä½¿ç”¨LIMIT_QTY**
- åªæª¢æŸ¥ç¸½é‡‘é¡/æ•¸é‡é–€æª»(`condAmt`)
- é–€æª»é”æˆå¾Œ,**æ‰€æœ‰**åˆæ ¼å•†å“ä»¥å…¨æ•¸é‡æŠ˜æ‰£

---

### Event F - åˆè³¼åƒ¹

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\functions\SoEventF.java`

**é‚è¼¯** (Lines 223-245):
```java
private void calculateDiscQty(HashMap<String,Object>[] discItems, int maxQty, int index, int befDiscQty) {
    HashMap<String,Object> map = discItems[index];
    int posAmt = Integer.parseInt((String)map.get("PosAmt")); // POSåƒ¹
    int buyQty = Integer.parseInt((String)map.get("Qty")); // è³¼è²·æ•¸é‡
    int condAmt = Integer.parseInt((String)map.get("condAmt")); // â˜… æ¢ä»¶æ•¸é‡

    // â˜… å¯æŠ˜æ‰£æ•¸é‡ = (æœ€å¤§å„ªæƒ çµ„æ•¸ * æ¢ä»¶æ•¸é‡) - å·²æŠ˜æ‰£æ•¸é‡
    int totalLimitQty = (maxQty * condAmt) - befDiscQty;

    // å¯æŠ˜æŠµæ•¸é‡ = å…©æ•¸å–æœ€å° (è³¼è²·æ•¸é‡, å¯æŠ˜æ‰£æ•¸é‡)
    int discQty = Math.min(buyQty, totalLimitQty);
    // ...
}
```

**ç‰¹å¾µ**:
- âŒ **ä¸ä½¿ç”¨LIMIT_QTY**
- ä½¿ç”¨`condAmt` (ä¾†è‡ª`TblPromCondition.getConditionAmt()`)
- æ¢ä»¶æ•¸é‡ä»£è¡¨çµ„åˆä¸­æ­¤å•†å“çš„å¿…éœ€æ•¸é‡

---

### Event H - å–®å“æ‹†åƒ¹åˆè³¼åƒ¹

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\functions\SoEventH.java`

**é‚è¼¯** (Lines 222-238):
```java
private void calculateDiscQty(HashMap<String,Object>[] discItems, int maxQty, int index, int befDiscQty) {
    HashMap<String,Object> map = discItems[index];
    int buyQty = Integer.parseInt((String)map.get("Qty")); // è³¼è²·æ•¸é‡
    int limitQty = Integer.valueOf((String)map.get("condAmt")).intValue(); // â˜… æ¢ä»¶æ•¸é‡

    // â˜… å¯æŠ˜æ‰£æ•¸é‡ = æœ€å¤§å„ªæƒ çµ„æ•¸ * æ¢ä»¶æ•¸é‡ - å·²æŠ˜æ‰£æ•¸é‡
    int totalLimitQty = (maxQty * limitQty) - befDiscQty;

    // å¯æŠ˜æŠµæ•¸é‡ = å…©æ•¸å–æœ€å° (è³¼è²·æ•¸é‡, å¯æŠ˜æ‰£æ•¸é‡)
    int discQty = Math.min(buyQty, totalLimitQty);
    map.put("discQty", String.valueOf(discQty));

    // éè¿´è™•ç†å¤šå•†å“
    if(discQty > 0 && (index+1) < discItems.length){
        index++;
        calculateDiscQty(discItems, maxQty, index, (discQty+befDiscQty));
    }
}
```

**ç‰¹å¾µ**:
- âŒ **ä¸ä½¿ç”¨LIMIT_QTY**
- ä½¿ç”¨`condAmt`ä½†å‘½åç‚º`limitQty` (å®¹æ˜“æ··æ·†!)
- èˆ‡Event Fç›¸åŒæ¨¡å¼

---

## é‚Šç·£æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹1: limitQty = 0 æ™‚æœƒç™¼ç”Ÿä»€éº¼?

| äº‹ä»¶ | è¡Œç‚º | çµæœ |
|------|------|------|
| **Event A** | `limitQty != 0`æª¢æŸ¥ | âœ… **è¦–ç‚ºç„¡é™åˆ¶** (è·³éé©—è­‰) |
| **Event B** | `Math.min(buyQty, 0)` | âŒ **å…¨éƒ¨æ‹’çµ•** (discQty = 0) |
| **Event D** | `maxQty * 0 - befDiscQty` | âŒ **å…¨éƒ¨æ‹’çµ•** (totalLimitQty = è² æ•¸) |
| **Event E** | èˆ‡Event Dç›¸åŒ | âŒ **å…¨éƒ¨æ‹’çµ•** |
| **Event G** | `>=0`æª¢æŸ¥å¤±æ•— | âŒ **è·³éå±¤ç´š** |

**ä¸ä¸€è‡´æ€§**: Event Aå°‡0è¦–ç‚ºç„¡é™,å…¶ä»–äº‹ä»¶å°‡0è¦–ç‚ºã€Œä¸å…è¨±æŠ˜æ‰£ã€

**å»ºè­°**: æ¨™æº–åŒ–è¡Œç‚º (å»ºè­°: 0 = ç„¡é™åˆ¶)

---

### æ¡ˆä¾‹2: limitQty = NULL æ™‚æœƒç™¼ç”Ÿä»€éº¼?

**æ‰€æœ‰äº‹ä»¶éƒ½æœƒæ‹‹å‡º `NullPointerException`** å› ç‚º:

```java
// Event A:
int limitQty = promoGupCdt.getLimitQty();
// âŒ unbox null Short â†’ NPE

// Events B/D/E/G:
int limitQty = tblPromSet.getDiscountQty();
// âŒ å›å‚³null â†’ NPE
```

**ç¼ºå°‘é©—è­‰**: æ‰€æœ‰äº‹ä»¶éƒ½æ²’æœ‰nullå®‰å…¨æª¢æŸ¥

**å»ºè­°ä¿®æ­£**:
```java
int limitQty = Objects.requireNonNullElse(promoGupCdt.getLimitQty(), Integer.MAX_VALUE);
```

---

### æ¡ˆä¾‹3: è² æ•¸é‡(é€€è²¨)æ™‚æœƒç™¼ç”Ÿä»€éº¼?

**Event A** (Lines 159-161):
```java
if(discItemDetlSeqId.contains(orderDetlVO.getDetlSeqId())
        && limitQty != 0 && totalQtyMap.get(orderDetlVO.getSkuNo()) > limitQty)
```
- å¦‚æœ`totalQty < 0` (è² æ•¸é€€è²¨),é©—è­‰é€šé
- **éŒ¯èª¤**: é€€è²¨å¯ä»¥ç¹éé™åˆ¶æª¢æŸ¥

**Events B/D/E/G**:
```java
int discQty = Math.min(buyQty, totalLimitQty);
// å¦‚æœ buyQty < 0
```
- çµæœ: `discQty = è² å€¼`
- **éŒ¯èª¤**: å¯èƒ½ç”¢ç”Ÿè² æŠ˜æ‰£

**å»ºè­°ä¿®æ­£**:
```java
int buyQty = Math.max(0, Integer.parseInt(orderDetlVO.getQuantity()));
```

---

### æ¡ˆä¾‹4: å¤šå±¤ç´šä¿ƒéŠ·ä¸”ä¸åŒé™åˆ¶?

| äº‹ä»¶ | æ”¯æ´å¤šå±¤ç´š? | è™•ç†æ–¹å¼ |
|------|------------|----------|
| **Event B** | âœ… æ˜¯ | å¾æœ€é«˜å±¤ç´šè™•ç†,ç´¯ç©`befDiscQty` |
| **Event D** | âœ… æ˜¯ | å¤šå±¤ç´šå¾ªç’°(Lines 124-186),è¿½è¹¤`remainQty` |
| **Event E** | âŒ å¦ | åƒ…å–®å±¤ç´š(Lines 134-138è¨»è§£: ã€Œä¸æ”¯æ´å¤šéšå±¤ã€) |
| **Event G** | âœ… æ˜¯ | è¤‡é›œéè¿´å±¤ç´šé‡è©¦(Lines 161-315) |

**æœ€ä½³å¯¦ä½œ**: Event Dæ­£ç¢ºè¿½è¹¤è·¨å±¤ç´šçš„`remainQty`ä»¥é˜²æ­¢é‡è¤‡æŠ˜æ‰£

---

## å·²ç™¼ç¾çš„éŒ¯èª¤å’Œä¸ä¸€è‡´

### é—œéµéŒ¯èª¤

#### 1. ç©ºæŒ‡æ¨™é¢¨éšª (æ‰€æœ‰ä½¿ç”¨limitQtyçš„äº‹ä»¶)

**å•é¡Œ**: åœ¨unbox `Short getLimitQty()` ç‚º `int`å‰ç„¡nullæª¢æŸ¥

**å—å½±éŸ¿äº‹ä»¶**: A, B, D, E, G

**ä»£ç¢¼ä½ç½®**:
- `SoEventA.java:129`
- `SoEventB.java:213, 234`
- `SoEventD.java:219`
- `SoEventE.java:280`
- `SoEventG.java:236, 300`

**éŒ¯èª¤å †ç–Š**:
```
NullPointerException at SoEventA.checkDiscItems(SoEventA.java:129)
  at SoEventA.init(SoEventA.java:84)
```

**å»ºè­°ä¿®æ­£**:
```java
// âŒ ç•¶å‰ä»£ç¢¼
int limitQty = promoGupCdt.getLimitQty();

// âœ… å»ºè­°ä¿®æ­£
int limitQty = Objects.requireNonNullElse(promoGupCdt.getLimitQty(), Integer.MAX_VALUE);
```

---

#### 2. è² æ•¸é‡éŒ¯èª¤ (Events B/D/E)

**å•é¡Œ**: é€€è²¨äº¤æ˜“(è² æ•¸é‡)å¯èƒ½ç¹éé™åˆ¶æˆ–ç”¢ç”Ÿè² æŠ˜æ‰£

**å—å½±éŸ¿äº‹ä»¶**: B, D, E

**ä»£ç¢¼ä½ç½®**:
- `SoEventB.java:210, 231`
- `SoEventD.java:212`
- `SoEventE.java:276`

**å•é¡Œå ´æ™¯**:
```
å®¢æˆ¶é€€è²¨5å€‹ â†’ qty = -5
limitQty = 10
totalLimitQty = (3 * 10) - 0 = 30
discQty = min(-5, 30) = -5  âŒ è² æŠ˜æ‰£!
```

**å»ºè­°ä¿®æ­£**:
```java
// âŒ ç•¶å‰ä»£ç¢¼
int buyQty = Integer.parseInt((String)map.get("Qty"));

// âœ… å»ºè­°ä¿®æ­£
int buyQty = Math.max(0, Integer.parseInt((String)map.get("Qty")));
```

---

#### 3. Event A é€€è²¨ç¹é

**å•é¡Œ**: `totalQty > limitQty`æª¢æŸ¥åœ¨`totalQty < 0`æ™‚å¤±æ•ˆ

**å—å½±éŸ¿äº‹ä»¶**: A

**ä»£ç¢¼ä½ç½®**: `SoEventA.java:161`

**å•é¡Œå ´æ™¯**:
```
é€€è²¨15å€‹å°èŠ±å•†å“ â†’ totalQty = -15
limitQty = 10
æª¢æŸ¥: -15 > 10? â†’ FALSE âœ… (éŒ¯èª¤åœ°é€šéé©—è­‰)
```

**å»ºè­°ä¿®æ­£**:
```java
// âŒ ç•¶å‰ä»£ç¢¼
&& totalQtyMap.get(orderDetlVO.getSkuNo()) > limitQty

// âœ… å»ºè­°ä¿®æ­£
&& Math.abs(totalQtyMap.get(orderDetlVO.getSkuNo())) > limitQty
```

---

### ä¸ä¸€è‡´æ€§

#### 1. limitQty=0 çš„è§£é‡‹

| äº‹ä»¶ | limitQty=0 è¡Œç‚º | æ¥­å‹™æ„ç¾© |
|------|----------------|----------|
| **Event A** | è¦–ç‚ºç„¡é™åˆ¶ (è·³éé©—è­‰) | ä¸é™è³¼ |
| **Events B/D/E/G** | æ‹’çµ•å…¨éƒ¨æŠ˜æ‰£ (discQty=0) | ç¦æ­¢ä¿ƒéŠ· |

**å»ºè­°**: æ¨™æº–åŒ–è¡Œç‚º (å»ºè­°: 0 = ç„¡é™åˆ¶,èˆ‡Event Aä¸€è‡´)

---

#### 2. éŒ¯èª¤è™•ç†

| äº‹ä»¶ | è¶…éé™åˆ¶æ™‚çš„è¡Œç‚º | ä½¿ç”¨è€…é€šçŸ¥ |
|------|----------------|-----------|
| **Event A** | é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯,å–æ¶ˆä¿ƒéŠ· | âœ… æ˜ç¢ºéŒ¯èª¤è¨Šæ¯ |
| **Events B/D/E** | éœé»˜å°é ‚,è¶…é¡å¿½ç•¥ | âŒ ç„¡é€šçŸ¥ |
| **Event G** | éœé»˜é™ç´šåˆ°ä¸‹å±¤ç´š | âŒ ç„¡é€šçŸ¥ |

**å»ºè­°**: æ–°å¢å¯é¸è­¦å‘Šæ—¥èªŒä»¥ä¾¿é™¤éŒ¯

---

#### 3. æ¬„ä½åç¨±æ··æ·†

| äº‹ä»¶ | ä½¿ç”¨çš„æ¬„ä½ | ä¾†æº | èªç¾© |
|------|----------|------|------|
| **Event A** | `TblPromCondition.getLimitQty()` | ä¿ƒéŠ·æ¢ä»¶ | å–®ç­†ç™¼ç¥¨é™è³¼æ•¸é‡ |
| **Events B/D/E/G** | `TblPromSet.getDiscountQty()` | ä¿ƒéŠ·å•†å“é›† | é™åˆ¶æŠ˜æ‰£æ•¸é‡ |
| **Events F/H** | `TblPromCondition.getConditionAmt()` | ä¿ƒéŠ·æ¢ä»¶ | æ¢ä»¶æ•¸é‡ (éé™åˆ¶!) |

**Event Hçš„å‘½åæ··æ·†**:
```java
// Line 224:
int limitQty = Integer.valueOf((String)map.get("condAmt")).intValue();
// âŒ è®Šæ•¸åç‚ºlimitQtyä½†å¯¦éš›æ˜¯condAmt!
```

**å»ºè­°**: åœ¨æ–‡æª”ä¸­è¨˜éŒ„å“ªå€‹æ¬„ä½æ§åˆ¶æ¯ç¨®äº‹ä»¶é¡å‹çš„ä»€éº¼

---

## æ¥­å‹™è¦å‰‡è§£é‡‹

### 1. Event A (å°èŠ±åƒ¹): åš´æ ¼åŸ·è¡Œ,å¿…é ˆé€šçŸ¥ä½¿ç”¨è€…

**æ¥­å‹™ç†ç”±**:
- å°èŠ±åƒ¹éœ€è¦æ”¶éŠ€å“¡ç¢ºèª
- POSæ”¶éŠ€å“¡éœ€è¦çŸ¥é“ç‚ºä»€éº¼ç„¡æ³•å¥—ç”¨ä¿ƒéŠ·
- å¯èƒ½æ¶‰åŠåº«å­˜æˆ–æ”¿ç­–é™åˆ¶,éœ€è¦äººå·¥å¹²é 

**å¯¦ä½œ**: å…¨æœ‰æˆ–å…¨ç„¡æ‹’çµ• + æ˜ç¢ºéŒ¯èª¤è¨Šæ¯

---

### 2. Events B/D/E (åŠ è³¼/çµ„åˆ): è»Ÿæ€§ä¸Šé™,ç³»çµ±è‡ªå‹•å¥—ç”¨æœ€å¤§å¯ç”¨æŠ˜æ‰£

**æ¥­å‹™ç†ç”±**:
- æ›´å¥½çš„UX,å®¢æˆ¶ç²å¾—æœ€å¤§å¯ç”¨æŠ˜æ‰£
- é¿å…æ”¶éŠ€å“¡éœ€è¦æ‰‹å‹•èª¿æ•´æ•¸é‡
- æ¸›å°‘çµå¸³æ™‚é–“

**å¯¦ä½œ**: Math.minå°é ‚ + éœé»˜è™•ç†

---

### 3. Event G (å…±äº«çµ„åˆ): æ©Ÿæœƒå¼å±¤ç´šåŒ¹é…,å˜—è©¦æœ€ä½³å¯èƒ½å±¤ç´š

**æ¥­å‹™ç†ç”±**:
- è·¨SKUçš„è¤‡é›œå…±äº«åº«å­˜éœ€è¦å½ˆæ€§åŒ¹é…
- é«˜å±¤ç´šä¸ç¬¦åˆæ™‚è‡ªå‹•é™ç´šä»¥ä»æä¾›éƒ¨åˆ†æŠ˜æ‰£
- æœ€å¤§åŒ–ä¿ƒéŠ·ä½¿ç”¨ç‡

**å¯¦ä½œ**: è¤‡é›œæª¢æŸ¥ + å±¤ç´šé‡è©¦éè¿´

---

### 4. Events C/F/H: ç„¡å–®å“é™åˆ¶,åƒ…çµ„åˆ¥é–€æª»

**æ¥­å‹™ç†ç”±**:
- ã€Œå…¨æœ‰æˆ–å…¨ç„¡ã€é–€æª»ä¿ƒéŠ·
- ç°¡åŒ–ä¿ƒéŠ·é‚è¼¯
- é¼“å‹µå¤§é‡è³¼è²·

**å¯¦ä½œ**: ç„¡LIMIT_QTYä½¿ç”¨

---

## å»ºè­°

### 1. æ¨™æº–åŒ–NULLè™•ç†

```java
// å»ºè­°çš„å®‰å…¨è½‰æ›
int limitQty = Objects.requireNonNullElse(
    promoGupCdt.getLimitQty(),
    Integer.MAX_VALUE // é è¨­ç‚ºç„¡é™åˆ¶
);
```

---

### 2. æ–°å¢è² æ•¸é‡é˜²è­·

```java
// åœ¨æ‰€æœ‰äº‹ä»¶ä¸­æ–°å¢
int buyQty = Math.max(0, Integer.parseInt(orderDetlVO.getQuantity()));
```

---

### 3. è¨˜éŒ„limitQty=0çš„è¡Œç‚º

åœ¨è³‡æ–™åº«æ¶æ§‹è¨»è§£ä¸­:
```sql
COMMENT ON COLUMN TBL_PROM_CONDITION.LIMIT_QTY IS
    'å–®ç­†äº¤æ˜“é™è³¼æ•¸é‡ã€‚0è¡¨ç¤ºç„¡é™åˆ¶ã€‚NULLè¦–ç‚ºéŒ¯èª¤ã€‚';
```

---

### 4. æ–°å¢æ•´åˆæ¸¬è©¦æ¡ˆä¾‹

**å¿…æ¸¬æ¡ˆä¾‹**:
- limitQty = NULL
- limitQty = 0
- è² æ•¸é‡ (é€€è²¨)
- å¤šå±¤ç´šé™åˆ¶é‚Šç•Œ
- è¶…éé™åˆ¶ (å„ç¨®äº‹ä»¶)

**ç¯„ä¾‹æ¸¬è©¦**:
```java
@Test
public void testEventA_LimitQtyZero_ShouldTreatAsUnlimited() {
    // è¨­å®š limitQty = 0
    TblPromCondition condition = new TblPromCondition();
    condition.setLimitQty((short)0);

    // è³¼è²·100å€‹
    OrderDetlVO order = createOrder("014014014", 100);

    // åŸ·è¡Œ
    soEventA.init(Arrays.asList(order), ...);

    // é©—è­‰: æ‡‰è©²å…¨éƒ¨æŠ˜æ‰£ (ä¸æ‹’çµ•)
    assertEquals("100", order.getDiscountQty());
}

@Test(expected = NullPointerException.class)
public void testEventB_LimitQtyNull_ShouldThrowNPE() {
    // è¨­å®š limitQty = NULL
    TblPromSet promSet = new TblPromSet();
    promSet.setDiscountQty(null);

    // æ‡‰æ‹‹å‡ºNPE
    soEventB.calculateDiscQty(...);
}

@Test
public void testEventD_NegativeQty_ShouldNotAllowDiscount() {
    // é€€è²¨ -5å€‹
    OrderDetlVO order = createOrder("014014014", -5);

    // åŸ·è¡Œ
    soEventD.init(Arrays.asList(order), ...);

    // é©—è­‰: è² æ•¸é‡æ‡‰è¢«è¦–ç‚º0
    assertEquals("0", order.getDiscountQty());
}
```

---

### 5. è€ƒæ…®æ–°å¢è­¦å‘Šæ—¥èªŒ

å°æ–¼Events B/D/E/Gçš„éœé»˜å°é ‚,æ–°å¢é™¤éŒ¯æ—¥èªŒ:

```java
if (buyQty > totalLimitQty) {
    logger.warn("å•†å“: " + skuNo + " è³¼è²·æ•¸é‡: " + buyQty +
               " è¶…éé™åˆ¶: " + totalLimitQty +
               " ,å·²å°é ‚ç‚º: " + totalLimitQty);
}
```

---

## æª”æ¡ˆåƒè€ƒæ‘˜è¦

### äº‹ä»¶è¨ˆç®—å™¨æª”æ¡ˆ

| äº‹ä»¶ | æª”æ¡ˆè·¯å¾‘ | LIMIT_QTYè¡Œæ•¸ |
|------|---------|--------------|
| **A** | `so-bzservices/src/main/java/com/trihome/som/bz/functions/SoEventA.java` | 129-170 |
| **B** | `so-bzservices/src/main/java/com/trihome/som/bz/functions/SoEventB.java` | 209-248 |
| **C** | `so-bzservices/src/main/java/com/trihome/som/bz/functions/SoEventC.java` | N/A |
| **D** | `so-bzservices/src/main/java/com/trihome/som/bz/functions/SoEventD.java` | 210-236 |
| **E** | `so-bzservices/src/main/java/com/trihome/som/bz/functions/SoEventE.java` | 275-293 |
| **F** | `so-bzservices/src/main/java/com/trihome/som/bz/functions/SoEventF.java` | N/A (ä½¿ç”¨condAmt) |
| **G** | `so-bzservices/src/main/java/com/trihome/som/bz/functions/SoEventG.java` | 223-305 |
| **H** | `so-bzservices/src/main/java/com/trihome/som/bz/functions/SoEventH.java` | N/A (ä½¿ç”¨condAmt) |

---

### è³‡æ–™åº«å¯¦é«”æª”æ¡ˆ

**TblPromCondition.java**
- **è·¯å¾‘**: `so-coredb/src/main/java/com/trihome/som/so/mybatis/dao/TblPromCondition.java`
- **é—œéµæ¬„ä½**:
  - `Short limitQty` (Line 42): å–®ç­†äº¤æ˜“é™è³¼æ•¸é‡
  - `Integer conditionAmt` (Line 18): æ¢ä»¶é‡‘é¡/æ•¸é‡
  - `String heap` (Line 26): æ˜¯å¦ç´¯è¨ˆ ("Y"/"N")
  - `String allocationType` (Line 34): æŠ˜æ‰£åˆ†é…æ–¹å¼

**TblPromSet.java**
- **è·¯å¾‘**: `so-coredb/src/main/java/com/trihome/som/so/mybatis/dao/TblPromSet.java`
- **é—œéµæ¬„ä½**:
  - `Short discountQty`: æŠ˜æ‰£æ•¸é‡é™åˆ¶ (Events B/D/E/Gä½¿ç”¨æ­¤æ¬„ä½)

---

## çµè«–å’Œä¸‹ä¸€æ­¥

### ç™¼ç¾æ‘˜è¦

1. **å››ç¨®è™•ç†æ¨¡å¼**: æ‹’çµ•ã€å°é ‚ã€ä¸‰é‡æœ€å°å€¼ã€è¤‡é›œæª¢æŸ¥
2. **ä¸ä¸€è‡´è¡Œç‚º**: limitQty=0çš„è§£é‡‹,éŒ¯èª¤è™•ç†æ–¹å¼
3. **é—œéµéŒ¯èª¤**: ç©ºæŒ‡æ¨™é¢¨éšªã€è² æ•¸é‡éŒ¯èª¤ã€é€€è²¨ç¹é
4. **æ¬„ä½æ··æ·†**: limitQty vs discountQty vs condAmt

### éœ€è¦æ¥­å‹™æ±ºç­–

1. **æ¨™æº–åŒ–limitQty=0**: æ‡‰è©²çµ±ä¸€è¦–ç‚ºç„¡é™åˆ¶é‚„æ˜¯æ‹’çµ•?
2. **éŒ¯èª¤é€šçŸ¥**: æ˜¯å¦æ‡‰è©²åœ¨éœé»˜å°é ‚æ™‚é€šçŸ¥å®¢æˆ¶/æ”¶éŠ€å“¡?
3. **é€€è²¨è™•ç†**: é€€è²¨äº¤æ˜“æ˜¯å¦æ‡‰è©²é©ç”¨ä¿ƒéŠ·é™åˆ¶?
4. **NULLè¡Œç‚º**: limitQty=NULLæ‡‰è©²æ‹‹å‡ºéŒ¯èª¤é‚„æ˜¯è¦–ç‚ºç„¡é™åˆ¶?

### æŠ€è¡“å»ºè­°

1. **æ–°å¢nullå®‰å…¨æª¢æŸ¥**: æ‰€æœ‰limitQtyä½¿ç”¨è™•
2. **æ–°å¢è² æ•¸é‡é˜²è­·**: Math.max(0, qty)
3. **ä¿®æ­£Event Aé€€è²¨ç¹é**: ä½¿ç”¨Math.abs()
4. **æ¨™æº–åŒ–limitQty=0è¡Œç‚º**: åœ¨æ‰€æœ‰äº‹ä»¶ä¸­ä¸€è‡´
5. **æ–°å¢æ•´åˆæ¸¬è©¦**: è¦†è“‹é‚Šç·£æ¡ˆä¾‹
6. **æ–°å¢è­¦å‘Šæ—¥èªŒ**: é™¤éŒ¯å°é ‚è¡Œç‚º

---

**æ–‡æª”çµæŸ**
