# è·¨é¡ä¿ƒéŠ·ç–ŠåŠ è¦å‰‡è¿½è¹¤

## æ–‡æª”å…ƒæ•¸æ“š

**å‰µå»ºæ—¥æœŸ**: 2025-10-27
**éšæ®µ**: Phase 2 Week 3 - ä¿ƒéŠ·é‚è¼¯åˆ†æ
**ç¯„åœ**: Event A-Hã€æœƒå“¡æŠ˜æ‰£ã€å„ªæƒ åˆ¸ã€ç´…åˆ©ç©é»ä¹‹é–“çš„ç–ŠåŠ /äº’æ–¥è¦å‰‡
**ä»£ç¢¼ä½ç½®**: so-bzservices
**ç‹€æ…‹**: âœ… å·²å®Œæˆ - å·²è­˜åˆ¥å®Œæ•´ç–ŠåŠ çŸ©é™£

---

## åŸ·è¡Œæ‘˜è¦

### é—œéµç™¼ç¾

**ğŸ”’ ä¸‰å±¤é˜²è­·æ©Ÿåˆ¶**: SOMç³»çµ±ä½¿ç”¨ä¸‰å±¤é˜²è­·ç¢ºä¿ä¸é‡è¤‡æŠ˜æ‰£:
1. **è®Šåƒ¹æ——æ¨™**: å¥—ç”¨æŠ˜æ‰£æ™‚è¨­å®šæ——æ¨™ï¼ˆposAmtChangePrice, installChangePrice, deliveryChangePriceï¼‰
2. **å‹•æ…‹åˆ†é¡**: æ¯æ¬¡æŠ˜æ‰£å¾Œé‡æ–°åŸ·è¡ŒAssortSkuï¼Œè‡ªå‹•æ’é™¤è®Šåƒ¹å•†å“
3. **æŠ˜æ‰£å‰æª¢æŸ¥**: å¥—ç”¨æ–°æŠ˜æ‰£å‰å†æ¬¡æª¢æŸ¥æ——æ¨™

### ä¸»è¦ç–ŠåŠ è¦å‰‡

| çµ„åˆ | é—œä¿‚ | èªªæ˜ |
|------|------|------|
| **Type 2 â†’ Event â†’ Type 0/1** | âœ… å¯ç–ŠåŠ  | åš´æ ¼æŒ‰é †åºåŸ·è¡Œï¼Œæ¯æ¬¡é‡æ–°åˆ†é¡ |
| **åŒä¸€å•†å“å¤šå€‹Event** | âŒ äº’æ–¥ | eventNospç‚ºStringï¼Œè³‡æ–™çµæ§‹é™åˆ¶ |
| **Type 0/1 â†” Type CT** | âŒ äº’æ–¥ | Type CTåƒ…åœ¨Type 0/1/2å…¨éƒ¨ç‚ºç©ºæ™‚åŸ·è¡Œ |
| **ç´…åˆ©ç©é» â†” Event** | âŒ äº’æ–¥ | bonusTotal > 0æ™‚ä¸åƒèˆ‡Event |
| **å„ªæƒ åˆ¸ â†” Event** | âš ï¸ æ¢ä»¶æ€§ | è¦–excludeCardè¨­å®šè€Œå®š |
| **äººå·¥è®Šåƒ¹ â†” æ‰€æœ‰è‡ªå‹•æŠ˜æ‰£** | âŒ å®Œå…¨äº’æ–¥ | ç§»å‡ºlstComputeSku |

---

## å®šåƒ¹å¼•æ“åŸ·è¡Œé †åº

### å®Œæ•´æµç¨‹

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\service\BzSoServices.java`
**ä»£ç¢¼ä½ç½®**: Lines 4434-4478

```java
// ===============================================
// å®šåƒ¹å¼•æ“åŸ·è¡Œé †åºï¼ˆæŒ‰åºè™ŸåŸ·è¡Œï¼‰
// ===============================================

// 0. åˆå§‹åŒ–ï¼šåˆ†é¡å•†å“
AssortSku assortSku = new AssortSku(lstAllSku, lstWorkTypeSku);
ArrayList<OrderDetlVO> lstComputeSku = assortSku.getLstComputeSku();

// 1. Type 2 æœƒå“¡æŠ˜æ‰£ - Cost Markup (æˆæœ¬åŠ æˆ)
memberDiscSkus.addAll(soFunctionMemberDisServices.soComputeFunctionMemberDis(
    lstComputeSku, soBO.getMemberCardId(), channelId, "2", isTaxZero
));

// 1.5 é‡æ–°åˆ†é¡ï¼ˆæ’é™¤å·²è®Šåƒ¹å•†å“ï¼‰
if(!memberDiscSkus.isEmpty()){
    assortSku = new AssortSku(lstAllSku, lstWorkTypeSku);
    lstComputeSku = assortSku.getLstComputeSku();
}

// 2. Event A-H å¤šé‡ä¿ƒéŠ·
SoComputeFunctionMain soComputeFunctionMain =
    soComputeFunctionMainServices.getSoComputeFunctionMain(lstComputeSku, isTaxZero);
soVO.setStampErrorMsg(soComputeFunctionMain.getStampErrorMsg());
soVO.setLstOrderEventMsgVO(soComputeFunctionMain.getOrderEventMsgVO());

// 3. Type 0 æœƒå“¡æŠ˜æ‰£ - Discounting (æŠ˜æ‰£)
memberDiscSkus.addAll(soFunctionMemberDisServices.soComputeFunctionMemberDis(
    lstComputeSku, soBO.getMemberCardId(), channelId, "0", isTaxZero
));

// 4. Type 1 æœƒå“¡æŠ˜æ‰£ - Down Margin (é™æ¯›åˆ©)
memberDiscSkus.addAll(soFunctionMemberDisServices.soComputeFunctionMemberDis(
    lstComputeSku, soBO.getMemberCardId(), channelId, "1", isTaxZero
));

// 5. Type CT ç‰¹æ®Šæœƒå“¡æŠ˜æ‰£ï¼ˆåƒ…åœ¨Type 0/1/2å…¨éƒ¨ç‚ºç©ºæ™‚ï¼‰
if(memberDiscSkus.isEmpty()){
    memberDiscSkus.addAll(soFunctionMemberDisServices.soComputeMemberDisForSpecial(
        lstComputeSku, soBO.getMemberCardId(), channelId, isTaxZero
    ));
}

// 6. å„ªæƒ åˆ¸/ç´…åˆ©é»æ•¸è™•ç†ï¼ˆLines 4581-4768ï¼‰
// æ’åºå„ªæƒ åˆ¸ä¸¦é€å¼µå¥—ç”¨...
```

### åŸ·è¡Œæµç¨‹åœ–

```
è¨‚å–®è©¦ç®—é–‹å§‹
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éšæ®µ0: åˆå§‹åŒ– & å•†å“åˆ†é¡                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ AssortSku(lstAllSku, lstWorkTypeSku)            â”‚ â”‚
â”‚ â”‚ â†’ lstComputeSku (å¯ä¿ƒéŠ·å•†å“)                     â”‚ â”‚
â”‚ â”‚ â†’ lstGoodsSku (ä¸€èˆ¬å•†å“)                         â”‚ â”‚
â”‚ â”‚ â†’ lstInstallSku (å®‰è£å•†å“)                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éšæ®µ1: Type 2 æœƒå“¡æŠ˜æ‰£ï¼ˆæˆæœ¬åŠ æˆï¼‰                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ“ æª¢æŸ¥ï¼šç„¡è®Šåƒ¹æ——æ¨™                                â”‚ â”‚
â”‚ â”‚ âœ“ è¨ˆç®—ï¼šceil(unitCost Ã— (1 + markup%))          â”‚ â”‚
â”‚ â”‚ âœ“ å¥—ç”¨ï¼šæ›´æ–°sellingPrice                         â”‚ â”‚
â”‚ â”‚ âœ“ è¨­å®šï¼šposAmtChangePrice = true                â”‚ â”‚
â”‚ â”‚ âœ“ é‡æ–°åˆ†é¡ï¼šAssortSkuï¼ˆæ’é™¤è®Šåƒ¹å•†å“ï¼‰             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éšæ®µ2: Event A-H å¤šé‡ä¿ƒéŠ·                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ“ æª¢æŸ¥ï¼šå•†å“åœ¨lstComputeSkuä¸­                     â”‚ â”‚
â”‚ â”‚ âœ“ æª¢æŸ¥ï¼šbonusTotal = 0 (ç„¡ç´…åˆ©ç©é»)              â”‚ â”‚
â”‚ â”‚ âœ“ åˆ†é…ï¼šæ¯å€‹å•†å“åˆ°å–®ä¸€Event (A-Hå…¶ä¸­ä¹‹ä¸€)        â”‚ â”‚
â”‚ â”‚ âœ“ è¨ˆç®—ï¼šä¾Eventé¡å‹è¨ˆç®—æŠ˜æ‰£                       â”‚ â”‚
â”‚ â”‚ âœ“ è¨­å®šï¼šdiscountAmt, discountType               â”‚ â”‚
â”‚ â”‚ âœ— ä¸è¨­å®šè®Šåƒ¹æ——æ¨™ï¼ˆå…è¨±å¾ŒçºŒæœƒå“¡æŠ˜æ‰£ç–ŠåŠ ï¼‰           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éšæ®µ3: Type 0 æœƒå“¡æŠ˜æ‰£ï¼ˆDiscountingï¼‰                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ“ æª¢æŸ¥ï¼šç„¡è®Šåƒ¹æ——æ¨™                                â”‚ â”‚
â”‚ â”‚ âœ“ è¨ˆç®—åŸºæº–ï¼šå¯¦éš›å”®åƒ¹ - EventæŠ˜æ‰£                  â”‚ â”‚
â”‚ â”‚ âœ“ å¥—ç”¨ï¼šæŠ˜æ‰£é‡‘é¡ = åŸºæº– Ã— æŠ˜æ‰£%                   â”‚ â”‚
â”‚ â”‚ âœ“ è¨­å®šï¼šposAmtChangePrice = true                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éšæ®µ4: Type 1 æœƒå“¡æŠ˜æ‰£ï¼ˆDown Marginï¼‰                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ“ æª¢æŸ¥ï¼šç„¡è®Šåƒ¹æ——æ¨™                                â”‚ â”‚
â”‚ â”‚ âœ“ è¨ˆç®—åŸºæº–ï¼šå¯¦éš›å”®åƒ¹ - EventæŠ˜æ‰£                  â”‚ â”‚
â”‚ â”‚ âœ“ å¥—ç”¨ï¼šä¾æ¯›åˆ©ç‡è¨ˆç®—æŠ˜æ‰£                          â”‚ â”‚
â”‚ â”‚ âœ“ è¨­å®šï¼šposAmtChangePrice = true                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éšæ®µ5: Type CT ç‰¹æ®Šæœƒå“¡æŠ˜æ‰£ï¼ˆæ¢ä»¶æ€§ï¼‰                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ“ æ¢ä»¶ï¼šmemberDiscSkus.isEmpty()                â”‚ â”‚
â”‚ â”‚         ï¼ˆType 0/1/2å…¨éƒ¨æœªå¥—ç”¨æ‰åŸ·è¡Œï¼‰            â”‚ â”‚
â”‚ â”‚ âœ“ æª¢æŸ¥ï¼šç„¡è®Šåƒ¹æ——æ¨™                                â”‚ â”‚
â”‚ â”‚ âœ“ è¨ˆç®—åŸºæº–ï¼šå¯¦éš›å”®åƒ¹ - EventæŠ˜æ‰£                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éšæ®µ6: å„ªæƒ åˆ¸/ç´…åˆ©é»æ•¸ï¼ˆå¦‚æœ‰ï¼‰                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ“ æ’åºï¼šä¾å„ªæƒ åˆ¸å„ªå…ˆç´šæ’åº                         â”‚ â”‚
â”‚ â”‚ âœ“ æª¢æŸ¥ï¼šexcludeCardè¨­å®š                          â”‚ â”‚
â”‚ â”‚ âœ“ æ’é™¤ï¼šè®Šåƒ¹å•†å“ã€Eventå•†å“(è¦–åˆ¸è¨­å®š)             â”‚ â”‚
â”‚ â”‚ âœ“ è¨ˆç®—åŸºæº–ï¼šå·²æ‰£é™¤æ‰€æœ‰å‰é¢çš„æŠ˜æ‰£                   â”‚ â”‚
â”‚ â”‚ âœ“ é€å¼µå¥—ç”¨ï¼šå¯ç–ŠåŠ å¤šå¼µå„ªæƒ åˆ¸                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è©¦ç®—å®Œæˆ
```

---

## å®Œæ•´ç–ŠåŠ è¦å‰‡çŸ©é™£

### ç¸½è¦½çŸ©é™£è¡¨æ ¼

| ä¿ƒéŠ·/æŠ˜æ‰£é¡å‹ | Type 2<br>æœƒå“¡æŠ˜æ‰£ | Event A-H<br>ä¿ƒéŠ· | Type 0<br>æœƒå“¡æŠ˜æ‰£ | Type 1<br>æœƒå“¡æŠ˜æ‰£ | Type CT<br>ç‰¹æ®Šæœƒå“¡ | å„ªæƒ åˆ¸<br>(Coupon) | ç´…åˆ©é»æ•¸<br>(Bonus) | äººå·¥è®Šåƒ¹ |
|:---|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| **Type 2 æœƒå“¡æŠ˜æ‰£** | - | âœ…<br>å¾ŒåŸ·è¡Œ | âœ…<br>å¾ŒåŸ·è¡Œ | âœ…<br>å¾ŒåŸ·è¡Œ | âŒ<br>äº’æ–¥ | âœ…<br>å¾ŒåŸ·è¡Œ | âœ…<br>å¾ŒåŸ·è¡Œ | âŒ<br>äº’æ–¥ |
| **Event A-H ä¿ƒéŠ·** | âœ…<br>å…ˆåŸ·è¡Œ | âŒ<br>å–®ä¸€Event | âœ…<br>å¾ŒåŸ·è¡Œ | âœ…<br>å¾ŒåŸ·è¡Œ | âœ…<br>å¾ŒåŸ·è¡Œ | âš ï¸<br>è¦–åˆ¸è¨­å®š | âŒ<br>äº’æ–¥ | âŒ<br>äº’æ–¥ |
| **Type 0 æœƒå“¡æŠ˜æ‰£** | âœ…<br>å…ˆåŸ·è¡Œ | âœ…<br>å…ˆåŸ·è¡Œ | - | âŒ<br>æ“‡ä¸€ | âŒ<br>äº’æ–¥ | âœ…<br>å¾ŒåŸ·è¡Œ | âœ…<br>å¾ŒåŸ·è¡Œ | âŒ<br>äº’æ–¥ |
| **Type 1 æœƒå“¡æŠ˜æ‰£** | âœ…<br>å…ˆåŸ·è¡Œ | âœ…<br>å…ˆåŸ·è¡Œ | âŒ<br>æ“‡ä¸€ | - | âŒ<br>äº’æ–¥ | âœ…<br>å¾ŒåŸ·è¡Œ | âœ…<br>å¾ŒåŸ·è¡Œ | âŒ<br>äº’æ–¥ |
| **Type CT ç‰¹æ®Šæœƒå“¡** | âŒ<br>äº’æ–¥ | âœ…<br>å…ˆåŸ·è¡Œ | âŒ<br>äº’æ–¥ | âŒ<br>äº’æ–¥ | - | âœ…<br>å¾ŒåŸ·è¡Œ | âœ…<br>å¾ŒåŸ·è¡Œ | âŒ<br>äº’æ–¥ |
| **å„ªæƒ åˆ¸ (Coupon)** | âœ…<br>å…ˆåŸ·è¡Œ | âš ï¸<br>è¦–åˆ¸è¨­å®š | âœ…<br>å…ˆåŸ·è¡Œ | âœ…<br>å…ˆåŸ·è¡Œ | âœ…<br>å…ˆåŸ·è¡Œ | ğŸ”¢<br>å¤šåˆ¸å¯ç–Š | âœ…<br>å¯åŒæ™‚ | âŒ<br>äº’æ–¥ |
| **ç´…åˆ©é»æ•¸ (Bonus)** | âœ…<br>å…ˆåŸ·è¡Œ | âŒ<br>äº’æ–¥ | âœ…<br>å…ˆåŸ·è¡Œ | âœ…<br>å…ˆåŸ·è¡Œ | âœ…<br>å…ˆåŸ·è¡Œ | âœ…<br>å¯åŒæ™‚ | ğŸ”¢<br>å¯ç–ŠåŠ  | âŒ<br>äº’æ–¥ |
| **äººå·¥è®Šåƒ¹** | âŒ<br>äº’æ–¥ | âŒ<br>äº’æ–¥ | âŒ<br>äº’æ–¥ | âŒ<br>äº’æ–¥ | âŒ<br>äº’æ–¥ | âŒ<br>äº’æ–¥ | âŒ<br>äº’æ–¥ | - |

**åœ–ä¾‹èªªæ˜ï¼š**
- âœ… **å¯ç–ŠåŠ **ï¼šå…©è€…å¯åŒæ™‚å¥—ç”¨
- âŒ **äº’æ–¥**ï¼šåªèƒ½æ“‡ä¸€
- âš ï¸ **æ¢ä»¶æ€§**ï¼šè¦–è¨­å®šè€Œå®š
- ğŸ”¢ **å¤šæ¬¡ç–ŠåŠ **ï¼šå¯å¥—ç”¨å¤šæ¬¡
- **å…ˆåŸ·è¡Œ/å¾ŒåŸ·è¡Œ**ï¼šè¡¨ç¤ºåŸ·è¡Œé †åº

---

## è¦å‰‡1: Event A-Hä¹‹é–“çš„ç–ŠåŠ ï¼ˆåŒä¸€å•†å“ï¼‰

### çµè«–ï¼šâŒ åŒä¸€å•†å“åªèƒ½åƒèˆ‡ä¸€å€‹Event

**åŸå› 1ï¼šè³‡æ–™çµæ§‹é™åˆ¶**

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\bean\OrderDetlVO.java`
**ä»£ç¢¼ä½ç½®**: Lines 93-96

```java
private String eventNosStamp;  // é¸æ“‡å°èŠ±å•†å“ä¹‹Event
private String eventNos;       // æœ‰ç¬¦åˆé™åƒ¹ä¿ƒéŠ·æ™‚ä¹‹Event
private String eventNosp;      // æœ‰ç¬¦åˆå¤šé‡ä¿ƒéŠ·æ™‚ä¹‹Event â† Stringï¼ŒéListï¼
private String evnetType;      // Eventé¡å‹(A-H) â† æ‹¼å¯«éŒ¯èª¤ï¼Œæ‡‰ç‚ºeventType
```

**é—œéµæ´å¯Ÿ**:
- `eventNosp`ç‚º**String**é¡å‹ï¼Œä¸æ˜¯é™£åˆ—æˆ–é›†åˆ
- è³‡æ–™çµæ§‹è¨­è¨ˆå°±é™åˆ¶ç‚º**å–®ä¸€Event**
- ç„¡æ³•å„²å­˜å¤šå€‹Eventç·¨è™Ÿ

---

**åŸå› 2ï¼šåˆ†é¡é‚è¼¯å–®ä¸€é¸æ“‡**

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\functions\SoComputeFunctionMain.java`
**ä»£ç¢¼ä½ç½®**: Lines 150-179

```java
/**
 * å°‡å•†å“ä¾æ“šä¿ƒéŠ·ç¨®é¡åˆ†é¡
 */
private void assortEventNo(ArrayList<OrderDetlVO> items){
    String eventType = StringUtils.EMPTY;
    for (OrderDetlVO orderDetlVO : items) {
        if(StringUtils.isNotBlank(orderDetlVO.getEventNosp()) &&
           (StringUtils.isBlank(orderDetlVO.getBonusTotal()) ||
            Integer.parseInt(orderDetlVO.getBonusTotal()) == 0)){

            // åˆå§‹åŒ–æŠ˜æ‰£æ¬„ä½
            orderDetlVO.setDiscountAmt("0");
            orderDetlVO.setDiscountQty("0");

            // å–å¾—Eventé¡å‹
            eventType = orderDetlVO.getEvnetType();

            // â˜… ä½¿ç”¨ if-else if çµæ§‹ï¼šåªèƒ½é€²å…¥ä¸€å€‹åˆ†æ”¯
            if("A".equals(eventType) && orderDetlVO.isStampFlag()){
                soEventItemsA.add(orderDetlVO);
            }else if("B".equals(eventType)){
                soEventItemsB.add(orderDetlVO);
            }else if("C".equals(eventType)){
                soEventItemsC.add(orderDetlVO);
            }else if("D".equals(eventType)){
                soEventItemsD.add(orderDetlVO);
            }else if("E".equals(eventType)){
                soEventItemsE.add(orderDetlVO);
            }else if("F".equals(eventType)){
                soEventItemsF.add(orderDetlVO);
            }else if("G".equals(eventType)){
                soEventItemsG.add(orderDetlVO);
            }else if("H".equals(eventType)){
                soEventItemsH.add(orderDetlVO);
            }
        }
    }
}
```

**é—œéµæ´å¯Ÿ**:
- ä½¿ç”¨**å–®ä¸€if-else if**çµæ§‹
- æ¯å€‹å•†å“åªæœƒè¢«åŠ å…¥åˆ°**å”¯ä¸€ä¸€å€‹**Eventæ¸…å–®
- å¾ŒçºŒè¨ˆç®—æ™‚ï¼Œæ¯å€‹Eventæ¸…å–®äº’ä¸é‡ç–Š

---

### âœ… ä¸€å€‹è¨‚å–®ä¸­å¯ä»¥æœ‰å¤šå€‹ä¸åŒEventé¡å‹çš„å•†å“

**å ´æ™¯ç¯„ä¾‹**:
```
è¨‚å–®è™Ÿ: SO123456
å•†å“A (014014014): eventNosp="MT24100001", evnetType="C" â†’ Event Cä¿ƒéŠ·
å•†å“B (015015015): eventNosp="MT24100002", evnetType="F" â†’ Event Fä¿ƒéŠ·
å•†å“C (016016016): eventNosp="" â†’ ç„¡Eventä¿ƒéŠ·
```

**çµè«–**:
- âœ… è¨‚å–®å±¤ç´šå¯ä»¥æ··åˆä¸åŒEventé¡å‹çš„å•†å“
- âŒ å–®ä¸€å•†å“ç„¡æ³•åŒæ™‚å¥—ç”¨å¤šå€‹Event
- ğŸ”’ é˜²è­·æ©Ÿåˆ¶ï¼šè³‡æ–™çµæ§‹æœ¬èº«é™åˆ¶ + åˆ†é¡é‚è¼¯å–®ä¸€é¸æ“‡

---

## è¦å‰‡2: Eventä¿ƒéŠ·èˆ‡æœƒå“¡æŠ˜æ‰£çš„ç–ŠåŠ 

### çµè«–ï¼šâœ… å¯ç–ŠåŠ ï¼ŒæŒ‰é †åºåŸ·è¡Œï¼Œè¨ˆç®—åŸºæº–æœƒæ‰£é™¤å‰é¢çš„æŠ˜æ‰£

### 2.1 æœƒå“¡æŠ˜æ‰£è¨ˆç®—åŸºæº–

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\service\SoFunctionMemberDisServices.java`
**ä»£ç¢¼ä½ç½®**: Lines 207-213

```java
// è¨ˆç®—æœƒå“¡æŠ˜æ‰£çš„åŸºæº–åƒ¹æ ¼
double price = 0; // å¯¦éš›å”®åƒ¹å°è¨ˆ

// â˜… çµ„ä¿ƒé‡‘é¡ï¼ˆEventæŠ˜æ‰£ï¼‰
double discountAmt = 0;
if(StringUtils.isNotBlank(orderDetlVO.getDiscountAmt())){
    discountAmt = Double.parseDouble(orderDetlVO.getDiscountAmt());
}

// â˜… å¯¦éš›å”®åƒ¹å°è¨ˆ æ‰£é™¤ çµ„ä¿ƒé‡‘é¡
price += discountAmt;  // discountAmtç‚ºè² æ•¸ï¼Œæ‰€ä»¥æ˜¯æ‰£é™¤
```

**é—œéµæ´å¯Ÿ**:
- æœƒå“¡æŠ˜æ‰£è¨ˆç®—åŸºæº– = **å¯¦éš›å”®åƒ¹ - EventæŠ˜æ‰£é‡‘é¡**
- EventæŠ˜æ‰£å„²å­˜ç‚º**è² æ•¸** (discountAmt < 0)
- `price += discountAmt` å¯¦éš›ä¸Šæ˜¯æ‰£é™¤ï¼ˆè² è² å¾—æ­£ï¼‰

---

### 2.2 Type 0/1 æœƒå“¡æŠ˜æ‰£è¨­å®šè®Šåƒ¹æ——æ¨™

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\service\SoFunctionMemberDisServices.java`
**ä»£ç¢¼ä½ç½®**: Lines 453, 460, 496, 501

```java
// Type 0 Discounting
if(GoodsType.P.equals(orderDetlVO.getGoodsType())){
    orderDetlVO.setPosAmtChangePrice(true);  // â† POSè®Šåƒ¹ (Line 453)
}
if(GoodsType.I.equals(skuInfo.getGoodsType()) ||
   GoodsType.IA.equals(skuInfo.getGoodsType())){
    orderDetlVO.setInstallChangePrice(true); // â† å®‰è£è®Šåƒ¹ (Line 460)
}

// Type 1 Down Margin (Lines 496, 501 ç›¸åŒé‚è¼¯)
```

**é—œéµæ´å¯Ÿ**:
- Type 0/1æœƒå“¡æŠ˜æ‰£**æœƒè¨­å®šè®Šåƒ¹æ——æ¨™**
- è¨­å®šå¾Œå•†å“è¢«ç§»å‡º`lstComputeSku`ï¼ˆé‡æ–°åˆ†é¡æ™‚ï¼‰
- å¾ŒçºŒä¿ƒéŠ·ç„¡æ³•å†å¥—ç”¨ï¼ˆé˜²æ­¢é‡è¤‡æŠ˜æ‰£ï¼‰

---

### 2.3 Eventä¿ƒéŠ·ä¸è¨­å®šè®Šåƒ¹æ——æ¨™

**æª”æ¡ˆ**: æœå°‹æ‰€æœ‰Eventè¨ˆç®—å™¨ï¼ˆSoEventA-H.javaï¼‰
**ç™¼ç¾**: æ²’æœ‰ä»»ä½•Eventè¨ˆç®—å™¨è¨­å®šè®Šåƒ¹æ——æ¨™

**é—œéµæ´å¯Ÿ**:
- Eventä¿ƒéŠ·**ä¸è¨­å®šè®Šåƒ¹æ——æ¨™**
- å…è¨±å¾ŒçºŒType 0/1æœƒå“¡æŠ˜æ‰£ç–ŠåŠ 
- é€™æ˜¯è¨­è¨ˆæ±ºç­–ï¼Œéç–æ¼

---

### 2.4 é‡æ–°åˆ†é¡æ©Ÿåˆ¶

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\service\BzSoServices.java`
**ä»£ç¢¼ä½ç½®**: Lines 4444-4446

```java
// Type 2æœƒå“¡æŠ˜æ‰£å¥—ç”¨å¾Œï¼Œé‡æ–°åˆ†é¡
if(!memberDiscSkus.isEmpty()){
    assortSku = new AssortSku(lstAllSku, lstWorkTypeSku);  // é‡æ–°åˆ†é¡
    lstComputeSku = assortSku.getLstComputeSku();          // å–å¾—æ–°çš„å¯ä¿ƒéŠ·å•†å“æ¸…å–®
    lstGoodsSku = assortSku.getLstGoodsSku();
}
```

**é—œéµæ´å¯Ÿ**:
- æ¯æ¬¡å¥—ç”¨æŠ˜æ‰£å¾Œ**å‹•æ…‹é‡æ–°åˆ†é¡**
- å·²è®Šåƒ¹å•†å“è‡ªå‹•è¢«æ’é™¤ï¼ˆç§»å‡ºlstComputeSkuï¼‰
- ç¢ºä¿å¾ŒçºŒæŠ˜æ‰£ä¸æœƒå¥—ç”¨åˆ°å·²è®Šåƒ¹å•†å“

---

### å®Œæ•´ç–ŠåŠ ç¯„ä¾‹

**å ´æ™¯**: å•†å“åŸåƒ¹1000å…ƒï¼ŒåŒæ™‚ç¬¦åˆEvent Cä¿ƒéŠ·å’ŒType 0æœƒå“¡æŠ˜æ‰£

```
åŸåƒ¹: 1000å…ƒ

éšæ®µ2: Event Cä¿ƒéŠ·ï¼ˆæ»¿3000æŠ˜300ï¼Œæ­¤å•†å“åˆ†æ”¤100å…ƒï¼‰
  - discountAmt = -100
  - å°è¨ˆ: 1000 + (-100) = 900å…ƒ
  - âœ— ä¸è¨­å®šè®Šåƒ¹æ——æ¨™

éšæ®µ3: Type 0æœƒå“¡æŠ˜æ‰£ï¼ˆ9æŠ˜ï¼‰
  - è¨ˆç®—åŸºæº– = 1000 + (-100) = 900å…ƒ
  - æŠ˜æ‰£é‡‘é¡ = 900 Ã— 10% = 90å…ƒ
  - å°è¨ˆ: 900 - 90 = 810å…ƒ
  - âœ“ è¨­å®šposAmtChangePrice = true

æœ€çµ‚åƒ¹æ ¼: 810å…ƒ
ç¸½æŠ˜æ‰£: 190å…ƒ (Event 100 + æœƒå“¡ 90)
```

---

## è¦å‰‡3: Eventä¿ƒéŠ·èˆ‡å„ªæƒ åˆ¸çš„ç–ŠåŠ 

### çµè«–ï¼šâš ï¸ æ¢ä»¶æ€§äº’æ–¥ï¼Œè¦–å„ªæƒ åˆ¸çš„excludeCardè¨­å®šè€Œå®š

### 3.1 å„ªæƒ åˆ¸æ’é™¤Eventå•†å“çš„æ¢ä»¶

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\service\SoFunctionCouponServices.java`
**ä»£ç¢¼ä½ç½®**: Lines 1647-1657

```java
/**
 * æ’é™¤çµ„åˆä¿ƒéŠ·å’Œé™åƒ¹ä¿ƒéŠ·å•†å“
 */
private void checkSkuBundleAndSaleDiscount(CouponVO coupon, List<OrderDetlVO> lstFindSku) {
    for (int i=lstFindSku.size()-1 ; i >=0  ; i--) {
        OrderDetlVO item = lstFindSku.get(i);

        // â˜… é—œéµåˆ¤æ–·ï¼šå„ªæƒ åˆ¸æ˜¯å¦æ’é™¤çµ„ä¿ƒ/é™åƒ¹ä¿ƒéŠ·
        if ("Y".equals(coupon.getExcludeCard())) {
            // æª¢æŸ¥å•†å“æ˜¯å¦æœ‰ä¿ƒéŠ·
            if (StringUtils.isNotEmpty(item.getDiscountType()) ||
                StringUtils.isNotEmpty(item.getEventNos())) {

                logger.info("å•†å“: " + item.getSkuName()  +
                    ",æœ‰ä½¿ç”¨çµ„åˆä¿ƒéŠ·/é™åƒ¹ä¿ƒéŠ·ï¼Œä¸”æŠ˜åƒ¹åˆ¸: " + coupon.getDscSku() +
                    " æœ‰æ’é™¤çµ„åˆä¿ƒéŠ·/é™åƒ¹ä¿ƒéŠ·,éœ€æ’é™¤å‡ºæŠ˜åƒ¹ç¯„åœã€‚");

                // â˜… å¾å„ªæƒ åˆ¸é©ç”¨å•†å“æ¸…å–®ä¸­ç§»é™¤
                lstFindSku.remove(i);
            }
        }
    }
}
```

**é—œéµæ´å¯Ÿ**:
- `coupon.excludeCard = "Y"`: æ’é™¤å·²æœ‰Eventä¿ƒéŠ·çš„å•†å“
- `coupon.excludeCard = "N"`: ä¸æ’é™¤ï¼Œå¯ç–ŠåŠ Eventä¿ƒéŠ·
- æª¢æŸ¥`discountType`ï¼ˆEventé¡å‹A-Hï¼‰å’Œ`eventNos`ï¼ˆé™åƒ¹ä¿ƒéŠ·ï¼‰

---

### 3.2 å„ªæƒ åˆ¸è¨ˆç®—åŸºæº–

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\service\SoFunctionCouponServices.java`
**ä»£ç¢¼ä½ç½®**: Lines 827-830

```java
// â˜… å•†å“ç¸½é‡‘é¡ = å•†å“ç¸½é‡‘é¡ - å·²æŠ˜åƒ¹ç¸½é¡ + ç¸½é¡è®Šåƒ¹æŠ˜æ‰£(è² æ•¸)
couponCheckVo.setSkuTotalAmt(
    OrderDetlUtils.sumSkuTotalPrice(lstFindSku)    // å•†å“ç¸½é‡‘é¡
    - couponCheckVo.getTotalCouponDisc()           // å·²æŠ˜åƒ¹ç¸½é¡ï¼ˆå·²å¥—ç”¨çš„å„ªæƒ åˆ¸ï¼‰
    - Math.abs(couponCheckVo.getComputeDisc())     // ç¸½é¡è®Šåƒ¹æŠ˜æ‰£
);
```

**é—œéµæ´å¯Ÿ**:
- å„ªæƒ åˆ¸è¨ˆç®—åŸºæº–**å·²æ‰£é™¤EventæŠ˜æ‰£å’Œæœƒå“¡æŠ˜æ‰£**
- æ”¯æŒ**å¤šå¼µå„ªæƒ åˆ¸ç–ŠåŠ **ï¼ˆæ¯æ¬¡æ‰£é™¤å·²æŠ˜åƒ¹ç¸½é¡ï¼‰

---

### 3.3 ç´…åˆ©é»æ•¸ä¸æ’é™¤Eventä¿ƒéŠ·

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\service\SoFunctionCouponServices.java`
**ä»£ç¢¼ä½ç½®**: Line 805

```java
// â˜… ç´…åˆ©é»æ•¸ä¸æª¢æŸ¥Eventä¿ƒéŠ·æ’é™¤
if(CouponType.BONUS != couponType){
    checkSkuBundleAndSaleDiscount(coupon, lstFindSku);
}
```

**é—œéµæ´å¯Ÿ**:
- **ç´…åˆ©é»æ•¸ï¼ˆBonusï¼‰**å„ªæƒ åˆ¸é¡å‹ä¸æ’é™¤Eventå•†å“
- å…¶ä»–é¡å‹å„ªæƒ åˆ¸è¦–`excludeCard`è¨­å®š

---

### ç–ŠåŠ ç¯„ä¾‹

**å ´æ™¯1: excludeCard="Y"ï¼ˆæ’é™¤Eventï¼‰**
```
å•†å“A: 1000å…ƒï¼Œå¥—ç”¨Event Fä¿ƒéŠ·ï¼ŒæŠ˜å¾Œ900å…ƒ
å•†å“B: 1000å…ƒï¼Œç„¡ä¿ƒéŠ·
å„ªæƒ åˆ¸: 100å…ƒï¼ŒexcludeCard="Y"

çµæœ:
  å•†å“Aè¢«æ’é™¤ï¼ˆæœ‰Event Fï¼‰
  å•†å“Bå¥—ç”¨å„ªæƒ åˆ¸: 1000 - 100 = 900å…ƒ
  å„ªæƒ åˆ¸æŠ˜æŠµç¸½é¡: 100å…ƒï¼ˆåƒ…å¾å•†å“Bæ‰£é™¤ï¼‰
```

**å ´æ™¯2: excludeCard="N"ï¼ˆå¯ç–ŠåŠ Eventï¼‰**
```
å•†å“A: 1000å…ƒï¼Œå¥—ç”¨Event Fä¿ƒéŠ·ï¼ŒæŠ˜å¾Œ900å…ƒ
å•†å“B: 1000å…ƒï¼Œç„¡ä¿ƒéŠ·
å„ªæƒ åˆ¸: 100å…ƒï¼ŒexcludeCard="N"

çµæœ:
  å•†å“A+Bç¸½é¡: 900 + 1000 = 1900å…ƒ
  å„ªæƒ åˆ¸æŠ˜æŠµ: 100å…ƒï¼ˆä¾åˆ†é…è¦å‰‡å¾A+Bæ‰£é™¤ï¼‰
```

---

## è¦å‰‡4: ç´…åˆ©ç©é»èˆ‡Eventä¿ƒéŠ·çš„äº’æ–¥

### çµè«–ï¼šâŒ å®Œå…¨äº’æ–¥ï¼ŒbonusTotal > 0æ™‚å•†å“ä¸åƒèˆ‡Event

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\functions\SoComputeFunctionMain.java`
**ä»£ç¢¼ä½ç½®**: Lines 153-156

```java
private void assortEventNo(ArrayList<OrderDetlVO> items){
    String eventType = StringUtils.EMPTY;
    for (OrderDetlVO orderDetlVO : items) {
        // â˜… é—œéµæª¢æŸ¥ï¼šå¿…é ˆbonusTotalç‚ºç©ºæˆ–ç‚º0
        if(StringUtils.isNotBlank(orderDetlVO.getEventNosp()) &&
           (StringUtils.isBlank(orderDetlVO.getBonusTotal()) ||
            Integer.parseInt(orderDetlVO.getBonusTotal()) == 0)){

            // ... åˆ†é…åˆ°Event A-H
        }
    }
}
```

**é—œéµæ´å¯Ÿ**:
- `bonusTotal > 0`çš„å•†å“**å®Œå…¨ä¸åƒèˆ‡Eventåˆ†é¡**
- å³ä½¿å•†å“æœ‰`eventNosp`ï¼Œä¹Ÿæœƒè¢«è·³é
- é€™æ˜¯æ¥­å‹™è¦å‰‡ï¼Œé˜²æ­¢ã€Œé›™é‡å„ªæƒ ã€

---

### ä½†ç´…åˆ©ç©é»å¯ä»¥èˆ‡æœƒå“¡æŠ˜æ‰£ç–ŠåŠ 

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\service\SoFunctionMemberDisServices.java`
**ä»£ç¢¼ä½ç½®**: ç„¡æ˜ç¢ºbonusTotalæª¢æŸ¥

**é—œéµæ´å¯Ÿ**:
- æœƒå“¡æŠ˜æ‰£**ä¸æª¢æŸ¥**bonusTotal
- ç´…åˆ©ç©é»å•†å“**å¯ä»¥å¥—ç”¨æœƒå“¡æŠ˜æ‰£**
- äº’æ–¥åƒ…é™æ–¼Eventä¿ƒéŠ·

---

### ç–ŠåŠ ç¯„ä¾‹

**å ´æ™¯**: å•†å“1000å…ƒï¼Œä½¿ç”¨500ç´…åˆ©ç©é»ï¼Œæœ‰æœƒå“¡å¡9æŠ˜

```
åŸåƒ¹: 1000å…ƒ

ç´…åˆ©ç©é»æŠ˜æŠµ: -500å…ƒ
å°è¨ˆ: 500å…ƒ

Type 0æœƒå“¡æŠ˜æ‰£(9æŠ˜):
  è¨ˆç®—åŸºæº–: 500å…ƒï¼ˆå·²æ‰£ç´…åˆ©ï¼‰
  æŠ˜æ‰£: 500 Ã— 10% = 50å…ƒ
  æœ€çµ‚: 450å…ƒ

ç¸½æŠ˜æ‰£: 550å…ƒï¼ˆç´…åˆ©500 + æœƒå“¡50ï¼‰
```

---

## è¦å‰‡5: è®Šåƒ¹æ——æ¨™é˜²è­·æ©Ÿåˆ¶

### ä¸‰å±¤é˜²è­·æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å±¤: è¨­å®šæ——æ¨™                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ å¥—ç”¨æŠ˜æ‰£æ™‚è¨­å®šå°æ‡‰æ——æ¨™:                       â”‚ â”‚
â”‚ â”‚ - posAmtChangePrice                          â”‚ â”‚
â”‚ â”‚ - installChangePrice                         â”‚ â”‚
â”‚ â”‚ - deliveryChangePrice                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2å±¤: å‹•æ…‹é‡æ–°åˆ†é¡                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ AssortSkué‡æ–°åŸ·è¡Œ:                            â”‚ â”‚
â”‚ â”‚ - æª¢æŸ¥è®Šåƒ¹æ——æ¨™                                â”‚ â”‚
â”‚ â”‚ - å·²è®Šåƒ¹å•†å“ç§»å‡ºlstComputeSku                 â”‚ â”‚
â”‚ â”‚ - å¾ŒçºŒä¿ƒéŠ·æ”¶ä¸åˆ°å·²è®Šåƒ¹å•†å“                    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3å±¤: æŠ˜æ‰£å‰å†æª¢æŸ¥                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ å¥—ç”¨æ–°æŠ˜æ‰£å‰:                                 â”‚ â”‚
â”‚ â”‚ - æœƒå“¡æŠ˜æ‰£æª¢æŸ¥isPosAmtChangePrice()          â”‚ â”‚
â”‚ â”‚ - å„ªæƒ åˆ¸æª¢æŸ¥æ‰€æœ‰è®Šåƒ¹æ——æ¨™                      â”‚ â”‚
â”‚ â”‚ - é›™é‡ä¿éšª                                    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.1 æ——æ¨™å®šç¾©

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\bean\OrderDetlVO.java`
**ä»£ç¢¼ä½ç½®**: Lines 115-118

```java
private boolean installChangePrice = false;  // å®‰è£å•†å“æ˜¯å¦è®Šåƒ¹
private boolean deliveryChangePrice = false; // é‹é€å•†å“æ˜¯å¦è®Šåƒ¹
private boolean posAmtChangePrice = false;   // POSåƒ¹æ˜¯å¦è®Šåƒ¹
private boolean stampFlag;                    // å°èŠ±åƒ¹æ ¼ä½¿ç”¨æ¨™è¨˜ï¼ˆEvent Aå°ˆç”¨ï¼‰
```

---

### 5.2 ç¬¬1å±¤ï¼šè¨­å®šæ——æ¨™æ™‚æ©Ÿ

#### æœƒå“¡æŠ˜æ‰£è¨­å®šæ——æ¨™

**æª”æ¡ˆ**: `SoFunctionMemberDisServices.java`
**Type 0/1 è¨­å®š** (Lines 453, 460, 496, 501):
```java
// Type 0 Discounting
orderDetlVO.setPosAmtChangePrice(true);      // POSè®Šåƒ¹
orderDetlVO.setInstallChangePrice(true);     // å®‰è£è®Šåƒ¹

// Type 1 Down Marginï¼ˆç›¸åŒé‚è¼¯ï¼‰
```

**Type 2 è¨­å®š** (Lines 493, 500):
```java
// Type 2 Cost Markup
orderDetlVO.setPosAmtChangePrice(true);      // POSè®Šåƒ¹
orderDetlVO.setInstallChangePrice(true);     // å®‰è£è®Šåƒ¹
```

#### å„ªæƒ åˆ¸è¨­å®šæ——æ¨™

**æª”æ¡ˆ**: `SoFunctionCouponServices.java`
**ä»£ç¢¼ä½ç½®** (Lines 626, 635, 641):
```java
orderDetlVO.setPosAmtChangePrice(true);      // POSè®Šåƒ¹
orderDetlVO.setInstallChangePrice(true);     // å®‰è£è®Šåƒ¹
orderDetlVO.setDeliveryChangePrice(true);    // é‹é€è®Šåƒ¹
```

---

### 5.3 ç¬¬2å±¤ï¼šAssortSkuå‹•æ…‹éæ¿¾

#### ä¸€èˆ¬å•†å“éæ¿¾

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\functions\AssortSku.java`
**ä»£ç¢¼ä½ç½®**: Lines 71-76

```java
// å¯åšä¿ƒéŠ· : ç„¡è®Šåƒ¹ï¼ŒopenPrice=Nï¼ŒPosAmtæœªè®Šåƒ¹ï¼Œéæœå‹™å•†å“ï¼Œæ•¸é‡ä¸ç‚º0
if (StringUtils.isBlank(orderDetlVO.getGoodsAuthEmpId())           // ç„¡äººå·¥è®Šåƒ¹æˆæ¬Š
    && CommonConstant.NO_FLAG.equals(orderDetlVO.getOpenPrice())   // éé–‹æ”¾åƒ¹å•†å“
    && !orderDetlVO.isPosAmtChangePrice()                          // â˜… POSåƒ¹æœªè®Šåƒ¹
    && !BzSkuInfoServices.isServiceSku(orderDetlVO.getSubDeptId(), orderDetlVO.getClassId())
    && !"0".equals(orderDetlVO.getQuantity())) {

    lstComputeSku.add(orderDetlVO);  // â† åªæœ‰ç¬¦åˆæ¢ä»¶çš„æ‰åŠ å…¥å¯ä¿ƒéŠ·æ¸…å–®
}
```

#### å®‰è£å•†å“éæ¿¾

**ä»£ç¢¼ä½ç½®**: Lines 139-146

```java
// å¯ä¿ƒéŠ·å•†å“: æœªå·¥ç¨®å®‰è£è®Šåƒ¹ & ä¸ç‚ºå…å®‰ & openPrice=N & ä¸ç‚ºæœ‰å…å®‰çš„æ¨™å®‰ & æ•¸é‡ä¸ç‚º0
if (StringUtils.isBlank(installSku.getInstallAuthEmpId())         // ç„¡å®‰è£è®Šåƒ¹æˆæ¬Š
    && !GoodsType.FI.equals(installSku.getGoodsType())            // ä¸ç‚ºå…å®‰å•†å“
    && !installSku.isInstallChangePrice()                         // â˜… å®‰è£æœªè®Šåƒ¹
    && CommonConstant.NO_FLAG.equals(installSku.getOpenPrice())   // éé–‹æ”¾åƒ¹å•†å“
    && !installSku.isHasFreeInstall()                             // ä¸ç‚ºæœ‰å…å®‰çš„æ¨™å®‰
    && !"0".equals(installSku.getQuantity())) {

    lstComputeSku.add(installSku);
}
```

#### é‹é€å•†å“éæ¿¾

**ä»£ç¢¼ä½ç½®**: Lines 207-213

```java
// ç„¡è®Šåƒ¹ã€éå·¥ç¨®è®Šåƒ¹å•†å“ï¼ŒopenPrice=Nï¼Œæ•¸é‡ä¸ç‚º0ï¼Œå¯åšä¿ƒéŠ·
if (StringUtils.isBlank(deliverySku.getDeliveryAuthEmpId())       // ç„¡é‹é€è®Šåƒ¹æˆæ¬Š
    && !deliverySku.isDeliveryChangePrice()                       // â˜… é‹é€æœªè®Šåƒ¹
    && CommonConstant.NO_FLAG.equals(deliverySku.getOpenPrice())  // éé–‹æ”¾åƒ¹å•†å“
    && !"0".equals(deliverySku.getQuantity())) {

    lstComputeSku.add(deliverySku);
}
```

---

### 5.4 ç¬¬3å±¤ï¼šæŠ˜æ‰£å‰å†æª¢æŸ¥

#### æœƒå“¡æŠ˜æ‰£æª¢æŸ¥

**æª”æ¡ˆ**: `SoFunctionMemberDisServices.java`
**Type CTæª¢æŸ¥** (Lines 108-110):
```java
// Type CTç‰¹æ®Šæœƒå“¡æŠ˜æ‰£
if( !orderDetlVO.isPosAmtChangePrice() &&      // â˜… POSæœªè®Šåƒ¹
    !orderDetlVO.isDeliveryChangePrice() &&    // â˜… é‹é€æœªè®Šåƒ¹
    !orderDetlVO.isInstallChangePrice() ){     // â˜… å®‰è£æœªè®Šåƒ¹
    allSkus.add(orderDetlVO.getSkuNo());
}
```

**Type 0/1æª¢æŸ¥** (Lines 280-282ï¼Œç›¸åŒé‚è¼¯)

#### å„ªæƒ åˆ¸æª¢æŸ¥

**æª”æ¡ˆ**: `SoFunctionCouponServices.java`
**ä»£ç¢¼ä½ç½®**: Lines 655-663

```java
logger.info("å•†å“: " + item.getSkuName()  + ",æ˜¯å¦æœ‰åšè®Šåƒ¹: " + item.isPosAmtChangePrice());
logger.info("å•†å“: " + item.getSkuName()  + ",æ˜¯å¦æœ‰åšå·¥ç¨®å®‰è£è®Šåƒ¹: " + item.isInstallChangePrice());
logger.info("å•†å“: " + item.getSkuName()  + ",æ˜¯å¦æœ‰åšå·¥ç¨®é‹é€è®Šåƒ¹: " + item.isDeliveryChangePrice());

// â˜… äººå·¥è®Šåƒ¹å•†å“æ’é™¤
if (StringUtils.isNotBlank(item.getGoodsAuthEmpId())
    && (item.isPosAmtChangePrice() || item.isInstallChangePrice() || item.isDeliveryChangePrice())
    && StringUtils.equals(CommonConstant.NO_FLAG, item.getOpenPrice())) {

    logger.info("å•†å“: " + item.getSkuName()  +
        ",ç”± EMP_ID: " + item.getGoodsAuthEmpId() + " é€²è¡Œè®Šåƒ¹,éœ€æ’é™¤å‡ºæŠ˜åƒ¹ç¯„åœã€‚");
    lstFindSku.remove(i);
}
```

---

### 5.5 stampFlagå°èŠ±åƒ¹æ——æ¨™ï¼ˆEvent Aå°ˆç”¨ï¼‰

**æª”æ¡ˆ**: `SoComputeFunctionMain.java`
**ä»£ç¢¼ä½ç½®**: Lines 160-161

```java
if("A".equals(eventType) && orderDetlVO.isStampFlag()){  // â˜… å¿…é ˆstampFlag=true
    soEventItemsA.add(orderDetlVO);
}
```

**é—œéµæ´å¯Ÿ**:
- `stampFlag`æ˜¯**Event Aå°èŠ±åƒ¹å°ˆç”¨**çš„é¡å¤–æª¢æŸ¥
- å…¶ä»–Eventä¸ä½¿ç”¨æ­¤æ——æ¨™
- å‰ç«¯è¨­å®šï¼ˆJSP checkboxï¼‰

---

## è¦å‰‡6: AssortSkuå•†å“åˆ†é¡é‚è¼¯

### 6.1 åˆ†é¡æ¸…å–®å®šç¾©

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\functions\AssortSku.java`
**ä»£ç¢¼ä½ç½®**: Lines 22-47

```java
private ArrayList<OrderDetlVO> lstAllTypeSku;        // å…¨å•†å“
private ArrayList<OrderDetlVO> lstGoodsSku;          // ä¸€èˆ¬å•†å“
private ArrayList<OrderDetlVO> lstInstallSku;        // å®‰è£å•†å“
private ArrayList<OrderDetlVO> lstFreeInstallSku;    // å…å®‰å•†å“
private ArrayList<OrderDetlVO> lstDirectShipmentSku; // ç›´é€å•†å“
private ArrayList<OrderDetlVO> lstDeliverSku;        // é‹é€å•†å“
private ArrayList<OrderDetlVO> lstTaxAllSku;         // å…¨éƒ¨æ‡‰ç¨…å•†å“
private ArrayList<OrderDetlVO> lstFreeTaxAllSku;     // å…¨éƒ¨å…ç¨…å•†å“

// â˜… é—œéµæ¸…å–®
private ArrayList<OrderDetlVO> lstComputeSku;        // å¯ä¿ƒéŠ·å•†å“
```

### 6.2 å¯ä¿ƒéŠ·å•†å“ï¼ˆlstComputeSkuï¼‰æ¢ä»¶ç¸½è¦½

| å•†å“é¡å‹ | æ¢ä»¶1 | æ¢ä»¶2 | æ¢ä»¶3 | æ¢ä»¶4 | æ¢ä»¶5 | æ¢ä»¶6 |
|---------|------|------|------|------|------|------|
| **ä¸€èˆ¬å•†å“** | ç„¡äººå·¥è®Šåƒ¹æˆæ¬Š | éé–‹æ”¾åƒ¹ | POSæœªè®Šåƒ¹ | éæœå‹™å•†å“ | æ•¸é‡>0 | - |
| **å®‰è£å•†å“** | ç„¡å®‰è£è®Šåƒ¹æˆæ¬Š | éé–‹æ”¾åƒ¹ | å®‰è£æœªè®Šåƒ¹ | éå…å®‰ | æ•¸é‡>0 | éæœ‰å…å®‰çš„æ¨™å®‰ |
| **é‹é€å•†å“** | ç„¡é‹é€è®Šåƒ¹æˆæ¬Š | éé–‹æ”¾åƒ¹ | é‹é€æœªè®Šåƒ¹ | - | æ•¸é‡>0 | - |
| **ç›´é€å•†å“** | - | éé–‹æ”¾åƒ¹ | - | - | - | - |

### 6.3 åŸ·è¡Œæ™‚æ©Ÿ

**æª”æ¡ˆ**: `BzSoServices.java`
**åˆå§‹åˆ†é¡** (Line 4412):
```java
AssortSku assortSku = new AssortSku(lstAllSku, lstWorkTypeSku);
```

**é‡æ–°åˆ†é¡** (Lines 4444-4446):
```java
if(!memberDiscSkus.isEmpty()){
    assortSku = new AssortSku(lstAllSku, lstWorkTypeSku);  // â˜… é‡æ–°åˆ†é¡
    lstComputeSku = assortSku.getLstComputeSku();          // â˜… å–å¾—æ–°æ¸…å–®
    lstGoodsSku = assortSku.getLstGoodsSku();
}
```

**é—œéµæ´å¯Ÿ**:
- **å‹•æ…‹é‡æ–°åˆ†é¡**: æ¯æ¬¡å¥—ç”¨æŠ˜æ‰£å¾Œé‡æ–°åŸ·è¡Œ
- **è‡ªå‹•æ’é™¤**: å·²è®Šåƒ¹å•†å“è‡ªå‹•è¢«ç§»å‡ºlstComputeSku
- **é˜²æ­¢é‡è¤‡**: å¾ŒçºŒä¿ƒéŠ·æ”¶ä¸åˆ°å·²è®Šåƒ¹å•†å“

---

## å®Œæ•´äº’æ–¥/ç›¸å®¹è¦å‰‡ç¸½çµ

### 1. å®Œå…¨äº’æ–¥çµ„åˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [äººå·¥è®Šåƒ¹] âŸ· [æ‰€æœ‰è‡ªå‹•æŠ˜æ‰£]                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŸå› ï¼šè¨­å®šgoodsAuthEmpIdå¾Œç§»å‡ºlstComputeSku      â”‚
â”‚ ä»£ç¢¼ï¼šAssortSku.java:71-76                       â”‚
â”‚ å½±éŸ¿ï¼šç„¡æ³•åƒèˆ‡ä»»ä½•å¾ŒçºŒä¿ƒéŠ·è¨ˆç®—                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ç´…åˆ©ç©é»(bonusTotal > 0)] âŸ· [Eventä¿ƒéŠ·]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŸå› ï¼šEventåˆ†é¡æ™‚æ˜ç¢ºæª¢æŸ¥bonusTotal               â”‚
â”‚ ä»£ç¢¼ï¼šSoComputeFunctionMain.java:155            â”‚
â”‚ å½±éŸ¿ï¼šbonusTotal>0çš„å•†å“ä¸åƒèˆ‡Event              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Type 0/1æœƒå“¡æŠ˜æ‰£] âŸ· [Type CTç‰¹æ®Šæœƒå“¡]          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŸå› ï¼šType CTåƒ…åœ¨memberDiscSkus.isEmpty()æ™‚åŸ·è¡Œ  â”‚
â”‚ ä»£ç¢¼ï¼šBzSoServices.java:4463                     â”‚
â”‚ å½±éŸ¿ï¼šType 0/1/2ä»»ä¸€å¥—ç”¨å‰‡Type CTä¸åŸ·è¡Œ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [åŒä¸€å•†å“] âŸ· [å¤šå€‹Event]                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŸå› ï¼ševentNospç‚ºStringï¼ˆéListï¼‰                â”‚
â”‚ ä»£ç¢¼ï¼šOrderDetlVO.java:95                        â”‚
â”‚ å½±éŸ¿ï¼šè³‡æ–™çµæ§‹é™åˆ¶ç‚ºå–®ä¸€Event                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ¢ä»¶æ€§äº’æ–¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [å„ªæƒ åˆ¸] âŸ· [Eventä¿ƒéŠ·]                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ¢ä»¶ï¼šè¦–coupon.excludeCardè¨­å®š                   â”‚
â”‚   - "Y": äº’æ–¥ï¼ˆæ’é™¤Eventå•†å“ï¼‰                   â”‚
â”‚   - "N": å¯ç–ŠåŠ                                   â”‚
â”‚ ä»£ç¢¼ï¼šSoFunctionCouponServices.java:1650        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å¯ç–ŠåŠ çµ„åˆï¼ˆæŒ‰é †åºåŸ·è¡Œï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Type 2æœƒå“¡æŠ˜æ‰£] â†’ [Eventä¿ƒéŠ·] â†’ [Type 0/1]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ©Ÿåˆ¶ï¼š                                            â”‚
â”‚ 1. Type 2åŸ·è¡Œï¼Œè¨­å®šè®Šåƒ¹æ——æ¨™                      â”‚
â”‚ 2. é‡æ–°åˆ†é¡AssortSkuï¼Œæ’é™¤è®Šåƒ¹å•†å“               â”‚
â”‚ 3. Eventè¨ˆç®—ï¼ˆåŸºæ–¼æ–°lstComputeSkuï¼‰             â”‚
â”‚ 4. Type 0/1åŸ·è¡Œï¼ˆè¨ˆç®—åŸºæº–å·²æ‰£EventæŠ˜æ‰£ï¼‰         â”‚
â”‚ 5. æ¯æ¬¡è¨­å®šè®Šåƒ¹æ——æ¨™ï¼Œé˜²æ­¢å¾ŒçºŒé‡è¤‡æŠ˜æ‰£            â”‚
â”‚                                                   â”‚
â”‚ ä»£ç¢¼ï¼šBzSoServices.java:4434-4478                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [æœƒå“¡æŠ˜æ‰£/Event] â†’ [å„ªæƒ åˆ¸]                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ©Ÿåˆ¶ï¼š                                            â”‚
â”‚ 1. æœƒå“¡æŠ˜æ‰£å’ŒEventå…ˆåŸ·è¡Œ                         â”‚
â”‚ 2. å„ªæƒ åˆ¸å¾ŒåŸ·è¡Œ                                   â”‚
â”‚ 3. è¨ˆç®—åŸºæº–å·²æ‰£é™¤å‰é¢çš„æŠ˜æ‰£                       â”‚
â”‚ 4. æ”¯æŒå¤šå¼µå„ªæƒ åˆ¸ç–ŠåŠ                              â”‚
â”‚                                                   â”‚
â”‚ ä»£ç¢¼ï¼šSoFunctionCouponServices.java:827          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [ç´…åˆ©ç©é»] + [æœƒå“¡æŠ˜æ‰£/å„ªæƒ åˆ¸]                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ©Ÿåˆ¶ï¼š                                            â”‚
â”‚ 1. ç´…åˆ©ç©é»ä¸æª¢æŸ¥è®Šåƒ¹æ——æ¨™                        â”‚
â”‚ 2. ç´…åˆ©ç©é»å•†å“å¯å¥—ç”¨æœƒå“¡æŠ˜æ‰£                    â”‚
â”‚ 3. ç´…åˆ©å„ªæƒ åˆ¸ä¸æ’é™¤Eventå•†å“                     â”‚
â”‚                                                   â”‚
â”‚ é™åˆ¶ï¼šç´…åˆ©ç©é»èˆ‡Eventäº’æ–¥                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ¸¬è©¦å ´æ™¯å»ºè­°

### å ´æ™¯1: Eventèˆ‡æœƒå“¡æŠ˜æ‰£ç–ŠåŠ 
**ç›®çš„**: é©—è­‰Eventä¿ƒéŠ·å¾Œä»å¯å¥—ç”¨æœƒå“¡æŠ˜æ‰£ï¼Œä¸”è¨ˆç®—åŸºæº–æ­£ç¢º

**æ¸¬è©¦æ­¥é©Ÿ**:
1. å»ºç«‹æœƒå“¡å¡ï¼ˆType 0 Discounting 9æŠ˜ï¼‰
2. åŠ å…¥å•†å“Aï¼ˆPosAmt=1000ï¼Œç¬¦åˆEvent Cä¿ƒéŠ·-æ»¿3000æŠ˜300ï¼‰
3. åŠ å…¥å•†å“Bã€Cï¼ˆå„1000å…ƒï¼Œæ¹Šæ»¿3000ï¼‰
4. åŸ·è¡Œè©¦ç®—

**é æœŸçµæœ**:
```
å•†å“A:
  åŸåƒ¹: 1000
  Event CæŠ˜æ‰£: -100 (300Ã·3)
  å°è¨ˆ: 900
  Type 0æœƒå“¡æŠ˜æ‰£åŸºæº–: 900 (1000-100)
  Type 0æŠ˜æ‰£: -90 (900 Ã— 10%)
  æœ€çµ‚åƒ¹æ ¼: 810

ç¸½æŠ˜æ‰£: 190å…ƒï¼ˆEvent 100 + æœƒå“¡ 90ï¼‰
```

**é©—è­‰é»**:
- âœ“ EventæŠ˜æ‰£æ­£ç¢ºå¥—ç”¨
- âœ“ æœƒå“¡æŠ˜æ‰£è¨ˆç®—åŸºæº– = å¯¦éš›å”®åƒ¹ - EventæŠ˜æ‰£
- âœ“ å•†å“æœ€çµ‚åƒ¹æ ¼ = 810å…ƒ

**ä»£ç¢¼è¿½è¹¤**:
- BzSoServices.java:4454 (EventåŸ·è¡Œ)
- BzSoServices.java:4460 (Type 0åŸ·è¡Œ)
- SoFunctionMemberDisServices.java:207-213 (è¨ˆç®—åŸºæº–)

---

### å ´æ™¯2: äººå·¥è®Šåƒ¹å¾Œç„¡æ³•å¥—ç”¨ä¿ƒéŠ·
**ç›®çš„**: é©—è­‰è®Šåƒ¹æ——æ¨™ä¸‰å±¤é˜²è­·æ©Ÿåˆ¶

**æ¸¬è©¦æ­¥é©Ÿ**:
1. åŠ å…¥å•†å“Aï¼ˆPosAmt=1000ï¼Œç¬¦åˆEvent Dä¿ƒéŠ·ï¼‰
2. åŸ·è¡Œäººå·¥è®Šåƒ¹ï¼ˆèª¿æ•´ç‚º900ï¼Œè¨­å®šgoodsAuthEmpId="EMP001"ï¼‰
3. åŸ·è¡Œè©¦ç®—

**é æœŸçµæœ**:
```
å•†å“A:
  äººå·¥è®Šåƒ¹: 900
  Event D: ä¸å¥—ç”¨ï¼ˆç§»å‡ºlstComputeSkuï¼‰
  Type 0æœƒå“¡æŠ˜æ‰£: ä¸å¥—ç”¨ï¼ˆç§»å‡ºlstComputeSkuï¼‰
  æœ€çµ‚åƒ¹æ ¼: 900ï¼ˆåƒ…äººå·¥è®Šåƒ¹ï¼‰

goodsAuthEmpId: "EMP001"
posAmtChangePrice: trueï¼ˆäººå·¥è®Šåƒ¹è¨­å®šï¼‰
```

**é©—è­‰é»**:
- âœ“ å•†å“è¢«ç§»å‡ºlstComputeSku
- âœ“ Event Dä¸å¥—ç”¨
- âœ“ Type 0/1æœƒå“¡æŠ˜æ‰£ä¸å¥—ç”¨
- âœ“ æœ€çµ‚åƒ¹æ ¼ = 900å…ƒï¼ˆåƒ…äººå·¥è®Šåƒ¹ï¼‰

**ä»£ç¢¼è¿½è¹¤**:
- AssortSku.java:71-76 (æ’é™¤è®Šåƒ¹å•†å“)
- SoFunctionMemberDisServices.java:108-110 (æœƒå“¡æŠ˜æ‰£æª¢æŸ¥)

---

### å ´æ™¯3: å„ªæƒ åˆ¸æ’é™¤Eventå•†å“
**ç›®çš„**: é©—è­‰æ¢ä»¶æ€§äº’æ–¥è¦å‰‡ï¼ˆexcludeCard="Y"ï¼‰

**æ¸¬è©¦æ­¥é©Ÿ**:
1. å»ºç«‹å„ªæƒ åˆ¸ï¼ˆé¢é¡100ï¼ŒexcludeCard="Y"ï¼‰
2. åŠ å…¥å•†å“Aï¼ˆ1000å…ƒï¼Œå¥—ç”¨Event Fä¿ƒéŠ·ï¼ŒæŠ˜å¾Œ900å…ƒï¼‰
3. åŠ å…¥å•†å“Bï¼ˆ1000å…ƒï¼Œç„¡ä¿ƒéŠ·ï¼‰
4. å¥—ç”¨å„ªæƒ åˆ¸

**é æœŸçµæœ**:
```
å•†å“A:
  è¢«å„ªæƒ åˆ¸æ’é™¤ï¼ˆæœ‰Event Fï¼‰
  discountType="F"
  æœ€çµ‚: 900å…ƒï¼ˆåƒ…EventæŠ˜æ‰£ï¼‰

å•†å“B:
  å¯å¥—ç”¨å„ªæƒ åˆ¸
  æœ€çµ‚: 900å…ƒï¼ˆ1000-100ï¼‰

å„ªæƒ åˆ¸æŠ˜æŠµç¸½é¡: 100å…ƒï¼ˆåƒ…å¾å•†å“Bæ‰£é™¤ï¼‰
è¨‚å–®ç¸½é¡: 900 + 900 = 1800å…ƒ
```

**é©—è­‰é»**:
- âœ“ å•†å“Aè¢«å„ªæƒ åˆ¸æ’é™¤ï¼ˆæœ‰discountTypeï¼‰
- âœ“ å•†å“Bå¥—ç”¨å„ªæƒ åˆ¸
- âœ“ å„ªæƒ åˆ¸åƒ…å¾å•†å“Bæ‰£é™¤

**ä»£ç¢¼è¿½è¹¤**:
- SoFunctionCouponServices.java:1650-1654 (checkSkuBundleAndSaleDiscount)

---

### å ´æ™¯4: ç´…åˆ©ç©é»èˆ‡Eventäº’æ–¥
**ç›®çš„**: é©—è­‰ç´…åˆ©ç©é»æ’é™¤Eventä¿ƒéŠ·

**æ¸¬è©¦æ­¥é©Ÿ**:
1. åŠ å…¥å•†å“Aï¼ˆ1000å…ƒï¼Œç¬¦åˆEvent Cä¿ƒéŠ·ï¼‰
2. è¨­å®šå•†å“Açš„bonusTotal=500ï¼ˆç´…åˆ©ç©é»æŠ˜æŠµï¼‰
3. åŸ·è¡Œè©¦ç®—

**é æœŸçµæœ**:
```
å•†å“A:
  åŸåƒ¹: 1000
  ç´…åˆ©ç©é»: -500
  Event C: ä¸å¥—ç”¨ï¼ˆbonusTotal > 0ï¼‰
  æœ€çµ‚åƒ¹æ ¼: 500

eventNosp: "" (ä¸åƒèˆ‡Eventåˆ†é¡)
bonusTotal: "500"
```

**é©—è­‰é»**:
- âœ“ å•†å“Aä¸åƒèˆ‡Event Cä¿ƒéŠ·
- âœ“ bonusTotalæª¢æŸ¥ç”Ÿæ•ˆ
- âœ“ æœ€çµ‚åƒ¹æ ¼ = 500å…ƒï¼ˆåƒ…ç´…åˆ©æŠ˜æŠµï¼‰

**ä»£ç¢¼è¿½è¹¤**:
- SoComputeFunctionMain.java:154-156 (bonusTotalæª¢æŸ¥)

---

### å ´æ™¯5: å¤šå¼µå„ªæƒ åˆ¸ç–ŠåŠ 
**ç›®çš„**: é©—è­‰å„ªæƒ åˆ¸å¯å¤šæ¬¡ç–ŠåŠ 

**æ¸¬è©¦æ­¥é©Ÿ**:
1. å»ºç«‹å„ªæƒ åˆ¸Aï¼ˆé¢é¡100ï¼ŒexcludeCard="N"ï¼‰
2. å»ºç«‹å„ªæƒ åˆ¸Bï¼ˆé¢é¡50ï¼ŒexcludeCard="N"ï¼‰
3. åŠ å…¥å•†å“ï¼ˆ2000å…ƒï¼Œç„¡ä¿ƒéŠ·ï¼‰
4. ä¾åºå¥—ç”¨å„ªæƒ åˆ¸Aã€B

**é æœŸçµæœ**:
```
åŸåƒ¹: 2000
å„ªæƒ åˆ¸A: -100 â†’ 1900
å„ªæƒ åˆ¸B: -50  â†’ 1850
æœ€çµ‚åƒ¹æ ¼: 1850

totalCouponDiscç´¯è¨ˆ: 150å…ƒ
```

**é©—è­‰é»**:
- âœ“ å„ªæƒ åˆ¸Aå…ˆå¥—ç”¨: 2000-100=1900
- âœ“ å„ªæƒ åˆ¸Bå¾Œå¥—ç”¨: 1900-50=1850
- âœ“ æœ€çµ‚åƒ¹æ ¼ = 1850å…ƒ

**ä»£ç¢¼è¿½è¹¤**:
- BzSoServices.java:4710-4727 (é€å¼µå¥—ç”¨å„ªæƒ åˆ¸)
- SoFunctionCouponServices.java:827 (æ‰£é™¤å·²æŠ˜åƒ¹ç¸½é¡)

---

### å ´æ™¯6: Type CTèˆ‡Type 0/1äº’æ–¥
**ç›®çš„**: é©—è­‰ç‰¹æ®Šæœƒå“¡æŠ˜æ‰£çš„äº’æ–¥æ¢ä»¶

**æ¸¬è©¦æ­¥é©Ÿ**:
1. å»ºç«‹æœƒå“¡ï¼ˆåŒæ™‚ç¬¦åˆType 0å’ŒType CTæ¢ä»¶ï¼‰
2. åŠ å…¥å•†å“Aï¼ˆ1000å…ƒï¼‰
3. åŸ·è¡Œè©¦ç®—

**é æœŸçµæœ**:
```
Type 0æœƒå“¡æŠ˜æ‰£: åŸ·è¡Œ
  memberDiscSkus: éç©º

Type CTç‰¹æ®Šæœƒå“¡æŠ˜æ‰£: ä¸åŸ·è¡Œ
  if(memberDiscSkus.isEmpty()) â†’ FALSE

æœ€çµ‚: åƒ…Type 0æŠ˜æ‰£å¥—ç”¨
```

**é©—è­‰é»**:
- âœ“ Type 0æœƒå“¡æŠ˜æ‰£åŸ·è¡Œ
- âœ“ memberDiscSkuséç©º
- âœ“ Type CTæœƒå“¡æŠ˜æ‰£ä¸åŸ·è¡Œ

**ä»£ç¢¼è¿½è¹¤**:
- BzSoServices.java:4463-4466 (isEmptyæª¢æŸ¥)

---

### å ´æ™¯7: è¤‡é›œç–ŠåŠ ï¼ˆType 2 + Event + Type 0 + å„ªæƒ åˆ¸ï¼‰
**ç›®çš„**: é©—è­‰å®Œæ•´ç–ŠåŠ æµç¨‹

**æ¸¬è©¦æ­¥é©Ÿ**:
1. å»ºç«‹æœƒå“¡ï¼ˆType 2æˆæœ¬åŠ æˆ20%ï¼ŒType 0æŠ˜æ‰£9æŠ˜ï¼‰
2. åŠ å…¥å•†å“Aï¼ˆunitCost=500ï¼ŒPosAmt=800ï¼Œç¬¦åˆEvent Dä¿ƒéŠ·è²·3é€1ï¼‰
3. åŠ å…¥å•†å“A Ã— 3å€‹
4. å»ºç«‹å„ªæƒ åˆ¸ï¼ˆ100å…ƒï¼ŒexcludeCard="N"ï¼‰
5. å¥—ç”¨å„ªæƒ åˆ¸

**é æœŸçµæœ**:
```
éšæ®µ1: Type 2æœƒå“¡æŠ˜æ‰£ï¼ˆæˆæœ¬åŠ æˆ20%ï¼‰
  è¨ˆç®—åƒ¹æ ¼: ceil(500 Ã— 1.2) Ã— 1.05 = 630å…ƒ/å€‹
  3å€‹å°è¨ˆ: 1890å…ƒ
  posAmtChangePrice: true
  é‡æ–°åˆ†é¡: ç§»å‡ºlstComputeSku

éšæ®µ2-5: è·³éï¼ˆå·²è®Šåƒ¹ï¼Œä¸åœ¨lstComputeSkuä¸­ï¼‰

éšæ®µ6: å„ªæƒ åˆ¸
  è¨ˆç®—åŸºæº–: 1890å…ƒ
  å„ªæƒ åˆ¸æŠ˜æ‰£: -100å…ƒ
  æœ€çµ‚: 1790å…ƒ

ç¸½æŠ˜æ‰£: 510å…ƒï¼ˆType 2é™åƒ¹ 170Ã—3 + å„ªæƒ åˆ¸ 100ï¼‰
```

**é©—è­‰é»**:
- âœ“ Type 2åŸ·è¡Œä¸¦è¨­å®šè®Šåƒ¹æ——æ¨™
- âœ“ é‡æ–°åˆ†é¡å¾Œå•†å“ç§»å‡ºlstComputeSku
- âœ“ Event/Type 0è·³éï¼ˆä¸åœ¨lstComputeSkuï¼‰
- âœ“ å„ªæƒ åˆ¸ä»å¯å¥—ç”¨ï¼ˆä¸æª¢æŸ¥è®Šåƒ¹æ——æ¨™ï¼‰

**ä»£ç¢¼è¿½è¹¤**:
- BzSoServices.java:4442 (Type 2)
- BzSoServices.java:4444-4446 (é‡æ–°åˆ†é¡)
- BzSoServices.java:4454 (Eventè·³é)
- SoFunctionCouponServices.java:785-877 (å„ªæƒ åˆ¸)

---

## å·²ç™¼ç¾çš„å•é¡Œèˆ‡ä¸ä¸€è‡´

### 1. âš ï¸ æ¬„ä½å‘½åæ‹¼å¯«éŒ¯èª¤

**æª”æ¡ˆ**: `OrderDetlVO.java:96`
```java
private String evnetType;  // â† æ‹¼å¯«éŒ¯èª¤ï¼Œæ‡‰ç‚ºeventType
```

**å½±éŸ¿**: ç„¡åŠŸèƒ½å½±éŸ¿ï¼Œä½†é™ä½ä»£ç¢¼å¯è®€æ€§

**å»ºè­°**: åœ¨é‡å¯«æ™‚ä¿®æ­£ç‚º`eventType`

---

### 2. âš ï¸ Eventèˆ‡Type 2çš„è¨ˆç®—åŸºæº–ä¸æ˜ç¢º

**ç™¼ç¾**:
- Type 0/1æœƒå“¡æŠ˜æ‰£æ˜ç¢ºæ‰£é™¤EventæŠ˜æ‰£ï¼ˆLine 207-213ï¼‰
- ä½†Eventè¨ˆç®—æ™‚æœªæ˜ç¢ºèªªæ˜æ˜¯å¦è€ƒæ…®Type 2æŠ˜æ‰£

**ç¾æ³**:
- Type 2åŸ·è¡Œå¾Œè¨­å®š`posAmtChangePrice = true`
- é‡æ–°åˆ†é¡å¾Œï¼Œå·²è®Šåƒ¹å•†å“ç§»å‡º`lstComputeSku`
- Eventè¨ˆç®—æ™‚æ”¶ä¸åˆ°Type 2è®Šåƒ¹å•†å“

**çµè«–**: Type 2èˆ‡Event **å¯¦éš›ä¸Šäº’æ–¥**ï¼ˆType 2è®Šåƒ¹å¾Œå•†å“ä¸åƒèˆ‡Eventï¼‰

**å»ºè­°**: è£œå……æ–‡æª”èªªæ˜Type 2èˆ‡Eventçš„å¯¦éš›é—œä¿‚

---

### 3. âš ï¸ stampFlagè¨­å®šæ™‚æ©Ÿä¸æ˜ç¢º

**ç™¼ç¾**:
- `stampFlag`ç”¨æ–¼Event Aåˆ¤æ–·ï¼ˆSoComputeFunctionMain.java:160ï¼‰
- ä½†æœå°‹ä»£ç¢¼åƒ…ç™¼ç¾JSPä¸­disable stampFlagï¼Œæœªæ‰¾åˆ°è¨­å®šç‚ºtrueçš„é‚è¼¯
- å‰ç«¯å¯èƒ½é€écheckboxè¨­å®š

**å»ºè­°**: è£œå……stampFlagå®Œæ•´ç”Ÿå‘½é€±æœŸæ–‡æª”

---

### 4. âœ… è®Šåƒ¹æ——æ¨™é‡ç½®æ©Ÿåˆ¶å­˜åœ¨ä½†ä¸æ˜é¡¯

**ç™¼ç¾**:
- æ——æ¨™è¨­å®šé‚è¼¯å®Œæ•´ï¼ˆsetPosAmtChangePriceç­‰ï¼‰
- æ‰¾åˆ°é‡ç½®é‚è¼¯ï¼ˆBzSoServices.java:5214,5256ï¼‰
- ä½†åƒ…åœ¨ç‰¹å®šæµç¨‹ï¼ˆé‡æ–°è©¦ç®—ï¼‰æ™‚é‡ç½®

**å¯èƒ½é¢¨éšª**: è¨‚å–®ç·¨è¼¯æ™‚æ——æ¨™å¯èƒ½æœªæ­£ç¢ºé‡ç½®

**å»ºè­°**:
1. æª¢æŸ¥è¨‚å–®ç·¨è¼¯æµç¨‹çš„æ——æ¨™é‡ç½®æ©Ÿåˆ¶
2. æ–°å¢å–®å…ƒæ¸¬è©¦é©—è­‰æ——æ¨™é‡ç½®

---

### 5. âš ï¸ Type 2èˆ‡Eventçš„å¯¦éš›é—œä¿‚æœªè¨˜éŒ„

**ç•¶å‰æ–‡æª”**:
- ç–ŠåŠ çŸ©é™£é¡¯ç¤ºã€ŒType 2 âœ… Eventã€ï¼ˆå¯ç–ŠåŠ ï¼‰
- ä½†å¯¦éš›ä¸ŠType 2è¨­å®šè®Šåƒ¹æ——æ¨™å¾Œï¼Œå•†å“ç§»å‡ºlstComputeSku

**å¯¦éš›è¡Œç‚º**:
```
Type 2åŸ·è¡Œ â†’ posAmtChangePrice=true
â†’ é‡æ–°åˆ†é¡AssortSku
â†’ å•†å“ç§»å‡ºlstComputeSku
â†’ Eventæ”¶ä¸åˆ°æ­¤å•†å“
â†’ å¯¦éš›ä¸Š**ç„¡æ³•ç–ŠåŠ **
```

**å»ºè­°**: æ›´æ–°ç–ŠåŠ çŸ©é™£ï¼Œæ¨™è¨˜Type 2èˆ‡Eventç‚ºã€Œæ¢ä»¶æ€§äº’æ–¥ã€

---

## é—œéµä»£ç¢¼æª”æ¡ˆæ¸…å–®

| æª”æ¡ˆè·¯å¾‘ | åŠŸèƒ½ | é—œéµè¡Œæ•¸ |
|:---|:---|:---|
| **BzSoServices.java** | ä¸»è©¦ç®—æµç¨‹ | 4412, 4434-4478, 4581-4768 |
| **AssortSku.java** | å•†å“åˆ†é¡é‚è¼¯ | 22-47, 70-76, 138-146, 207-213 |
| **SoComputeFunctionMain.java** | Eventä¿ƒéŠ·åˆ†é… | 150-179 |
| **SoFunctionMemberDisServices.java** | æœƒå“¡æŠ˜æ‰£è¨ˆç®— | 108-110, 207-213, 280-282, 453, 460, 496, 501 |
| **SoFunctionCouponServices.java** | å„ªæƒ åˆ¸è™•ç† | 785-877, 1647-1657, 655-663, 805, 827-830 |
| **OrderDetlVO.java** | å•†å“VOå®šç¾© | 93-96, 115-118, 72-74 |

---

## ç¸½çµ

SOMç³»çµ±çš„ä¿ƒéŠ·/æŠ˜æ‰£ç–ŠåŠ è¦å‰‡è¨­è¨ˆ**åš´è¬¹ä¸”æœ‰å±¤æ¬¡**ï¼Œä½¿ç”¨ä¸‰å±¤é˜²è­·æ©Ÿåˆ¶ç¢ºä¿ä¸é‡è¤‡æŠ˜æ‰£ï¼š

### ä¸»è¦ç™¼ç¾

1. **Eventä¿ƒéŠ·äº’æ–¥æ€§**: åŒä¸€å•†å“åªèƒ½å¥—ç”¨ä¸€å€‹Eventï¼ˆè³‡æ–™çµæ§‹+é‚è¼¯é›™é‡é™åˆ¶ï¼‰
2. **åš´æ ¼åŸ·è¡Œé †åº**: Type 2 â†’ Event â†’ Type 0/1 â†’ Type CT â†’ å„ªæƒ åˆ¸
3. **å‹•æ…‹é‡æ–°åˆ†é¡**: æ¯æ¬¡æŠ˜æ‰£å¾Œé‡æ–°åŸ·è¡ŒAssortSkuï¼Œè‡ªå‹•æ’é™¤è®Šåƒ¹å•†å“
4. **ä¸‰å±¤é˜²è­·æ©Ÿåˆ¶**:
   - ç¬¬1å±¤ï¼šè¨­å®šè®Šåƒ¹æ——æ¨™
   - ç¬¬2å±¤ï¼šAssortSkuå‹•æ…‹éæ¿¾
   - ç¬¬3å±¤ï¼šæŠ˜æ‰£å‰å†æª¢æŸ¥
5. **æ¢ä»¶æ€§è¦å‰‡**: å„ªæƒ åˆ¸è¦–excludeCardè¨­å®šæ±ºå®šæ˜¯å¦èˆ‡Eventç–ŠåŠ 
6. **ç‰¹æ®Šäº’æ–¥**: ç´…åˆ©ç©é»èˆ‡Eventäº’æ–¥ï¼Œä½†å¯èˆ‡æœƒå“¡æŠ˜æ‰£/å„ªæƒ åˆ¸ç–ŠåŠ 

### å»ºè­°å¾ŒçºŒå·¥ä½œ

1. **è£œå……æ–‡æª”**:
   - stampFlagè¨­å®šæµç¨‹
   - Type 2èˆ‡Eventçš„å¯¦éš›é—œä¿‚

2. **é©—è­‰æ©Ÿåˆ¶**:
   - è¨‚å–®ç·¨è¼¯æ™‚çš„æ——æ¨™é‡ç½®æ©Ÿåˆ¶
   - å»ºç«‹7å€‹æ¸¬è©¦å ´æ™¯çš„è‡ªå‹•åŒ–æ¸¬è©¦

3. **ä»£ç¢¼æ”¹é€²**:
   - ä¿®æ­£evnetTypeæ‹¼å¯«éŒ¯èª¤ï¼ˆåœ¨é‡å¯«æ™‚ï¼‰
   - æ–°å¢è®Šåƒ¹æ——æ¨™é‡ç½®çš„å–®å…ƒæ¸¬è©¦

---

**æ–‡æª”çµæŸ**
