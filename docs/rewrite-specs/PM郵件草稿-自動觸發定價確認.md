# 郵件草稿：產品經理 - 自動觸發定價規則確認

## 郵件元數據

**收件人**：[產品經理姓名] <pm@company.com>
**副本**：[業務經理]、[技術主管]
**主旨**：需要確認：Rewrite-Spec v1.2 的自動觸發定價規則
**優先級**：高
**附件**：
- WORKTYPE-PRICE-APPORTIONMENT-TRACE.md
- SPECIAL-MEMBER-DISCOUNT-TRACE.md
- TYPE2-COST-MARKUP-DISCOUNT-TRACE.md

---

## 郵件內容

您好 [PM 姓名]，

希望您一切安好。

作為我們**業務邏輯覆蓋率改進計畫**（第1階段）的一部分，我們已完成三個關鍵定價領域的程式碼追蹤。在此分析過程中，我們識別出數個**自動觸發定價規則**，需要產品經理確認以納入 Rewrite-Spec v1.2。

### 背景

我們正在將測試覆蓋率從 **87% 提升至 95%+**，方法是透過系統化程式碼追蹤記錄缺失的業務規則。第1階段第1週已完成，產出三份完整的追蹤文件（附件）。

### 需要確認

以下是程式碼中發現的 **10 條自動觸發定價規則**，需要您的確認。請審查並確認每條規則：
- ✅ **正確** - 應按現狀記錄在 Rewrite-Spec 中
- ⚠️ **需要澄清** - 需要額外的業務背景
- ❌ **不正確** - 在重寫中應該變更

---

## 第一部分：會員折扣自動觸發規則

### 規則 1：會員折扣類型優先順序

**當前行為**（程式碼中發現）：
```
執行順序：
1. Type 0（折扣）- 首先應用
2. Type 1（降毛利）- 其次應用
3. Type 2（成本加成）- 第三應用
4. Type CT（特殊會員折扣）- 僅在 Type 0/1/2 全部返回空時應用
```

**程式碼位置**：`BzSoServices.java:4459-4466`

**問題**：此優先順序是否有產品需求文件記錄？
- Type CT 是否為「回退」機制？
- 是否應該是「最佳折扣獲勝」而非「首次匹配獲勝」？

**您的確認**：
- [ ] ✅ 正確 - 優先順序按設計
- [ ] ⚠️ 需要澄清：[您的註解]
- [ ] ❌ 不正確 - 應該是：[您的建議]

---

### 規則 2：會員折扣間的互斥

**當前行為**：
如果訂單中**任何項目**匹配 Type 0/1/2 折扣，**所有項目**跳過 Type CT（特殊折扣）。

**範例**：
- 訂單有 10 個項目
- 項目 1 匹配 Type 0 折扣配置
- 項目 2-10 不匹配 Type 0/1/2
- **結果**：項目 2-10 不獲得折扣（整個訂單跳過 Type CT）

**程式碼位置**：`BzSoServices.java:4464-4466`

**問題**：「全有或全無」行為是否為有意的？
- 替代方案：逐項回退（項目 1 使用 Type 0，項目 2-10 使用 Type CT）

**您的確認**：
- [ ] ✅ 正確 - 全有或全無是有意的
- [ ] ⚠️ 需要澄清：[您的註解]
- [ ] ❌ 不正確 - 應允許逐項回退

---

### 規則 3：Type 1/2 折扣的類別排除

**當前行為**：
SUB_DEPT_ID **025** 和 **026** 自動從 Type 1（降毛利）和 Type 2（成本加成）折扣中**排除**。

**程式碼位置**：`SoFunctionMemberDisServices.java:533-539`

**問題**：
1. 類別 025 和 026 是什麼？（例如：運輸、特殊服務）
2. 為何從 Type 1/2 排除但允許 Type 0？
3. 是否應排除其他類別？
4. 此規則是否有產品需求文件記錄？

**您的確認**：
- [ ] ✅ 正確 - 類別 025/026 應排除
  - 業務原因：[請說明]
- [ ] ⚠️ 需要澄清：[您的註解]
- [ ] ❌ 不正確 - 不應排除 / 不同類別

---

### 規則 4：兩階段會員折扣匹配

**當前行為**：
會員折扣匹配使用兩階段演算法：
1. **階段 1**：TBL_CDISC 中的精確 SKU 匹配（SKU_NO = 實際 SKU）
2. **階段 2**：類別萬用字元匹配（SKU_NO = '000000000' + CLASS/SUB_DEPT/SUB_CLASS）

**程式碼位置**：`SoFunctionMemberDisServices.java:293-360`

**問題**：萬用字元 SKU '000000000' 是否為標準慣例？
- 是否應記錄為配置標準？
- 是否有其他使用中的萬用字元模式？

**您的確認**：
- [ ] ✅ 正確 - '000000000' 是標準萬用字元
- [ ] ⚠️ 需要澄清：[您的註解]
- [ ] ❌ 不正確 - 不同萬用字元模式：[您的建議]

---

## 第二部分：工種價格分攤規則

### 規則 5：免費安裝自動覆蓋

**當前行為**：
當 `actualInstallAmt = 0`（免費安裝）時，**所有安裝 SKU 的分攤成本自動設為 0**，無論計算的分攤如何。

**程式碼位置**：`BzSoServices.java:4619-4628`

**業務邏輯**：
- 安裝費 = 計算的 500 TWD
- 促銷使安裝免費（actualInstallAmt = 0）
- **結果**：所有安裝 SKU 的 preApportion = 0

**問題**：免費安裝是否仍應分攤成本用於毛利追蹤？
- 當前：免費安裝 → 零分攤（無成本追蹤）
- 替代方案：即使最終價格為零，仍分攤計算的成本（用於分析）

**您的確認**：
- [ ] ✅ 正確 - 免費安裝應將所有分攤歸零
- [ ] ⚠️ 需要澄清：[您的註解]
- [ ] ❌ 不正確 - 應分攤用於毛利追蹤

---

### 規則 6：最後項目吸收餘額

**當前行為**：
按比例分攤工種價格時，**四捨五入餘額由訂單中的最後項目吸收**。

**範例**：
- 安裝總額：501 TWD
- 項目 1（50%）：250.5 → 四捨五入為 251
- 項目 2（30%）：150.3 → 四捨五入為 150
- 項目 3（20%）：100.2 → 四捨五入為 100 + 餘額
- **最後項目吸收**：100 + (501 - 251 - 150) = 100 TWD

**程式碼位置**：`BzSoServices.java:4663-4681`

**問題**：最後項目餘額吸收是否可接受？
- 可能造成最後項目 ±5-10 TWD 的差異
- 替代方案：按比例將餘額分配給所有項目

**您的確認**：
- [ ] ✅ 正確 - 最後項目吸收可接受
- [ ] ⚠️ 需要澄清：可接受範圍 = ±[X] TWD
- [ ] ❌ 不正確 - 應按比例分配餘額

---

## 第三部分：Type 2 成本加成規則

### 規則 7：單位成本來源自動載入

**當前行為**：
Type 2（成本加成）折扣在訂單建立時自動從 **TBL_SKU_STORE.AVG_COST** 載入單位成本。

**資料流**：
1. 前端查詢 SKU 資訊 → 後端返回 `avgCost`
2. 前端儲存在 `lstSkuInfo[].unitCost`
3. 後端持久化到 `TBL_ORDER_DETL.UNIT_COST`
4. Type 2 折扣使用儲存的 `unitCost` 進行加成計算

**程式碼位置**：`BzSoServices.java:906-999`、`soSKUSubPage.jsp:626`

**問題**：
1. AVG_COST 是否為正確來源？（vs. 最新採購成本、標準成本）
2. AVG_COST 多久更新一次？（每日、每週、每月）
3. 如果 AVG_COST 為 NULL 或 0 怎麼辦？
4. 過時的成本資料是否應觸發警報？

**您的確認**：
- [ ] ✅ 正確 - AVG_COST 是正確來源
  - 更新頻率：[請指定]
- [ ] ⚠️ 需要澄清：[您的註解]
- [ ] ❌ 不正確 - 應使用：[不同成本來源]

---

### 規則 8：Type 2 稅金四捨五入自動應用

**當前行為**：
Type 2 折扣在加成計算**之後**使用 **ROUND_FLOOR**（無條件捨去）應用營業稅。

**公式**：
```
1. markupPrice = ceil(unitCost × (1 + markupPercent))
2. 如果應稅：finalPrice = floor(markupPrice × 1.05)
3. discountAmt = originalPrice - finalPrice
```

**程式碼位置**：`SoFunctionMemberDisServices.java:488-492`

**變更歷史**：2020-05-07 從 ROUND_HALF_UP 變更為 ROUND_FLOOR

**問題**：Type 2 為何與 Type 0/1（使用 ceil）不同？
- Type 0/1：ceil（無條件進位）
- Type 2：floor（無條件捨去）
- 所有折扣類型是否應使用一致的四捨五入？

**您的確認**：
- [ ] ✅ 正確 - Type 2 應使用 floor（對客戶友善）
  - 業務原因：[請說明]
- [ ] ⚠️ 需要澄清：[您的註解]
- [ ] ❌ 不正確 - 應標準化為：[ceil 或 floor]

---

## 第四部分：價格變更旗標自動設定

### 規則 9：Type 2 價格變更旗標行為

**當前行為**：
Type 2 折扣**直接替換**售價並設定價格變更旗標：
- GoodsType.P → 設定 `posAmtChangePrice = true`
- 安裝 SKU → 設定 `installChangePrice = true`
- 運送 SKU → 設定 `deliveryChangePrice = true`

**影響**：
價格變更旗標一旦設定，項目將被排除在：
- 後續會員折扣嘗試
- 某些促銷
- 價格調整

**程式碼位置**：`SoFunctionMemberDisServices.java:493-507`

**問題**：Type 2 是否應設定價格變更旗標？
- Type 0（折扣）：不設定旗標（應用折扣金額）
- Type 1（降毛利）：設定旗標（變更價格）
- Type 2（成本加成）：設定旗標（變更價格）
- 與 Type 1 一致？

**您的確認**：
- [ ] ✅ 正確 - Type 2 應設定價格變更旗標
- [ ] ⚠️ 需要澄清：[您的註解]
- [ ] ❌ 不正確 - 應表現得像 Type 0（僅折扣）

---

### 規則 10：Type 2 免稅總額排除

**當前行為**：
Type 2 折扣從會員折扣免稅總額計算中**自動排除**。

**程式碼位置**：`SoFunctionMemberDisServices.java:602-610`
```java
for (MemberDiscVO sku : memberDiscSkus) {
    if(MEMBER_DISCOUNT_TYPE_2.equals(sku.getDiscType())) {
        continue;  // 跳過 Type 2
    }
    // 僅為 Type 0 計算免稅總額
}
```

**問題**：Type 2 為何從免稅計算中排除？
- 假設：Type 2 變更價格，而非折扣（已調整稅金）
- Type 0/1：折扣金額需要單獨的稅金計算

**您的確認**：
- [ ] ✅ 正確 - Type 2 應排除（價格變更，非折扣）
  - 業務原因：[請說明]
- [ ] ⚠️ 需要澄清：[您的註解]
- [ ] ❌ 不正確 - 應包含在免稅計算中

---

## 第五部分：需要 PM 輸入的關鍵問題

### 🚨 關鍵：Type 2 負折扣

**發現的問題**：
Type 2 折扣可能導致**價格上漲**（負折扣），當加成超過原價時。

**範例**：
- 單位成本：90 TWD
- 加成：30%
- 計算價格：ceil(90 × 1.3) × 1.05 = 122 TWD
- 原始 POS 價格：100 TWD
- **折扣金額：-22 TWD**（會員多付錢！）

**當前程式碼**：無驗證 - 允許負折扣

**業務影響**：
- 客戶滿意度風險
- 潛在法律問題（虛假廣告）
- 品牌聲譽損害

**問題**：我們是否應防止負折扣？
- **方案 A**：如果 newPrice > originalPrice 則跳過折扣（推薦）
- **方案 B**：限制在原價（會員支付原價，無折扣）
- **方案 C**：允許負折扣（當前行為）

**您的輸入**：
- [ ] 方案 A：防止負折扣
- [ ] 方案 B：限制在原價
- [ ] 方案 C：允許負折扣（需要業務理由）
- [ ] 其他：[您的建議]

**緊急性**：這需要在定稿 Rewrite-Spec v1.2 之前**立即決定**。

---

## 回覆格式

請在 [日期 - 建議 5 個工作日] 之前使用此格式回覆您的確認：

```
規則 1：✅ 正確
規則 2：⚠️ 需要澄清 - 應允許逐項回退以獲得更好的客戶體驗
規則 3：✅ 正確 - 類別 025（快遞）和 026（特殊運輸）為標準化費用
規則 4：✅ 正確
規則 5：⚠️ 需要澄清 - 讓我們討論毛利追蹤需求
規則 6：✅ 正確 - 可接受範圍 ±10 TWD
規則 7：✅ 正確 - AVG_COST 每晚透過批次作業更新
規則 8：✅ 正確 - Floor 四捨五入是 2020 年稽核的財務要求
規則 9：✅ 正確
規則 10：✅ 正確 - Type 2 排除因為價格已預先調整稅金

關鍵問題：方案 A - 防止負折扣
```

## 下一步

收到您的確認後：

1. **第2週行動**：
   - 用已確認規則更新 Rewrite-Spec v1.2
   - 安排業務經理會議審查決策
   - 根據已確認行為建立測試場景

2. **第3週行動**：
   - Rewrite-Spec v1.2 審查和核准
   - 開始第2階段：促銷邏輯追蹤

## 有問題嗎？

如果您有任何問題或需要額外背景，請隨時與我聯繫。我可以安排電話討論任何這些項目的細節。

三份附加的追蹤文件提供了完整的實作細節、程式碼參考和測試場景供您審查。

感謝您的時間和輸入！

此致
[您的姓名]
[您的職稱]
[聯絡資訊]

---

## 附件摘要

1. **WORKTYPE-PRICE-APPORTIONMENT-TRACE.md**（892行）
   - 涵蓋規則 5-6
   - 完整工種分攤邏輯追蹤
   - 包含 4 個測試場景

2. **SPECIAL-MEMBER-DISCOUNT-TRACE.md**（1,096行）
   - 涵蓋規則 1-4
   - 特殊會員折扣回退機制
   - 包含 5 個測試場景

3. **TYPE2-COST-MARKUP-DISCOUNT-TRACE.md**（1,596行）
   - 涵蓋規則 3、7-10 和關鍵問題
   - Type 2 成本加成完整分析
   - 包含 5 個測試場景 + 負折扣範例

**總計**：3,584 行完整文件

---

## 郵件元數據（用於追蹤）

**發送日期**：[待發送]
**回覆到期**：[發送後 5 個工作日]
**後續追蹤**：[3 天後無回覆則追蹤]
**相關工單**：[連結到 Jira/追蹤系統]
**階段**：第1階段第2週 - 業務確認
**目標**：用已確認的自動觸發定價規則完成 Rewrite-Spec v1.2

---

**郵件草稿結束**
