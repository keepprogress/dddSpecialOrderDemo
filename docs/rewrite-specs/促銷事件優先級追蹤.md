# ä¿ƒéŠ·äº‹ä»¶å„ªå…ˆç´šé‚è¼¯ - å®Œæ•´ä»£ç¢¼è¿½è¹¤

## æ–‡æª”å…ƒæ•¸æ“š

**å‰µå»ºæ—¥æœŸ**: 2025-10-27
**éšæ®µ**: Phase 2 Week 3 - ä¿ƒéŠ·é‚è¼¯åˆ†æ
**ç¯„åœ**: Event A-H ä¿ƒéŠ·åˆ†é…ã€å„ªå…ˆç´šè§£æã€åŸ·è¡Œé †åº
**ä»£ç¢¼ä½ç½®**: so-bzservices, so-batchjob, so-webapp
**ç‹€æ…‹**: âœ… å·²å®Œæˆ - å¾…æ¥­å‹™å¯©æŸ¥

---

## åŸ·è¡Œæ‘˜è¦

### é—œéµç™¼ç¾

**ğŸ”´ é‡å¤§ç™¼ç¾**: SOMç³»çµ±**ä¸è² è²¬è§£æ±º**Event A-Hä¿ƒéŠ·ä¹‹é–“çš„å„ªå…ˆç´šè¡çªã€‚è¡çªè§£æç™¼ç”Ÿåœ¨**ä¸Šæ¸¸OMS (è¨‚å–®ç®¡ç†ç³»çµ±)**,ç”±OMSæ±ºå®šæ¯å€‹é–€å¸‚çš„æ¯å€‹SKUåˆ†é…å“ªä¸€å€‹ä¿ƒéŠ·ã€‚

### ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OMSç³»çµ± (å¤–éƒ¨)                                                   â”‚
â”‚ - ç®¡ç†ä¿ƒéŠ·ç›®éŒ„                                                    â”‚
â”‚ - æ ¹æ“šè‡ªèº«è¦å‰‡å°‡MP_EVENTåˆ†é…çµ¦SKU                                  â”‚
â”‚ - å„²å­˜åœ¨ bs_sku_store@oms.MP_EVENT                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ æ¯æ—¥æ‰¹æ¬¡ (ä¸Šåˆ9:00å¾Œ)
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SOMè³‡æ–™åº«                                                        â”‚
â”‚ TBL_SKU_STORE.PROM_EVENT_NO â† bs_sku_store@oms.MP_EVENT        â”‚
â”‚ (æ¯å€‹é–€å¸‚çš„æ¯å€‹SKUåªèƒ½æœ‰ä¸€å€‹äº‹ä»¶ç·¨è™Ÿ)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ ä½¿ç”¨è€…é¸æ“‡SKU
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ (JSP)                                                       â”‚
â”‚ lstSkuInfo[].eventNosp = promEventNo                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â”‚ ä½¿ç”¨è€…é»æ“Šã€Œè¨ˆç®—ã€
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®šåƒ¹å¼•æ“                                                         â”‚
â”‚ - æ ¹æ“šEVENT_TYPEè·¯ç”±åˆ°äº‹ä»¶è¨ˆç®—å™¨A-H                               â”‚
â”‚ - ä½¿ç”¨äº‹ä»¶ç‰¹å®šè¦å‰‡è¨ˆç®—æŠ˜æ‰£                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é€™æ„å‘³è‘—ä»€éº¼

1. **SOMç„¡å„ªå…ˆç´šè¦å‰‡**: æ¯å€‹SKUåŒæ™‚åªèƒ½æœ‰ä¸€å€‹`PROM_EVENT_NO`
2. **OMSåšæ±ºå®š**: ç•¶å¤šå€‹ä¿ƒéŠ·å¯èƒ½é©ç”¨æ™‚,OMSé¸æ“‡ä½¿ç”¨å“ªä¸€å€‹
3. **SOMåŸ·è¡Œ**: SOMåªæ˜¯è¨ˆç®—è¢«åˆ†é…ä¿ƒéŠ·çš„æŠ˜æ‰£
4. **Aâ†’Hé †åº**: è™•ç†é †åº(ä¸æ˜¯å„ªå…ˆç´šé †åº),è¦‹`SoComputeFunctionMain.init()`

---

## äº‹ä»¶é¡å‹å®šç¾©

### Event A: å°èŠ±åƒ¹

**æ¥­å‹™é‚è¼¯**: ä»¥ç‰¹æ®Šå°èŠ±/å°ç« ä¿ƒéŠ·åƒ¹æ ¼éŠ·å”®å•†å“

**æª”æ¡ˆ**: `SoComputeFunctionMain.java:37, 64`
```java
SoEventA soEventA; // å°èŠ±åƒ¹
soEventA = new SoEventA(bzSoServices, zeroTax);
```

**å¯¦ä½œæª”**: `SoEventA.java`
**ç‰¹å¾µ**:
- éœ€è¦å°èŠ±æ——æ¨™é©—è­‰
- ç‰¹æ®ŠéŒ¯èª¤è¨Šæ¯é€é`stampErrorMsg`
- ç¬¬ä¸€å€‹è¢«åˆå§‹åŒ–çš„äº‹ä»¶(ä½†éæœ€é«˜å„ªå…ˆç´š)

---

### Event B: ç™¼ç¥¨é‡‘é¡æ»¿é¡åŠ åƒ¹è³¼

**æ¥­å‹™é‚è¼¯**: ç•¶ç™¼ç¥¨ç¸½é¡é”åˆ°é–€æª»æ™‚,å¯ä»¥ç‰¹åƒ¹è³¼è²·åŠ è³¼å•†å“

**æª”æ¡ˆ**: `SoComputeFunctionMain.java:38, 65, 88-96`
```java
SoEventB soEventB; // ç™¼ç¥¨é‡‘é¡æ»¿é¡åŠ åƒ¹è³¼

if (soEventItemsB.size() != 0) {
    long total = 0; // å•†å“ç¸½é‡‘é¡
    int posAmt = 0; // posåƒ¹
    int qty = 0; // æ•¸é‡
    for (OrderDetlVO orderDetlVO : items) {
        posAmt = Integer.parseInt(orderDetlVO.getPosAmt());
        qty = Integer.parseInt(orderDetlVO.getQuantity());
        total += posAmt * qty;
    }
    soEventB.init(soEventItemsB, total, lstOrderEventMsgVO);
}
```

**å¯¦ä½œæª”**: `SoEventB.java`
**ç‰¹å¾µ**:
- éœ€è¦è¨ˆç®—ç™¼ç¥¨ç¸½é‡‘é¡
- åŸºæ–¼é–€æª»å•Ÿå‹•
- å”¯ä¸€æ¥æ”¶`total`åƒæ•¸çš„äº‹ä»¶

---

### Event C: å•†å“æ»¿(é‡‘é¡/æ•¸é‡)ä»¥ä¸Š,å…¨é¢å„ªæƒ 

**æ¥­å‹™é‚è¼¯**: ç•¶ç¸½é‡‘é¡æˆ–æ•¸é‡é”åˆ°é–€æª»æ™‚,æ‰€æœ‰å•†å“ç²å¾—æŠ˜æ‰£

**æª”æ¡ˆ**: `SoComputeFunctionMain.java:39, 66`
```java
SoEventC soEventC; // å•†å“æ»¿(é‡‘é¡/æ•¸é‡)ä»¥ä¸Š,å…¨é¢å„ªæƒ 
```

**å¯¦ä½œæª”**: `SoEventC.java`
**ç‰¹å¾µ**:
- å¯ä½¿ç”¨é‡‘é¡æˆ–æ•¸é‡é–€æª»
- å°ä¿ƒéŠ·ä¸­æ‰€æœ‰å•†å“å¥—ç”¨æŠ˜æ‰£
- ç´¯ç©è¨ˆç®—

---

### Event D: å•†å“æ¯è²·Må€‹,äº«å…¶ä¸­Nå€‹å„ªæƒ 

**æ¥­å‹™é‚è¼¯**: è³¼è²·Må€‹æ•¸é‡,å…¶ä¸­Nå€‹å•†å“äº«æŠ˜æ‰£(ä¾‹å¦‚:è²·3é€1æŠ˜æ‰£)

**æª”æ¡ˆ**: `SoComputeFunctionMain.java:40, 67`
```java
SoEventD soEventD; // å•†å“æ¯è²·Må€‹,äº«å…¶ä¸­Nå€‹å„ªæƒ 
```

**å¯¦ä½œæª”**: `SoEventD.java`
**ç‰¹å¾µ**:
- M/Næ¯”ä¾‹è¨ˆç®—
- å¯é‡è¤‡ä¿ƒéŠ·(Mçš„å€æ•¸)
- é¸æ“‡æ€§æŠ˜æ‰£å¥—ç”¨

---

### Event E: è²·æ¢ä»¶å•†å“Aç¾¤çµ„(æ•¸é‡/é‡‘é¡)å¯äº«Bå•†å“ç¾¤çµ„å„ªæƒ 

**æ¥­å‹™é‚è¼¯**: è³¼è²·æ¢ä»¶ç¾¤çµ„Aä»¥è§£é–çå‹µç¾¤çµ„Bçš„æŠ˜æ‰£

**æª”æ¡ˆ**: `SoComputeFunctionMain.java:41, 68`
```java
SoEventE soEventE; // è²·æ¢ä»¶å•†å“Aç¾¤çµ„(æ•¸é‡/é‡‘é¡)å¯äº«Bå•†å“ç¾¤çµ„å„ªæƒ 
```

**å¯¦ä½œæª”**: `SoEventE.java`
**ç‰¹å¾µ**:
- é›™ç¾¤çµ„çµæ§‹(æ¢ä»¶+çå‹µ)
- è·¨å•†å“ä¿ƒéŠ·
- ç¾¤çµ„Açš„é–€æª»é©—è­‰

---

### Event F: åˆè³¼åƒ¹

**æ¥­å‹™é‚è¼¯**: ä¸€èµ·è³¼è²·å¤šå€‹ç‰¹å®šå•†å“ä»¥ç²å¾—ç‰¹æ®Šçµ„åˆåƒ¹

**æª”æ¡ˆ**: `SoComputeFunctionMain.java:42, 69`
```java
SoEventF soEventF; // åˆè³¼åƒ¹
```

**å¯¦ä½œæª”**: `SoEventF.java`
**ç‰¹å¾µ**:
- éœ€è¦çµ„åˆä¸­çš„æ‰€æœ‰å•†å“
- å›ºå®šçµ„åˆ
- å…¨æœ‰æˆ–å…¨ç„¡å•Ÿå‹•

---

### Event G: å…±ç”¨å•†å“åˆè³¼åƒ¹

**æ¥­å‹™é‚è¼¯**: å…·æœ‰è·¨å¤šå€‹çµ„åˆé¸é …å…±äº«å•†å“çš„çµ„åˆåƒ¹

**æª”æ¡ˆ**: `SoComputeFunctionMain.java:43, 70`
```java
SoEventG soEventG; // å…±ç”¨å•†å“åˆè³¼åƒ¹
```

**å¯¦ä½œæª”**: `SoEventG.java`
**ç‰¹å¾µ**:
- å…·æœ‰å…±äº«çµ„ä»¶çš„è¤‡é›œçµ„åˆ
- å•†å“å¯åƒèˆ‡å¤šå€‹çµ„åˆè¨ˆç®—
- ç‰¹æ®Šå…±äº«å•†å“è™•ç†

**æ¸¬è©¦è¦†è“‹**: `SoEventG_IntegrationTest.java`, `SoEventG_UnitTest.java`

---

### Event H: å–®å“æ‹†åƒ¹åˆè³¼åƒ¹

**æ¥­å‹™é‚è¼¯**: å–®ä¸€SKUåœ¨çµ„åˆä¸­è³¼è²·æ™‚ç²å¾—æ‹†åˆ†å®šåƒ¹

**æª”æ¡ˆ**: `SoComputeFunctionMain.java:44, 71`
```java
SoEventH soEventH; // å–®å“æ‹†åƒ¹åˆè³¼åƒ¹
```

**å¯¦ä½œæª”**: `SoEventH.java`
**ç‰¹å¾µ**:
- å–®ä¸€SKUå…§çš„åƒ¹æ ¼åˆ†é…
- ä»¥åƒ¹æ ¼æ‹†åˆ†åƒèˆ‡çµ„åˆ
- è¤‡é›œæŠ˜æ‰£åˆ†é…

---

## è³‡æ–™æµåˆ†æ

### éšæ®µ1: ä¿ƒéŠ·è³‡æ–™åŒæ­¥ (OMS â†’ SOM)

#### 1.1 OMSè³‡æ–™ä¾†æº

**å¤–éƒ¨è³‡æ–™åº«é€£çµ**: `bs_sku_store@oms`

**é—œéµæ¬„ä½**:
- `MP_EVENT`: å¤šé‡ä¿ƒéŠ·äº‹ä»¶ç·¨è™Ÿ(åœ¨SOMä¸­æˆç‚º`EVENT_NOSP`)
- `EVENT_NO`: å–®å“ä¿ƒéŠ·ç·¨è™Ÿ
- `MODIFY_TIME`: æœ€å¾Œä¿®æ”¹æ™‚é–“æˆ³è¨˜
- `MW_TIME`: ä¸­é–“ä»¶åŒæ­¥æ™‚é–“æˆ³è¨˜

#### 1.2 æ‰¹æ¬¡ä½œæ¥­: StoreSkuPriceReceiver

**æª”æ¡ˆ**: `C:\Projects\som\so-batchjob\src\main\java\com\trihome\som\so\dataexchange\service\StoreSkuPriceReceiver.java`

**åŸ·è¡Œæ’ç¨‹**: æ¯æ—¥ä¸Šåˆ9:00å¾Œ,ç­‰å¾…OMSåƒ¹æ ¼æ›´æ–°å®Œæˆ

**ä»£ç¢¼ä½ç½®**: Lines 93-115
```java
@Scheduled(cron = "0 */10 9-23 * * ?")  // 9:00åˆ°23:59æ¯10åˆ†é˜ä¸€æ¬¡
@Async
public void start() {
    // æª¢æŸ¥OMSåƒ¹æ ¼æ›´æ–°æ˜¯å¦å®Œæˆ
    int checkSkuStoreCount = customOmsBsSkuStoreMapper.checkOmsStorePrice();
    int checkAvgCostCount = customOmsBsSkuStoreMapper.checkOmsAvgCost();

    if (checkSkuStoreCount == 0 && checkAvgCostCount >= 1) {
        // OMSæ›´æ–°å®Œæˆ,ç¹¼çºŒåŒæ­¥
        String storeId = getStoreId(i);
        storeRecord = customOmsBsSkuStoreMapper.updateBsSkuStore(storeId);

        logger.info("é–€å¸‚ " + storeId + " åŒæ­¥: " + storeRecord + " ç­†è¨˜éŒ„");
    }
}
```

**ç­‰å¾…æ©Ÿåˆ¶**:
- æ¯10åˆ†é˜æª¢æŸ¥ä¸€æ¬¡OMSç‹€æ…‹
- åªæœ‰ç•¶OMSç¢ºèªåƒ¹æ ¼æ›´æ–°å®Œæˆæ™‚æ‰åŒæ­¥
- é˜²æ­¢åŒæ­¥éæ™‚æˆ–ä¸å®Œæ•´çš„è³‡æ–™

#### 1.3 MERGE SQLèªå¥

**æª”æ¡ˆ**: `C:\Projects\som\so-batchjob\src\main\resources\sqlMap\CustomOmsBsSkuStoreMapper.xml`

**ä»£ç¢¼ä½ç½®**: Lines 4-93
```xml
<update id="updateBsSkuStore" parameterType="String">
    MERGE INTO TBL_SKU_STORE tss
    USING (
        SELECT
            STORE_ID AS storeId,
            SKU AS sku,
            EVENT_NO AS eventNo,
            MP_EVENT AS mpEvent,              -- â˜… é€™æœƒæˆç‚ºPROM_EVENT_NO
            POS_AMT AS posAmt,
            AVG_COST AS avgCost,
            ...
        FROM bs_sku_store@oms
        WHERE (MODIFY_TIME >= TRUNC(SYSDATE-2)
               OR MW_TIME >= TRUNC(SYSDATE-2))
          AND STORE_ID = #{storeId}
    ) bssku
    ON (tss.STORE_ID = bssku.storeId AND tss.SKU_NO = bssku.sku)
    WHEN MATCHED THEN UPDATE SET
        tss.EVENT_NO = bssku.eventNo,
        tss.PROM_EVENT_NO = bssku.mpEvent,    -- â˜… æ¯å€‹SKUä¸€å€‹äº‹ä»¶
        tss.POS_AMT = bssku.posAmt,
        tss.AVG_COST = bssku.avgCost,
        ...
    WHEN NOT MATCHED THEN INSERT (
        STORE_ID, SKU_NO, EVENT_NO, PROM_EVENT_NO, ...
    ) VALUES (
        bssku.storeId, bssku.sku, bssku.eventNo, bssku.mpEvent, ...
    )
</update>
```

**é—œéµæ´å¯Ÿ**: `PROM_EVENT_NO`æ¬„ä½æ¯å€‹SKUåªèƒ½å„²å­˜**ä¸€å€‹**å€¼ã€‚å¦‚æœOMSæ›´æ”¹ä¿ƒéŠ·,èˆŠå€¼å°‡è¢«è¦†è“‹ã€‚

---

### éšæ®µ2: å‰ç«¯SKUæª¢ç´¢

#### 2.1 SKUæŸ¥è©¢èˆ‡ä¿ƒéŠ·è³‡è¨Š

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\service\BzSkuInfoServices.java`

**ä»£ç¢¼ä½ç½®**: Lines 138-144
```java
public SkuInfoVO qerySkuInfo(String skuNo, String storeId, ...) {
    SkuInfoVO skuInfoVO = customSkuInfoOpenCloseMapper.selectSkuInfo(
        skuNo, storeId
    );

    // è¿”å›å¸¶æœ‰ä¿ƒéŠ·è³‡è¨Šçš„SKU
    // skuInfoVO.promEventNo = TBL_SKU_STORE.PROM_EVENT_NO
    // skuInfoVO.promEventType = TBL_PROM_EVENT.EVENT_TYPE

    return skuInfoVO;
}
```

#### 2.2 SQLèˆ‡ä¿ƒéŠ·è¡¨JOIN

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\resources\sqlMap\CustomSkuInfoOpenCloseMapper.xml`

**ä»£ç¢¼ä½ç½®**: Lines 163-246
```xml
<select id="selectSkuInfo" resultType="SkuInfoVO">
    SELECT
        tss.SKU_NO AS skuNo,
        tss.POS_AMT AS posAmt,
        tss.PROM_EVENT_NO AS promEventNo,      -- â˜… ä¾†è‡ªTBL_SKU_STORE
        tpe.EVENT_TYPE AS promEventType,       -- â˜… JOINè‡ªTBL_PROM_EVENT
        tpe.EVENT_NAME AS promEventName,
        tss.AVG_COST AS avgCost,
        ...
    FROM TBL_SKU_STORE tss
    LEFT JOIN TBL_PROM_EVENT tpe
        ON tss.PROM_EVENT_NO = tpe.EVENT_NO    -- â˜… JOINä»¥å–å¾—äº‹ä»¶é¡å‹
    WHERE tss.SKU_NO = #{skuNo}
      AND tss.STORE_ID = #{storeId}
</select>
```

**çµæœ**: å‰ç«¯æ¥æ”¶åˆ°å¸¶æœ‰å…¶åˆ†é…çš„ä¿ƒéŠ·äº‹ä»¶ç·¨è™Ÿå’Œé¡å‹(A-H)çš„SKU

#### 2.3 å‰ç«¯è³¦å€¼

**æª”æ¡ˆ**: `C:\Projects\som\so-webapp\src\main\webapp\WEB-INF\views\so\commonpage\soSKUSubPage.jsp`

**ä»£ç¢¼ä½ç½®**: Lines 626-735
```javascript
function getSkuInfo(skuNo) {
    $.ajax({
        url: '/so/getSkuInfo',
        data: { skuNo: skuNo, storeId: storeId },
        success: function(jsonData) {
            var selSkuIdx = lstSkuInfo.length;

            // å¾å¾Œç«¯åˆ†é…ä¿ƒéŠ·äº‹ä»¶è³‡è¨Š
            lstSkuInfo[selSkuIdx].eventNosp = jsonData.promEventNo;
            lstSkuInfo[selSkuIdx].promEventNo = jsonData.promEventNo;
            lstSkuInfo[selSkuIdx].promEventType = jsonData.promEventType; // A-H

            // å…¶ä»–SKUå±¬æ€§
            lstSkuInfo[selSkuIdx].skuNo = jsonData.skuNo;
            lstSkuInfo[selSkuIdx].posAmt = jsonData.posAmt;
            lstSkuInfo[selSkuIdx].unitCost = jsonData.avgCost;
            ...
        }
    });
}
```

---

### éšæ®µ3: äº‹ä»¶é¡å‹åˆ†é…å’Œåˆ†é¡

#### 3.1 äº‹ä»¶é¡å‹æŸ¥è©¢

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\service\SoComputeFunctionMainServices.java`

**ä»£ç¢¼ä½ç½®**: Lines 44-66
```java
public SoComputeFunctionMain getSoComputeFunctionMain(
    ArrayList<OrderDetlVO> items, boolean zeroTax
) {
    SoComputeFunctionMain soComputeFunctionMain =
        new SoComputeFunctionMain(bzSoServices, zeroTax);

    // â˜… ç‚ºæ¯å€‹å•†å“è¨­å®šäº‹ä»¶é¡å‹(A-H)
    this.setOrderDtlsEventType(items);

    // åˆå§‹åŒ–äº‹ä»¶è¨ˆç®—å™¨
    soComputeFunctionMain.init(items);

    return soComputeFunctionMain;
}

/**
 * è¨­å®šè¨‚å–®å•†å“æ–¼çµ„åˆä¿ƒéŠ·å…§çš„ä¿ƒéŠ·æ–¹æ¡ˆ
 */
public void setOrderDtlsEventType(ArrayList<OrderDetlVO> items) {
    for (OrderDetlVO orderDetlVO : items) {
        if (StringUtils.isNotBlank(orderDetlVO.getEventNosp())) {
            logger.info("å•†å“:" + orderDetlVO.getSkuNo() +
                       " ,EVENT_NOSP: " + orderDetlVO.getEventNosp());

            // æŸ¥è©¢TBL_PROM_EVENTå–å¾—äº‹ä»¶é¡å‹
            TblPromEvent promEvent = bzSoServices.queryPromEvent(
                orderDetlVO.getEventNosp()
            );

            if (promEvent != null) {
                // è¨­å®šA-Häº‹ä»¶é¡å‹
                orderDetlVO.setEvnetType(promEvent.getEventType());
            }
        }
    }
}
```

---

### éšæ®µ4: äº‹ä»¶åˆ†é¡å’Œåˆå§‹åŒ–

**æª”æ¡ˆ**: `C:\Projects\som\so-bzservices\src\main\java\com\trihome\som\bz\functions\SoComputeFunctionMain.java`

**ä»£ç¢¼ä½ç½®**: Lines 78-116
```java
/**
 * åˆå§‹åŒ–,å°‡æ‰€æœ‰å•†å“ä¾æ“šä¿ƒéŠ·ç¨®é¡åˆ†ç¾¤
 */
public void init(ArrayList<OrderDetlVO> items) {
    // æ­¥é©Ÿ1: ä¾å•†å“é¡å‹åˆ†é›¢(P, I, DDç­‰)
    assortGoodType(items);

    // æ­¥é©Ÿ2: ä¾äº‹ä»¶é¡å‹A-Håˆ†é¡
    assortEventNo(skuItems);           // ç”¢å“å•†å“
    assortEventNo(installSkuItems);    // å®‰è£å•†å“
    assortEventNo(deliverSkuItems);    // é…é€å•†å“

    // æ­¥é©Ÿ3: ä»¥Aâ†’Bâ†’Câ†’Dâ†’Eâ†’Fâ†’Gâ†’Hé †åºåˆå§‹åŒ–äº‹ä»¶
    if (soEventItemsA.size() != 0) {
        stampErrorMsg = soEventA.init(soEventItemsA, lstOrderEventMsgVO);
    }
    if (soEventItemsB.size() != 0) {
        long total = 0; // è¨ˆç®—ç™¼ç¥¨ç¸½é¡çµ¦Event Bä½¿ç”¨
        for (OrderDetlVO orderDetlVO : items) {
            int posAmt = Integer.parseInt(orderDetlVO.getPosAmt());
            int qty = Integer.parseInt(orderDetlVO.getQuantity());
            total += posAmt * qty;
        }
        soEventB.init(soEventItemsB, total, lstOrderEventMsgVO);
    }
    // ... C through H follow
}
```

**åˆ†é¡é‚è¼¯** (Lines 150-179):
```java
private void assortEventNo(ArrayList<OrderDetlVO> items) {
    String eventType = StringUtils.EMPTY;

    for (OrderDetlVO orderDetlVO : items) {
        // åªè™•ç†æœ‰ä¿ƒéŠ·ä¸”ç„¡ç´…åˆ©ç©é»çš„å•†å“
        if (StringUtils.isNotBlank(orderDetlVO.getEventNosp()) &&
            (StringUtils.isBlank(orderDetlVO.getBonusTotal()) ||
             Integer.parseInt(orderDetlVO.getBonusTotal()) == 0)) {

            // åˆå§‹åŒ–æŠ˜æ‰£æ¬„ä½
            orderDetlVO.setDiscountAmt("0");
            orderDetlVO.setDiscountQty("0");

            // å–å¾—äº‹ä»¶é¡å‹A-H
            eventType = orderDetlVO.getEvnetType();

            // è·¯ç”±åˆ°é©ç•¶çš„æ¡¶
            if ("A".equals(eventType) && orderDetlVO.isStampFlag()) {
                soEventItemsA.add(orderDetlVO);
            } else if ("B".equals(eventType)) {
                soEventItemsB.add(orderDetlVO);
            } else if ("C".equals(eventType)) {
                soEventItemsC.add(orderDetlVO);
            }
            // ... D through H
        }
    }
}
```

---

## æ¥­å‹™è¦å‰‡

### PROM-R1: æ¯å€‹SKUå–®ä¸€ä¿ƒéŠ·

**è¦å‰‡**: æ¯å€‹SKUåŒä¸€æ™‚é–“åªèƒ½æœ‰ä¸€å€‹æ´»å‹•çš„å¤šé‡ä¿ƒéŠ·äº‹ä»¶(`PROM_EVENT_NO`)ã€‚

**è³‡æ–™åº«ç´„æŸ**:
- `TBL_SKU_STORE.PROM_EVENT_NO`æ˜¯å–®ä¸€VARCHARæ¬„ä½(ä¸æ˜¯åˆ—è¡¨)
- MERGEèªå¥è¦†è“‹å…ˆå‰çš„å€¼

**ä»£ç¢¼è­‰æ“š**: `CustomOmsBsSkuStoreMapper.xml:43`
```sql
WHEN MATCHED THEN UPDATE SET
    tss.PROM_EVENT_NO = bssku.mpEvent  -- è¦†è“‹å…ˆå‰çš„å€¼
```

---

### PROM-R2: OMSæ¬Šå¨

**è¦å‰‡**: OMSç³»çµ±æ“æœ‰**å”¯ä¸€æ¬Šå¨**å°‡ä¿ƒéŠ·åˆ†é…çµ¦SKUã€‚SOMç„¡æ³•è¦†è“‹æˆ–ä¿®æ”¹ä¿ƒéŠ·åˆ†é…ã€‚

**ä»£ç¢¼è­‰æ“š**:
- **è³‡æ–™ä¾†æº**: `bs_sku_store@oms`(å¤–éƒ¨è³‡æ–™åº«é€£çµ)
- **å”¯è®€**: SOMåªè®€å–`MP_EVENT`,å¾ä¸æ›´æ–°å®ƒ
- **å–®å‘åŒæ­¥**: æ¯æ—¥æ‰¹æ¬¡åŒ¯å…¥OMSæ±ºç­–

**æ¥­å‹™å½±éŸ¿**:
- SOMç„¡æ³•å»ºç«‹è‡¨æ™‚ä¿ƒéŠ·
- ä¿ƒéŠ·è®Šæ›´éœ€è¦OMSé…ç½®
- åŒæ­¥å»¶é²: ä¿ƒéŠ·è®Šæ›´æœ€å¤š24å°æ™‚

---

### PROM-R3: äº‹ä»¶é¡å‹ä¸å¯è®Šæ€§

**è¦å‰‡**: ä¸€æ—¦ä¿ƒéŠ·äº‹ä»¶ç·¨è™Ÿè¢«åˆ†é…çµ¦è¨‚å–®ä¸­çš„å•†å“,å…¶äº‹ä»¶é¡å‹(A-H)åœ¨è¨‚å–®è™•ç†æœŸé–“ç„¡æ³•æ›´æ”¹ã€‚

**ä»£ç¢¼è­‰æ“š**: `SoComputeFunctionMainServices.java:56-66`
```java
public void setOrderDtlsEventType(ArrayList<OrderDetlVO> items) {
    // åœ¨è¨‚å–®è¨ˆç®—æœŸé–“æŸ¥è©¢TBL_PROM_EVENTä¸€æ¬¡
    // äº‹ä»¶é¡å‹è¢«è¨­å®šå¾Œä¸å†é‡æ–°æª¢æŸ¥
    orderDetlVO.setEvnetType(promEvent.getEventType());
}
```

---

### PROM-R4: ç´…åˆ©ç©é»äº’æ–¥

**è¦å‰‡**: æœ‰ç´…åˆ©ç©é»(`bonusTotal > 0`)çš„å•†å“**ç„¡æ³•**åƒèˆ‡å¤šé‡ä¿ƒéŠ·äº‹ä»¶ã€‚

**ä»£ç¢¼è­‰æ“š**: `SoComputeFunctionMain.java:153-156`
```java
if (StringUtils.isNotBlank(orderDetlVO.getEventNosp()) &&
    (StringUtils.isBlank(orderDetlVO.getBonusTotal()) ||
     Integer.parseInt(orderDetlVO.getBonusTotal()) == 0)) {
    // åªæœ‰bonusTotalç‚ºç©ºç™½æˆ–0æ™‚æ‰è™•ç†
}
```

**æ¥­å‹™é‚è¼¯**:
- ç´…åˆ©ç©é»å’Œäº‹ä»¶ä¿ƒéŠ·äº’æ–¥
- å¦‚æœ`bonusTotal > 0`,å•†å“è·³éäº‹ä»¶è™•ç†
- é€™é˜²æ­¢ã€Œé›™é‡å„ªæƒ ã€(ç©é»+ä¿ƒéŠ·)

---

### PROM-R5: Event Aéœ€è¦å°èŠ±æ——æ¨™

**è¦å‰‡**: Event A(å°èŠ±åƒ¹)éœ€è¦å•†å“æœ‰`stampFlag = true`ã€‚

**ä»£ç¢¼è­‰æ“š**: `SoComputeFunctionMain.java:160-161`
```java
if ("A".equals(eventType) && orderDetlVO.isStampFlag()) {
    soEventItemsA.add(orderDetlVO);
}
```

---

### PROM-R6: è™•ç†é †åº â‰  å„ªå…ˆç´šé †åº

**è¦å‰‡**: Aâ†’Bâ†’Câ†’Dâ†’Eâ†’Fâ†’Gâ†’Hè™•ç†é †åº**ä¸æ˜¯**å„ªå…ˆç´šæ’åã€‚å®ƒåªæ˜¯äº‹ä»¶è¨ˆç®—å™¨çš„**åˆå§‹åŒ–é †åº**ã€‚

**ä»£ç¢¼è­‰æ“š**: `SoComputeFunctionMain.java:84-115`
```java
// äº‹ä»¶ä¾åºåˆå§‹åŒ–Aâ†’H
// ä½†æ¯å€‹å•†å“å·²ç¶“è¢«åˆ†é…åˆ°ä¸€å€‹äº‹ä»¶
// æ²’æœ‰ç™¼ç”Ÿç«¶çˆ­æˆ–å„ªå…ˆç´šè§£æ
```

**ç‚ºä»€éº¼é€™å¾ˆé‡è¦**:
- é–‹ç™¼äººå“¡å¯èƒ½å‡è¨­Aæœ‰ã€Œæœ€é«˜å„ªå…ˆç´šã€
- **éŒ¯èª¤**: å•†å“å·²ç”±OMSé å…ˆåˆ†é…åˆ°ä¸€å€‹äº‹ä»¶
- è™•ç†é †åºåªå½±éŸ¿è¨ˆç®—åºåˆ—
- æ²’æœ‰äº‹ä»¶ã€Œç²å‹ã€å¦ä¸€å€‹(ä¸å­˜åœ¨è¡çª)

---

### PROM-R7: å•†å“é¡å‹åˆ†é›¢

**è¦å‰‡**: ä¿ƒéŠ·è¨ˆç®—ä¾å•†å“é¡å‹åˆ†é›¢: ç”¢å“(P)ã€å®‰è£(I/IA/IE/IC/IS)ã€é…é€(DD)ã€‚

**ä»£ç¢¼è­‰æ“š**: `SoComputeFunctionMain.java:78-82`
```java
assortGoodType(items);           // ä¾P, I, DDåˆ†é›¢
assortEventNo(skuItems);         // è™•ç†ç”¢å“å•†å“
assortEventNo(installSkuItems);  // è™•ç†å®‰è£å•†å“
assortEventNo(deliverSkuItems);  // è™•ç†é…é€å•†å“
```

---

### PROM-R8: æ¯æ—¥åŒæ­¥è¦–çª—

**è¦å‰‡**: ä¿ƒéŠ·è³‡æ–™æ¯æ—¥ä¸Šåˆ9:00å¾ŒåŒæ­¥,ç­‰å¾…OMSåƒ¹æ ¼æ›´æ–°å®Œæˆã€‚

**ä»£ç¢¼è­‰æ“š**: `StoreSkuPriceReceiver.java:93-115`
```java
@Scheduled(cron = "0 */10 9-23 * * ?")  // æ¯10åˆ†é˜, 9:00-23:59
public void start() {
    // æª¢æŸ¥OMSæ›´æ–°æ˜¯å¦å®Œæˆ
    int checkSkuStoreCount = customOmsBsSkuStoreMapper.checkOmsStorePrice();

    if (checkSkuStoreCount == 0) {
        // OMSæº–å‚™å¥½,ç¹¼çºŒåŒæ­¥
        updateBsSkuStore(storeId);
    }
}
```

**æ¥­å‹™å½±éŸ¿**:
- OMSçš„ä¿ƒéŠ·è®Šæ›´å¯èƒ½éœ€è¦æœ€å¤š24å°æ™‚æ‰æœƒå‡ºç¾åœ¨SOM
- ä¸æ”¯æ´æ—¥å…§ä¿ƒéŠ·è®Šæ›´
- é–€å¸‚ä¸æ‡‰ä¾è³´å³æ™‚ä¿ƒéŠ·æ›´æ–°

---

## é‡å¤§å•é¡Œå’Œå»ºè­°

### ğŸš¨ é‡å¤§: SOMç«¯ç„¡å„ªå…ˆç´šè§£æ

**å•é¡Œ**: SOMç³»çµ±**å®Œå…¨ç„¡èƒ½åŠ›**è§£æ±ºå¤šå€‹ä¿ƒéŠ·å¯èƒ½é©ç”¨æ–¼åŒä¸€SKUæ™‚çš„è¡çªã€‚

**ç•¶å‰è¡Œç‚º**:
- OMSé€é`MP_EVENT`æ¬„ä½åˆ†é…ä¸€å€‹ä¿ƒéŠ·
- SOMç›²ç›®æ¥å—OMSæ±ºå®š
- ç„¡é©—è­‰æˆ–è¡çªæª¢æ¸¬

**é¢¨éšªå ´æ™¯**:

1. **OMSéŒ¯èª¤**: å¦‚æœOMSåˆ†é…éŒ¯èª¤çš„ä¿ƒéŠ·,SOMç„¡æ³•æª¢æ¸¬æˆ–ç³¾æ­£
2. **æ‰‹å‹•è¦†è“‹**: é–€å¸‚äººå“¡ç„¡æ³•æ‰‹å‹•åˆ‡æ›ä¿ƒéŠ·
3. **é‚Šç·£æ¡ˆä¾‹**: æ™‚é–“æ•æ„Ÿä¿ƒéŠ·(åˆå¤œçµæŸ)å¯èƒ½ä½¿ç”¨éæ™‚è³‡æ–™

**å»ºè­°**:
- **è¨˜éŒ„OMSå„ªå…ˆç´šè¦å‰‡**æ–¼æ¥­å‹™éœ€æ±‚ä¸­
- **æ–°å¢æ—¥èªŒè¨˜éŒ„**è¿½è¹¤å“ªäº›ä¿ƒéŠ·è¢«OMSã€Œæ‹’çµ•ã€
- **å»ºç«‹å„€è¡¨æ¿**é¡¯ç¤ºä¿ƒéŠ·è¡çª(ä¾›æ¥­å‹™åˆ†æ)
- **è€ƒæ…®å¾Œå‚™æ–¹æ¡ˆ**: å¦‚æœOMS `MP_EVENT`ç„¡æ•ˆ/éæœŸ,SOMæ‡‰è­¦å‘Šæˆ–é˜»æ­¢è¨‚å–®?

---

### âš ï¸ é«˜: è™•ç†é †åºæ··æ·†

**å•é¡Œ**: Aâ†’Håˆå§‹åŒ–é †åºå®¹æ˜“èˆ‡å„ªå…ˆç´šé †åºæ··æ·†ã€‚

**ä»£ç¢¼ä½ç½®**: `SoComputeFunctionMain.java:84-115`

**ç•¶å‰å‘½å**:
```java
// é€™çœ‹èµ·ä¾†åƒå„ªå…ˆç´šé †åºä½†ä¸æ˜¯
if (soEventItemsA.size() != 0) {
    soEventA.init(...);  // ã€ŒAå…ˆè™•ç†ã€â‰ ã€ŒAæœ‰å„ªå…ˆç´šã€
}
if (soEventItemsB.size() != 0) {
    soEventB.init(...);
}
```

**é¢¨éšª**:
- æœªä¾†é–‹ç™¼äººå“¡å¯èƒ½å‡è¨­A > B > Cå„ªå…ˆç´š
- æ¥­å‹™å¯èƒ½è¦æ±‚ã€Œå„ªå…ˆEvent Cå‹éEvent Aã€
- ä»£ç¢¼ç¶­è­·æ··æ·†

**å»ºè­°**:
- **æ–°å¢è¨»è§£**èªªæ˜é€™ä¸æ˜¯å„ªå…ˆç´šé †åº
- **é‡æ–°å‘½åæ–¹æ³•**: `init()` â†’ `calculateDiscounts()`
- **è¨˜éŒ„æ–¼è¦æ ¼**: ã€Œä¿ƒéŠ·å„ªå…ˆç´šç”±OMSæ±ºå®š,éSOMè™•ç†é †åºã€

**å»ºè­°ä»£ç¢¼è¨»è§£**:
```java
// ============================================
// é‡è¦: è™•ç†é †åºAâ†’Hä¸æ˜¯å„ªå…ˆç´šé †åº!
// æ¯å€‹å•†å“å·²ç¶“ç”±OMSåˆ†é…åˆ°ä¸€å€‹äº‹ä»¶ã€‚
// é€™å€‹å¾ªç’°åªæ˜¯ç‚ºå·²åˆ†é…çš„äº‹ä»¶åˆå§‹åŒ–è¨ˆç®—å™¨ã€‚
// å„ªå…ˆç´š/è¡çªè§£æç™¼ç”Ÿåœ¨OMS,è€Œéæ­¤è™•ã€‚
// ============================================
if (soEventItemsA.size() != 0) {
    soEventA.init(soEventItemsA, lstOrderEventMsgVO);
}
```

---

### âš ï¸ ä¸­: éæ™‚ä¿ƒéŠ·è³‡æ–™è¦–çª—

**å•é¡Œ**: OMSä¿ƒéŠ·è®Šæ›´å’ŒSOMå¯è¦‹æ€§ä¹‹é–“æœ€å¤š24å°æ™‚å»¶é²ã€‚

**å ´æ™¯**:
1. è¡ŒéŠ·æ–¼ä¸Šåˆ10:00åœ¨OMSå»ºç«‹æ–°ä¿ƒéŠ·
2. SOMä¸Šæ¬¡æ–¼ä¸Šåˆ9:30åŒæ­¥(ä¿ƒéŠ·å°šä¸å­˜åœ¨)
3. ä¸‹æ¬¡åŒæ­¥æ–¼éš”å¤©ä¸Šåˆ9:30
4. **å»¶é²**: 23.5å°æ™‚

**æ¥­å‹™å½±éŸ¿**:
- å¿«é–ƒä¿ƒéŠ·ç„¡æ³•ç«‹å³é–‹å§‹
- ä¿ƒéŠ·çµæŸæ™‚é–“æœ‰æœ€å¤š24å°æ™‚æ¼‚ç§»
- å®¢æˆ¶æŠ±æ€¨ã€Œä¿ƒéŠ·ç„¡æ³•ä½¿ç”¨ã€

**å»ºè­°**:
- **æ–°å¢æ‰‹å‹•åŒæ­¥è§¸ç™¼**ç”¨æ–¼ç·Šæ€¥ä¿ƒéŠ·
- **é¡¯ç¤ºåŒæ­¥æ™‚é–“æˆ³è¨˜**æ–¼é–€å¸‚POS(ã€Œä¿ƒéŠ·æ›´æ–°æ™‚é–“: 2024-10-27 09:30ã€)
- **å»ºç«‹è­¦å ±**å¦‚æœåŒæ­¥å¤±æ•—æˆ–å»¶é²>2å°æ™‚

---

### âš ï¸ ä¸­: ç„¡ä¿ƒéŠ·éæœŸé©—è­‰

**å•é¡Œ**: SOMåœ¨è¨‚å–®å»ºç«‹æ™‚ä¸é©—è­‰ä¿ƒéŠ·æ˜¯å¦å·²éæœŸã€‚

**ä»£ç¢¼ç¼ºå£**: `setOrderDtlsEventType()`æŸ¥è©¢`TBL_PROM_EVENT`ä½†ä¸æª¢æŸ¥`START_DAT`/`END_DAT`ã€‚

**é¢¨éšªå ´æ™¯**:
1. SKUå¾æ˜¨å¤©çš„æ‰¹æ¬¡æœ‰`PROM_EVENT_NO = "MT22046216"`
2. ä¿ƒéŠ·æ–¼åˆå¤œéæœŸ(END_DAT = 2024-10-26)
3. å®¢æˆ¶æ–¼2024-10-27ä¸Šåˆ10:00å»ºç«‹è¨‚å–®
4. **SOMä»å¥—ç”¨å·²éæœŸä¿ƒéŠ·**(å› æ‰¹æ¬¡å°šæœªåŸ·è¡Œ)

**ç•¶å‰ä»£ç¢¼** (Lines 56-66):
```java
TblPromEvent promEvent = bzSoServices.queryPromEvent(orderDetlVO.getEventNosp());
if (promEvent != null) {
    // âŒ ç„¡æ—¥æœŸé©—è­‰!
    orderDetlVO.setEvnetType(promEvent.getEventType());
}
```

**å»ºè­°**:
```java
TblPromEvent promEvent = bzSoServices.queryPromEvent(orderDetlVO.getEventNosp());
if (promEvent != null) {
    // âœ… æ–°å¢æ—¥æœŸé©—è­‰
    Date now = new Date();
    if (now.compareTo(promEvent.getStartDat()) >= 0 &&
        now.compareTo(promEvent.getEndDat()) <= 0) {
        orderDetlVO.setEvnetType(promEvent.getEventType());
    } else {
        logger.warn("ä¿ƒéŠ·å·²éæœŸ: " + promEvent.getEventNo() +
                   " (END_DAT: " + promEvent.getEndDat() + ")");
        // æ¸…é™¤ä¿ƒéŠ·åˆ†é…
        orderDetlVO.setEventNosp(null);
    }
}
```

---

### âš ï¸ ä½: äº‹ä»¶é¡å‹æ‹¼å¯«éŒ¯èª¤

**å•é¡Œ**: æ¬„ä½åç¨±`evnetType`æ‡‰ç‚º`eventType`(ç¼ºå°‘'e')ã€‚

**ä»£ç¢¼è­‰æ“š**: æ•´å€‹ä»£ç¢¼åº«
```java
orderDetlVO.setEvnetType(promEvent.getEventType());  // æ‹¼å¯«éŒ¯èª¤
String eventType = orderDetlVO.getEvnetType();        // æ‹¼å¯«éŒ¯èª¤
```

**å½±éŸ¿**:
- ä½(åŠŸèƒ½ä»£ç¢¼é‹ä½œæ­£å¸¸)
- ä»£ç¢¼å¯è®€æ€§é™ä½
- è‡ªå‹•å®Œæˆæ··æ·†

**å»ºè­°**:
- **åœ¨é‡å¯«æ™‚ä¿®æ­£**: ä½¿ç”¨æ­£ç¢ºæ‹¼å¯«`eventType`
- **è¨˜éŒ„æ–¼é·ç§»æŒ‡å—**: ã€ŒèˆŠæ¬„ä½`evnetType`é‡æ–°å‘½åç‚º`eventType`ã€

---

## æª”æ¡ˆåƒè€ƒæ‘˜è¦

### æ‰¹æ¬¡ä½œæ¥­å±¤

**StoreSkuPriceReceiver.java**
- **è·¯å¾‘**: `so-batchjob/src/main/java/com/trihome/som/so/dataexchange/service/StoreSkuPriceReceiver.java`
- **è¡Œæ•¸**: 93-115
- **ç›®çš„**: å¾OMSæ¯æ—¥æ‰¹æ¬¡åŒæ­¥,åˆ†é…`PROM_EVENT_NO`

**CustomOmsBsSkuStoreMapper.xml**
- **è·¯å¾‘**: `so-batchjob/src/main/resources/sqlMap/CustomOmsBsSkuStoreMapper.xml`
- **è¡Œæ•¸**: 4-93
- **ç›®çš„**: MERGE SQLåŒæ­¥`bs_sku_store@oms.MP_EVENT` â†’ `TBL_SKU_STORE.PROM_EVENT_NO`

---

### æœå‹™å±¤

**BzSoServices.java**
- **è·¯å¾‘**: `so-bzservices/src/main/java/com/trihome/som/bz/service/BzSoServices.java`
- **è¡Œæ•¸**:
  - 296: Autowired `SoComputeFunctionMainServices`
  - 770-781: `queryPromEvent()` - å–å¾—äº‹ä»¶é¡å‹
  - 789-803: `queryPromGroup()` - å–å¾—å±¤ç´šçµæ§‹
  - 814-838: `queryPromCondition()` - å–å¾—é–€æª»
  - 848-870: `queryPromSet()` - å–å¾—SKUé›†åˆ
  - 4454-4478: å®šåƒ¹å¼•æ“æ•´åˆ
- **ç›®çš„**: æ ¸å¿ƒä¿ƒéŠ·æŸ¥è©¢æœå‹™

**SoComputeFunctionMainServices.java**
- **è·¯å¾‘**: `so-bzservices/src/main/java/com/trihome/som/bz/service/SoComputeFunctionMainServices.java`
- **è¡Œæ•¸**:
  - 44-49: `getSoComputeFunctionMain()` - ä¸»è¦å…¥å£é»
  - 56-66: `setOrderDtlsEventType()` - äº‹ä»¶é¡å‹åˆ†é…
- **ç›®çš„**: å¤šé‡ä¿ƒéŠ·ç·¨æ’æœå‹™

---

### åŠŸèƒ½å±¤

**SoComputeFunctionMain.java**
- **è·¯å¾‘**: `so-bzservices/src/main/java/com/trihome/som/bz/functions/SoComputeFunctionMain.java`
- **è¡Œæ•¸**:
  - 37-44: äº‹ä»¶è¨ˆç®—å™¨å®£å‘Š
  - 47-54: äº‹ä»¶å•†å“æ¡¶å®£å‘Š
  - 62-72: äº‹ä»¶è¨ˆç®—å™¨åˆå§‹åŒ–
  - 78-116: `init()` - äº‹ä»¶åˆ†é¡å’Œåˆå§‹åŒ–
  - 122-144: `assortGoodType()` - ä¾P, I, DDåˆ†é›¢
  - 150-179: `assortEventNo()` - ä¾äº‹ä»¶é¡å‹A-Håˆ†é¡
  - 190-240: `getDiscQty()`, `getDiscAmt()`, `getDiscInfo()`
- **ç›®çš„**: äº‹ä»¶åˆ†é¡å’Œè·¯ç”±

---

## çµè«–å’Œä¸‹ä¸€æ­¥

### ç™¼ç¾æ‘˜è¦

1. **ç„¡SOMå„ªå…ˆç´šé‚è¼¯**: å„ªå…ˆç´šè§£æç™¼ç”Ÿåœ¨OMS,éSOM
2. **å–®ä¸€äº‹ä»¶ç´„æŸ**: `TBL_SKU_STORE.PROM_EVENT_NO`åªèƒ½å„²å­˜ä¸€å€‹ä¿ƒéŠ·
3. **æ¯æ—¥åŒæ­¥**: ä¿ƒéŠ·è®Šæ›´æœ‰æœ€å¤š24å°æ™‚å»¶é²
4. **è™•ç†é †åº â‰  å„ªå…ˆç´š**: Aâ†’Hé †åºæ˜¯åˆå§‹åŒ–åºåˆ—,éå„ªå…ˆç´šæ’å
5. **äº‹ä»¶é¡å‹ä¸å¯è®Šæ€§**: ä¸€æ—¦åˆ†é…çµ¦è¨‚å–®å•†å“,äº‹ä»¶é¡å‹ä¸è®Š
6. **ç´…åˆ©ç©é»æ’é™¤**: æœ‰ç´…åˆ©ç©é»çš„å•†å“ç„¡æ³•ä½¿ç”¨äº‹ä»¶ä¿ƒéŠ·
7. **ç„¡éæœŸé©—è­‰**: å·²éæœŸä¿ƒéŠ·å¯èƒ½ä»è¢«å¥—ç”¨(éŒ¯èª¤)

### éœ€è¦æ¥­å‹™æ±ºç­–

1. **è¨˜éŒ„OMSå„ªå…ˆç´šè¦å‰‡**: ç•¶å¤šå€‹ä¿ƒéŠ·åŒ¹é…æ™‚OMSå¦‚ä½•æ±ºå®š?
2. **å®šç¾©é‚Šç·£æ¡ˆä¾‹**: æ™‚é–“é‡ç–Šä¿ƒéŠ·æœƒç™¼ç”Ÿä»€éº¼?
3. **åŒæ­¥é »ç‡**: ç·Šæ€¥ä¿ƒéŠ·æ‡‰è©²æœ‰æ‰‹å‹•åŒæ­¥è§¸ç™¼å—?
4. **éæœŸè™•ç†**: SOMæ‡‰è©²åœ¨è¨‚å–®æ™‚é©—è­‰ä¿ƒéŠ·æ—¥æœŸå—?
5. **è¡çªæ—¥èªŒè¨˜éŒ„**: SOMæ‡‰è©²è¨˜éŒ„å“ªäº›ä¿ƒéŠ·è¢«OMSã€Œæ‹’çµ•ã€å—?

### æŠ€è¡“å»ºè­°

1. **æ–°å¢æ—¥æœŸé©—è­‰**: åœ¨`setOrderDtlsEventType()`æª¢æŸ¥`START_DAT`/`END_DAT`
2. **æ–°å¢è™•ç†é †åºè¨»è§£**: æ¾„æ¸…Aâ†’Hä¸æ˜¯å„ªå…ˆç´šé †åº
3. **ä¿®æ­£æ¬„ä½åç¨±æ‹¼å¯«**: åœ¨é‡å¯«æ™‚å°‡`evnetType`é‡æ–°å‘½åç‚º`eventType`
4. **å»ºç«‹ä¿ƒéŠ·å„€è¡¨æ¿**: é¡¯ç¤ºæ¥­å‹™çš„è¡çªåˆ†æ
5. **æ–°å¢æ‰‹å‹•åŒæ­¥è§¸ç™¼**: ç”¨æ–¼ç·Šæ€¥ä¿ƒéŠ·å•Ÿå‹•

---

**æ–‡æª”çµæŸ**
