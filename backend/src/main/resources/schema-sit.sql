-- Schema for H2 Database (Development/Test)
-- Feature: 001-keycloak-user-login
-- Tables: TBL_USER, TBL_CHANNEL, TBL_STORE, TBL_USER_MAST_STORE, TBL_USER_STORE
-- Updated to match UAT Oracle structure

-- Drop tables if exist (for clean reset)
DROP TABLE IF EXISTS TBL_USER_STORE;
DROP TABLE IF EXISTS TBL_USER_MAST_STORE;
DROP TABLE IF EXISTS TBL_STORE;
DROP TABLE IF EXISTS TBL_USER;
DROP TABLE IF EXISTS TBL_CHANNEL;

-- TBL_CHANNEL (通路/系統別)
CREATE TABLE TBL_CHANNEL (
    CHANNEL_ID VARCHAR(10) PRIMARY KEY,
    CHANNEL_NAME VARCHAR(50) NOT NULL,
    POS_CHANNEL VARCHAR(10),
    COMPANY_CODE VARCHAR(10),
    SEQUENCE_NUM INT,
    SAP_CHANNEL VARCHAR(10),
    DC_STORE_ID VARCHAR(10),
    STATUS VARCHAR(1)
);

-- TBL_USER (使用者)
CREATE TABLE TBL_USER (
    EMP_ID VARCHAR(20) PRIMARY KEY,
    CHANNEL_ID VARCHAR(10),
    STORE_ID VARCHAR(10),
    EMP_NAME VARCHAR(100) NOT NULL,
    SYSTEM_FLAG VARCHAR(50),
    DISABLED_FLAG VARCHAR(1),
    AUTHORITY_GRADE SMALLINT,
    START_DATE TIMESTAMP,
    END_DATE TIMESTAMP,
    UPDATE_DATE TIMESTAMP,
    UPDATE_EMP_ID VARCHAR(20),
    UPDATE_EMP_NAME VARCHAR(100)
);

-- TBL_STORE (店別)
CREATE TABLE TBL_STORE (
    STORE_ID VARCHAR(10) PRIMARY KEY,
    CHANNEL_ID VARCHAR(10) NOT NULL,
    STORE_NAME VARCHAR(100) NOT NULL,
    SHORT_NAME VARCHAR(50),
    CREATE_DATE TIMESTAMP,
    CLOSE_DATE TIMESTAMP,
    STORE_ADDR VARCHAR(200),
    STORE_TEL VARCHAR(20),
    STORE_FAX VARCHAR(20),
    STATUS VARCHAR(1),
    COMPANY_ID VARCHAR(10),
    SITE_ID VARCHAR(10),
    AREA_ID VARCHAR(10),
    COST_CENTER VARCHAR(20),
    ZIP_CODE VARCHAR(10),
    TXN_TYPE VARCHAR(10),
    STORE_TYPE VARCHAR(10),
    GUI_TYPE VARCHAR(10),
    EMAIL VARCHAR(100),
    POS_STORE_NAME VARCHAR(100),
    INV_TITLE VARCHAR(100),
    TTS_AUTO_EMAIL VARCHAR(100),
    HCT_ID VARCHAR(20),
    PAYPAGE_EMAIL VARCHAR(100),
    JSGO_KEY VARCHAR(50),
    UPDATE_DATE TIMESTAMP,
    UPDATE_EMP_ID VARCHAR(20),
    UPDATE_EMP_NAME VARCHAR(100),
    SHOW_FLAG VARCHAR(1)
);

-- TBL_USER_MAST_STORE (使用者主店別)
CREATE TABLE TBL_USER_MAST_STORE (
    EMP_ID VARCHAR(20) NOT NULL,
    STORE_ID VARCHAR(10),
    CHANNEL_ID VARCHAR(10),
    UPDATE_DATE TIMESTAMP,
    UPDATE_EMP_ID VARCHAR(20),
    UPDATE_EMP_NAME VARCHAR(100)
);

-- TBL_USER_STORE (使用者支援店別)
CREATE TABLE TBL_USER_STORE (
    EMP_ID VARCHAR(20) NOT NULL,
    STORE_ID VARCHAR(10) NOT NULL,
    CHANNEL_ID VARCHAR(10),
    UPDATE_DATE TIMESTAMP,
    UPDATE_EMP_ID VARCHAR(20),
    UPDATE_EMP_NAME VARCHAR(100),
    PRIMARY KEY (EMP_ID, STORE_ID)
);

-- Create indexes for performance
CREATE INDEX IDX_USER_CHANNEL ON TBL_USER(CHANNEL_ID);
CREATE INDEX IDX_USER_STORE_ID ON TBL_USER(STORE_ID);
CREATE INDEX IDX_STORE_CHANNEL ON TBL_STORE(CHANNEL_ID);
CREATE INDEX IDX_UMS_EMP ON TBL_USER_MAST_STORE(EMP_ID);
CREATE INDEX IDX_US_EMP ON TBL_USER_STORE(EMP_ID);
CREATE INDEX IDX_US_STORE ON TBL_USER_STORE(STORE_ID);

-- TBL_AUDIT_LOG (稽核日誌)
DROP TABLE IF EXISTS TBL_AUDIT_LOG;
CREATE TABLE TBL_AUDIT_LOG (
    LOG_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EMP_ID VARCHAR(20) NOT NULL,
    EMP_NAME VARCHAR(100),
    ACTION_TYPE VARCHAR(20) NOT NULL,
    ACTION_DETAIL VARCHAR(500),
    STORE_ID VARCHAR(10),
    CHANNEL_ID VARCHAR(10),
    IP_ADDRESS VARCHAR(50),
    USER_AGENT VARCHAR(500),
    RESULT VARCHAR(20),
    ERROR_MESSAGE VARCHAR(500),
    CREATE_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create index for audit log queries
CREATE INDEX IDX_AUDIT_EMP ON TBL_AUDIT_LOG(EMP_ID);
CREATE INDEX IDX_AUDIT_ACTION ON TBL_AUDIT_LOG(ACTION_TYPE);
CREATE INDEX IDX_AUDIT_DATE ON TBL_AUDIT_LOG(CREATE_DATE);
