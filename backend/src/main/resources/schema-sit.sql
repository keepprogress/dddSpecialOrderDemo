-- Schema for H2 Database (Development/Test)
-- Feature: 001-keycloak-user-login
-- Tables: TBL_USER, TBL_CHANNEL, TBL_STORE, TBL_USER_MAST_STORE, TBL_USER_STORE
-- Updated to match UAT Oracle structure

-- Drop tables if exist (for clean reset)
DROP TABLE IF EXISTS TBL_USER_STORE;
DROP TABLE IF EXISTS TBL_USER_MAST_STORE;
DROP TABLE IF EXISTS TBL_STORE;
DROP TABLE IF EXISTS TBL_USER;
DROP TABLE IF EXISTS TBL_CHANNEL;

-- TBL_CHANNEL (通路/系統別)
CREATE TABLE TBL_CHANNEL (
    CHANNEL_ID VARCHAR(10) PRIMARY KEY,
    CHANNEL_NAME VARCHAR(50) NOT NULL,
    POS_CHANNEL VARCHAR(10),
    COMPANY_CODE VARCHAR(10),
    SEQUENCE_NUM INT,
    SAP_CHANNEL VARCHAR(10),
    DC_STORE_ID VARCHAR(10),
    STATUS VARCHAR(1)
);

-- TBL_USER (使用者)
CREATE TABLE TBL_USER (
    EMP_ID VARCHAR(20) PRIMARY KEY,
    CHANNEL_ID VARCHAR(10),
    STORE_ID VARCHAR(10),
    EMP_NAME VARCHAR(100) NOT NULL,
    SYSTEM_FLAG VARCHAR(50),
    DISABLED_FLAG VARCHAR(1),
    AUTHORITY_GRADE SMALLINT,
    START_DATE TIMESTAMP,
    END_DATE TIMESTAMP,
    UPDATE_DATE TIMESTAMP,
    UPDATE_EMP_ID VARCHAR(20),
    UPDATE_EMP_NAME VARCHAR(100)
);

-- TBL_STORE (店別)
CREATE TABLE TBL_STORE (
    STORE_ID VARCHAR(10) PRIMARY KEY,
    CHANNEL_ID VARCHAR(10) NOT NULL,
    STORE_NAME VARCHAR(100) NOT NULL,
    SHORT_NAME VARCHAR(50),
    CREATE_DATE TIMESTAMP,
    CLOSE_DATE TIMESTAMP,
    STORE_ADDR VARCHAR(200),
    STORE_TEL VARCHAR(20),
    STORE_FAX VARCHAR(20),
    STATUS VARCHAR(1),
    COMPANY_ID VARCHAR(10),
    SITE_ID VARCHAR(10),
    AREA_ID VARCHAR(10),
    COST_CENTER VARCHAR(20),
    ZIP_CODE VARCHAR(10),
    TXN_TYPE VARCHAR(10),
    STORE_TYPE VARCHAR(10),
    GUI_TYPE VARCHAR(10),
    EMAIL VARCHAR(100),
    POS_STORE_NAME VARCHAR(100),
    INV_TITLE VARCHAR(100),
    TTS_AUTO_EMAIL VARCHAR(100),
    HCT_ID VARCHAR(20),
    PAYPAGE_EMAIL VARCHAR(100),
    JSGO_KEY VARCHAR(50),
    UPDATE_DATE TIMESTAMP,
    UPDATE_EMP_ID VARCHAR(20),
    UPDATE_EMP_NAME VARCHAR(100),
    SHOW_FLAG VARCHAR(1)
);

-- TBL_USER_MAST_STORE (使用者主店別)
CREATE TABLE TBL_USER_MAST_STORE (
    EMP_ID VARCHAR(20) NOT NULL,
    STORE_ID VARCHAR(10),
    CHANNEL_ID VARCHAR(10),
    UPDATE_DATE TIMESTAMP,
    UPDATE_EMP_ID VARCHAR(20),
    UPDATE_EMP_NAME VARCHAR(100)
);

-- TBL_USER_STORE (使用者支援店別)
CREATE TABLE TBL_USER_STORE (
    EMP_ID VARCHAR(20) NOT NULL,
    STORE_ID VARCHAR(10) NOT NULL,
    CHANNEL_ID VARCHAR(10),
    UPDATE_DATE TIMESTAMP,
    UPDATE_EMP_ID VARCHAR(20),
    UPDATE_EMP_NAME VARCHAR(100),
    PRIMARY KEY (EMP_ID, STORE_ID)
);

-- Create indexes for performance
CREATE INDEX IDX_USER_CHANNEL ON TBL_USER(CHANNEL_ID);
CREATE INDEX IDX_USER_STORE_ID ON TBL_USER(STORE_ID);
CREATE INDEX IDX_STORE_CHANNEL ON TBL_STORE(CHANNEL_ID);
CREATE INDEX IDX_UMS_EMP ON TBL_USER_MAST_STORE(EMP_ID);
CREATE INDEX IDX_US_EMP ON TBL_USER_STORE(EMP_ID);
CREATE INDEX IDX_US_STORE ON TBL_USER_STORE(STORE_ID);

-- TBL_AUDIT_LOG (稽核日誌)
DROP TABLE IF EXISTS TBL_AUDIT_LOG;
CREATE TABLE TBL_AUDIT_LOG (
    LOG_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EMP_ID VARCHAR(20) NOT NULL,
    EMP_NAME VARCHAR(100),
    ACTION_TYPE VARCHAR(20) NOT NULL,
    ACTION_DETAIL VARCHAR(500),
    STORE_ID VARCHAR(10),
    CHANNEL_ID VARCHAR(10),
    IP_ADDRESS VARCHAR(50),
    USER_AGENT VARCHAR(500),
    RESULT VARCHAR(20),
    ERROR_MESSAGE VARCHAR(500),
    CREATE_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Create index for audit log queries
CREATE INDEX IDX_AUDIT_EMP ON TBL_AUDIT_LOG(EMP_ID);
CREATE INDEX IDX_AUDIT_ACTION ON TBL_AUDIT_LOG(ACTION_TYPE);
CREATE INDEX IDX_AUDIT_DATE ON TBL_AUDIT_LOG(CREATE_DATE);

-- ================================================================
-- Feature: 002-create-order (訂單建立)
-- Tables: TBL_ORDER_MAST, TBL_ORDER_DETL, TBL_ORDER_COMPUTE, TBL_SKU_MAST
-- ================================================================

-- Sequences for Order IDs
DROP SEQUENCE IF EXISTS SEQ_ORDER_ID;
CREATE SEQUENCE SEQ_ORDER_ID START WITH 3000000000 INCREMENT BY 1;

DROP SEQUENCE IF EXISTS SEQ_PROJECT_ID;
CREATE SEQUENCE SEQ_PROJECT_ID START WITH 1 INCREMENT BY 1;

-- TBL_ORDER_MAST (訂單主檔)
DROP TABLE IF EXISTS TBL_ORDER_COMPUTE;
DROP TABLE IF EXISTS TBL_ORDER_DETL;
DROP TABLE IF EXISTS TBL_ORDER_MAST;

CREATE TABLE TBL_ORDER_MAST (
    ORDER_ID VARCHAR(10) PRIMARY KEY,
    PROJECT_ID VARCHAR(16) NOT NULL,
    MEMBER_CARD_ID VARCHAR(20),
    CARD_TYPE VARCHAR(2),
    MEMBER_NAME VARCHAR(100),
    MEMBER_PHONE VARCHAR(20),
    MEMBER_CELL_PHONE VARCHAR(20),
    CONTACT_NAME VARCHAR(100),
    CONTACT_PHONE VARCHAR(20),
    INSTALL_ZIP VARCHAR(5),
    INSTALL_ADDR VARCHAR(200),
    STORE_ID VARCHAR(10) NOT NULL,
    CHANNEL_ID VARCHAR(10) NOT NULL,
    ORDER_STATUS VARCHAR(1) DEFAULT '1',
    ORDER_SOURCE VARCHAR(10),
    HANDLER_ID VARCHAR(20),
    SPECIALIST_ID VARCHAR(20),
    TOTAL_AMT DECIMAL(12,0) DEFAULT 0,
    DISC_AMT DECIMAL(12,0) DEFAULT 0,
    TAX_AMT DECIMAL(12,0) DEFAULT 0,
    PAYABLE_AMT DECIMAL(12,0) DEFAULT 0,
    PROMOTION_SKIPPED VARCHAR(1) DEFAULT 'N',
    IDEMPOTENCY_KEY VARCHAR(36),
    CREATE_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CREATE_EMP_ID VARCHAR(20),
    UPDATE_DATE TIMESTAMP,
    UPDATE_EMP_ID VARCHAR(20)
);

-- TBL_ORDER_DETL (訂單明細)
CREATE TABLE TBL_ORDER_DETL (
    LINE_ID VARCHAR(20) PRIMARY KEY,
    ORDER_ID VARCHAR(10) NOT NULL,
    SERIAL_NO INT NOT NULL,
    SKU_NO VARCHAR(20) NOT NULL,
    SKU_NAME VARCHAR(200),
    QUANTITY INT DEFAULT 1,
    POS_AMT DECIMAL(12,0) DEFAULT 0,
    ACT_POS_AMT DECIMAL(12,0) DEFAULT 0,
    TAX_TYPE VARCHAR(1),
    DELIVERY_FLAG VARCHAR(1) DEFAULT 'N',
    TRADE_STATUS VARCHAR(1) DEFAULT 'X',
    DELIVERY_DATE DATE,
    WORK_TYPE_ID VARCHAR(10),
    MEMBER_DISC DECIMAL(12,0) DEFAULT 0,
    BONUS_DISC DECIMAL(12,0) DEFAULT 0,
    COUPON_DISC DECIMAL(12,0) DEFAULT 0,
    POS_AMT_CHANGE_PRICE VARCHAR(1) DEFAULT 'N',
    HAS_FREE_INSTALL VARCHAR(1) DEFAULT 'N',
    CREATE_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATE_DATE TIMESTAMP,
    CONSTRAINT FK_DETL_ORDER FOREIGN KEY (ORDER_ID) REFERENCES TBL_ORDER_MAST(ORDER_ID)
);

-- TBL_ORDER_COMPUTE (訂單試算結果)
CREATE TABLE TBL_ORDER_COMPUTE (
    COMPUTE_ID BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ORDER_ID VARCHAR(10) NOT NULL,
    COMPUTE_TYPE VARCHAR(1) NOT NULL,
    COMPUTE_NAME VARCHAR(50),
    TOTAL_PRICE DECIMAL(12,0) DEFAULT 0,
    DISCOUNT DECIMAL(12,0) DEFAULT 0,
    ACT_TOTAL_PRICE DECIMAL(12,0) DEFAULT 0,
    CREATE_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_COMPUTE_ORDER FOREIGN KEY (ORDER_ID) REFERENCES TBL_ORDER_MAST(ORDER_ID)
);

-- TBL_SKU_MAST (商品主檔 - 簡化版供開發測試用)
DROP TABLE IF EXISTS TBL_SKU_MAST;
CREATE TABLE TBL_SKU_MAST (
    SKU_NO VARCHAR(20) PRIMARY KEY,
    SKU_NAME VARCHAR(200) NOT NULL,
    CATEGORY_ID VARCHAR(10),
    CATEGORY_NAME VARCHAR(100),
    TAX_TYPE VARCHAR(1) DEFAULT '1',
    MARKET_PRICE DECIMAL(12,0) DEFAULT 0,
    REG_PRICE DECIMAL(12,0) DEFAULT 0,
    POS_PRICE DECIMAL(12,0) DEFAULT 0,
    COST DECIMAL(12,0) DEFAULT 0,
    ALLOW_SALES VARCHAR(1) DEFAULT 'Y',
    HOLD_ORDER VARCHAR(1) DEFAULT 'N',
    IS_SYSTEM_SKU VARCHAR(1) DEFAULT 'N',
    IS_NEGATIVE_SKU VARCHAR(1) DEFAULT 'N',
    FREE_DELIVERY VARCHAR(1) DEFAULT 'N',
    FREE_DELIVERY_SHIPPING VARCHAR(1) DEFAULT 'N',
    ALLOW_DIRECT_SHIPMENT VARCHAR(1) DEFAULT 'N',
    ALLOW_HOME_DELIVERY VARCHAR(1) DEFAULT 'Y',
    UPDATE_DATE TIMESTAMP
);

-- Create indexes for order tables
CREATE INDEX IDX_ORDER_PROJECT ON TBL_ORDER_MAST(PROJECT_ID);
CREATE INDEX IDX_ORDER_MEMBER ON TBL_ORDER_MAST(MEMBER_CARD_ID);
CREATE INDEX IDX_ORDER_STORE ON TBL_ORDER_MAST(STORE_ID);
CREATE INDEX IDX_ORDER_STATUS ON TBL_ORDER_MAST(ORDER_STATUS);
CREATE INDEX IDX_ORDER_IDEMP ON TBL_ORDER_MAST(IDEMPOTENCY_KEY);
CREATE INDEX IDX_DETL_ORDER ON TBL_ORDER_DETL(ORDER_ID);
CREATE INDEX IDX_DETL_SKU ON TBL_ORDER_DETL(SKU_NO);
CREATE INDEX IDX_COMPUTE_ORDER ON TBL_ORDER_COMPUTE(ORDER_ID);
CREATE INDEX IDX_SKU_CATEGORY ON TBL_SKU_MAST(CATEGORY_ID);
